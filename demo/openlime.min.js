// ##########################################
// OpenLIME - Open Layered IMage Explorer
// Author: CNR ISTI - Visual Computing Lab
// Author: CRS4 Visual and Data-intensive Computing Group
// openlime v1.2.1 - GPL-3.0 License
// Documentation: https://cnr-isti-vclab.github.io/openlime/
// Repository: https://github.com/cnr-isti-vclab/openlime.git
// ##########################################
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).OpenLIME=t.OpenLIME||{})}(this,(function(t){"use strict";window.structuredClone="function"==typeof structuredClone?structuredClone:function(t){return JSON.parse(JSON.stringify(t))};class e{static padZeros(t,e){return t.toString().padStart(e,"0")}static printSrcCode(t){let i="";t.split(/\r\n|\r|\n/).forEach(((t,s)=>{const n=e.padZeros(s+1,5);i+=`${n}   ${t}\n`})),console.log(i)}static createSVGElement(t,e){const i=document.createElementNS("http://www.w3.org/2000/svg",t);if(e)for(const[t,s]of Object.entries(e))i.setAttribute(t,s);return i}static SVGFromString(t){return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement}static async loadSVG(t){let i=await fetch(t);if(!i.ok){const t=`An error has occured: ${i.status}`;throw new Error(t)}let s=await i.text(),n=null;if(!e.isSVGString(s)){throw new Error(`${t} is not an SVG file`)}return n=e.SVGFromString(s),n}static async loadHTML(t){let e=await fetch(t);if(!e.ok){const t=`An error has occured: ${e.status}`;throw new Error(t)}return await e.text()}static async loadJSON(t){let e=await fetch(t);if(!e.ok){const t=`An error has occured: ${e.status}`;throw new Error(t)}return await e.json()}static async loadImage(t){return new Promise(((e,i)=>{const s=new Image;s.addEventListener("load",(()=>e(s))),s.addEventListener("error",(t=>i(t))),s.src=t}))}static async appendImg(t,i,s=null){const n=await e.loadImage(i);return s&&n.classList.add(s),t.appendChild(n),n}static async appendImgs(t,i,s=null){for(const n of i){const i=await e.loadImage(n);s&&i.classList.add(s),t.appendChild(i)}}static isSVGString(t){return null!=t&&null!=t&&(t=(t=t.toString().replace(/\s*<!Entity\s+\S*\s*(?:"|')[^"]+(?:"|')\s*>/gim,"")).replace(/<!--([\s\S]*?)-->/g,""),Boolean(t)&&/^\s*(?:<\?xml[^>]*>\s*)?(?:<!doctype svg[^>]*\s*(?:\[?(?:\s*<![^>]*>\s*)*\]?)*[^>]*>\s*)?(?:<svg[^>]*>[^]*<\/svg>|<svg[^/>]*\/\s*>)\s*$/i.test(t))}static computeSDF(t,e,i,s=.25,n=8){function r(t,e,i,s,n,r,a){for(let l=0;l<e;l++){for(let n=0;n<i;n++)s[n]=t[n*e+l];o(s,n,r,a,i);for(let s=0;s<i;s++)t[s*e+l]=n[s]}for(let l=0;l<i;l++){for(let i=0;i<e;i++)s[i]=t[l*e+i];o(s,n,r,a,e);for(let i=0;i<e;i++)t[l*e+i]=Math.sqrt(n[i])}}function o(t,e,i,s,n){i[0]=0,s[0]=-l,s[1]=+l;for(let e=1,o=0;e<n;e++){for(var r=(t[e]+e*e-(t[i[o]]+i[o]*i[o]))/(2*e-2*i[o]);r<=s[o];)o--,r=(t[e]+e*e-(t[i[o]]+i[o]*i[o]))/(2*e-2*i[o]);o++,i[o]=e,s[o]=r,s[o+1]=+l}for(let r=0,o=0;r<n;r++){for(;s[o+1]<r;)o++;e[r]=(r-i[o])*(r-i[o])+t[i[o]]}}var a=new Uint8ClampedArray(t);const l=1e20,h=Math.max(e,i),c=Array(e*i),d=Array(e*i),u=Array(h),p=Array(h),m=Array(h+1),f=Array(h);for(let t=0;t<e*i;t++){var g=a[t]/255;c[t]=1===g?0:0===g?l:Math.pow(Math.max(0,.5-g),2),d[t]=1===g?l:0===g?0:Math.pow(Math.max(0,g-.5),2)}r(c,e,i,u,p,f,m),r(d,e,i,u,p,f,m);const v=window.Float32Array?new Float32Array(e*i):new Array(e*i);for(let t=0;t<e*i;t++)v[t]=Math.min(Math.max(1-((c[t]-d[t])/n+s),0),1);return v}static async rasterizeSVG(t,i=[64,64]){const s=await e.loadSVG(t),n=s.getAttribute("width"),r=s.getAttribute("height"),o=document.createElement("canvas");o.width=i[0],o.height=i[1],s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%");const a=o.getContext("2d"),l=(new XMLSerializer).serializeToString(s),h=window.URL||window.webkitURL||window,c=new Image,d=new Blob([l],{type:"image/svg+xml;charset=utf-8"}),u=h.createObjectURL(d);return c.src=u,new Promise(((t,e)=>{c.onload=()=>{const e=i[0]/i[1],s=n/r;let o=0,l=0;s<e?(l=i[1],o=l*s):(o=i[0],l=o/s);let d=.5*(i[1]-l),p=.5*(i[0]-o);a.translate(p,d),a.drawImage(c,0,0),h.revokeObjectURL(u);const m=a.getImageData(0,0,i[0],i[1]);t(m)},c.onerror=t=>e(t)}))}}class i{constructor(t){Object.assign(this,{xLow:1e20,yLow:1e20,xHigh:-1e20,yHigh:-1e20}),Object.assign(this,t)}fromArray(t){this.xLow=t[0],this.yLow=t[1],this.xHigh=t[2],this.yHigh=t[3]}toEmpty(){this.xLow=1e20,this.yLow=1e20,this.xHigh=-1e20,this.yHigh=-1e20}isEmpty(){return this.xLow>=this.xHigh||this.yLow>=this.yHigh}toArray(){return[this.xLow,this.yLow,this.xHigh,this.yHigh]}toString(){return this.xLow.toString()+" "+this.yLow.toString()+" "+this.xHigh.toString()+" "+this.yHigh.toString()}mergeBox(t){null!=t&&(this.isEmpty()?Object.assign(this,t):(this.xLow=Math.min(this.xLow,t.xLow),this.yLow=Math.min(this.yLow,t.yLow),this.xHigh=Math.max(this.xHigh,t.xHigh),this.yHigh=Math.max(this.yHigh,t.yHigh)))}mergePoint(t){this.xLow=Math.min(this.xLow,t.x),this.yLow=Math.min(this.yLow,t.y),this.xHigh=Math.max(this.xHigh,t.x),this.yHigh=Math.max(this.yHigh,t.y)}shift(t,e){this.xLow+=t,this.yLow+=e,this.xHigh+=t,this.yHigh+=e}quantize(t){this.xLow=Math.floor(this.xLow/t),this.yLow=Math.floor(this.yLow/t),this.xHigh=Math.floor((this.xHigh-1)/t)+1,this.yHigh=Math.floor((this.yHigh-1)/t)+1}width(){return Math.max(0,this.xHigh-this.xLow)}height(){return Math.max(0,this.yHigh-this.yLow)}area(){return this.width()*this.height()}center(){return{x:(this.xLow+this.xHigh)/2,y:(this.yLow+this.yHigh)/2}}corner(t){let e=this.toArray();return{x:e[0+(1&t)<<1],y:e[1+(2&t)]}}intersects(t){return!(!t||t.isEmpty()||this.isEmpty())&&(this.xLow<=t.xHigh&&this.xHigh>=t.xLow&&this.yLow<=t.yHigh&&this.yHigh>=t.yLow)}intersection(t){return this.intersects(t)?new i({xLow:Math.max(this.xLow,t.xLow),yLow:Math.max(this.yLow,t.yLow),xHigh:Math.min(this.xHigh,t.xHigh),yHigh:Math.min(this.yHigh,t.yHigh)}):null}clone(){return new i({xLow:this.xLow,yLow:this.yLow,xHigh:this.xHigh,yHigh:this.yHigh})}containsPoint(t,e=0){return!this.isEmpty()&&(t.x>=this.xLow-e&&t.x<=this.xHigh+e&&t.y>=this.yLow-e&&t.y<=this.yHigh+e)}print(){console.log("BOX="+this.xLow.toFixed(2)+", "+this.yLow.toFixed(2)+", "+this.xHigh.toFixed(2)+", "+this.yHigh.toFixed(2))}}class s{constructor(t){Object.assign(this,{x:0,y:0,z:1,a:0,t:0}),this.t||(this.t=performance.now()),"object"==typeof t&&Object.assign(this,t)}copy(){let t=new s;return Object.assign(t,this),t}apply(t,e){let i=s.rotate(t,e,this.a);return{x:i.x*this.z+this.x,y:i.y*this.z+this.y}}inverse(){let t=s.rotate(this.x/this.z,this.y/this.z,-this.a);return new s({x:-t.x,y:-t.y,z:1/this.z,a:-this.a,t:this.t})}static normalizeAngle(t){for(;t>360;)t-=360;for(;t<0;)t+=360;return t}static rotate(t,e,i){return i=Math.PI*(i/180),{x:Math.cos(i)*t-Math.sin(i)*e,y:Math.sin(i)*t+Math.cos(i)*e}}compose(t){let e=this.copy(),i=t;e.z*=i.z,e.a+=i.a;var n=s.rotate(e.x,e.y,i.a);return e.x=n.x*i.z+i.x,e.y=n.y*i.z+i.y,e}transformBox(t){let e=new i;for(let i=0;i<4;i++){let s=t.corner(i),n=this.apply(s.x,s.y);e.mergePoint(n)}return e}getInverseBox(t){let e=this.inverse(),s=[{x:t.x,y:t.y},{x:t.x+t.dx,y:t.y},{x:t.x,y:t.y+t.dy},{x:t.x+t.dx,y:t.y+t.dy}],n=new i;for(let i of s){let s=e.apply(i.x-t.w/2,-i.y+t.h/2);n.mergePoint(s)}return n}isAtTarget(t){return t>=this.t}static interpolate(t,e,i,n){console.assert(!isNaN(t.x)),console.assert(!isNaN(e.x));const r=new s;let o=e.t-t.t;if(r.isComplete=!1,i<t.t)Object.assign(r,t);else if(i>e.t||o<.001)Object.assign(r,e),r.isComplete=!0;else{let s=(i-t.t)/o;switch(n){case"ease-out":s=1-Math.pow(1-s,2);break;case"ease-in-out":s=s<.5?2*s*s:1-Math.pow(-2*s+2,2)/2}let a=1-s;for(let i of["x","y","z","a"])r[i]=a*t[i]+s*e[i]}return r.t=i,r}projectionMatrix(t){let e=this.z,i=2/t.dx,s=2/t.dy,n=i*this.x+2/t.dx*(t.w/2-t.x)-1,r=s*this.y+2/t.dy*(t.h/2-t.y)-1,o=Math.PI*this.a/180;return[Math.cos(o)*i*e,Math.sin(o)*s*e,0,0,-Math.sin(o)*i*e,Math.cos(o)*s*e,0,0,0,0,1,0,n,r,0,1]}sceneToViewportCoords(t,e){return[e[0]*this.z+this.x-t.x+t.w/2,e[1]*this.z-this.y+t.y+t.h/2]}viewportToSceneCoords(t,e){return[(e[0]+t.x-t.w/2-this.x)/this.z,(e[1]-t.y-t.h/2+this.y)/this.z]}print(t="",e=0){const i=e;console.log(t+" x:"+this.x.toFixed(i)+", y:"+this.y.toFixed(i)+", z:"+this.z.toFixed(i)+", a:"+this.a.toFixed(i)+", t:"+this.t.toFixed(i))}}function n(t,...e){t.prototype.allSignals??=[],t.prototype.allSignals=[...t.prototype.allSignals,...e],t.prototype.initSignals=function(){this.signals??=Object.fromEntries(this.allSignals.map((t=>[t,[]])))},t.prototype.addEvent=function(t,e){this.signals?.hasOwnProperty(t)||this.initSignals(),this.signals[t].push(e)},t.prototype.once=function(t,e){if(!e||"function"!=typeof e)return void console.error("Callback must be a function");const i=(...s)=>{this.removeEvent(t,i),e.apply(this,s)};this.addEvent(t,i)},t.prototype.removeEvent=function(t,e){if(!this.signals)return this.initSignals(),!1;if(!this.signals[t])return!1;if(void 0===e){const e=this.signals[t].length>0;return this.signals[t]=[],e}const i=this.signals[t].length;return this.signals[t]=this.signals[t].filter((t=>t!==e)),i>this.signals[t].length},t.prototype.emit=function(t,...e){this.signals||this.initSignals();const i=[...this.signals[t]];for(let t of i)t(...e)}}class r{constructor(){Object.assign(this,{index:null,bbox:null,level:null,x:null,y:null,w:null,h:null,start:null,end:null,tex:[],missing:null,time:null,priority:null,size:null})}}class o{static fromViewportToCanvasHtml(t,e,i){const s=this.getViewport(e,i);let n=this.invertY(t,s);return i?this.scale(n,1/window.devicePixelRatio):n}static fromCanvasHtmlToViewport(t,e,i){let s=i?this.scale(t,window.devicePixelRatio):t;const n=this.getViewport(e,i);return this.invertY(s,n)}static fromViewportToLayer(t,e,i,s){const n=this.getCurrentTransform(e,s).inverse(),r=i.inverse();return this.getFromViewportToCenterTransform(e,s).compose(n.compose(r)).apply(t.x,t.y)}static fromLayerToViewport(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).apply(t.x,t.y)}static fromLayerToCenter(t,e,i,s){const n=this.getCurrentTransform(e,s);return i.compose(n).apply(t.x,t.y)}static fromLayerToImage(t,e){let i={x:t.x+e.w/2,y:t.y+e.h/2};return this.invertY(i,e)}static fromCanvasHtmlToScene(t,e,i){let s=this.fromCanvasHtmlToViewport(t,e,i);const n=this.getFromViewportToCenterTransform(e,i),r=this.getCurrentTransform(e,i).inverse();return n.compose(r).apply(s.x,s.y)}static fromSceneToCanvasHtml(t,e,i){let s=this.fromSceneToViewport(t,e,i);return this.fromViewportToCanvasHtml(s,e,i)}static fromSceneToViewport(t,e,i){const s=this.getFromViewportToCenterTransform(e,i).inverse();return this.getCurrentTransform(e,i).compose(s).apply(t.x,t.y)}static fromSceneToViewportNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(i).inverse();return e.compose(s).apply(t.x,t.y)}static fromViewportToScene(t,e,i){const s=this.getFromViewportToCenterTransform(e,i),n=this.getCurrentTransform(e,i).inverse();return s.compose(n).apply(t.x,t.y)}static fromViewportToSceneNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(i),n=e.inverse();return s.compose(n).apply(t.x,t.y)}static fromCanvasHtmlToImage(t,e,i,s,n){let r=this.fromCanvasHtmlToScene(t,e,n);return r=i.inverse().apply(r.x,r.y),r=this.fromLayerToImage(r,s),r}static fromViewportBoxToImageBox(t,e,n,r,a){let l=new s({x:-n.w/2,y:-n.h/2}),h=e.inverse(),c=r.inverse(),d=new s({x:a.w/2,y:a.h/2}),u=l.compose(h.compose(c.compose(d))),p=new i;for(let e=0;e<4;++e){let i=t.corner(e);i=u.apply(i.x,i.y),i=o.invertY(i,a),p.mergePoint(i)}return p}static fromLayerBoxToSceneBox(t,e){return e.transformBox(t)}static fromSceneBoxToLayerBox(t,e){return e.inverse().transformBox(t)}static fromLayerBoxToViewportBox(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).transformBox(t)}static fromViewportBoxToLayerBox(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).inverse().transformBox(t)}static getFromViewportToCenterTransform(t,e){const i=this.getViewport(t,e);return this.getFromViewportToCenterTransformNoCamera(i)}static getFromViewportToCenterTransformNoCamera(t){return new s({x:t.x-t.w/2,y:t.y-t.h/2,z:1,a:0,t:0})}static reflectY(t){return new s({x:t.x,y:-t.y,z:t.z,a:t.a,t:t.t})}static getFromLayerToViewportTransform(t,e,i){const s=this.getCurrentTransform(t,i),n=this.getFromViewportToCenterTransform(t,i).inverse();return e.compose(s.compose(n))}static getFromLayerToViewportTransformNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(e).inverse();return i.compose(t.compose(s))}static scale(t,e){return{x:t.x*e,y:t.y*e}}static invertY(t,e){return{x:t.x,y:e.h-t.y}}static getViewport(t,e){return e?t.glViewport():t.viewport}static getCurrentTransform(t,e){return e?t.getGlCurrentTransform(performance.now()):t.getCurrentTransform(performance.now())}}class a{constructor(t,e,i){if("image"!=e){if(e in this.types)return this.types[e](t,e,i);if(null==e)return;throw"Layout type: "+e+" unknown, or module not loaded"}this.setDefaults(e),this.init(t,e,i)}getTileSize(){return[this.width,this.height]}setDefaults(t){Object.assign(this,{type:t,width:0,height:0,suffix:"jpg",urls:[],status:null,subdomains:"abc"})}init(t,e,i){i&&Object.assign(this,i),"string"==typeof t&&this.setUrls([t])}setUrls(t){this.urls=t,this.getTileURL=(t,e)=>this.urls[t],this.status="ready",this.emit("ready")}imageUrl(t,e){return t.substring(0,t.lastIndexOf("/")+1)+e+".jpg"}getTileURL(t,e){throw Error("Layout not defined or ready.")}boundingBox(){return new i({xLow:-this.width/2,yLow:-this.height/2,xHigh:this.width/2,yHigh:this.height/2})}tileCoords(t){let e=this.width,i=this.height;var s=new Float32Array([0,1,0,0,1,0,1,1]);return{coords:new Float32Array([-e/2,-i/2,0,-e/2,i/2,0,e/2,i/2,0,e/2,-i/2,0]),tcoords:s}}newTile(t){let e=new r;return e.index=t,e}needed(t,e,i,s,n,r,o=8){let a=r.get(0)||this.newTile(0);return a.time=performance.now(),a.priority=10,null===a.missing?[a]:[]}available(t,e,i,s,n,r){let o={};return r.has(0)&&0==r.get(0).missing&&(o[0]=r.get(0)),o}getViewportBox(t,e,s){const n=new i({xLow:t.x,yLow:t.y,xHigh:t.x+t.dx,yHigh:t.y+t.dy});return o.fromViewportBoxToImageBox(n,e,t,s,{w:this.width,h:this.height})}}a.prototype.types={},n(a,"ready","updateSize");class h{static#t;#e=[];#i;#s=0;#n=0;#r;#o;#a=null;#l;#h;#c=0;constructor(t={}){if(h.#t)return h.#t;const e={capacity:536870912,maxRequest:6,maxRequestsRate:0,maxPrefetch:8388608,...t};this.#i=e.capacity,this.#r=e.maxRequest,this.#o=e.maxRequestsRate,this.#h=e.maxPrefetch,this.#l=performance.now(),h.#t=this}static getInstance(t){if(h.#t){if(t){const e=h.#t;void 0!==t.capacity&&(e.#i=t.capacity),void 0!==t.maxRequest&&(e.#r=t.maxRequest),void 0!==t.maxRequestsRate&&(e.#o=t.maxRequestsRate),void 0!==t.maxPrefetch&&(e.#h=t.maxPrefetch)}}else new h(t);return h.#t}setCandidates(t){this.#e.includes(t)||this.#e.push(t),Promise.resolve().then((()=>this.update()))}#d(){if(this.#n>=this.#r)return!0;if(0===this.#o)return!1;const t=performance.now(),e=1e3/this.#o,i=t-this.#l;return!(i>e)&&(this.#a||(this.#a=setTimeout((()=>{this.#a=null,this.update()}),e-i+10)),!0)}update(){if(this.#d())return;const t=this.#u();if(t){for(;this.#s>this.#i;){const e=this.#p();if(!e){console.warn("Cache management issue: No tiles available for removal");break}if(!(e.tile.time<t.tile.time))return;this.#m(e.layer,e.tile)}t.layer.queue.shift(),this.#l=performance.now(),this.#f(t.layer,t.tile)}}#u(){let t=null;for(const e of this.#e){for(;e.queue.length>0&&e.tiles.has(e.queue[0].index);)e.queue.shift();if(!e.queue.length)continue;const i=e.queue[0];(!t||i.time>t.tile.time+1||i.priority>t.tile.priority)&&(t={layer:e,tile:i})}return t}#p(){let t=null;for(const e of this.#e)for(const i of e.tiles.values())0===i.missing&&(!t||i.time<t.tile.time||i.time===t.tile.time&&i.priority<t.tile.priority)&&(t={layer:e,tile:i});return t}#f(t,e){this.#n++,(async()=>{try{await t.loadTile(e,(t=>{this.#s+=t,this.#n--,this.update()}))}catch(t){console.error("Error loading tile:",t),this.#n--,this.update()}})()}#m(t,e){this.#s-=e.size,t.dropTile(e)}flushLayer(t){if(this.#e.includes(t))for(const e of t.tiles.values())this.#m(t,e)}getStats(){return{capacity:this.#i,used:this.#s,usedPercentage:this.#s/this.#i*100,activeRequests:this.#n,layers:this.#e.length}}}class c{constructor(t){if((t=Object.assign({isLinear:!1,isSrgbSimplified:!0},t)).type){let e=t.type;if(delete t.type,e in this.types)return this.types[e](t);throw"Layer type: "+e+"  module has not been loaded"}this.init(t)}derive(t={}){const e={layout:this.layout,sourceLayer:this,label:t.label||this.label,zindex:void 0!==t.zindex?t.zindex:this.zindex+1,visible:void 0!==t.visible?t.visible:this.visible,transform:t.transform||this.transform.copy(),shaders:t.shaders||Object.assign({},this.shaders),mipmapBias:t.mipmapBias||this.mipmapBias,pixelSize:t.pixelSize||this.pixelSize,debug:void 0!==t.debug?t.debug:this.debug},i=new c(e);return t.defaultShader&&e.shaders[t.defaultShader]&&i.setShader(t.defaultShader),i}init(t){if(Object.assign(this,{transform:new s,viewport:null,debug:!1,visible:!0,zindex:0,overlay:!1,rasters:[],layers:[],controls:{},controllers:[],shaders:{},layout:"image",shader:null,gl:null,width:0,height:0,prefetchBorder:1,mipmapBias:.4,pixelSize:0,tiles:new Map,queue:[],requested:new Map}),Object.assign(this,t),this.sourceLayer&&(this.tiles=this.sourceLayer.tiles),this.transform=new s(this.transform),"string"==typeof this.layout){let t={width:this.width,height:this.height};this.server&&(t.server=this.server),this.setLayout(new a(null,this.layout,t))}else this.setLayout(this.layout)}setViewport(t){this.viewport=t,this.emit("update")}addShader(t,e){if(t in this.shaders)throw new Error(`Shader with id '${t}' already exists`);return e.isLinear=this.isLinear,e.isSrgbSimplified=this.isSrgbSimplified,this.shaders[t]=e,1!==Object.keys(this.shaders).length||this.shader||this.setShader(t),this}removeShader(t){if(!(t in this.shaders))throw new Error(`Shader with id '${t}' does not exist`);const e=this.shader===this.shaders[t];if(delete this.shaders[t],e){this.shader=null;const t=Object.keys(this.shaders);t.length>0&&this.setShader(t[0]),this.emit("update")}return this}addShaderFilter(t){if(!this.shader)throw"Shader not implemented";this.shader.addFilter(t)}removeShaderFilter(t){if(!this.shader)throw"Shader not implemented";this.shader.removeFilter(t)}clearShaderFilters(){if(!this.shader)throw"Shader not implemented";this.shader.clearFilters()}setState(t,e,i="linear"){if("controls"in t)for(const[s,n]of Object.entries(t.controls))this.setControl(s,n,e,i);"mode"in t&&t.mode&&this.setMode(t.mode)}getState(t=null){const e={controls:{}};for(const[i,s]of Object.entries(this.controls))(!t||"controls"in t&&i in t.controls)&&(e.controls[i]=s.current.value);return t&&!("mode"in t)||this.getMode()&&(e.mode=this.getMode()),e}setLayout(t){this.layout=t;let e=()=>{this.status="ready",this.setupTiles(),this.emit("ready"),this.emit("update")};"ready"==t.status?e():t.addEvent("ready",e),this.layout.addEvent("updateSize",(()=>{this.shader&&this.shader.setTileSize(this.layout.getTileSize()),this.emit("updateSize")}))}setTransform(t){this.transform=t,this.emit("updateSize")}setShader(t){if(!t in this.shaders)throw"Unknown shader: "+t;this.shader=this.shaders[t],this.shader.isLinear=this.isLinear,this.shader.isSrgbSimplified=this.isSrgbSimplified,this.setupTiles(),this.shader.addEvent("update",(()=>{this.emit("update")}))}getMode(){return this.shader?this.shader.mode:null}getModes(){return this.shader?this.shader.modes:[]}setMode(t){this.shader.setMode(t),this.emit("update")}setVisible(t){this.visible=t,this.previouslyNeeded=null,this.emit("update")}setZindex(t){this.zindex=t,this.emit("update")}static computeLayersMinScale(t,e){if(null==t||null==t)return console.log("ASKING SCALE INFO ON NO LAYERS"),1;let i=1;for(let s of Object.values(t))if(!e||s.visible){let t=s.scale();i=Math.min(i,t)}return i}scale(){return this.transform.z}pixelSizePerMM(){return this.pixelSize*this.transform.z}boundingBox(){let t=this.layout.boundingBox();return null!=this.transform&&null!=this.transform&&(t=this.transform.transformBox(t)),t}static computeLayersBBox(t,e=!1){let s=new i,n=0;for(const i in t){const r=t[i];if(!r.visible&&e)continue;const o=r.boundingBox();o&&!o.isEmpty()&&(s.mergeBox(o),n++)}return 0===n||s.isEmpty()?null:s}getControl(t){let e=this.controls[t]?this.controls[t]:null;if(e){let t=performance.now();this.interpolateControl(e,t)}return e}addControl(t,e){if(this.controls[t])throw new Error('Control "$name" already exist!');let i=performance.now();this.controls[t]={source:{value:e,t:i},target:{value:e,t:i},current:{value:e,t:i},easing:"linear"}}setControl(t,e,i,s="linear"){let n=performance.now(),r=this.controls[t];this.interpolateControl(r,n),r.source.value=[...r.current.value],r.source.t=n,r.target.value=[...e],r.target.t=n+i,r.easing=s,this.emit("update")}interpolateControls(){let t=performance.now(),e=!0;for(let i of Object.values(this.controls))e=this.interpolateControl(i,t)&&e;return e}interpolateControl(t,e){let i=t.source,s=t.target,n=t.current;if(n.t=e,e<i.t)return n.value=[...i.value],!1;if(e>s.t-1e-4){let t=n.value.every(((t,e)=>t===s.value[e]));return n.value=[...s.value],t}let r=s.t-i.t,o=(e-i.t)/r;switch(t.easing){case"ease-out":o=1-Math.pow(1-o,2);break;case"ease-in-out":o=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2}let a=1-o;n.value=[];for(let t=0;t<i.value.length;t++)n.value[t]=a*i.value[t]+o*s.value[t];return!1}dropTile(t){for(let e=0;e<t.tex.length;e++)t.tex[e]&&this.gl.deleteTexture(t.tex[e]);this.tiles.delete(t.index)}clear(){this.ibuffer=this.vbuffer=null,h.flushLayer(this),this.tiles=new Map,this.setupTiles(),this.queue=[],this.previouslyNeeded=!1}draw(t,e){if("ready"!=this.status)return!0;if(!this.shader)throw"Shader not specified!";let i=this.interpolateControls(),s=e;this.viewport&&(e=this.viewport,this.gl.viewport(e.x,e.y,e.dx,e.dy)),this.prepareWebGL();let n=this.layout.available(e,t,this.transform,0,this.mipmapBias,this.tiles),r=(t=this.transform.compose(t)).projectionMatrix(e);this.gl.uniformMatrix4fv(this.shader.matrixlocation,this.gl.FALSE,r),this.updateAllTileBuffers(n);let o=this.shader.samplers.length;for(const t of this.shader.filters)for(let e=0;e<t.samplers.length;e++)this.gl.uniform1i(t.samplers[e].location,o),this.gl.activeTexture(this.gl.TEXTURE0+o),this.gl.bindTexture(this.gl.TEXTURE_2D,t.samplers[e].tex),o++;let a=0;for(let t of Object.values(n))this.drawTile(t,a),++a;return this.vieport&&this.gl.viewport(s.x,s.y,s.dx,s.dy),i}drawTile(t,e){if(0!=t.missing)throw"Attempt to draw tile still missing textures";let i=this.gl;for(var s=0;s<this.shader.samplers.length;s++){let e=this.shader.samplers[s].id;i.uniform1i(this.shader.samplers[s].location,s),i.activeTexture(i.TEXTURE0+s),i.bindTexture(i.TEXTURE_2D,t.tex[e])}const n=this.getTileByteOffset(e);i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,n)}getTileByteOffset(t){return 6*t*2}updateTileBuffers(t,e){let i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.coordattrib,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.coordattrib),i.bindBuffer(i.ARRAY_BUFFER,this.tbuffer),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.texattrib,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.texattrib)}updateAllTileBuffers(t){let e=this.gl,i=Object.values(t).length;if(0==i)return;const s=new Uint16Array(6*i),n=new Float32Array(12*i),r=new Float32Array(8*i);let o=0;for(let e of Object.values(t)){let t=this.layout.tileCoords(e);n.set(t.coords,12*o),r.set(t.tcoords,8*o);const i=4*o;e.indexBufferByteOffset=2*o*6,s.set([i+3,i+2,i+1,i+3,i+1,i+0],6*o),++o}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.vertexAttribPointer(this.shader.coordattrib,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.shader.coordattrib),e.bindBuffer(e.ARRAY_BUFFER,this.tbuffer),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.vertexAttribPointer(this.shader.texattrib,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.shader.texattrib)}setupTiles(){if(this.shader&&this.layout&&"ready"==this.layout.status)for(let t of this.tiles){t.missing=this.shader.samplers.length;for(let e of this.shader.samplers)t.tex[e.id]&&t.missing--}}prepareWebGL(){let t=this.gl;this.ibuffer||(this.ibuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ibuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([3,2,1,3,1,0]),t.STATIC_DRAW),this.vbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),t.STATIC_DRAW),this.tbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.tbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,1,0]),t.STATIC_DRAW)),this.shader.needsUpdate&&this.shader.createProgram(t),t.useProgram(this.shader.program),this.shader.updateUniforms(t)}sameNeeded(t,e){if(t.level!=e.level)return!1;for(let i of["xLow","xHigh","yLow","yHigh"])if(t.pyramid[t.level][i]!=e.pyramid[t.level][i])return!1;return!0}prefetch(t,e){if(this.viewport&&(e=this.viewport),0!=this.layers.length)for(let i of this.layers)i.prefetch(t,e);if(0!=this.rasters.length&&"ready"==this.status){if("object"!=typeof this.layout)throw"AH!";this.queue=this.layout.needed(e,t,this.transform,this.prefetchBorder,this.mipmapBias,this.tiles),h.getInstance().setCandidates(this)}}async loadTile(t,e){if(this.tiles.has(t.index)){e(new Error(`Tile with index ${t.index} already exists in cache`))}else{if(this.requested.has(t.index))return console.warn(`Duplicate tile request for index ${t.index}`),void e(new Error("Duplicate tile request"));this.tiles.set(t.index,t),this.requested.set(t.index,!0),t.size=0,t.missing=this.shader.samplers.length,t.tex=[];try{"itarzoom"===this.layout.type?await this._loadInterleaved(t,e):await this._loadParallel(t,e)}catch(i){this.requested.delete(t.index),this.tiles.delete(t.index),console.error(`Error loading tile ${t.index}:`,i),e(i)}}}async _loadInterleaved(t,e){t.url=this.layout.getTileURL(null,t);const i={};t.end&&(i.headers={range:`bytes=${t.start}-${t.end}`,"Accept-Encoding":"identity"});const s=await fetch(t.url,i);if(!s.ok)throw new Error(`Failed loading ${t.url}: ${s.statusText} (${s.status})`);const n=await s.blob();for(let e=0;e<this.shader.samplers.length;e++){const i=this.shader.samplers[e],s=this.rasters[i.id],r=n.slice(t.offsets[e],t.offsets[e+1]),o=await s.blobToImage(r,this.gl),a=s.loadTexture(this.gl,o),l=o.width*o.height*this.getPixelSize(i.id);t.size+=l,t.tex[i.id]=a,t.w=o.width,t.h=o.height}t.missing=0,this.emit("update"),this.requested.delete(t.index),e&&e(null,t.size)}async _loadParallel(t,e){let i=[];const s=this.shader.samplers.map((async e=>{try{const i=this.rasters[e.id];t.url=this.layout.getTileURL(e.id,t);const[s,n]=await i.loadImage(t,this.gl);return"image"===this.layout.type&&(this.layout.width=i.width,this.layout.height=i.height,this.layout.emit("updateSize")),t.size+=n,t.tex[e.id]=s,t.missing--,t.missing<=0&&(this.emit("update"),0===this.requested.size&&this.emit("loaded")),{success:!0,size:n}}catch(t){return i.push(t),{success:!1,error:t}}}));await Promise.allSettled(s),this.requested.delete(t.index),i.length>0?e(i[0]):e(null,t.size)}getPixelSize(t){let e=3;const i=this.rasters[t];if(i&&i.format)switch(i.format){case"vec4":e=4;break;case"vec3":e=3;break;case"float":e=1}return e}getPixelValues(t,e){if(!this.shader)throw new Error("WebGL resources not initialized");if(!this.gl)return console.log("Not a GL Layer"),null;if(t=Math.floor(t),e=Math.floor(e),t<0||t>=this.width||e<0||e>=this.height)return console.warn(`Coordinates (${t}, ${e}) outside image bounds (${this.width}x${this.height})`),[];const i=Array(this.rasters.length).fill(null);try{const s=this.gl.createFramebuffer();if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,s),"image"===this.layout.type||"itarzoom"===this.layout.type){const s=this.tiles.get(0);if(s&&0===s.missing)for(let n=0;n<this.rasters.length;n++)if(n<s.tex.length&&s.tex[n]&&(this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,s.tex[n],0),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)===this.gl.FRAMEBUFFER_COMPLETE)){const s=new Uint8Array(4);this.gl.readPixels(t,e,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s),i[n]=s}}else{let s=!1;for(let n=this.layout.nlevels-1;n>=0;n--){const r=this.layout.getTileSize(),o=Math.pow(2,this.layout.nlevels-1-n),a=r[0]*o,l=r[1]*o,h=Math.floor(t/a),c=Math.floor(e/l),d=this.layout.index(n,h,c);if(this.tiles.has(d)){const n=this.tiles.get(d);if(0===n.missing){const o=t-h*a,d=e-c*l,u=n.w||r[0],p=n.h||r[1],m=Math.min(Math.floor(o*u/a),u-1),f=Math.min(Math.floor(d*p/l),p-1);let g=!1;for(let t=0;t<this.rasters.length;t++)if(null===i[t]&&t<n.tex.length&&n.tex[t]&&(this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,n.tex[t],0),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)===this.gl.FRAMEBUFFER_COMPLETE)){const e=new Uint8Array(4);this.gl.readPixels(m,f,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),i[t]=e,g=!0}if(g&&(s=!0,i.every((t=>null!==t))))break}}}s||console.warn(`No suitable tile found for coordinates (${t}, ${e})`)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.deleteFramebuffer(s);for(let t=0;t<i.length;t++)null===i[t]&&(i[t]=new Uint8Array([0,0,0,255]))}catch(t){console.error("Error reading pixel data:",t)}return i}}c.prototype.types={},n(c,"ready","update","loaded","updateSize"),window.structuredClone="function"==typeof structuredClone?structuredClone:function(t){return JSON.parse(JSON.stringify(t))};class d{constructor(t,e,i,s){Object.assign(this,{canvasElement:null,preserveDrawingBuffer:!1,gl:null,overlayElement:null,camera:i,layers:{},ready:!1,targetfps:30,fps:0,timing:[16],timingLength:5,overBudget:0,srgb:!0,isSrgbSimplified:!0,stencil:!1,useOffscreenFramebuffer:!0,offscreenFramebuffer:null,offscreenTexture:null,offscreenRenderbuffer:null,_renderingToOffscreen:!1,signals:{update:[],updateSize:[],ready:[]},splitViewport:!1,leftLayers:[],rightLayers:[]}),Object.assign(this,s),this.init(t,e);for(let t in this.layers)this.addLayer(t,new c(this.layers[t]));this.camera.addEvent("update",(()=>this.emit("update")))}addRenderTiming(t){for(this.timing.push(t);this.timing.length>this.timingLength;)this.timing.shift();this.overBudget=this.timing.filter((t=>t>1e3/this.targetfps)).length/this.timingLength,this.fps=1e3/(this.timing.reduce(((t,e)=>t+e),0)/this.timing.length)}init(t,e){if(!t)throw"Missing element parameter";if("string"==typeof t&&!(t=document.querySelector(t)))throw"Could not find dom element.";if(!e)throw"Missing element parameter";if("string"==typeof e&&!(e=document.querySelector(e)))throw"Could not find dom element.";if(!t.tagName)throw"Element is not a DOM element";if("CANVAS"!=t.tagName)throw"Element is not a canvas element";this.canvasElement=t,this.overlayElement=e;const i={antialias:!1,depth:!1,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,colorSpace:this.srgb?"srgb":"display-p3"};if(this.gl=this.gl||t.getContext("webgl2",i),!this.gl)throw new Error("Could not create a WebGL 2.0 context");this.useOffscreenFramebuffer&&this.setupOffscreenFramebuffer(),t.addEventListener("webglcontextlost",(t=>{console.log("Context lost."),t.preventDefault()}),!1),t.addEventListener("webglcontextrestored",(()=>{this.restoreWebGL()}),!1),document.addEventListener("visibilitychange",(t=>{this.gl.isContextLost()&&this.restoreWebGL()})),this.hasFloatRender=!!this.gl.getExtension("EXT_color_buffer_float"),this.hasLinearFloat=!!this.gl.getExtension("OES_texture_float_linear"),console.log("Support for rendering to float textures:",this.hasFloatRender),console.log("Support for linear filtering on float textures:",this.hasLinearFloat)}setupOffscreenFramebuffer(){const t=this.gl;this.offscreenFramebuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.offscreenFramebuffer),this.offscreenTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.offscreenTexture);const e=this.canvasElement.width,i=this.canvasElement.height;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.stencil&&(this.offscreenRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.offscreenRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e,i),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,this.offscreenRenderbuffer)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.offscreenTexture,0);const s=t.checkFramebufferStatus(t.FRAMEBUFFER);s!==t.FRAMEBUFFER_COMPLETE&&(console.error("Framebuffer not complete. Status:",s),this.useOffscreenFramebuffer=!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),this.stencil&&t.bindRenderbuffer(t.RENDERBUFFER,null)}resizeOffscreenFramebuffer(){if(!this.useOffscreenFramebuffer||!this.offscreenFramebuffer)return;const t=this.gl,e=this.canvasElement.width,i=this.canvasElement.height;t.bindTexture(t.TEXTURE_2D,this.offscreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),this.stencil&&this.offscreenRenderbuffer&&(t.bindRenderbuffer(t.RENDERBUFFER,this.offscreenRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e,i)),t.bindTexture(t.TEXTURE_2D,null),this.stencil&&t.bindRenderbuffer(t.RENDERBUFFER,null)}getActiveFramebuffer(){return this.useOffscreenFramebuffer&&this._renderingToOffscreen?this.offscreenFramebuffer:null}setActiveFramebuffer(t){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this._renderingToOffscreen=t===this.offscreenFramebuffer}setState(t,e,i="linear"){if("camera"in t){const s=t.camera;this.camera.setPosition(e,s.x,s.y,s.z,s.a,i)}if("layers"in t)for(const[s,n]of Object.entries(t.layers))if(s in this.layers){this.layers[s].setState(n,e,i)}}getState(t=null){let e={};if(!t||t.camera){let t=performance.now(),i=this.camera.getCurrentTransform(t);e.camera={x:i.x,y:i.y,z:i.z,a:i.a}}e.layers={};for(let i of Object.values(this.layers)){const s=window.structuredClone(t);t&&t.layers&&Object.assign(s,t.layers[i.id]),e.layers[i.id]=i.getState(s)}return e}restoreWebGL(){let t={antialias:!1,depth:!1,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,colorSpace:this.srgb?"srgb":"display-p3"};this.gl=this.gl||this.canvasElement.getContext("webgl2",t),this.useOffscreenFramebuffer&&(this.offscreenFramebuffer&&this.gl.deleteFramebuffer(this.offscreenFramebuffer),this.offscreenTexture&&this.gl.deleteTexture(this.offscreenTexture),this.offscreenRenderbuffer&&this.gl.deleteRenderbuffer(this.offscreenRenderbuffer),this.setupOffscreenFramebuffer());for(let t of Object.values(this.layers))t.gl=this.gl,t.clear(),t.shader&&t.shader.restoreWebGL(this.gl);this.prefetch(),this.emit("update")}addLayer(t,e){console.assert(!(t in this.layers),"Duplicated layer id"),e.id=t,e.addEvent("ready",(()=>{Object.values(this.layers).every((t=>"ready"==t.status))&&(this.ready=!0,this.emit("ready")),this.prefetch()})),e.addEvent("update",(()=>{this.emit("update")})),e.addEvent("updateSize",(()=>{this.updateSize()})),e.gl=this.gl,e.canvas=this,e.overlayElement=this.overlayElement,e.isSrgbSimplified=this.isSrgbSimplified,this.layers[t]=e,this.prefetch()}removeLayer(t){t.clear(),delete this.layers[t.id],delete h.layers[t],this.prefetch()}updateSize(){const t=!1;let e=c.computeLayersBBox(this.layers,t),i=c.computeLayersMinScale(this.layers,t);e&&this.camera.viewport&&!e.isEmpty()&&this.camera.updateBounds(e,i),this.useOffscreenFramebuffer&&this.resizeOffscreenFramebuffer(),this.emit("updateSize")}setSplitViewport(t,e=[],i=[]){this.splitViewport=t,this.leftLayers=e,this.rightLayers=i,this.emit("update")}draw(t){let e=this.gl,i=this.camera.glViewport();this.useOffscreenFramebuffer?(e.bindFramebuffer(e.FRAMEBUFFER,this.offscreenFramebuffer),this._renderingToOffscreen=!0):this._renderingToOffscreen=!1,e.viewport(i.x,i.y,i.dx,i.dy);var s=[0,0,0,0];e.clearColor(s[0],s[1],s[2],s[3],s[4]),e.clear(e.COLOR_BUFFER_BIT),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND);let n=this.camera.getGlCurrentTransform(t);this.prefetch(n);let r=Object.values(this.layers).sort(((t,e)=>t.zindex-e.zindex)),o=!0;if(this.splitViewport){e.enable(e.SCISSOR_TEST);const t=Math.floor(i.dx/2);e.scissor(i.x,i.y,t,i.dy);for(let t of r)this.leftLayers.includes(t.id)&&(o=t.draw(n,i)&&o);e.scissor(i.x+t,i.y,i.dx-t,i.dy);for(let t of r)this.rightLayers.includes(t.id)&&(o=t.draw(n,i)&&o);e.disable(e.SCISSOR_TEST)}else for(let t of r)t.visible&&(o=t.draw(n,i)&&o);return this.useOffscreenFramebuffer&&(e.bindFramebuffer(e.FRAMEBUFFER,null),this._renderingToOffscreen=!1,this.drawOffscreenToCanvas()),o&&n.isComplete}drawOffscreenToCanvas(){const t=this.gl,e=this.camera.glViewport();if(t.viewport(e.x,e.y,e.dx,e.dy),!this._fullscreenQuadProgram){const e="#version 300 es\n\t\t\t\tin vec4 aPosition;\n\t\t\t\tin vec2 aTexCoord;\n\t\t\t\tout vec2 vTexCoord;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_Position = aPosition;\n\t\t\t\t\tvTexCoord = aTexCoord;\n\t\t\t\t}\n\t\t\t";let i="#version 300 es\n\t\t\tprecision highp float;\n\t\t\tin vec2 vTexCoord;\n\t\t\tuniform sampler2D uTexture;\n\t\t\tout vec4 fragColor;";this.isSrgbSimplified?i+="\n\t\t\tvec4 linear2srgb(vec4 linear) {\n\t\t\t\treturn vec4(pow(linear.rgb, vec3(1.0/2.2)), linear.a);\n\t\t\t}":i+="\n\t\t\tvec4 linear2srgb(vec4 linear) {\n\t\t\t\tbvec3 cutoff = lessThan(linear.rgb, vec3(0.0031308));\n\t\t\t\tvec3 higher = vec3(1.055) * pow(linear.rgb, vec3(1.0/2.4)) - vec3(0.055);\n\t\t\t\tvec3 lower = linear.rgb * vec3(12.92);\n\t\t\t\treturn vec4(mix(higher, lower, cutoff), linear.a);\n\t\t\t}",i+="\n\t\tvoid main() {\n\t\t\tfragColor = texture(uTexture, vTexCoord);\n\t\t\tfragColor = linear2srgb(fragColor);\n\t\t\tfragColor = clamp(fragColor, 0.0, 1.0);\n\t\t}";const s=this._createShader(t,t.VERTEX_SHADER,e),n=this._createShader(t,t.FRAGMENT_SHADER,i);this._fullscreenQuadProgram=this._createProgram(t,s,n),this._positionLocation=t.getAttribLocation(this._fullscreenQuadProgram,"aPosition"),this._texCoordLocation=t.getAttribLocation(this._fullscreenQuadProgram,"aTexCoord"),this._textureLocation=t.getUniformLocation(this._fullscreenQuadProgram,"uTexture"),this._quadPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._quadPositionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),t.STATIC_DRAW),this._quadTexCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._quadTexCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),t.STATIC_DRAW),this._quadVAO=t.createVertexArray(),t.bindVertexArray(this._quadVAO),t.bindBuffer(t.ARRAY_BUFFER,this._quadPositionBuffer),t.enableVertexAttribArray(this._positionLocation),t.vertexAttribPointer(this._positionLocation,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._quadTexCoordBuffer),t.enableVertexAttribArray(this._texCoordLocation),t.vertexAttribPointer(this._texCoordLocation,2,t.FLOAT,!1,0,0),t.bindVertexArray(null)}t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(this._fullscreenQuadProgram),t.bindVertexArray(this._quadVAO),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.offscreenTexture),t.uniform1i(this._textureLocation,0),t.drawArrays(t.TRIANGLE_STRIP,0,4),t.bindVertexArray(null),t.bindTexture(t.TEXTURE_2D,null)}_createShader(t,e,i){const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(console.error("Shader compilation error:",t.getShaderInfoLog(s)),t.deleteShader(s),null)}_createProgram(t,e,i){const s=t.createProgram();return t.attachShader(s,e),t.attachShader(s,i),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error("Program linking error:",t.getProgramInfoLog(s)),t.deleteProgram(s),null)}prefetch(t){t||(t=this.camera.getGlCurrentTransform(performance.now()));for(let e in this.layers){let i=this.layers[e];i.visible&&"ready"==i.status&&i.prefetch(t,this.camera.glViewport())}}dispose(){const t=this.gl;this.useOffscreenFramebuffer&&(this.offscreenFramebuffer&&(t.deleteFramebuffer(this.offscreenFramebuffer),this.offscreenFramebuffer=null),this.offscreenTexture&&(t.deleteTexture(this.offscreenTexture),this.offscreenTexture=null),this.offscreenRenderbuffer&&(t.deleteRenderbuffer(this.offscreenRenderbuffer),this.offscreenRenderbuffer=null)),this._fullscreenQuadProgram&&(t.deleteProgram(this._fullscreenQuadProgram),this._fullscreenQuadProgram=null),this._quadVAO&&(t.deleteVertexArray(this._quadVAO),this._quadVAO=null),this._quadPositionBuffer&&(t.deleteBuffer(this._quadPositionBuffer),this._quadPositionBuffer=null),this._quadTexCoordBuffer&&(t.deleteBuffer(this._quadTexCoordBuffer),this._quadTexCoordBuffer=null);for(const t in this.layers)this.removeLayer(this.layers[t])}}n(d,"update","updateSize","ready");class p{constructor(t){Object.assign(this,{viewport:null,bounded:!0,minScreenFraction:1,maxFixedZoom:2,maxZoom:2,minZoom:1,boundingBox:new i}),Object.assign(this,t),this.target=new s(this.target),this.source=this.target.copy(),this.easing="linear"}copy(){let t=new p;return Object.assign(t,this),t}setViewport(t){if(this.viewport){let e=Math.sqrt(t.w/this.viewport.w*(t.h/this.viewport.h));this.viewport=t;const{x:i,y:s,z:n,a:r}=this.target;this.setPosition(0,i,s,n*e,r)}else this.viewport=t}glViewport(){let t=window.devicePixelRatio,e={};for(let i in this.viewport)e[i]=this.viewport[i]*t;return e}setPosition(t,e,i,n,r,o){if(this.easing=o||this.easing,this.bounded){const t=this.viewport.dx,o=this.viewport.dy;let a=new s({x:e,y:i,z:n,a:r,t:0}).transformBox(this.boundingBox);const l=a.width(),h=a.height(),c=Math.abs(l-t)/2;e=Math.min(Math.max(-c,e),c);const d=Math.abs(h-o)/2;i=Math.min(Math.max(-d,i),d)}let a=performance.now();this.source=this.getCurrentTransform(a),r=s.normalizeAngle(r),this.source.a=s.normalizeAngle(this.source.a),r-this.source.a>180&&(this.source.a+=360),this.source.a-r>180&&(this.source.a-=360),Object.assign(this.target,{x:e,y:i,z:n,a:r,t:a+t}),console.assert(!isNaN(this.target.x)),this.emit("update")}pan(t,e,i){let s=performance.now(),n=this.getCurrentTransform(s);n.x+=e,n.y+=i,this.setPosition(t,n.x,n.y,n.z,n.a)}zoom(t,e,i,s){i||(i=0),s||(s=0);let n=performance.now(),r=this.getCurrentTransform(n);this.bounded&&(e=Math.min(Math.max(e,this.minZoom),this.maxZoom)),r.x+=(r.x+i)*(r.z-e)/r.z,r.y+=(r.y+s)*(r.z-e)/r.z,this.setPosition(t,r.x,r.y,e,r.a)}rotate(t,e){let i=performance.now(),s=this.getCurrentTransform(i);this.setPosition(t,s.x,s.y,s.z,this.target.a+e)}deltaZoom(t,e,i=0,n=0){let r=performance.now(),o=this.getCurrentTransform(r);e*=this.target.z/o.z,this.bounded&&(o.z*e<this.minZoom&&(e=this.minZoom/o.z),o.z*e>this.maxZoom&&(e=this.maxZoom/o.z));let a=s.rotate(i,n,o.a);o.x+=a.x*o.z*(1-e),o.y+=a.y*o.z*(1-e),this.setPosition(t,o.x,o.y,o.z*e,o.a)}getCurrentTransform(t){return t>this.target.t&&(this.easing="linear"),s.interpolate(this.source,this.target,t,this.easing)}hasReachedTarget(t){return t||(t=this.getCurrentTransform(performance.now())),t.isComplete}getGlCurrentTransform(t){const e=this.getCurrentTransform(t);return e.x*=window.devicePixelRatio,e.y*=window.devicePixelRatio,e.z*=window.devicePixelRatio,e}fit(t,e){if(t.isEmpty())return;e||(e=0);let i=this.viewport.dx,s=this.viewport.dy,n=t.width(),r=t.height(),o=t.center(),a=Math.min(i/n,s/r);this.setPosition(e,-o.x*a,-o.y*a,a,0)}fitCameraBox(t){this.fit(this.boundingBox,t)}updateBounds(t,e){this.boundingBox=t;const i=this.viewport.dx,s=this.viewport.dy;let n=this.boundingBox.width(),r=this.boundingBox.height();this.minZoom=Math.min(i/n,s/r)*this.minScreenFraction,this.maxZoom=e>0?this.maxFixedZoom/e:this.maxFixedZoom,this.maxZoom=Math.max(this.minZoom,this.maxZoom)}}n(p,"update");class m{constructor(t,e){this.xs=t,this.ys=e,this.ks=this.getNaturalKs(new Float64Array(this.xs.length))}getNaturalKs(t){const e=this.xs.length-1,i=m.zerosMat(e+1,e+2);for(let t=1;t<e;t++)i[t][t-1]=1/(this.xs[t]-this.xs[t-1]),i[t][t]=2*(1/(this.xs[t]-this.xs[t-1])+1/(this.xs[t+1]-this.xs[t])),i[t][t+1]=1/(this.xs[t+1]-this.xs[t]),i[t][e+1]=3*((this.ys[t]-this.ys[t-1])/((this.xs[t]-this.xs[t-1])*(this.xs[t]-this.xs[t-1]))+(this.ys[t+1]-this.ys[t])/((this.xs[t+1]-this.xs[t])*(this.xs[t+1]-this.xs[t])));return i[0][0]=2/(this.xs[1]-this.xs[0]),i[0][1]=1/(this.xs[1]-this.xs[0]),i[0][e+1]=3*(this.ys[1]-this.ys[0])/((this.xs[1]-this.xs[0])*(this.xs[1]-this.xs[0])),i[e][e-1]=1/(this.xs[e]-this.xs[e-1]),i[e][e]=2/(this.xs[e]-this.xs[e-1]),i[e][e+1]=3*(this.ys[e]-this.ys[e-1])/((this.xs[e]-this.xs[e-1])*(this.xs[e]-this.xs[e-1])),m.solve(i,t)}getIndexBefore(t){let e=0,i=this.xs.length,s=0;for(;e<i;)s=Math.floor((e+i)/2),this.xs[s]<t&&s!==e?e=s:i=this.xs[s]>=t&&s!==i?s:e;return e===this.xs.length-1?this.xs.length-1:e+1}at(t){let e=this.getIndexBefore(t);const i=(t-this.xs[e-1])/(this.xs[e]-this.xs[e-1]),s=this.ks[e-1]*(this.xs[e]-this.xs[e-1])-(this.ys[e]-this.ys[e-1]),n=-this.ks[e]*(this.xs[e]-this.xs[e-1])+(this.ys[e]-this.ys[e-1]);return(1-i)*this.ys[e-1]+i*this.ys[e]+i*(1-i)*(s*(1-i)+n*i)}static solve(t,e){const i=t.length;let s=0,n=0;for(;s<i&&n<=i;){let e=0,r=-1/0;for(let o=s;o<i;o++){const i=Math.abs(t[o][n]);i>r&&(e=o,r=i)}if(0===t[e][n])n++;else{m.swapRows(t,s,e);for(let e=s+1;e<i;e++){const r=t[e][n]/t[s][n];t[e][n]=0;for(let o=n+1;o<=i;o++)t[e][o]-=t[s][o]*r}s++,n++}}for(let s=i-1;s>=0;s--){var r=0;t[s][s]&&(r=t[s][i]/t[s][s]),e[s]=r;for(let e=s-1;e>=0;e--)t[e][i]-=t[e][s]*r,t[e][s]=0}return e}static zerosMat(t,e){const i=[];for(let s=0;s<t;s++)i.push(new Float64Array(e));return i}static swapRows(t,e,i){let s=t[e];t[e]=t[i],t[i]=s}}class f{constructor(t,e=void 0,i=void 0,s=void 0){if("string"==typeof t)if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){let n=t.substring(1).split("");3==n.length&&(n=[n[0],n[0],n[1],n[1],n[2],n[2]]),n="0x"+n.join("")+"FF",t=f.normalizedRGBA(n>>24),e=f.normalizedRGBA(n>>16),i=f.normalizedRGBA(n>>8),s=f.normalizedRGBA(n)}else if(/^#([A-Fa-f0-9]{4}){1,2}$/.test(t)){let n=t.substring(1).split("");n="0x"+n.join(""),t=f.normalizedRGBA(n>>24),e=f.normalizedRGBA(n>>16),i=f.normalizedRGBA(n>>8),s=f.normalizedRGBA(n)}else if(/^rgb\(/.test(t)){let n=t.split("(")[1].split(")")[0];n=n.split(","),t=f.clamp(n[0]/255),e=f.clamp(n[1]/255),i=f.clamp(n[2]/255),s=1}else{if(!/^rgba\(/.test(t))throw Error("Value is not a color");{let n=t.split("(")[1].split(")")[0];n=n.split(","),t=f.clamp(n[0]/255),e=f.clamp(n[1]/255),i=f.clamp(n[2]/255),s=f.clamp(n[3]/255)}}this.r=t,this.g=e,this.b=i,this.a=s}static clamp=(t,e=0,i=1)=>Math.min(Math.max(t,e),i);static hex(t){var e=t.toString(16).toUpperCase();return 1==e.length?"0"+e:e}static normalizedRGBA(t){return f.clamp((255&t)/255)}static rgbToHex(t,e,i){return"#"+(16777216|(i|e<<8|t<<16)).toString(16).substring(1).toUpperCase()}static rgbToHexa(t,e,i,s){return"#"+f.hex(t)+f.hex(e)+f.hex(i)+f.hex(s)}value(){return[this.r,this.g,this.b,this.a]}toRGB(){const t=[255*this.r,255*this.g,255*this.b];return t.forEach(((t,e,i)=>{i[e]=f.clamp(Math.round(t),0,255)})),t}toHex(){const t=this.toRGB();return f.rgbToHex(t[0],t[1],t[2])}toHexa(){const t=this.toRGBA();return f.rgbToHexa(t[0],t[1],t[2],t[3])}toRGBA(){const t=[255*this.r,255*this.g,255*this.b,255*this.a];return t.forEach(((t,e,i)=>{i[e]=f.clamp(Math.round(t),0,255)})),t}}class g{constructor(t){Object.assign(this,{format:"vec3"}),this._texture=null,Object.assign(this,t)}async loadImage(t,e){let i,s=new URL(t.url,window.location.href).origin!==window.location.origin;if(t.end||"undefined"==typeof createImageBitmap){let n={};n.headers={range:`bytes=${t.start}-${t.end}`,"Accept-Encoding":"indentity",mode:s?"cors":"same-origin"};let r=await fetch(t.url,n);if(!r.ok)return void console.error(`Failed to load ${t.url}: ${r.status} ${r.statusText}`);if(206!=r.status)throw new Error("The server doesn't support partial content requests (206).");let o=await r.blob();i=await this.blobToImage(o,e)}else i=document.createElement("img"),s&&(i.crossOrigin=""),i.onerror=function(t){console.log("Texture loading error!")},i.src=t.url,await new Promise(((t,e)=>{i.onload=()=>{t()}}));const n=this.loadTexture(e,i);const r=i.width*i.height*3;return this.emit("loaded"),[n,r]}async blobToImage(t,e){let i;if("undefined"!=typeof createImageBitmap){var s="undefined"!=typeof InstallTrigger;i=s?await createImageBitmap(t):await createImageBitmap(t,{imageOrientation1:"flipY"})}else{let e=window.URL||window.webkitURL;i=document.createElement("img"),i.onerror=function(t){console.log("Texture loading error!")},i.src=e.createObjectURL(t),await new Promise(((t,e)=>{i.onload=()=>t()})),e.revokeObjectURL(i.src)}return i}loadTexture(t,e){this.width=e.width,this.height=e.height;var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);let s=t.RGBA,n=t.RGBA;switch(this.format){case"vec3":s=t.RGB;break;case"vec4":s=t.RGBA;break;case"float":s=t instanceof WebGL2RenderingContext?t.RED:t.LUMINANCE}return n="float"===this.format?t.R8:s===t.RGB?t.RGB:t.RGBA,t.texImage2D(t.TEXTURE_2D,0,n,s,t.UNSIGNED_BYTE,e),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.width>1024||this.height>1024?(t.generateMipmap(t.TEXTURE_2D),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)):t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this._texture=i,i}}n(g,"loaded");class v{constructor(t){t=Object.assign({isLinear:!1,isSrgbSimplified:!0},t),Object.assign(this,{debug:!1,samplers:[],uniforms:{},label:null,program:null,modes:[],mode:null,needsUpdate:!0,autoSamplerDeclaration:!0,tileSize:[0,0]}),n(v,"update"),Object.assign(this,t),this.filters=[]}clearFilters(){this.filters=[],this.needsUpdate=!0,this.emit("update")}addFilter(t){t.shader=this,this.filters.push(t),this.needsUpdate=!0,t.needsUpdate=!0,this.emit("update")}removeFilter(t){this.filters=this.filters.filter((e=>e.name!=t)),this.needsUpdate=!0,this.emit("update")}setMode(t){if(-1==this.modes.indexOf(t))throw Error("Unknown mode: "+t);this.mode=t,this.needsUpdate=!0}restoreWebGL(t){this.createProgram(t)}setTileSize(t){this.tileSize=t,this.needsUpdate=!0}setUniform(t,e){let i=this.getUniform(t);if(!i)throw new Error(`Unknown '${t}'. It is not a registered uniform.`);if("number"!=typeof e&&"boolean"!=typeof e||i.value!=e){if(Array.isArray(e)&&Array.isArray(i.value)&&e.length==i.value.length){let t=!0;for(let s=0;s<e.length;s++)if(e[s]!=i.value[s]){t=!1;break}if(t)return}i.value=e,i.needsUpdate=!0,this.emit("update")}}completeFragShaderSrc(t){let e="#version 300 es\n";if(e+="precision highp float;\n",e+="precision highp int;\n",e+=`const vec2 tileSize = vec2(${this.tileSize[0]}.0, ${this.tileSize[1]}.0);\n`,this.isSrgbSimplified?e+="\n// Simplified sRGB to linear conversion using gamma 2.2\n// Convert from sRGB to linear RGB\nvec3 srgb2linear(vec3 srgb) {\n    return pow(srgb, vec3(2.2));\n}\n\n// Convert from sRGB to linear RGB (vec4 version - preserves alpha)\nvec4 srgb2linear(vec4 srgb) {\n    return vec4(srgb2linear(srgb.rgb), srgb.a);\n}\n\n// Convert a single sRGB channel to linear\nfloat srgb2linear(float c) {\n    return pow(c, 2.2);\n}\n\n// Simplified linear to sRGB conversion using gamma 1/2.2\n// Convert from linear RGB to sRGB\nvec3 linear2srgb(vec3 linear) {\n    return pow(linear, vec3(1.0/2.2));\n}\n\n// Convert from linear RGB to sRGB (vec4 version - preserves alpha)\nvec4 linear2srgb(vec4 linear) {\n    return vec4(linear2srgb(linear.rgb), linear.a);\n}\n\n// Convert a single linear channel to sRGB\nfloat linear2srgb(float c) {\n    return pow(c, 1.0/2.2);\n}\n":e+="\n// IEC 61966-2-1 specification\t\t\n// Convert from sRGB to linear RGB\nvec3 srgb2linear(vec3 srgb) {\n    bvec3 cutoff = lessThan(srgb, vec3(0.04045));\n    vec3 higher = pow((srgb + vec3(0.055))/vec3(1.055), vec3(2.4));\n    vec3 lower = srgb/vec3(12.92);\n    \n    return mix(higher, lower, cutoff);\n}\n\n// Convert from sRGB to linear RGB (vec4 version - preserves alpha)\nvec4 srgb2linear(vec4 srgb) {\n    return vec4(srgb2linear(srgb.rgb), srgb.a);\n}\n\n// Convert a single sRGB channel to linear\nfloat srgb2linear(float c) {\n    return c <= 0.04045 ? c/12.92 : pow((c + 0.055)/1.055, 2.4);\n}\n\n// IEC 61966-2-1 specification\n// Convert from linear RGB to sRGB\nvec3 linear2srgb(vec3 linear) {\n    bvec3 cutoff = lessThan(linear, vec3(0.0031308));\n    vec3 higher = vec3(1.055) * pow(linear, vec3(1.0/2.4)) - vec3(0.055);\n    vec3 lower = linear * vec3(12.92);\n    \n    return mix(higher, lower, cutoff);\n}\n\n// Convert from linear RGB to sRGB (vec4 version - preserves alpha)\nvec4 linear2srgb(vec4 linear) {\n    return vec4(linear2srgb(linear.rgb), linear.a);\n}\n\n// Convert a single linear channel to sRGB\nfloat linear2srgb(float c) {\n    return c <= 0.0031308 ? c * 12.92 : 1.055 * pow(c, 1.0/2.4) - 0.055;\n}\n",this.autoSamplerDeclaration){for(let t of this.samplers)e+=`uniform sampler2D ${t.name};\n`;for(let t of this.samplers)e+=`uniform bool ${t.name}_isLinear;\n`}e+=this.fragShaderSrc()+"\n";for(let t of this.filters)e+=`\t\t// Filter: ${t.name}\n`,e+=t.fragModeSrc()+"\n",e+=t.fragSamplerSrc()+"\n",e+=t.fragUniformSrc()+"\n",e+=t.fragDataSrc()+"\n\n";e+="\n\tout vec4 color;\n\tvoid main() { \n\t\tcolor = data();\n\t\t";for(let t of this.filters)e+=`color=${t.functionName()}(color);\n`;return e+="}",e}createProgram(t){let i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,this.vertShaderSrc(t)),t.compileShader(i);let s=t.getShaderParameter(i,t.COMPILE_STATUS);if(!s)throw e.printSrcCode(this.vertShaderSrc(t)),console.log(t.getShaderInfoLog(i)),Error("Failed vertex shader compilation: see console log and ask for support.");this.debug&&(console.log("here"),e.printSrcCode(this.vertShaderSrc(t)));let n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,this.completeFragShaderSrc(t)),t.compileShader(n),this.program&&t.deleteProgram(this.program);let r=t.createProgram();if(t.getShaderParameter(n,t.COMPILE_STATUS),s=t.getShaderParameter(n,t.COMPILE_STATUS),!s)throw e.printSrcCode(this.completeFragShaderSrc(t)),console.log(t.getShaderInfoLog(n)),Error("Failed fragment shader compilation: see console log and ask for support.");if(this.debug&&e.printSrcCode(this.completeFragShaderSrc(t)),t.attachShader(r,i),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS)){var o=t.getProgramInfoLog(r);throw new Error("Could not compile WebGL program. \n\n"+o)}for(let e of this.samplers)e.location=t.getUniformLocation(r,e.name);for(let e of this.filters)for(let i of e.samplers)i.location=t.getUniformLocation(r,i.name);this.coordattrib=t.getAttribLocation(r,"a_position"),t.vertexAttribPointer(this.coordattrib,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.coordattrib),this.texattrib=t.getAttribLocation(r,"a_texcoord"),t.vertexAttribPointer(this.texattrib,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.texattrib),this.matrixlocation=t.getUniformLocation(r,"u_matrix"),this.program=r,this.needsUpdate=!1;for(let t of Object.values(this.allUniforms()))t.location=null,t.needsUpdate=!0;for(let e of this.filters)e.prepare(t)}getUniform(t){let e=this.uniforms[t];if(e)return e;for(let i of this.filters)if(e=i.uniforms[t],e)return e;return e}allUniforms(){const t=this.uniforms;for(let e of this.filters)Object.assign(t,e.uniforms);return t}updateUniforms(t){for(const[e,i]of Object.entries(this.allUniforms()))if(i.location||(i.location=t.getUniformLocation(this.program,e)),i.location&&i.needsUpdate){let e=i.value;switch(i.type){case"vec4":t.uniform4fv(i.location,e);break;case"vec3":t.uniform3fv(i.location,e);break;case"vec2":t.uniform2fv(i.location,e);break;case"float":t.uniform1f(i.location,e);break;case"int":case"bool":t.uniform1i(i.location,e);break;case"mat3":t.uniformMatrix3fv(i.location,!1,e);break;case"mat4":t.uniformMatrix4fv(i.location,!1,e);break;default:throw Error("Unknown uniform type: "+u.type)}i.needsUpdate=!1}}vertShaderSrc(t){return"#version 300 es\n\nprecision highp float; \nprecision highp int; \n\nuniform mat4 u_matrix;\nin vec4 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_matrix * a_position;\n\t\t\t\tv_texcoord = a_texcoord;\n\t\t\t} "}fragShaderSrc(){return`\n\nin vec2 v_texcoord;\n\nvec4 data() {\n\tvec4 color = texture(source, v_texcoord);\n\t${this.isLinear?"":"color = srgb2linear(color);"}\n\treturn color;\n}\n`}}class y extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(this.url)this.layout.setUrls([this.url]);else if(0==this.layout.urls.length)throw"Missing options.url parameter";const e=null!=this.format?this.format:"vec4";let i=new g({format:e});this.rasters.push(i);let s=new v({label:"Rgb",samplers:[{id:0,name:"source",type:e}]});this.shaders={standard:s},this.setShader("standard")}}c.prototype.types.image=t=>new y(t);class x extends c{constructor(t){if(super(t=Object.assign({isLinear:!0},t)),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";this.textures=[],this.framebuffers=[],this.status="ready"}deleteFramebuffers(){if(this.gl){for(let t=0;t<this.textures.length;t++)this.textures[t]&&this.gl.deleteTexture(this.textures[t]);for(let t=0;t<this.framebuffers.length;t++)this.framebuffers[t]&&this.gl.deleteFramebuffer(this.framebuffers[t]);this.textures=[],this.framebuffers=[]}}draw(t,e){for(let t of this.layers)if("ready"!=t.status)return;if(!this.shader)throw"Shader not specified!";let i=e.dx,s=e.dy;this.framebuffers.length&&this.layout.width==i&&this.layout.height==s||(this.deleteFramebuffers(),this.layout.width=i,this.layout.height=s,this.createFramebuffers());let n=this.gl;var r=[0,0,0,0];n.clearColor(r[0],r[1],r[2],r[3]);const o=this.canvas.getActiveFramebuffer();for(let e=0;e<this.layers.length;e++)n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffers[e]),n.clear(n.COLOR_BUFFER_BIT),this.layers[e].draw(t,{x:0,y:0,dx:i,dy:s,w:i,h:s});this.canvas.setActiveFramebuffer(o),this.prepareWebGL();for(let t=0;t<this.layers.length;t++)n.uniform1i(this.shader.samplers[t].location,t),n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,this.textures[t]);this.updateTileBuffers(new Float32Array([-1,-1,0,-1,1,0,1,1,0,1,-1,0]),new Float32Array([0,0,0,1,1,1,1,0])),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}createFramebuffers(){let t=this.gl;for(let e=0;e<this.layers.length;e++){const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);const s=0,n=t.RGBA,r=0,o=t.RGBA,a=t.UNSIGNED_BYTE;t.texImage2D(t.TEXTURE_2D,s,n,this.layout.width,this.layout.height,r,o,a,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const l=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,l),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);const h=t.checkFramebufferStatus(t.FRAMEBUFFER);h!==t.FRAMEBUFFER_COMPLETE&&console.error("LayerCombiner framebuffer not complete. Status:",h),t.bindFramebuffer(t.FRAMEBUFFER,null),this.textures[e]=i,this.framebuffers[e]=l}}boundingBox(){let t=c.computeLayersBBox(this.layers,!1);return t&&null!=this.transform&&null!=this.transform&&(t=this.transform.transformBox(t)),t}scale(){let t=c.computeLayersMinScale(this.layers,!1);return t*=this.transform.z,t}}c.prototype.types.combiner=t=>new x(t);class b{constructor(t={}){this.id=t.id??b.generateUUID(),this.code=t.code??null,this.label=t.label??"",this.description=t.description??null,this.class=t.class??null,this.target=t.target??null,this.svg=t.svg??null,this.image=t.image??null,this.region=t.region??null,this.data=t.data??{},this.style=t.style??null,this.bbox=t.bbox??null,this.visible=t.visible??!0,this.state=t.state??null,this.ready=t.ready??!1,this.needsUpdate=t.needsUpdate??!0,this.editing=t.editing??!1,this.elements=Array.isArray(t.elements)?t.elements:[]}static generateUUID(){return"a"+([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}getBBoxFromElements(){if(!this.elements.length){if(null==this.region)return new i;const t=this.region;return new i({xLow:t.x,yLow:t.y,xHigh:t.x+t.w,yHigh:t.y+t.h})}const t=this.elements[0].getBBox();let e=t.x,s=t.y,n=t.width,r=t.height;for(let t=1;t<this.elements.length;t++){const{x:i,y:o,width:a,height:l}=this.elements[t].getBBox();e=Math.min(e,i),s=Math.min(s,o);n=Math.max(e+n,i+a)-e,r=Math.max(s+r,o+l)-s}return new i({xLow:e,yLow:s,xHigh:e+n,yHigh:s+r})}static fromJsonLd(t){if("Annotation"!==t.type)throw new Error("Not a valid JSON-LD annotation");const e={id:t.id},i={identifying:"code",classifying:"class",describing:"description"};if(Array.isArray(t.body))for(const s of t.body){const t=i[s.purpose];t&&(e[t]=s.value)}const s=t.target?.selector;if(s){if("SvgSelector"!==s.type)throw new Error(`Unsupported selector: ${s.type}`);e.svg=s.value,e.elements=[]}return new b(e)}toJsonLd(){const t=[];null!==this.code&&t.push({type:"TextualBody",value:this.code,purpose:"identifying"}),null!==this.class&&t.push({type:"TextualBody",value:this.class,purpose:"classifying"}),null!==this.description&&t.push({type:"TextualBody",value:this.description,purpose:"describing"});const e={"@context":"http://www.w3.org/ns/anno.jsonld",id:this.id,type:"Annotation",body:t,target:{selector:{}}};if(this.target&&(e.target.selector.source=this.target),this.elements.length>0){const t=this.elements[0];if(t){const i=new XMLSerializer;e.target.selector.type="SvgSelector",e.target.selector.value=i.serializeToString(t)}}else this.svg&&(e.target.selector.type="SvgSelector",e.target.selector.value=this.svg);return e}}class w extends c{constructor(t){super(t=Object.assign({style:null,annotations:[],selected:new Set,overlay:!0,annotationsListEntry:null},t)),"string"==typeof this.annotations&&(async()=>{await this.loadAnnotations(this.annotations)})()}async loadAnnotations(t){const e=new Headers;e.append("pragma","no-cache"),e.append("cache-control","no-cache");var i=await fetch(t,{method:"GET",headers:e});if(i.ok)if(this.annotations=await i.json(),"error"!=this.annotations.status){this.annotations=this.annotations.map((t=>new b(t)));for(let t of this.annotations)1!=t.publish&&(t.visible=!1);this.annotationsListEntry&&this.createAnnotationsList(),this.emit("update"),this.status="ready",this.emit("ready"),this.emit("loaded")}else alert("Failed to load annotations: "+this.annotations.msg);else this.status="Failed loading "+this.url+": "+i.statusText}newAnnotation(t){t||(t=new b),this.annotations.push(t);let e=this.createAnnotationEntry(t),i=document.createElement("template");return i.innerHTML=e.trim(),this.annotationsListEntry.element.parentElement.querySelector(".openlime-list").appendChild(i.content.firstChild),this.clearSelected(),t}annotationsEntry(){return this.annotationsListEntry={html:"",list:[],classes:"openlime-annotations",status:()=>"active",oncreate:()=>{Array.isArray(this.annotations)&&this.createAnnotationsList()}}}createAnnotationsList(){let t="";for(let e of this.annotations)t+=this.createAnnotationEntry(e);let e=this.annotationsListEntry.element.parentElement.querySelector(".openlime-list");e.innerHTML=t,e.addEventListener("click",(t=>{let e=t.srcElement.closest("svg");if(e){let t=e.closest("[data-annotation]");t.classList.toggle("hidden");let i=t.getAttribute("data-annotation"),s=this.getAnnotationById(i);s.visible=!s.visible,s.needsUpdate=!0,this.emit("update")}let i=t.srcElement.getAttribute("data-annotation");if(i){this.clearSelected();let t=this.getAnnotationById(i);this.setSelected(t,!0)}}))}createAnnotationEntry(t){return`<a href="#" data-annotation="${t.id}" class="openlime-entry ${0==t.visible?"hidden":""}">${t.label||""}\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="openlime-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="openlime-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>\n\t\t\t</a>`}getAnnotationById(t){for(const e of this.annotations)if(e.id==t)return e;return null}clearSelected(){this.annotationsListEntry.element.parentElement.querySelectorAll("[data-annotation]").forEach((t=>t.classList.remove("selected"))),this.selected.clear()}setSelected(t,e=!0){this.annotationsListEntry.element.parentElement.querySelector(`[data-annotation="${t.id}"]`).classList.toggle("selected",e),e?this.selected.add(t.id):this.selected.delete(t.id),this.emit("selected",t)}}n(w,"selected","loaded");class E extends a{constructor(t,e,s){super(t,null,s),this.setDefaults(e),this.init(t,e,s),this.tileDescriptors=[],this.box=new i,null!=t&&this.loadDescriptors(t)}getTileSize(){return[0,0]}async loadDescriptors(t){let e=await fetch(t);if(e.ok)if(this.tileDescriptors=await e.json(),"error"!=this.tileDescriptors.status){this.tileDescriptors=this.tileDescriptors.map((t=>new b(t)));for(let t of this.tileDescriptors)1!=t.publish&&(t.visible=!1);this.computeBoundingBox(),this.emit("updateSize"),null==this.path&&this.setPathFromUrl(t),this.status="ready",this.emit("ready")}else alert("Failed to load annotations: "+this.tileDescriptors.msg);else this.status="Failed loading "+t+": "+e.statusText}computeBoundingBox(){this.box=new i;for(let t of this.tileDescriptors){let e=t.region,s=new i({xLow:e.x,yLow:e.y,xHigh:e.x+e.w,yHigh:e.y+e.h});this.box.mergeBox(s)}}boundingBox(){return this.box}setPathFromUrl(t){const e=t.split("/"),i=e.length;this.path="";for(let t=0;t<i-1;++t)this.path+=e[t]+"/";this.getTileURL=(t,e)=>this.path+"/"+this.tileDescriptors[e.index].image}setTileDescriptors(t){this.tileDescriptors=t,this.status="ready",this.emit("ready")}getTileURL(t,e){return this.path+"/"+this.tileDescriptors[t].image}setTileVisible(t,e){this.tileDescriptors[t].visible=e}setAllTilesVisible(t){const e=this.tileCount();for(let i=0;i<e;++i)this.tileDescriptors[i].visible=t}index(t,e,i){return e}tileCoords(t){const e=this.tileDescriptors[t.index].region,i=e.x,s=e.y,n=i+e.w,r=s+e.h;return{coords:new Float32Array([i,s,0,i,r,0,n,r,0,n,s,0]),tcoords:new Float32Array([0,1,0,0,1,0,1,1])}}needed(t,e,i,s,n,r,o=8){const a=this.getViewportBox(t,e,i);let l=[],h=performance.now();const c=this.tileCount();for(let t=0;t<c;t++){let e=this.index(0,t,0),i=r.get(e)||this.newTile(e);this.intersects(a,e,true)&&(i.time=h,i.priority=this.tileDescriptors[e].visible?10:1,null===i.missing&&l.push(i))}let d=a.center();return l.sort((function(t,e){return Math.abs(t.x-d[0])+Math.abs(t.y-d[1])-Math.abs(e.x-d[0])-Math.abs(e.y-d[1])})),l}available(t,e,i,s,n,r){const o=this.getViewportBox(t,e,i);let a=[];const l=this.tileCount();for(let t=0;t<l;t++){let e=this.index(0,t,0);if(this.tileDescriptors[e].visible&&this.intersects(o,e,true)&&r.has(e)){let t=r.get(e);0==t.missing&&(a[e]=t)}}return a}newTile(t){let e=new r;e.index=t;let i=this.tileDescriptors[t];return e.image=i.image,Object.assign(e,i.region),e}intersects(t,e,i=!0){const s=this.tileDescriptors[e].region,n=s.x,r=s.y,o=n+s.w,a=r+s.h,l=i?-t.yHigh:t.yLow,h=i?-t.yLow:t.yHigh;return n<t.xHigh&&r<h&&o>t.xLow&&a>l}tileCount(){return this.tileDescriptors.length}}a.prototype.types.tile_images=(t,e,i)=>new E(t,e,i);class T extends w{constructor(t){const e=t.url;null==t.path&&console.log("WARNING MISSING ANNOTATION PATH, SET TO ./annot/"),super(t);const i=null!=this.format?this.format:"vec4";this.addEvent("loaded",(()=>{t.path?this.layout.path=t.path:null!=e&&this.layout.setPathFromUrl(path);for(let t of this.annotations){let t=new g({format:i});this.rasters.push(t)}console.log("Set "+this.annotations.length+" annotations into layout"),this.setupShader(i),this.layout.setTileDescriptors(this.annotations)}))}length(){return this.annotations.length}setTileVisible(t,e){this.layout.setTileVisible(t,e)}setAllTilesVisible(t){this.layout.setAllTilesVisible(t)}drawTile(t,e){if(0!=t.missing)throw"Attempt to draw tile still missing textures";const i=t.index;let s=this.gl,n=this.shader.samplers[i].id;s.uniform1i(this.shader.samplers[i].location,i),s.activeTexture(s.TEXTURE0+i),s.bindTexture(s.TEXTURE_2D,t.tex[n]);const r=this.getTileByteOffset(e);s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,r)}setupShader(t){let e=[],i=this.rasters.length;for(let s=0;s<i;++s)e.push({id:s,name:"source",type:t});let s=new v({label:"Rgb",samplers:e});s.fragShaderSrc=function(t){let e=!(t instanceof WebGLRenderingContext);return`\n\n${e?"in":"varying"} vec2 v_texcoord;\n\nvec4 data() {\n\treturn texture${e?"":"2D"}(source, v_texcoord);\n}\n`},this.shaders={standard:s},this.setShader("standard")}}c.prototype.types.annotation_image=t=>new T(t);class S extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(this.url)this.layout.setUrls([this.url]);else if(0==this.layout.urls.length)throw"Missing options.url parameter";const e=null!=this.format?this.format:"vec4";let i=new g({format:e});this.rasters.push(i);let s=new v({label:"Rgb",samplers:[{id:0,name:"kd",type:e}]});s.fragShaderSrc=function(t){return`\n\n\t\t${!(t instanceof WebGLRenderingContext)?"in":"varying"} vec2 v_texcoord;\n\n\t\tvec2 bilinear_masked_scalar(sampler2D field, vec2 uv) {\n\t\t\tvec2 px = uv*tileSize;\n\t\t\tivec2 iuv = ivec2(floor( px ));\n\t\t\tvec2 fuv = fract(px);\n\t\t\tint i0 = iuv.x;\n\t\t\tint j0 = iuv.y;\n\t\t\tint i1 = i0+1>=int(tileSize.x) ? i0 : i0+1;\n\t\t\tint j1 = j0+1>=int(tileSize.y) ? j0 : j0+1;\n\t\t  \n\t\t\tfloat f00 = texelFetch(field, ivec2(i0, j0), 0).r;\n\t\t\tfloat f10 = texelFetch(field, ivec2(i1, j0), 0).r;\n\t\t\tfloat f01 = texelFetch(field, ivec2(i0, j1), 0).r;\n\t\t\tfloat f11 = texelFetch(field, ivec2(i1, j1), 0).r;\n\n\t\t\t// FIXME Compute weights of valid\n\t\t  \n\t\t\tvec2 result_masked_scalar;\n\t\t\tresult_masked_scalar.y = f00*f01*f10*f11;\n\t\t\tresult_masked_scalar.y = result_masked_scalar.y > 0.0 ? 1.0 : 0.0;\n\n\t\t\tconst float scale = 255.0/254.0;\n\t\t\tconst float bias  = -1.0/254.0;\n\t\t\tresult_masked_scalar.x = mix(mix(f00, f10, fuv.x), mix(f01, f11, fuv.x), fuv.y);\n\t\t\tresult_masked_scalar.x = result_masked_scalar.y * (scale * result_masked_scalar.x + bias);\t\t  \n\t\t\treturn result_masked_scalar;\n\t\t  }\n\t\t  \n\t\t  vec4 data() { \n\t\t\tvec2  masked_scalar = bilinear_masked_scalar(kd, v_texcoord);\n\t\t\treturn masked_scalar.y > 0.0 ?  vec4(masked_scalar.x, masked_scalar.x, masked_scalar.x, masked_scalar.y) :  vec4(1.0, 0.0, 0.0, masked_scalar.y);\n\t\t  }\n\t\t`},this.shaders={scalarimage:s},this.setShader("scalarimage"),this.rasters[0].loadTexture=this.loadTexture.bind(this)}draw(t,e){return super.draw(t,e)}loadTexture(t,e){this.rasters[0].width=e.width,this.rasters[0].height=e.height;const i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.R8,t.RED,t.UNSIGNED_BYTE,e),i}}c.prototype.types.maskedimage=t=>new S(t);class k extends a{constructor(t,e,i){super(t,null,i),this.setDefaults(e),this.init(t,e,i)}setDefaults(t){super.setDefaults(t),Object.assign(this,{tilesize:256,overlap:0,nlevels:1,qbox:[],bbox:[],urls:[],cachelevels:10})}async setUrls(t){this.urls=t;try{switch(this.type){case"google":await this.initGoogle();break;case"deepzoom1px":await this.initDeepzoom(!0);break;case"deepzoom":await this.initDeepzoom(!1);break;case"zoomify":await this.initZoomify();break;case"iiif":await this.initIIIF();break;case"iip":await this.initIIP();break;case"tarzoom":await this.initTarzoom();break;case"itarzoom":await this.initITarzoom()}this.initBoxes(),this.status="ready",this.emit("ready")}catch(t){console.log(t),this.status=t}}imageUrl(t,e){let i=t.substring(0,t.lastIndexOf("/")+1);switch(this.type){case"image":return i+e+".jpg";case"google":return i+e;case"deepzoom":return i+e+".dzi";case"tarzoom":return i+e+".tzi";case"itarzoom":return i+"planes.tzi";case"zoomify":return i+e+"/ImageProperties.xml";case"iip":return t+"&SDS="+e.substring(e.lastIndexOf("_")+1,e.length);case"iiif":throw Error("Unimplemented");default:throw Error("Unknown layout: "+this.type)}}getTileSize(){return[this.tilesize,this.tilesize]}index(t,e,i){let s=0;for(let e=0;e<t;e++)s+=this.qbox[e].xHigh*this.qbox[e].yHigh;return s+i*this.qbox[t].xHigh+e}reverseIndex(t){let e=t,i=0;for(let e=0;e<this.qbox.length;e++){let s=this.qbox[e].xHigh*this.qbox[e].yHigh;if(t-s<0)break;t-=s,i++}let s=this.qbox[i].xHigh,n=Math.floor(t/s),r=t%s;return console.assert(this.index(i,r,n)==e),{level:i,x:r,y:n}}initBoxes(){this.qbox=[],this.bbox=[];var t=this.width,e=this.height;if("image"==this.type)return this.qbox[0]=new i({xLow:0,yLow:0,xHigh:1,yHigh:1}),this.bbox[0]=new i({xLow:0,yLow:0,xHigh:t,yHigh:e}),this.emit("updateSize"),1;for(let s=this.nlevels-1;s>=0;s--)this.qbox[s]=new i({xLow:0,yLow:0,xHigh:0,yHigh:0}),this.bbox[s]=new i({xLow:0,yLow:0,xHigh:t,yHigh:e}),this.qbox[s].yHigh=Math.ceil(e/this.tilesize),this.qbox[s].xHigh=Math.ceil(t/this.tilesize),t>>>=1,e>>>=1;this.emit("updateSize")}tileCoords(t){let{level:e,x:i,y:s}=t;this.width,this.height;var n=new Float32Array([0,1,0,0,1,0,1,1]);let r=new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),o=this.nlevels-1-e,a=this.tilesize*(1<<o),l=a,h=a;a*(i+1)>this.width&&(l=this.width-a*i,"google"==this.type&&(n[4]=n[6]=l/a)),a*(s+1)>this.height&&(h=this.height-a*s,"google"==this.type&&(n[1]=n[7]=h/a));var c=this.qbox[e].xHigh-1,d=this.qbox[e].yHigh-1,u=this.overlap;if(u){let t=u/(l/(1<<o)+(0==i?0:u)+(i==c?0:u)),e=u/(h/(1<<o)+(0==s?0:u)+(s==d?0:u));n[0]=n[2]=0==i?0:t,n[3]=n[5]=0==s?0:e,n[4]=n[6]=i==c?1:1-t,n[1]=n[7]=s==d?1:1-e}let p=n[1];n[1]=n[7]=n[3],n[3]=n[5]=p;for(let t=0;t<r.length;t+=3)r[t]=r[t]*l+a*i-this.width/2,r[t+1]=-r[t+1]*h-a*s+this.height/2;return{coords:r,tcoords:n}}newTile(t){let e=super.newTile(t);return e.index=t,Object.assign(e,this.reverseIndex(t)),e}needed(t,e,i,s,n,r,o=8){let a=this.neededBox(t,e,i,0,n),l=[],h=performance.now();for(let t=0;t<=a.level;t++){let e=a.pyramid[t],i=[];for(let s=e.yLow;s<e.yHigh;s++)for(let n=e.xLow;n<e.xHigh;n++){let e=this.index(t,n,s),o=r.get(e)||this.newTile(e);o.time=h,o.priority=a.level-t,o.priority>this.cachelevels||null===o.missing&&i.push(o)}let s=e.center();i.sort((function(t,e){return Math.abs(t.x-s.x)+Math.abs(t.y-s.y)-Math.abs(e.x-s.x)-Math.abs(e.y-s.y)})),l=l.concat(i)}return l}available(t,e,i,s,n,r){let o=this.neededBox(t,e,i,0,n),a={},l={},h=o.level,c=o.pyramid[h];for(let t=c.yLow;t<c.yHigh;t++)for(let e=c.xLow;e<c.xHigh;e++){let i=h;for(;i>=0;){let s=h-i,n=this.index(i,e>>s,t>>s);if(r.has(n)&&0==r.get(n).missing){a[n]=r.get(n);break}{let n=e>>s+1<<1,r=t>>s+1<<1;l[this.index(i,n,r)]=1,l[this.index(i,n+1,r)]=1,l[this.index(i,n+1,r+1)]=1,l[this.index(i,n,r+1)]=1}i--}}for(let t in l)t in a&&(a[t].complete=!1);return a}neededBox(t,e,s,n,r){if("image"==this.type)return{level:0,pyramid:[new i({xLow:0,yLow:0,xHigh:1,yHigh:1})]};let o=Math.max(0,Math.min(Math.floor(-Math.log2(e.z)+r),this.nlevels-1)),a=this.nlevels-1-o;const l=this.getViewportBox(t,e,s);let h=[];for(let t=0;t<=a;t++){let e=this.nlevels-1-t,s=this.tilesize*Math.pow(2,e),r=new i(l);r.quantize(s),r.xLow=Math.max(r.xLow-n,this.qbox[t].xLow),r.yLow=Math.max(r.yLow-n,this.qbox[t].yLow),r.xHigh=Math.min(r.xHigh+n,this.qbox[t].xHigh),r.yHigh=Math.min(r.yHigh+n,this.qbox[t].yHigh),h[t]=r}return{level:a,pyramid:h}}getTileURL(t,e){throw Error("Layout not defined or ready.")}async initGoogle(){if(!this.width||!this.height)throw"Google rasters require to specify width and height";this.tilesize=256,this.overlap=0;let t=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(t)/Math.LN2)+1,this.urls[0].includes("{")?this.getTileURL=(t,e)=>{let i={s:this.subdomains?this.subdomains[Math.abs(e.x+e.y)%this.subdomains.length]:"",...e,z:e.level};return this.urls[t].replace(/{(.+?)}/g,((t,e)=>i[e]))}:this.getTileURL=(t,e)=>this.urls[t]+"/"+e.level+"/"+e.y+"/"+e.x+"."+this.suffix}async initDeepzoom(t){let e=this.urls.filter((t=>t))[0];var i=await fetch(e);if(!i.ok)throw this.status="Failed loading "+e+": "+i.statusText,new Error(this.status);let s=await i.text(),n=(new window.DOMParser).parseFromString(s,"text/xml").documentElement;this.suffix=n.getAttribute("Format"),this.tilesize=parseInt(n.getAttribute("TileSize")),this.overlap=parseInt(n.getAttribute("Overlap"));let r=n.querySelector("Size");this.width=parseInt(r.getAttribute("Width")),this.height=parseInt(r.getAttribute("Height"));let o=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(o)/Math.LN2)+1,this.urls=this.urls.map((t=>t?t.slice(0,t.lastIndexOf("."))+"_files/":null)),this.skiplevels=0,t&&(this.skiplevels=Math.ceil(Math.log(this.tilesize)/Math.LN2)),this.getTileURL=(t,e)=>this.urls[t]+(e.level+this.skiplevels)+"/"+e.x+"_"+e.y+"."+this.suffix}async initTarzoom(){this.tarzoom=[];for(let e of this.urls){var t=await fetch(e);if(!t.ok)throw this.status="Failed loading "+e+": "+t.statusText,new Error(this.status);let i=await t.json();i.url=e.slice(0,e.lastIndexOf("."))+".tzb",Object.assign(this,i),this.tarzoom.push(i)}this.getTileURL=(t,e)=>{const i=this.tarzoom[t];return e.start=i.offsets[e.index],e.end=i.offsets[e.index+1],i.url}}async initITarzoom(){const t=this.urls[0];var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.json();Object.assign(this,i),this.url=t.slice(0,t.lastIndexOf("."))+".tzb",this.getTileURL=(t,e)=>{let i=e.index*this.stride;e.start=this.offsets[i],e.end=this.offsets[i+this.stride],e.offsets=[];for(let t=0;t<this.stride+1;t++)e.offsets.push(this.offsets[i+t]-e.start);return this.url}}async initZoomify(){const t=this.urls[0];this.overlap=0;var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.text(),s=(new window.DOMParser).parseFromString(i,"text/xml").documentElement;if(this.tilesize=parseInt(s.getAttribute("TILESIZE")),this.width=parseInt(s.getAttribute("WIDTH")),this.height=parseInt(s.getAttribute("HEIGHT")),!this.tilesize||!this.height||!this.width)throw"Missing parameter files for zoomify!";let n=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(n)/Math.LN2)+1,this.getTileURL=(e,i)=>this.urls[e].slice(0,t.lastIndexOf("/"))+"/TileGroup"+(i.index>>8)+"/"+i.level+"-"+i.x+"-"+i.y+"."+this.suffix}async initIIIF(){const t=this.urls[0];this.overlap=0;var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.json();this.width=i.width,this.height=i.height,this.nlevels=i.tiles[0].scaleFactors.length,this.tilesize=i.tiles[0].width,this.getTileURL=(e,i)=>{const s=this.urls[e].slice(0,t.lastIndexOf("/"));let n=this.tilesize;parseInt(this.nlevels-1-i.level);let r=Math.pow(2,i.level),o=i.x*n*r,a=i.y*n*r,l=Math.min(n*r,this.width-o),h=Math.min(n*r,this.height-a),c=n;o+n*r>this.width&&(c=(this.width-o+r-1)/r);let d=n;return a+n*r>this.height&&(d=(this.height-a+r-1)/r),`${s}/${o},${a},${l},${h}/${c},${d}/0/default.jpg`}}async initIIP(){const t=(this.server?this.server+"?FIF=":"")+this.urls[0]+"&obj=Max-size&obj=Tile-size&obj=Resolution-number";let e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.text(),s=i.split("Tile-size:");return s[1]?(this.tilesize=parseInt(s[1].split(" ")[0]),s=i.split("Max-size:"),s[1]?(s=s[1].split("\n")[0].split(" "),this.width=parseInt(s[0]),this.height=parseInt(s[1]),this.nlevels=parseInt(i.split("Resolution-number:")[1]),void(this.getTileURL=(t,e)=>{let i=e.y*this.qbox[e.level].xHigh+e.x,s="JTL";return"webp"==this.suffix?s="WTL":"png"==this.suffix&&(s="PTL"),(this.server?this.server+"?FIF=":"")+this.urls[t]+"&"+s+"="+e.level+","+i})):null):null}}const C=(t,e,i)=>new k(t,e,i);for(let t of["google","deepzoom1px","deepzoom","zoomify","iiif","iip","tarzoom","itarzoom"])a.prototype.types[t]=C;class _{constructor(t){t=Object.assign({},t),Object.assign(this,t),this.name=this.constructor.name,this.uniforms={},this.samplers=[],this.needsUpdate=!0,this.shader=null,this.modes={}}setMode(t,e){if(!this.shader)throw Error("Shader not registered");if(Object.keys(this.modes).length>0){const i=this.modes[t];if(!i)throw Error(`Mode "${t}" not exist!`);i.map((t=>{t.enable=t.id==e})),this.shader.needsUpdate=!0}}prepare(t){this.needsUpdate&&this.createTextures&&this.createTextures(t),this.needsUpdate=!1}fragModeSrc(){let t="";for(const e of Object.keys(this.modes))for(const i of this.modes[e])i.enable&&(t+=i.src+"\n");return t}setUniform(t,e){if(!this.shader)throw Error("Shader not registered");this.shader.setUniform(this.uniformName(t),e)}fragSamplerSrc(){let t="";for(let e of this.samplers)t+=`\n            uniform sampler2D ${e.name};`;return t}fragUniformSrc(){let t="";for(const[e,i]of Object.entries(this.uniforms))t+=`\n            uniform ${this.uniforms[e].type} ${e};`;return t}fragDataSrc(t){return null}functionName(){return this.name+"_data"}samplerName(t){return`${this.name}_${t}`}uniformName(t){return`u_${this.name}_${t}`}modeName(t){return`m_${this.name}_${t}`}getSampler(t){const e=this.samplerName(t);return this.samplers.find((t=>t.name==e))}}class R{constructor(t){Object.assign(this,{active:!0,debug:!1,panDelay:50,zoomDelay:200,priority:0,activeModifiers:[0]}),Object.assign(this,t)}modifierState(t){let e=0;return t.ctrlKey&&(e+=1),t.shiftKey&&(e+=2),t.altKey&&(e+=4),e}captureEvents(){this.capture=!0}releaseEvents(){this.capture=!1}panStart(t){}panMove(t){}panEnd(t){}pinchStart(t,e){}pinchMove(t,e){}pinchEnd(t,e){}mouseWheel(t){}fingerSingleTap(t){}fingerDoubleTap(t){}}function L(t,e,i){return Math.max(e,Math.min(i,t))}class M extends R{constructor(t,e){super(e),Object.assign(this,{relative:!1,speed:2,start_x:0,start_y:0,current_x:0,current_y:0,onPanStart:null,onPanEnd:null},e),this.callback=t,this.box||(this.box=new i({xLow:-.99,yLow:-.99,xHigh:.99,yHigh:.99})),this.panning=!1}setPosition(t,e){this.current_x=t,this.current_y=e,this.callback(t,e)}project(t){let e=t.target.getBoundingClientRect();return[2*t.offsetX/e.width-1,2*(1-t.offsetY/e.height)-1]}rangeCoords(t){let[e,i]=this.project(t);return this.relative&&(e=L(this.speed*(e-this.start_x)+this.current_x,-1,1),i=L(this.speed*(i-this.start_y)+this.current_y,-1,1)),[e,i]}panStart(t){if(this.active&&this.activeModifiers.includes(this.modifierState(t))){if(this.relative){let[e,i]=this.project(t);this.start_x=e,this.start_y=i}this.onPanStart&&this.onPanStart(...this.rangeCoords(t)),this.callback(...this.rangeCoords(t)),this.panning=!0,t.preventDefault()}}panMove(t){if(!this.panning)return!1;this.callback(...this.rangeCoords(t))}panEnd(t){if(!this.panning)return!1;if(this.panning=!1,this.relative){let[e,i]=this.project(t);this.current_x=L(this.speed*(e-this.start_x)+this.current_x,-1,1),this.current_y=L(this.speed*(i-this.start_y)+this.current_y,-1,1)}this.onPanEnd&&this.onPanEnd(...this.rangeCoords(t))}fingerSingleTap(t){this.active&&this.activeModifiers.includes(this.modifierState(t))&&(this.relative||(this.callback(...this.rangeCoords(t)),t.preventDefault()))}}class A extends R{constructor(t,e){super(e),this.camera=t,this.zoomAmount=1.2,this.controlZoom=!1,this.panning=!1,this.initialTransform=null,this.startMouse=null,this.zooming=!1,this.initialDistance=0,this.useGLcoords=!1,e&&Object.assign(this,e)}panStart(t){if(!this.active||this.panning||!this.activeModifiers.includes(this.modifierState(t)))return;this.panning=!0,this.startMouse=o.fromCanvasHtmlToViewport({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords);let e=performance.now();this.initialTransform=this.camera.getCurrentTransform(e),this.camera.target=this.initialTransform.copy(),t.preventDefault()}panMove(t){if(!this.panning)return;let e=this.initialTransform;const i=o.fromCanvasHtmlToViewport({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords);let s=i.x-this.startMouse.x,n=i.y-this.startMouse.y;this.camera.setPosition(this.panDelay,e.x+s,e.y+n,e.z,e.a)}panEnd(t){this.panning=!1}distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}pinchStart(t,e){this.zooming=!0,this.initialDistance=Math.max(30,this.distance(t,e)),t.preventDefault()}pinchMove(t,e){if(!this.zooming)return;let i=t.target.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top,r=e.target.getBoundingClientRect(),a=e.clientX-r.left,l=e.clientY-r.top;const h=this.distance(t,e),c=o.fromCanvasHtmlToScene({x:(s+a)/2,y:(n+l)/2},this.camera,this.useGLcoords),d=h/this.initialDistance;this.camera.deltaZoom(this.zoomDelay,d,c.x,c.y),this.initialDistance=h,t.preventDefault()}pinchEnd(t,e,i,s){this.zooming=!1,t.preventDefault()}mouseWheel(t){if(!this.active)return;if(this.controlZoom&&!t.ctrlKey)return void this.emit("nowheel");let e=-t.deltaY/53;const i=o.fromCanvasHtmlToScene({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords),s=Math.pow(this.zoomAmount,e);this.camera.deltaZoom(this.zoomDelay,s,i.x,i.y),t.preventDefault()}fingerDoubleTap(t){}fingerDoubleTap(t){if(!this.active||!this.activeModifiers.includes(this.modifierState(t)))return;const e=o.fromCanvasHtmlToScene({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords),i=this.zoomAmount;this.camera.deltaZoom(this.zoomDelay,i,e.x,e.y)}}n(A,"nowheel");class z{constructor(t,e){this.target=t,Object.assign(this,{pinchMaxInterval:100,idleTime:60}),e&&Object.assign(this,e),this.idleTimeout=null,this.idling=!1,this.currentPointers=[],this.eventObservers=new Map,this.ppmm=z.getPixelsPerMM(),this.target.style.touchAction="none",this.target.addEventListener("pointerdown",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointermove",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointerup",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointercancel",(t=>this.handleEvent(t)),!1),this.target.addEventListener("wheel",(t=>this.handleEvent(t)),!1),this.startIdle()}static get ANYPOINTER(){return-1}static splitStr(t){return t.trim().split(/\s+/g)}static getPixelsPerMM(){const t=window.devicePixelRatio||1,e=document.createElement("div");e.style.width="1in",e.style.height="1in",e.style.position="absolute",e.style.left="-100%",e.style.top="-100%",document.body.appendChild(e);const i=e.offsetWidth*t;document.body.removeChild(e);return i/25.4}on(t,e,i=z.ANYPOINTER){return t=z.splitStr(t),"function"==typeof e&&((e=Object.fromEntries(t.map((t=>[t,e])))).priority=-1e3),t.forEach((t=>{if(i==z.ANYPOINTER)this.broadcastOn(t,e);else{const s=this.currentPointers[i];if(!s)throw new Error("Bad Index");s.on(t,e)}})),e}off(t,e,i=z.ANYPOINTER){i==z.ANYPOINTER?this.broadcastOff(t,e):z.splitStr(t).forEach((t=>{const s=this.currentPointers[i];if(!s)throw new Error("Bad Index");s.off(t,e)}))}onEvent(t){const e=["fingerHover","fingerSingleTap","fingerDoubleTap","fingerHold","mouseWheel","wentIdle","activeAgain"];if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!e.some((e=>"function"==typeof t[e])))throw new Error("Event handler properties are wrong or missing");for(let i of e)"function"==typeof t[i]&&this.on(i,t);t.panStart&&this.onPan(t),t.pinchStart&&this.onPinch(t)}onPan(t){if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!["panStart","panMove","panEnd"].every((e=>"function"==typeof t[e])))throw new Error("Pan handler is missing one of this functions: panStart, panMove or panEnd");t.fingerMovingStart=e=>{t.panStart(e),e.defaultPrevented&&(this.on("fingerMoving",(e=>{t.panMove(e)}),e.idx),this.on("fingerMovingEnd",(e=>{t.panEnd(e)}),e.idx))},this.on("fingerMovingStart",t)}onPinch(t){if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!["pinchStart","pinchMove","pinchEnd"].every((e=>"function"==typeof t[e])))throw new Error("Pinch handler is missing one of this functions: pinchStart, pinchMove or pinchEnd");t.fingerDown=e=>{const i=this.currentPointers.filter((t=>t&&t.idx!=e.idx&&t.status==t.stateEnum.DETECT));if(0==i.length)return;const s=[];for(let t of i){let e=null;for(let i of t.eventHistory.toArray())"fingerDown"==i.fingerType&&(e=i);e&&s.push(e)}s.sort(((t,e)=>e.timeStamp-t.timeStamp));for(let i of s){if(e.timeStamp-i.timeStamp>this.pinchMaxInterval)break;if(t.pinchStart(e,i),!e.defaultPrevented)break;clearTimeout(this.currentPointers[e.idx].timeout),clearTimeout(this.currentPointers[i.idx].timeout),this.on("fingerMovingStart",(t=>t.preventDefault()),e.idx),this.on("fingerMovingStart",(t=>t.preventDefault()),i.idx),this.on("fingerMoving",(s=>i&&t.pinchMove(e=s,i)),e.idx),this.on("fingerMoving",(s=>e&&t.pinchMove(e,i=s)),i.idx),this.on("fingerMovingEnd",(s=>{i&&t.pinchEnd(s,i),e=i=null}),e.idx),this.on("fingerMovingEnd",(s=>{e&&t.pinchEnd(e,s),e=i=null}),i.idx);break}},this.on("fingerDown",t)}broadcastOn(t,e){this.eventObservers.has(t)||this.eventObservers.set(t,new Set),this.eventObservers.get(t).add(e)}broadcastOff(t,e){z.splitStr(t).forEach((t=>{if(this.eventObservers.has(t))if(e){const i=this.eventObservers.get(t);i.delete(e),0===i.size&&this.eventObservers.delete(t)}else this.eventObservers.delete(t)}))}broadcast(t){if(!this.eventObservers.has(t.fingerType))return;const e=Array.from(this.eventObservers.get(t.fingerType));e.sort(((t,e)=>e.priority-t.priority));for(const i of e)if(i[t.fingerType](t),t.defaultPrevented)break}addCurrPointer(t){let e=-1;for(let t=0;t<this.currentPointers.length&&e<0;t++)null==this.currentPointers[t]&&(e=t);return e<0?(this.currentPointers.push(t),e=this.currentPointers.length-1):this.currentPointers[e]=t,e}removeCurrPointer(t){for(this.currentPointers[t]=null;this.currentPointers.length>0&&null==this.currentPointers[this.currentPointers.length-1];)this.currentPointers.pop()}startIdle(){this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=setTimeout((()=>{this.broadcast({fingerType:"wentIdle"}),this.idling=!0}),1e3*this.idleTime)}handleEvent(t){this.idling?(this.broadcast({fingerType:"activeAgain"}),this.idling=!1):this.startIdle(),"pointerdown"==t.type&&this.target.setPointerCapture(t.pointerId),"pointercancel"==t.type&&console.log(t);let e=!1;for(let i=0;i<this.currentPointers.length&&!e;i++){const s=this.currentPointers[i];s&&(e=s.handleEvent(t),s.isDone()&&this.removeCurrPointer(i))}if(!e){e=new P(this,t.pointerId,{ppmm:this.ppmm}).handleEvent(t)}}}class P{constructor(t,e,i){this.parent=t,this.pointerId=e,Object.assign(this,{ppmm:3}),i&&Object.assign(this,i),this.eventHistory=new U(10),this.isActive=!1,this.startTap=0,this.threshold=15,this.eventObservers=new Map,this.isDown=!1,this.done=!1,this.stateEnum={IDLE:0,DETECT:1,HOVER:2,MOVING_START:3,MOVING:4,MOVING_END:5,HOLD:6,TAPS_DETECT:7,SINGLE_TAP:8,DOUBLE_TAP_DETECT:9,DOUBLE_TAP:10},this.status=this.stateEnum.IDLE,this.timeout=null,this.holdTimeoutThreshold=600,this.tapTimeoutThreshold=100,this.oldDownPos={clientX:0,clientY:0},this.movingThreshold=1,this.idx=this.parent.addCurrPointer(this)}static distance(t,e,i,s){return Math.sqrt((i-t)**2+(s-e)**2)}distanceMM(t,e,i,s){return P.distance(t,e,i,s)/this.ppmm}on(t,e){this.eventObservers.set(t,e)}off(t){this.eventObservers.has(t)&&this.eventObservers.delete(t)}addToHistory(t){this.eventHistory.push(t)}prevPointerEvent(){return this.eventHistory.last()}handlePointerDown(t){this.startTap=t.timeStamp}handlePointerUp(t){t.timeStamp,this.startTap}isLikelySamePointer(t){let e=this.pointerId==t.pointerId;if(!e&&!this.isDown&&"pointerdown"==t.type){const i=this.prevPointerEvent();i&&(e=t.pointerType==i.pointerType&&this.distanceMM(t.clientX,t.clientY,i.clientX,i.clientY)<this.threshold)}return e}emit(t){this.eventObservers.has(t.fingerType)&&(this.eventObservers.get(t.fingerType)[t.fingerType](t),t.defaultPrevented)||this.parent.broadcast(t)}createOutputEvent(t,e){const i=t;i.fingerType=e,i.originSrc=this.originSrc,i.speedX=0,i.speedY=0,i.idx=this.idx;const s=this.prevPointerEvent();if(s&&"pointermove"==t.type){const t=i.timeStamp-s.timeStamp;t>0&&(i.speedX=(i.clientX-s.clientX)/t*1e3,i.speedY=(i.clientY-s.clientY)/t*1e3)}return i}processEvent(t){let e=0;if("pointerdown"==t.type&&(this.oldDownPos.clientX=t.clientX,this.oldDownPos.clientY=t.clientY,this.isDown=!0),"pointerup"!=t.type&&"pointercancel"!=t.type||(this.isDown=!1),"pointermove"==t.type&&this.isDown&&(e=this.distanceMM(t.clientX,t.clientY,this.oldDownPos.clientX,this.oldDownPos.clientY)),"wheel"!=t.type){switch(this.status){case this.stateEnum.HOVER:case this.stateEnum.IDLE:if("pointermove"==t.type)this.emit(this.createOutputEvent(t,"fingerHover")),this.status=this.stateEnum.HOVER,this.originSrc=t.composedPath()[0];else if("pointerdown"==t.type){if(this.status=this.stateEnum.DETECT,this.emit(this.createOutputEvent(t,"fingerDown")),t.defaultPrevented){this.status=this.stateEnum.MOVING;break}this.originSrc=t.composedPath()[0],this.timeout=setTimeout((()=>{this.emit(this.createOutputEvent(t,"fingerHold")),this.status=this.stateEnum.HOLD,t.defaultPrevented&&(this.status=this.stateEnum.IDLE)}),this.holdTimeoutThreshold)}break;case this.stateEnum.DETECT:"pointercancel"==t.type?(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerMovingEnd"))):"pointermove"==t.type&&e>this.movingThreshold?(clearTimeout(this.timeout),this.status=this.stateEnum.MOVING,this.emit(this.createOutputEvent(t,"fingerMovingStart"))):"pointerup"==t.type&&(clearTimeout(this.timeout),this.status=this.stateEnum.TAPS_DETECT,this.timeout=setTimeout((()=>{this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerSingleTap"))}),this.tapTimeoutThreshold));break;case this.stateEnum.HOLD:"pointerup"==t.type||"pointercancel"==t.type?this.status=this.stateEnum.IDLE:"pointermove"==t.type&&e>this.movingThreshold&&(this.status=this.stateEnum.MOVING,this.emit(this.createOutputEvent(t,"fingerMovingStart")));break;case this.stateEnum.TAPS_DETECT:"pointerdown"==t.type?(clearTimeout(this.timeout),this.status=this.stateEnum.DOUBLE_TAP_DETECT,this.timeout=setTimeout((()=>{this.status=this.stateEnum.HOLD,this.emit(this.createOutputEvent(t,"fingerHold")),t.defaultPrevented&&(this.status=this.stateEnum.IDLE)}),this.holdTimeoutThreshold)):"pointermove"==t.type&&e>this.movingThreshold&&(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerHover")));break;case this.stateEnum.DOUBLE_TAP_DETECT:"pointerup"==t.type||"pointercancel"==t.type?(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerDoubleTap"))):"pointermove"==t.type&&e>this.movingThreshold&&(clearTimeout(this.timeout),this.status=this.stateEnum.MOVING,this.emit(this.createOutputEvent(t,"fingerMovingStart")));break;case this.stateEnum.MOVING:"pointermove"==t.type?this.emit(this.createOutputEvent(t,"fingerMoving")):"pointerup"!=t.type&&"pointercancel"!=t.type||(this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerMovingEnd")));break;default:console.log("ERROR "+this.status),console.log(t)}this.addToHistory(t)}else this.emit(this.createOutputEvent(t,"mouseWheel"))}handleEvent(t){let e=!1;return this.isLikelySamePointer(t)&&(this.pointerId=t.pointerId,this.processEvent(t),e=!0),e}isDone(){return this.status==this.stateEnum.IDLE}}class U{constructor(t){if("number"!=typeof t||!Number.isInteger(t)||t<1)throw new TypeError("Invalid capacity");this.buffer=new Array(t),this.capacity=t,this.first=0,this.size=0}clear(){this.first=0,this.size=0}empty(){return 0===this.size}first(){return this.size>0?this.buffer[this.first]:null}last(){return this.size>0?this.buffer[(this.first+this.size-1)%this.capacity]:null}enqueue(t){this.first=this.first>0?this.first-1:this.capacity-1,this.buffer[this.first]=t,this.size<this.capacity&&this.size++}push(t){const e=(this.first+this.size)%this.capacity;this.buffer[e]=t,this.size===this.capacity?this.first=(this.first+1)%this.capacity:this.size++}pop(){if(0===this.size)throw new RangeError("Dequeue on empty buffer");const t=(this.first+this.size-1)%this.capacity,e=this.buffer[t];return this.size--,e}shift(){if(0===this.size)throw new RangeError("Shift on empty buffer");const t=this.buffer[this.first];return this.first=(this.first+1)%this.capacity,this.size--,t}get(t,e){if(0===this.size&&0===t&&(void 0===e||0===e))return[];if("number"!=typeof t||!Number.isInteger(t)||t<0)throw new TypeError("Invalid start value");if(t>=this.size)throw new RangeError("Start index past end of buffer: "+t);if(void 0===e)return this.buffer[(this.first+t)%this.capacity];if("number"!=typeof e||!Number.isInteger(e)||e<0)throw new TypeError("Invalid end value");if(e>=this.size)throw new RangeError("End index past end of buffer: "+e);const i=[];for(let s=t;s<=e;s++)i.push(this.buffer[(this.first+s)%this.capacity]);return i}toArray(){return 0===this.size?[]:this.get(0,this.size-1)}}class F{constructor(t,e){if(Object.assign(this,{background:null,autofit:!0,canvas:{},camera:new p,idleTime:60}),"string"==typeof t&&(t=document.querySelector(t)),!t)throw"Missing element parameter";Object.assign(this,e),this.background&&(t.style.background=this.background),this.containerElement=t,this.canvasElement=t.querySelector("canvas"),this.canvasElement||(this.canvasElement=document.createElement("canvas"),t.prepend(this.canvasElement)),this.overlayElement=document.createElement("div"),this.overlayElement.classList.add("openlime-overlay"),this.containerElement.appendChild(this.overlayElement),this.canvas=new d(this.canvasElement,this.overlayElement,this.camera,this.canvas),this.canvas.addEvent("update",(()=>{this.redraw()})),this.autofit&&(this.canvas.addEvent("ready",(()=>{this.camera.fitCameraBox(0)})),this.canvas.addEvent("updateSize",(()=>{Object.values(this.canvas.layers).some((t=>"ready"===t.status))&&this.camera.fitCameraBox(0)}))),this.pointerManager=new z(this.overlayElement,{idleTime:this.idleTime}),this.canvasElement.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),this.resizeObserver=new ResizeObserver((t=>{for(let e of t)this.resize(e.contentRect.width,e.contentRect.height)})),this.resizeObserver.observe(this.canvasElement),this.controllers=[]}addController(t){this.controllers.push(t),this.pointerManager.onEvent(t)}addLayer(t,e){this.canvas.addLayer(t,e),this.redraw()}removeLayer(t){"string"==typeof t&&(t=this.canvas.layers[t]),t&&(this.canvas.removeLayer(t),this.redraw())}resize(t,e){if(0==t||0==e)return;this.canvasElement.width=t*window.devicePixelRatio,this.canvasElement.height=e*window.devicePixelRatio;let i={x:0,y:0,dx:t,dy:e,w:t,h:e};this.camera.setViewport(i),this.canvas.updateSize(),this.emit("resize",i),this.canvas.prefetch(),this.redraw()}redraw(){this.animaterequest||(this.animaterequest=requestAnimationFrame((t=>{this.draw(t)})),this.requestTime=performance.now())}draw(t){t||(t=performance.now()),this.animaterequest=null;let e=performance.now()-this.requestTime;this.canvas.addRenderTiming(e),this.camera.viewport,this.camera.getCurrentTransform(t),this.canvas.draw(t)||this.redraw(),this.emit("draw")}setSplitViewport(t,e=[],i=[]){this.canvas.setSplitViewport(t,e,i)}}n(F,"draw"),n(F,"resize");class D extends v{constructor(t){super({autoSamplerDeclaration:!1}),Object.assign(this,{debug:!0,modes:["rgb","single_band"],mode:"rgb",wavelength:[],nplanes:0,nimg:0,blockIndex:null,uboBuffer:null,MAX_SUPPORTED_PLANES:33,MAX_TEXTURES:11}),Object.assign(this,t),this.uniforms={selectedBand:{type:"int",needsUpdate:!0,value:0},bandOutputChannel:{type:"int",needsUpdate:!0,value:0}},this.setMode(this.mode)}setMode(t){if(!this.modes.includes(t))throw new Error("Unknown mode: "+t);const e=this.mode;this.mode=t,this.needsUpdate=!0,this.emit("update",{mode:t,previousMode:e})}init(t){if(t.wavelength){this.wavelength=t.wavelength,this.nplanes=this.wavelength.length,this.nplanes>this.MAX_SUPPORTED_PLANES&&(console.warn(`Warning: ${this.nplanes} planes detected, but only ${this.MAX_SUPPORTED_PLANES} are supported. Some bands will be ignored.`),this.nplanes=this.MAX_SUPPORTED_PLANES),this.nimg=Math.ceil(this.nplanes/3),this.samplers=[];const e=Math.min(this.nimg,this.MAX_TEXTURES);for(let t=0;t<e;t++)this.samplers.push({id:t,name:`plane${t}`,type:"vec3"})}this.needsUpdate=!0}setupCTW(t,e,i,s){if(!t)return;if(null===this.blockIndex&&this.program&&(this.blockIndex=t.getUniformBlockIndex(this.program,"CTWBlock"),this.blockIndex===t.INVALID_INDEX))return void console.error("Failed to get UBO block index for CTWBlock");this.uboBuffer||(this.uboBuffer=t.createBuffer());const n=this.nplanes,r=16*n,o=3*r;t.bindBuffer(t.UNIFORM_BUFFER,this.uboBuffer),t.bufferData(t.UNIFORM_BUFFER,o,t.DYNAMIC_DRAW);const a=new ArrayBuffer(o),l=new Float32Array(a);for(let t=0;t<n;t++)l[4*t]=e[t];const h=r/4;for(let t=0;t<n;t++)l[h+4*t]=i[t];const c=2*r/4;for(let t=0;t<n;t++)l[c+4*t]=s[t];t.bufferSubData(t.UNIFORM_BUFFER,0,l),t.bindBufferBase(t.UNIFORM_BUFFER,0,this.uboBuffer),this.program&&this.blockIndex!==t.INVALID_INDEX&&t.uniformBlockBinding(this.program,this.blockIndex,0),this._currentCTW={red:e,green:i,blue:s}}setSingleBand(t,e=0){if(t<0||t>=this.nplanes)throw new Error(`Band index ${t} out of range [0-${this.nplanes-1}]`);this.setUniform("selectedBand",t),this.setUniform("bandOutputChannel",e),this.setMode("single_band")}setTextureSize(t){}fragShaderSrc(){let t="";for(let e=0;e<this.nimg&&e<this.MAX_TEXTURES;e++)t+=`uniform sampler2D plane${e};\n`;t+=`\n// UBO for Color Twist Weights (CTW)\n// std140 layout requires special alignment\nlayout(std140) uniform CTWBlock {\n  // Each element in std140 array is aligned to vec4 (16 bytes)\n  // We use a vec4 instead of float to make alignment explicit\n  vec4 ctwRedVec4[${this.nplanes}];\n  vec4 ctwGreenVec4[${this.nplanes}];\n  vec4 ctwBlueVec4[${this.nplanes}];\n};\n\n// Uniforms for single band mode\nuniform int selectedBand;\nuniform int bandOutputChannel;\n\nin vec2 v_texcoord;\n\n// Utility function to get a specific band from the multispectral data\n// Using texture() with normalized coordinates for better compatibility\nfloat getBand(int bandIndex) {\n  float result = 0.0;\n  \n  // Handling each possible band with constant indices\n`;for(let e=0;e<this.nplanes;e++){const i=Math.floor(e/3),s=e%3;if(i>=this.MAX_TEXTURES)continue;t+=`    if (bandIndex == ${e}) result = texture(plane${i}, v_texcoord).${0===s?"r":1===s?"g":"b"};\n`}if(t+=`\n   ${this.isLinear?"":"result = srgb2linear(result);"}      \n  return result; // Default return for out-of-range bands\n}\n\n// Check if a band has any non-zero CTW values to optimize memory access\nbool hasNonZeroCTW(int bandIndex) {\n  // Access the x component of each vec4 (where we store the actual value)\n  float r = ctwRedVec4[bandIndex].x;\n  float g = ctwGreenVec4[bandIndex].x;\n  float b = ctwBlueVec4[bandIndex].x;\n  return r != 0.0 || g != 0.0 || b != 0.0;\n}\n\n// Normalize CTW for a single channel\nfloat normalizeCTWChannel(vec4 ctwChannel[${this.nplanes}]) {\n  float totalWeight = 0.0;\n  \n  // Compute total absolute weight for the channel\n  for (int i = 0; i < ${this.nplanes}; i++) {\n      totalWeight += abs(ctwChannel[i].x);\n  }\n  \n  // Return normalization factor (avoid division by zero)\n  return totalWeight > 0.0 ? totalWeight : 1.0;\n}\n\nvec4 data() {\n`,"rgb"===this.mode){t+="\n  // RGB mode - Linear combination with channel-specific normalization\n  vec3 rgb = vec3(0.0);\n  // Normalize weights for each channel\n  //float redNorm = normalizeCTWChannel(ctwRedVec4);\n  //float greenNorm = normalizeCTWChannel(ctwGreenVec4);\n  //float blueNorm = normalizeCTWChannel(ctwBlueVec4);\n  \n  // Calculate linear combination for all channels with optimization\n";for(let e=0;e<this.nplanes;e++)t+=`\n  // Band ${e} processing\n  if (hasNonZeroCTW(${e})) {\n      float value${e} = getBand(${e});\n      rgb.r += value${e} * ctwRedVec4[${e}].x;\n      rgb.g += value${e} * ctwGreenVec4[${e}].x;\n      rgb.b += value${e} * ctwBlueVec4[${e}].x;\n  }`;t+="\n  // Additional normalization to ensure output is in [0,1]\n  //vec3 absRgb = abs(rgb);\n  //float maxVal = max(max(absRgb.r, absRgb.g), absRgb.b);\n  \n  // Normalize to preserve relative magnitudes and sign\n  //if (maxVal > 1.0) {\n  //    rgb /= maxVal;\n  //}\n\n  return vec4(rgb, 1.0);\n"}else"single_band"===this.mode?t+="\n  // Single band mode - Show one band in a specific channel\n  float value = getBand(selectedBand);\n  \n  // Output to specified channel\n  vec3 rgb = vec3(value, value, value);\n  if (bandOutputChannel == 1) rgb = vec3(value, 0.0, 0.0);\n  else if (bandOutputChannel == 2) rgb = vec3(0.0, value, 0.0);\n  else if (bandOutputChannel == 3) rgb = vec3(0.0, 0.0, value);\n  return vec4(rgb, 1.0);\n":t+="\n  // Default mode fallback\n  return vec4(0.5, 0.5, 0.5, 1.0);\n";return t+="\n}",t}createProgram(t){super.createProgram(t),this.program&&(this.blockIndex=t.getUniformBlockIndex(this.program,"CTWBlock"),this.blockIndex===t.INVALID_INDEX?console.error("Uniform block CTWBlock not found"):t.uniformBlockBinding(this.program,this.blockIndex,0))}}class B extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw new Error("Rasters options should be empty!");if(!this.url)throw new Error("Url option is required");if(!this.presets)throw new Error("Presets option is required");this.loadPresets(),this.linearRaster=!0,this.defaultMode=this.defaultMode||"single_band",this.shaders.multispectral=new D,this.setShader("multispectral"),this._currentCTW={red:null,green:null,blue:null},this.info=null,this.loadInfo(this.url)}imageUrl(t,e){let i=this.url.substring(0,this.url.lastIndexOf("/")+1);switch(this.layout.type){case"image":return i+e+".jpg";case"google":return i+e;case"deepzoom":return i+e+".dzi";case"tarzoom":case"itarzoom":return i+e+".tzi";case"zoomify":return i+e+"/ImageProperties.xml";case"iip":return t;case"iiif":throw new Error("Unimplemented");default:throw new Error("Unknown layout: "+this.layout.type)}}async loadInfo(t){try{let i=t;if("iip"==this.layout.type&&(i=(this.server?this.server+"?FIF=":"")+t+"&obj=description"),this.info=await e.loadJSON(i),console.log("Multispectral info loaded:",this.info),!this.info.basename)return this.status="Error: 'basename' is required in the multispectral configuration file",void console.error(this.status);this.info.format&&(this.layout.suffix=this.info.format),this.info.pixelSizeInMM&&(this.pixelSize=this.info.pixelSizeInMM),this.shader.init(this.info),this.info.width&&this.info.height&&(this.width=this.info.width,this.height=this.info.height);const s=this.info.basename;console.log("Using basename:",s);const n=[];if("itarzoom"===this.layout.type){let e=new g({format:"vec3",isLinear:this.linearRaster});this.rasters.push(e),n.push(this.imageUrl(t,s))}else for(let e=0;e<this.shader.nimg;e++){let i=new g({format:"vec3",isLinear:this.linearRaster});this.rasters.push(i);const r=e.toString().padStart(2,"0"),o=this.imageUrl(t,`${s}_${r}`);n.push(o),console.log(`Plane ${e} URL: ${o}`)}n.length>0&&this.layout.setUrls(n),this.setMode(this.defaultMode),this.initDefault()}catch(t){console.error("Error loading multispectral info:",t),this.status=t}}async loadPresets(){if("string"==typeof this.presets&&""!==this.presets.trim()&&(this.presets=await e.loadJSON(this.presets)),"object"!=typeof this.presets)throw new Error("presets not well formed")}info(){return this.info}initDefault(){const t=this.shader.nplanes;if(!t)return;let e=new Float32Array(t).fill(0),i=new Float32Array(t).fill(0),s=new Float32Array(t).fill(0);this._currentCTW.red=e,this._currentCTW.green=i,this._currentCTW.blue=s,"single-band"===this.defaultMode&&this.setSingleBand(0,0)}setMode(t){this.shader&&(this.shader.setMode(t),this.emit("update"))}setSingleBand(t,e=0){this.shader&&(this.shader.setSingleBand(t,e),this.emit("update"))}setCTW(t,e,i){if(!this.shader||!this.gl)return;const s=this.shader.nplanes;if(t.length!==s||e.length!==s||i.length!==s)throw new Error(`CTW arrays must be of length ${s}`);this._currentCTW.red=t,this._currentCTW.green=e,this._currentCTW.blue=i,this.shader.setupCTW(this.gl,t,e,i),this.setMode("rgb")}getPreset(t){if(t in this.presets){const{red:e,green:i,blue:s}=this.presets[t];return{red:e,green:i,blue:s}}return console.warn(`Preset "${t}" not found.`),null}applyPreset(t){if(!this.shader)return;const e=this.getPreset(t);if(!e)throw new Error(`Preset '${t}' not found`);this.setCTW(e.red,e.green,e.blue)}getWavelengths(){return this.shader?this.shader.wavelength:[]}getBandCount(){return this.shader?this.shader.nplanes:0}getAvailablePresets(){return this.presets?Object.keys(this.presets):[]}prepareWebGL(){super.prepareWebGL(),this._currentCTW.red&&this.shader&&this.gl&&this.shader.setupCTW(this.gl,this._currentCTW.red,this._currentCTW.green,this._currentCTW.blue)}getSpectrum(t,e){if(this.isTiledFormat())return this.getTiledSpectrum(t,e);const i=this.getPixelValues(t,e),s=[];if(!i||0===i.length)return new Array(this.shader.nplanes).fill(0);for(let t=0;t<this.info.nplanes;t++){const e=Math.floor(t/3);if(e<i.length){const n=i[e],r=t%3;n&&r<3?s.push(n[r]/255*100):s.push(0)}else s.push(0)}return s}isTiledFormat(){return["deepzoom","deepzoom1px","google","zoomify","iiif","tarzoom"].includes(this.layout.type)}getSpectrum(t,e){const i=this.getPixelValues(t,e),s=new Array(this.shader.nplanes).fill(0);if(!i||0===i.length)return s;for(let t=0;t<this.shader.nplanes;t++){const e=Math.floor(t/3),n=t%3;if(e<i.length){const r=i[e];r&&n<3&&(s[t]=r[n]/255*100)}}return s}}c.prototype.types.multispectral=t=>new B(t);class I extends g{constructor(t){if(super(Object.assign({format:"rgb16ui",debug:!1,useHalfFloat:!1,flipY:!1,premultiplyAlpha:!1},t)),Object.assign(this,{dataLoader:null,dataLoaderOptions:{},statInfo:{}}),t&&Object.assign(this,t),!this._isFormatSupported(this.format))throw new Error(`The format "${this.format}" is not supported by the browser.`);this.debug&&console.log(`Raster16Bit created with format: ${this.format}`)}_getComponentCount(){return!this.format.startsWith("r16")||this.format.startsWith("rg16")||this.format.startsWith("rgb16")||this.format.startsWith("rgba16")?this.format.startsWith("rg16")?2:this.format.startsWith("rgb16")?3:this.format.startsWith("rgba16")?4:(this.format,1):1}async loadImage(t,e){if(!(e instanceof WebGL2RenderingContext))throw new Error("WebGL2 context is required for 16-bit textures");let i;if(this.debug&&console.log(`Raster16Bit.loadImage called for URL: ${t.url}`),this.dataLoader){this.debug&&console.log("Using custom data loader");try{i=await this.dataLoader(t,e,this.dataLoaderOptions),this.statInfo.maxValue=i.statistics.maxValue,this.statInfo.avgLuminance=i.statistics.avgLuminance,this.statInfo.percentileLuminance=i.statistics.percentileLuminance,this.emit("loaded"),this.debug&&console.log(`Data loader returned: ${i.width}x${i.height}, ${i.channels} channels`)}catch(t){throw console.error("Error in data loader:",t),t}}else{this.debug&&console.log("Using default loader mechanism");try{let[i,s]=await super.loadImage(t,e);return s=this.width*this.height*this._getComponentCount()*2,[i,s]}catch(t){throw console.error("Error in default loader:",t),t}}this.width=i.width,this.height=i.height,this.debug&&console.log(`Creating texture: ${this.width}x${this.height}`);return[this._createTextureFromData(e,i.data,i.width,i.height,i.channels),i.width*i.height*i.channels*2]}getStatInfo(){return this.statInfo}_createTextureFromData(t,e,i,s,n){this.debug&&console.log(`Creating texture from data: ${i}x${s}, ${n} channels, data type: ${e.constructor.name}`);const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,this.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,1);const o=this._getFormatParameters(t,n);this.debug&&console.log("Format parameters:",o);try{t.texImage2D(t.TEXTURE_2D,0,o.internalFormat,i,s,0,o.format,o.type,e)}catch(t){throw console.error("Error creating texture:",t),t}return i>1024||s>1024?(t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)):t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this._texture=r,r}_getFormatParameters(t,e){let i,s,n;if(this.format.includes("16f"))switch(n=this.useHalfFloat?t.HALF_FLOAT:t.FLOAT,e){case 1:i=t.R16F,s=t.RED;break;case 2:i=t.RG16F,s=t.RG;break;case 3:i=t.RGB16F,s=t.RGB;break;case 4:i=t.RGBA16F,s=t.RGBA;break;default:throw new Error(`Unsupported channel count: ${e}`)}else if(this.format.includes("16ui"))switch(n=t.UNSIGNED_SHORT,e){case 1:i=t.R16UI,s=t.RED_INTEGER;break;case 2:i=t.RG16UI,s=t.RG_INTEGER;break;case 3:i=t.RGB16UI,s=t.RGB_INTEGER;break;case 4:i=t.RGBA16UI,s=t.RGBA_INTEGER;break;default:throw new Error(`Unsupported channel count: ${e}`)}else if(this.format.includes("16i"))switch(n=t.SHORT,e){case 1:i=t.R16I,s=t.RED_INTEGER;break;case 2:i=t.RG16I,s=t.RG_INTEGER;break;case 3:i=t.RGB16I,s=t.RGB_INTEGER;break;case 4:i=t.RGBA16I,s=t.RGBA_INTEGER;break;default:throw new Error(`Unsupported channel count: ${e}`)}else{if("depth16"!==this.format)throw new Error(`Unsupported format: ${this.format}`);i=t.DEPTH_COMPONENT16,s=t.DEPTH_COMPONENT,n=t.UNSIGNED_SHORT}return{internalFormat:i,format:s,type:n}}_isFormatSupported(t){const e=document.createElement("canvas").getContext("webgl2");if(!e)return console.error("WebGL2 is not supported by this browser."),!1;const i={r16f:{internalFormat:e.R16F,requiredExtensions:["EXT_color_buffer_float"]},rg16f:{internalFormat:e.RG16F,requiredExtensions:["EXT_color_buffer_float"]},rgb16f:{internalFormat:e.RGB16F,requiredExtensions:["EXT_color_buffer_float"]},rgba16f:{internalFormat:e.RGBA16F,requiredExtensions:["EXT_color_buffer_float"]},r16ui:{internalFormat:e.R16UI,requiredExtensions:[]},rg16ui:{internalFormat:e.RG16UI,requiredExtensions:[]},rgb16ui:{internalFormat:e.RGB16UI,requiredExtensions:[]},rgba16ui:{internalFormat:e.RGBA16UI,requiredExtensions:[]},r16i:{internalFormat:e.R16I,requiredExtensions:[]},rg16i:{internalFormat:e.RG16I,requiredExtensions:[]},rgb16i:{internalFormat:e.RGB16I,requiredExtensions:[]},rgba16i:{internalFormat:e.RGBA16I,requiredExtensions:[]},depth16:{internalFormat:e.DEPTH_COMPONENT16,requiredExtensions:[]}}[t];if(!i)return console.error(`Unknown format: ${t}`),!1;for(const s of i.requiredExtensions)if(!e.getExtension(s))return console.error(`Required WebGL extension "${s}" is not supported for format "${t}".`),!1;const s=e.getInternalformatParameter(e.RENDERBUFFER,i.internalFormat,e.SAMPLES);return s&&s.length>0}}class $ extends v{constructor(t){super(t=Object.assign({isLinear:!0,format:"rgba16f"},t)),this.modes=["reinhard","aces","exposure","balanced"],this.mode=t.mode||"reinhard",this.uniforms={whitePoint:{type:"float",needsUpdate:!0,value:1},shadowLift:{type:"float",needsUpdate:!0,value:0},acesContrast:{type:"float",needsUpdate:!0,value:1.6},exposure:{type:"float",needsUpdate:!0,value:1},highlightCompression:{type:"float",needsUpdate:!0,value:1}},this.samplers.push({id:0,name:"source",type:this.format}),this.toneMapOperations={reinhard:"\n                // Enhanced Reinhard with both whitePoint and shadowLift parameters\n                // Apply shadowLift pre-tone mapping to brighten shadows\n                color.rgb = mix(color.rgb, pow(color.rgb, vec3(0.4)), shadowLift);\n\n                // Reinhard tone mapping with more sensitive whitePoint\n                float wp = max(0.1, whitePoint);\n                color.rgb = (color.rgb * (1.0 + color.rgb/(wp))) / (1.0 + color.rgb);\n\n                // Apply shadowLift post-tone mapping for more pronounced effect\n                color.rgb = mix(color.rgb, pow(color.rgb, vec3(0.6)), shadowLift * 0.5);\n                ",aces:"\n                // ACES filmic tone mapping approximation\n                // Based on formula from Krzysztof Narkowicz\n                // https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/\n                // Allows for contrast adjustment with acesContrast parameter\n                \n                // Apply contrast parameter\n                color.rgb *= acesContrast;\n                \n                // ACES tone mapping formula\n                const vec3 a = vec3(2.51);\n                const vec3 b = vec3(0.03);\n                const vec3 c = vec3(2.43);\n                const vec3 d = vec3(0.59);\n                const vec3 e = vec3(0.14);\n                \n                color.rgb = (color.rgb * (a * color.rgb + b)) / (color.rgb * (c * color.rgb + d) + e);\n                \n                // Clamp to prevent artifacts\n                color.rgb = clamp(color.rgb, 0.0, 1.0);\n            ",exposure:"\n                // Apply exposure adjustment\n                // exposure = 1.0 means no change, > 1.0 brightens, < 1.0 darkens\n                color.rgb = vec3(1.0) - exp(-color.rgb * exposure);\n            ",balanced:"\n                // Lift shadows slightly to enhance details in dark areas\n                color.rgb = mix(color.rgb, pow(color.rgb, vec3(0.5)), 0.05);\n\n                // Adaptive scaling for highlights based on highlightCompression\n                float hc = max(0.1, highlightCompression); // Avoid division by zero\n                color.rgb = color.rgb / (color.rgb + vec3(hc));\n\n                // Apply logarithmic compression for highlights\n                color.rgb = log(1.0 + color.rgb) / log(1.0 + hc);\n\n                // Clamp to prevent overexposure\n                color.rgb = clamp(color.rgb, 0.0, 1.0);\n            "},this.samplers&&0!==this.samplers.length||(this.samplers=[{id:0,name:"source",type:"rgba16f"}])}fragShaderSrc(){const t=this.toneMapOperations[this.mode]||this.toneMapOperations.reinhard;return console.log(this.mode),console.log(t),`\nin vec2 v_texcoord;\n\n// Uniforms for tone mapping and enhancements\nuniform float whitePoint;\nuniform float shadowLift;\nuniform float acesContrast;\nuniform float exposure;\nuniform float highlightCompression;\n\nvec4 data() {\n    // Sample the HDR texture (already in linear space)\n    vec4 color = texture(source, v_texcoord);\n    \n    // Apply selected tone mapping operation to compress HDR values\n    ${t}\n    \n    // Return the tone-mapped color in linear space\n    // The final gamma correction will be applied by Canvas.js\n\n    return vec4(color.rgb, color.a);\n}\n`}setWhitePoint(t){this.setUniform("whitePoint",t)}setShadowLift(t){this.setUniform("shadowLift",t)}setAcesContrast(t){this.setUniform("acesContrast",t)}setExposure(t){this.setUniform("exposure",t)}setHighlightCompression(t){this.setUniform("highlightCompression",t)}}class O extends c{constructor(t){if(super(t=Object.assign({format:"rgba16f",autoWhitePoint:!0,debug:!1,mode:"reinhard"},t)),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(this.url)this.layout.setUrls([this.url]);else if(0==this.layout.urls.length)throw"Missing options.url parameter";const e={format:this.format,isLinear:!0,debug:this.debug};this.dataLoader&&(e.dataLoader=this.dataLoader,e.dataLoaderOptions=this.dataLoaderOptions||{});let i=new I(e);i.addEvent("loaded",(()=>{if(this.autoWhitePoint){const t=i.getStatInfo().maxValue?i.getStatInfo().maxValue:1;this.setWhitePoint(t)}this.emit("loaded")})),this.rasters.push(i);let s=new $({label:"HDR",format:this.format,mode:this.mode||"reinhard"});this.shaders={hdr:s},this.setShader("hdr"),this.addControl("whitePoint",[1]),this.addControl("shadowLift",[0]),this.addControl("acesContrast",[1.2]),this.addControl("exposure",[1]),this.addControl("highlightCompression",[1])}setWhitePoint(t,e=1,i="linear"){this.setControl("whitePoint",[t],e,i)}getWhitePoint(){return this.controls.whitePoint.current.value[0]}setShadowLift(t,e=1,i="linear"){this.setControl("shadowLift",[t],e,i)}getShadowLift(){return this.controls.shadowLift.current.value[0]}setAcesContrast(t,e=1,i="linear"){this.setControl("acesContrast",[t],e,i)}getAcesContrast(){return this.controls.acesContrast.current.value[0]}setExposure(t,e=1,i="linear"){this.setControl("exposure",[t],e,i)}getExposure(){return this.controls.exposure.current.value[0]}setHighlightCompression(t,e=1,i="linear"){this.setControl("highlightCompression",[t],e,i)}getHighlightCompression(){return this.controls.highlightCompression.current.value[0]}getStatInfo(){return this.rasters[0].getStatInfo()}interpolateControls(){const t=super.interpolateControls(),e=this.getWhitePoint(),i=this.getShadowLift(),s=this.getAcesContrast(),n=this.getExposure(),r=this.getHighlightCompression();return this.shader.setWhitePoint(e),this.shader.setShadowLift(i),this.shader.setAcesContrast(s),this.shader.setExposure(n),this.shader.setHighlightCompression(r),t}}c.prototype.types.hdr=t=>new O(t);let N="skin/skin.svg",G=null;class j{static setUrl(t){N=t}static async loadSvg(){var t=await fetch(N);if(!t.ok)throw Error("Failed loading "+N+": "+t.statusText);let e=await t.text(),i=new DOMParser;G=i.parseFromString(e,"image/svg+xml").documentElement}static async getElement(t){return G||await j.loadSvg(),G.querySelector(t).cloneNode(!0)}static async appendIcon(t,e){let i=null,s=null;if("string"==typeof e){i=await j.getElement(e),(e=document.createElementNS("http://www.w3.org/2000/svg","svg")).appendChild(i),document.body.appendChild(e),s=i.getBBox();let t=i.transform.baseVal;0==t.numberOfItems&&t.appendItem(e.createSVGTransform()),t.getItem(0).setTranslate(-s.x,-s.y)}else document.body.appendChild(e),s=e.getBBox();return e.setAttribute("viewBox",`-5 -5 ${s.width+10} ${s.height+10}`),e.setAttribute("preserveAspectRatio","xMidYMid meet"),t.appendChild(e),e}}class H{constructor(t){this.units=["km","m","cm","mm","m"],this.allUnits={"m":.001,mm:1,cm:10,m:1e3,km:1e6,in:254,ft:3048},this.precision=2,t&&Object.assign(t,this)}format(t,e){if(0==t)return"";if("px"===e)return Math.floor(t)+e;if(e)return(t/this.allUnits[e]).toFixed(this.precision)+e;let i=null,s=100;for(let e of this.units){let n=this.allUnits[e],r=t<=0?0:Math.abs(Math.log10(t/n)-1);r<s&&(i=e,s=r)}return this.format(t,i)}}class q extends H{constructor(t,i,s){super(s),s=Object.assign(this,{pixelSize:t,viewer:i,width:200,fontSize:24,precision:0},s),Object.assign(this,s),this.svg=e.createSVGElement("svg",{viewBox:`0 0 ${this.width} 30`}),this.svg.classList.add("openlime-scale"),this.line=e.createSVGElement("line",{x1:5,y1:26.5,x2:this.width-5,y2:26.5}),this.text=e.createSVGElement("text",{x:"50%",y:"16px","dominant-basiline":"middle","text-anchor":"middle"}),this.text.textContent="",this.svg.appendChild(this.line),this.svg.appendChild(this.text),this.viewer.containerElement.appendChild(this.svg),this.viewer.addEvent("draw",(()=>{this.updateScale()}))}updateScale(){let t=this.viewer.camera.target.z;if(t==this.lastScaleZoom)return;this.lastScaleZoom=t;let e=this.bestLength(this.width/2,this.width,this.pixelSize,t),i=this.width-e.length;this.line.setAttribute("x1",i/2),this.line.setAttribute("x2",this.width-i/2),this.text.textContent=this.format(e.label)}bestLength(t,e,i,s){i/=s;let n=Math.pow(10,Math.floor(Math.log(e*i)/Math.log(10))),r=n/i;if(r>t)return{length:r,label:n};let o=2*r;if(o>t)return{length:o,label:2*n};let a=5*r;return a>t?{length:a,label:5*n}:{length:0,label:0}}}class V extends H{constructor(t,e,i){super(i),Object.assign(this,{viewer:t,camera:t.camera,overlay:t.overlayElement,pixelSize:e,enabled:!1,priority:100,measure:null,history:[],fontSize:18,markerSize:8,cursor:"crosshair",svg:null,first:null,second:null}),i&&Object.assign(this,i)}start(){this.enabled=!0,this.previousCursor=this.overlay.style.cursor,this.overlay.style.cursor=this.cursor,this.svg||(this.svg=e.createSVGElement("svg",{class:"openlime-ruler"}),this.svgGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.append(this.svgGroup),this.overlay.appendChild(this.svg),this.viewer.addEvent("draw",(()=>this.update())),this.update())}end(){this.enabled=!1,this.overlay.style.cursor=this.previousCursor,this.clear()}clear(){this.svgGroup.replaceChildren([]),this.measure=null,this.history=[]}update(){if(!this.history.length)return;let t=this.camera.getGlCurrentTransform(performance.now()),e=this.camera.glViewport();this.svg.setAttribute("viewBox",`${-e.w/2} ${-e.h/2} ${e.w} ${e.h}`);let i=0,s=0;this.svgGroup.setAttribute("transform",`translate(${t.x} ${t.y}) rotate(${-t.a} 0 0) scale(${t.z} ${t.z}) translate(${i} ${s})`);for(let e of this.history)this.updateMeasure(e,t)}createMarker(t,i){let s=e.createSVGElement("path");return this.svgGroup.appendChild(s),s}updateMarker(t,e,i,s){let n=`M ${e-s} ${i} L ${e+s} ${i} M ${e} ${i-s} L ${e} ${i+s}`;t.setAttribute("d",n)}updateText(t,e){t.text.setAttribute("font-size",e+"px");let i=t.x1-t.x2,s=t.y1-t.y2,n=Math.sqrt(i*i+s*s);n>0&&(i/=n,s/=n),i<0&&(i=-i,s=-s);let r=(t.x1+t.x2)/2,o=(t.y1+t.y2)/2;s/i<0?(r-=.25*s*e,o+=i*e):(o-=.25*e,r+=.25*e),t.text.setAttribute("x",r),t.text.setAttribute("y",o);let a=this.pixelSize,l=null;a||(a=1,l="px"),t.text.textContent=this.format(n*a,l)}createMeasure(t,i){let s={marker1:this.createMarker(t,i),x1:t,y1:i,marker2:this.createMarker(t,i),x2:t,y2:i};return s.line=e.createSVGElement("line",{x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2}),this.svgGroup.appendChild(s.line),s.text=e.createSVGElement("text"),s.text.textContent="",this.svgGroup.appendChild(s.text),s}updateMeasure(t,e){let i=window.devicePixelRatio*this.markerSize/e.z;this.updateMarker(t.marker1,t.x1,t.y1,i),this.updateMarker(t.marker2,t.x2,t.y2,i);let s=window.devicePixelRatio*this.fontSize/e.z;this.updateText(t,s);for(let e of["x1","y1","x2","y2"])t.line.setAttribute(e,t[e])}fingerSingleTap(t){if(!this.enabled)return!1;const{x:e,y:i}=o.fromViewportToScene({x:t.layerX,y:t.layerY},this.camera,!1);this.measure?(this.measure.x2=e,this.measure.y2=i,this.measure=null):(this.measure=this.createMeasure(e,i),this.history.push(this.measure)),this.update(),t.preventDefault()}fingerHover(t){if(!this.enabled||!this.measure)return!1;const{x:e,y:i}=o.fromViewportToScene({x:t.layerX,y:t.layerY},this.camera,!1);this.measure.x2=e,this.measure.y2=i,this.update(),t.preventDefault()}}class W{constructor(t,e){let i=t.camera;Object.assign(this,{viewer:t,camera:t.camera,skin:"skin/skin.svg",autoFit:!0,actions:{home:{title:"Home",display:!0,key:"Home",task:t=>{i.boundingBox&&i.fitCameraBox(250)}},fullscreen:{title:"Fullscreen",display:!0,key:"f",task:t=>{this.toggleFullscreen()}},layers:{title:"Layers",display:!0,key:"Escape",task:t=>{this.toggleLayers()}},zoomin:{title:"Zoom in",display:!1,key:"+",task:t=>{i.deltaZoom(250,1.25,0,0)}},zoomout:{title:"Zoom out",display:!1,key:"-",task:t=>{i.deltaZoom(250,.8,0,0)}},rotate:{title:"Rotate",display:!1,key:"r",task:t=>{i.rotate(250,-45)}},light:{title:"Light",display:"auto",key:"l",task:t=>{this.toggleLightController()}},ruler:{title:"Ruler",display:!1,task:t=>{this.toggleRuler()}},help:{title:"Help",display:!1,key:"?",task:t=>{this.toggleHelp(this.actions.help)},html:"<p>Help here!</p>"},snapshot:{title:"Snapshot",display:!1,task:t=>{this.snapshot()}}},postInit:()=>{},showScale:!0,pixelSize:null,unit:null,attribution:null,lightcontroller:null,showLightDirections:!1,enableTooltip:!0,controlZoomMessage:null,menu:[]}),Object.assign(this,e),this.autoFit&&this.viewer.canvas.addEvent("updateSize",(()=>this.viewer.camera.fitCameraBox(0))),this.panzoom=new A(this.viewer.camera,{priority:-1e3,activeModifiers:[0,1],controlZoom:null!=this.controlZoomMessage}),this.controlZoomMessage&&this.panzoom.addEvent("nowheel",(()=>{this.showOverlayMessage(this.controlZoomMessage)})),this.viewer.addController(this.panzoom),this.menu.push({section:"Layers"});for(let[t,e]of Object.entries(this.viewer.canvas.layers)){let i=[];for(let s of e.getModes()){let n={button:s,mode:s,layer:t,onclick:()=>{e.setMode(s)},status:()=>e.getMode()==s?"active":""};"specular"==s&&e.shader.setSpecularExp&&(n.list=[{slider:"",oninput:t=>{e.shader.setSpecularExp(t.target.value)}}]),i.push(n)}let s={button:e.label||t,onclick:()=>{this.setLayer(e)},status:()=>e.visible?"active":"",layer:t};i.length>1&&(s.list=i),e.annotations&&(s.list=[],s.list.push(e.annotationsEntry())),this.menu.push(s)}let s=new M(((t,e)=>{let i=[t,e,Math.sqrt(1-t*t+e*e)];for(let i of n)i.setLight([t,e],0);this.showLightDirections&&this.updateLightDirections(t,e),this.emit("lightdirection",i)}),{active:!1,activeModifiers:[2,4],control:"light",onPanStart:this.showLightDirections?()=>{Object.values(this.viewer.canvas.layers).filter((t=>null!=t.annotations)).forEach((t=>t.setVisible(!1))),this.enableLightDirections(!0)}:null,onPanEnd:this.showLightDirections?()=>{Object.values(this.viewer.canvas.layers).filter((t=>null!=t.annotations)).forEach((t=>t.setVisible(!0))),this.enableLightDirections(!1)}:null,relative:!0});s.priority=0,this.viewer.pointerManager.onEvent(s),this.lightcontroller=s;let n=[];for(let[t,e]of Object.entries(this.viewer.canvas.layers))e.controls.light&&n.push(e);if(n.length){this.createLightDirections();for(let t of n)s.setPosition(.5,.5),t.controllers.push(s)}queueMicrotask?queueMicrotask((()=>{this.init()})):setTimeout((()=>{this.init()}),0)}showOverlayMessage(t,e=2e3){if(this.overlayMessage)return clearTimeout(this.overlayMessage.timeout),void(this.overlayMessage.timeout=setTimeout((()=>this.destroyOverlayMessage()),e));let i=document.createElement("div");i.classList.add("openlime-overlaymsg"),i.innerHTML=`<p>${t}</p>`,this.viewer.containerElement.appendChild(i),this.overlayMessage={background:i,timeout:setTimeout((()=>this.destroyOverlayMessage()),e)}}destroyOverlayMessage(){this.overlayMessage.background.remove(),this.overlayMessage=null}getMenuLayerEntry(t){return this.menu.find((e=>e.layer==t))}createLightDirections(){this.lightDirections=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.lightDirections.setAttribute("viewBox","-100, -100, 200 200"),this.lightDirections.setAttribute("preserveAspectRatio","xMidYMid meet"),this.lightDirections.style.display="none",this.lightDirections.classList.add("openlime-lightdir");for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){let i=document.createElementNS("http://www.w3.org/2000/svg","line");i.pos=[35*t,35*e],this.lightDirections.appendChild(i)}this.viewer.containerElement.appendChild(this.lightDirections)}updateLightDirections(t,e){let i=[...this.lightDirections.children];for(let s of i){let i=s.pos[0],n=s.pos[1];s.setAttribute("x1",.6*i-0*t),s.setAttribute("y1",.6*n+0*e),s.setAttribute("x2",i/.6+60*t),s.setAttribute("y2",n/.6-60*e)}}enableLightDirections(t){this.lightDirections.style.display=t?"block":"none"}init(){(async()=>{if(document.addEventListener("keydown",(t=>this.keyDown(t)),!1),document.addEventListener("keyup",(t=>this.keyUp(t)),!1),this.createMenu(),this.updateMenu(),this.viewer.canvas.addEvent("update",(()=>this.updateMenu())),this.actions.light&&"auto"===this.actions.light.display&&(this.actions.light.display=!0),this.skin&&await this.loadSkin(),this.setupActions(),this.showScale)if(this.pixelSize)this.scalebar=new q(this.pixelSize,this.viewer);else{let t=()=>{for(const[t,e]of Object.entries(this.viewer.canvas.layers))if(this.pixelSize=e.pixelSizePerMM(),this.pixelSize){this.scalebar=new q(this.pixelSize,this.viewer);break}};this.viewer.canvas.ready?t():this.viewer.canvas.addEvent("ready",t)}if(this.attribution){var t=document.createElement("p");t.classList.add("openlime-attribution"),t.innerHTML=this.attribution,this.viewer.containerElement.appendChild(t)}for(let t of Object.values(this.viewer.canvas.layers)){this.setLayer(t);break}this.actions.light&&this.actions.light.active&&this.toggleLightController(),this.actions.layers&&this.actions.layers.active&&this.toggleLayers(),this.postInit()})().catch((t=>{throw console.log(t),Error("Something failed")}))}keyDown(t){}keyUp(t){if((t.target==document.body||null==t.target.closest("input, textarea"))&&!t.defaultPrevented)for(const e of Object.values(this.actions))if("key"in e&&e.key==t.key)return t.preventDefault(),void e.task(t)}async loadSkin(){let t=document.createElement("div");t.classList.add("openlime-toolbar"),this.viewer.containerElement.appendChild(t);for(let[i,s]of Object.entries(this.actions))if(!0===s.display&&("icon"in s?"string"==typeof s.icon&&(e.isSVGString(s.icon)?s.icon=e.SVGFromString(s.icon):s.icon=await e.loadSVG(s.icon),s.icon.classList.add("openlime-button")):s.icon=".openlime-"+i,s.element=await j.appendIcon(t,s.icon),this.enableTooltip)){let t=document.createElementNS("http://www.w3.org/2000/svg","title");t.textContent=s.title,s.element.appendChild(t)}}setupActions(){for(let[t,e]of Object.entries(this.actions)){let t=e.element;t&&t.addEventListener("click",(t=>{e.task(t),t.preventDefault()}))}let t=document.querySelectorAll(".openlime-layers-button");for(let e of t){let t=e.getAttribute("data-layer");t&&e.addEventListener("click",(()=>{this.setLayer(this.viewer.layers[t])}))}}setActiveControllers(t){for(let e of this.viewer.controllers)e.active=t}toggleLightController(t){let e=this.viewer.containerElement.classList.toggle("openlime-light-active",t);this.lightActive=e,this.setActiveControllers(!e);for(let t of Object.values(this.viewer.canvas.layers))for(let i of t.controllers)"light"==i.control&&(i.active=!0,i.activeModifiers=e?[0,2,4]:[2,4])}toggleFullscreen(){let t=this.viewer.canvasElement,e=this.viewer.containerElement;e.classList.toggle("openlime-fullscreen-active")?(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e):((document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen).call(document),document.querySelector(".openlime-scale > line"),this.viewer.resize(t.offsetWidth,t.offsetHeight));this.viewer.resize(t.offsetWidth,t.offsetHeight)}toggleRuler(){const t=this.viewer.containerElement.querySelector(".openlime-button.openlime-ruler").classList.toggle("openlime-ruler-active");this.setActiveControllers(!t),this.ruler||(this.ruler=new V(this.viewer,this.pixelSize),this.viewer.pointerManager.onEvent(this.ruler)),this.ruler.enabled?this.ruler.end():this.ruler.start()}toggleHelp(t,e){t.dialog?t.dialog.toggle(e):(t.dialog=new X(this.viewer.containerElement,{modal:!0,class:"openlime-help-dialog"}),t.dialog.setContent(t.html))}snapshot(){var t=document.createElement("a");t.setAttribute("href",this.viewer.canvas.canvasElement.toDataURL()),t.setAttribute("download","snapshot.png"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}createEntry(t){"id"in t||(t.id="entry_"+this.entry_count++);let e=`id="${t.id}"`,i="tooltip"in t?`title="${t.tooltip}"`:"",s="classes"in t?t.classes:"",n="";if("title"in t)n+=`<h2 ${e} class="openlime-title ${s}" ${i}>${t.title}</h2>`;else if("section"in t)n+=`<h3 ${e} class="openlime-section ${s}" ${i}>${t.section}</h3>`;else if("html"in t)n+=`<div ${e} class="${s}">${t.html}</div>`;else if("button"in t){let r="group"in t?`data-group="${t.group}"`:"",o="layer"in t?`data-layer="${t.layer}"`:"",a="mode"in t?`data-mode="${t.mode}"`:"";n+=o&&!a?`<a href="#" ${e} ${r} ${o} ${a} ${i} class="openlime-entry openlime-layer-entry ${s}">\n\t\t\t\t\t\t\t<span class="openlime-layer-icon"></span>\n\t\t\t\t\t\t\t<span class="openlime-layer-name">${t.button}</span>\n\t\t\t\t\t\t\t<span class="openlime-layer-status"></span>\n\t\t\t\t\t</a>`:a?`<a href="#" ${e} ${r} ${o} ${a} ${i} class="openlime-entry openlime-mode-entry ${s}">\n\t\t\t\t\t\t\t<span class="openlime-mode-icon"></span>\n\t\t\t\t\t\t\t<span class="openlime-mode-name">${t.button}</span>\n\t\t\t\t\t</a>`:`<a href="#" ${e} ${r} ${o} ${a} ${i} class="openlime-entry ${s}">${t.button}</a>`}else if("slider"in t){let i="value"in t?t.value:50;n+=`\n\t\t\t<div class="openlime-slider-container" data-slider-id="${t.id}">\n\t\t\t\t\t<input type="range" min="1" max="100" value="${i}" class="openlime-slider ${s}" ${e}>\n\t\t\t\t\t<span class="openlime-slider-value">${i}</span>\n\t\t\t</div>`}if("list"in t){let e=`<div class="openlime-list ${s}">`;for(let i of t.list)e+=this.createEntry(i);e+="</div>",n+=e}return n}addEntryCallbacks(t){if(t.element=this.layerMenu.querySelector("#"+t.id),t.onclick&&t.element.addEventListener("click",(e=>{t.onclick();const i=t.element.querySelector(".openlime-slider-value");if(i){const e=t.element.querySelector(".openlime-slider");e&&(i.textContent=e.value)}})),t.element.classList.contains("openlime-slider")){const e=t.element.closest(".openlime-slider-container");if(e){const i=e.querySelector(".openlime-slider-value");i&&(i.textContent=t.element.value,t.element.addEventListener("input",(e=>{i.textContent=e.target.value,t.oninput&&t.oninput(e)})))}}else t.oninput&&t.element.addEventListener("input",(e=>{t.oninput(e)}));if(t.oncreate&&t.oncreate(),"list"in t)for(let e of t.list)this.addEntryCallbacks(e)}updateEntry(t){let e=t.status?t.status():"";if(t.element.classList.toggle("active","active"==e),t.layer){const i=t.element.querySelector(".openlime-layer-status");i&&(i.textContent="active"==e?"":"")}if("list"in t)for(let e of t.list)this.updateEntry(e)}createMenu(){this.entry_count=0;let t='<div class="openlime-layers-menu">\n\t\t\t\t\t\t\t\t\t<div class="openlime-layers-header">\n\t\t\t\t\t\t\t\t\t\t\t<h2>Layer Controls</h2>\n\t\t\t\t\t\t\t\t\t\t\t<button class="openlime-layers-close-btn"></button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="openlime-layers-content">';for(let e of this.menu)t+=this.createEntry(e);t+="</div></div>";let e=document.createElement("template");e.innerHTML=t.trim(),this.layerMenu=e.content.firstChild,this.viewer.containerElement.appendChild(this.layerMenu);const i=this.layerMenu.querySelector(".openlime-layers-close-btn");i&&i.addEventListener("click",(()=>this.toggleLayers()));for(let t of this.menu)this.addEntryCallbacks(t)}toggleLayers(){this.layerMenu.classList.contains("open")?(this.layerMenu.classList.add("closing"),setTimeout((()=>{this.layerMenu.classList.remove("open"),this.layerMenu.classList.remove("closing")}),300)):(this.layerMenu.classList.add("open"),this.updateMenu())}updateMenu(){for(let t of this.menu)this.updateEntry(t)}setLayer(t){if("string"==typeof t&&(t=this.viewer.canvas.layers[t]),t.overlay)t.setVisible(!t.visible);else for(let e of Object.values(this.viewer.canvas.layers))if(!e.overlay){e.setVisible(e==t);for(let i of e.controllers)"light"==i.control&&(i.active=this.lightActive&&e==t)}this.updateMenu(),this.viewer.redraw()}addUniformUI(t,e,i,s,n=0,r=100,o=0,a=1,l=100){let h=null,c=null;if(t.shader&&t.shader.uniforms&&t.shader.uniforms[e])h=t.shader.uniforms[e];else if(t.shader&&t.shader.filters)for(const i of t.shader.filters){for(const[t,s]of Object.entries(i.uniforms))if(t===e||t===i.uniformName(e)){h=s,c=i;break}if(h)break}if(!h)return console.warn(`Uniform '${e}' not found in layer ${t.id||"unknown"}`),!1;const d=this.getMenuLayerEntry(t.id);if(!d)return console.warn(`Layer menu entry for '${t.id||"unknown"}' not found`),!1;if(d.list||(d.list=[]),!d.uniformsSection){(d.list.some((t=>t.mode))||d.list.length>0)&&d.list.push({html:'<div class="openlime-uniform-separator"></div>'}),d.list.push({html:'<div class="openlime-uniform-section">Parameters</div>'}),d.uniformsSection=!0}const u=`uniform_${t.id}_${e.replace(/[^a-zA-Z0-9]/g,"_")}_${s}`,p={id:u,uniformName:e,uniformFilter:c,html:`<div class="openlime-uniform-container">\n\t\t\t\t\t\t\t<div class="openlime-uniform-name">${i}</div>\n\t\t\t\t\t\t\t<div class="openlime-uniform-control-wrapper" data-uniform="${e}" data-control-type="${s}"></div>\n\t\t\t\t\t\t </div>`};d.uniformControls||(d.uniformControls={});const m=h.value,f=t=>"checkbox"===s?t:o+(t-n)*(a-o)/(r-n),g=t=>"checkbox"===s?t:n+(t-o)*(r-n)/(a-o);p.mapToUniform=f,p.mapToDisplay=g,p.uiMin=o,p.uiMax=a,p.uiMinDisplayed=n,p.uiMaxDisplayed=r,p.uiType=s;const v=g(m);return p.oncreate=()=>{const i=p.element.querySelector(".openlime-uniform-control-wrapper");if(d.uniformControls[e]||(d.uniformControls[e]=[]),d.uniformControls[e].push({id:u,element:i,entry:p}),"checkbox"===s){i.innerHTML=`\n\t\t\t\t\t\t\t<label class="openlime-uniform-checkbox-wrapper">\n\t\t\t\t\t\t\t\t\t<input type="checkbox" class="openlime-uniform-checkbox" ${m?"checked":""}>\n\t\t\t\t\t\t\t\t\t<span class="openlime-uniform-checkbox-custom"></span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t`;i.querySelector(".openlime-uniform-checkbox").addEventListener("change",(i=>{const s=i.target.checked;this.updateUniformValue(t,e,s,c),this.updateRelatedControls(d,e,s,u)}))}else if("line-edit"===s){i.innerHTML=`\n\t\t\t\t\t\t\t<input type="text" class="openlime-uniform-line-edit" value="${v.toFixed(2)}">\n\t\t\t\t\t`;i.querySelector(".openlime-uniform-line-edit").addEventListener("change",(i=>{const s=parseFloat(i.target.value);if(isNaN(s))return void(i.target.value=v.toFixed(2));const o=Math.max(n,Math.min(r,s)),a=f(o);o!==s&&(i.target.value=o.toFixed(2)),this.updateUniformValue(t,e,a,c),this.updateRelatedControls(d,e,a,u)}))}else if("slider"===s){const s=l>0?((r-n)/l).toFixed(6):"any";i.innerHTML=`\n\t\t\t\t\t\t\t<div class="openlime-uniform-slider-container">\n\t\t\t\t\t\t\t\t\t<input type="range" class="openlime-uniform-slider" \n\t\t\t\t\t\t\t\t\t\t\t\t min="${n}" max="${r}" \n\t\t\t\t\t\t\t\t\t\t\t\t step="${s}" value="${v}">\n\t\t\t\t\t\t\t\t\t<span class="openlime-uniform-slider-value">${v.toFixed(2)}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t`;const o=i.querySelector(".openlime-uniform-slider"),a=i.querySelector(".openlime-uniform-slider-value");o.addEventListener("input",(i=>{const s=parseFloat(i.target.value);a.textContent=s.toFixed(2);const n=f(s);this.updateUniformValue(t,e,n,c),this.updateRelatedControls(d,e,n,u)}))}},d.list.push(p),this.layerMenu&&this.updateMenu(),!0}updateRelatedControls(t,e,i,s){if(t.uniformControls&&t.uniformControls[e])for(const n of t.uniformControls[e]){if(n.id===s)continue;const t=n.entry,e=n.element,r=t.mapToDisplay(i);if("checkbox"===t.uiType){const t=e.querySelector(".openlime-uniform-checkbox");t&&(t.checked=i)}else if("line-edit"===t.uiType){const t=e.querySelector(".openlime-uniform-line-edit");t&&(t.value=r.toFixed(2))}else if("slider"===t.uiType){const t=e.querySelector(".openlime-uniform-slider"),i=e.querySelector(".openlime-uniform-slider-value");t&&(t.value=r),i&&(i.textContent=r.toFixed(2))}}}updateUniformValue(t,e,i,s=null){s?e.startsWith(`u_${s.name}_`)?t.shader.setUniform(e,i):s.setUniform(e,i):t.shader.setUniform(e,i),t.emit("update")}}class X{constructor(t,e){Object.assign(this,{dialog:null,content:null,container:t,modal:!1,class:null,visible:!1,backdropEvents:!0},e),this.create()}create(){let t=document.createElement("div");t.classList.add("openlime-dialog-background");let e=document.createElement("div");e.classList.add("openlime-dialog"),this.class&&e.classList.add(this.class),(async()=>{let t=await j.appendIcon(e,".openlime-close");t.classList.add("openlime-close"),t.addEventListener("click",(()=>this.hide()))})();let i=document.createElement("div");i.classList.add("openlime-dialog-content"),e.append(i),this.modal?(this.backdropEvents&&t.addEventListener("click",(e=>{e.target==t&&this.hide()})),t.appendChild(e),this.container.appendChild(t),this.element=t):(this.container.appendChild(e),this.element=e),this.dialog=e,this.content=i,this.hide()}setContent(t){"string"==typeof t?this.content.innerHTML=t:this.content.replaceChildren(t)}show(){this.element.classList.remove("hidden"),this.visible=!0}hide(){this.element.classList.add("hidden"),this.visible=!1,this.emit("closed")}fade(t){this.element.classList.toggle("fading")}toggle(t){const e=void 0===t?!this.visible:t;this.element.classList.toggle("hidden",!e),this.visible=e}}n(X,"closed"),n(W,"lightdirection");class Y extends v{constructor(t){super({}),Object.assign(this,{modes:["light","normals","diffuse","gray_diffuse","specular"],mode:"normal",type:["ptm","hsh","sh","rbf","bln"],colorspaces:["lrgb","rgb","mrgb","mycc"],nplanes:null,yccplanes:null,njpegs:null,material:null,lights:null,sigma:null,ndimensions:null,scale:null,bias:null,basis:null,lweights:null}),Object.assign(this,t),this.relight&&this.init(this.relight),this.setMode("light")}setMode(t){if(!this.modes.includes(t))throw Error("Unknown mode: "+t);this.mode=t,this.needsUpdate=!0}updateUniforms(t){"light"==this.mode||this.uniforms.base1.value||(this.lightWeights([.612,.354,.707],"base"),this.lightWeights([-.612,.354,.707],"base1"),this.lightWeights([0,-.707,.707],"base2")),super.updateUniforms(t)}setLight(t){if(!this.uniforms.light)throw"Shader not initialized, wait on layer ready event for setLight.";let e=t[0],i=t[1],s=1;if("sh"==this.type){let n=3.1415,r=t[1]*(n/2),o=t[0]*n;e=Math.cos(r)*Math.cos(o),s=Math.cos(r)*Math.sin(o),i=Math.sin(r)}else{let t=Math.sqrt(e*e+i*i);t>1&&(e/=t,i/=t),s=Math.sqrt(Math.max(0,1-e*e-i*i))}return t=[e,i,s],"light"==this.mode&&this.lightWeights(t,"base"),this.setUniform("light",t),t}setSpecularExp(t){this.setUniform("specular_exp",t)}init(t){for(Object.assign(this,t),"mycc"==this.colorspace?this.nplanes=this.yccplanes[0]+this.yccplanes[1]+this.yccplanes[2]:this.yccplanes=[0,0,0],this.planes=[],this.njpegs=0;3*this.njpegs<this.nplanes;)this.njpegs++;for(let t=0;t<this.njpegs;t++)this.samplers.push({id:t,name:"plane"+t,type:"vec3"});this.normals&&this.samplers.push({id:this.njpegs,name:"normals",type:"vec3"}),this.material=this.materials[0],this.lights&&(this.lights,new Float32Array(this.lights)),"rbf"==this.type&&(this.ndimensions=this.lights.length/3),"bilinear"==this.type&&(this.ndimensions=this.resolution*this.resolution,this.type="bln"),this.scale=this.material.scale,this.bias=this.material.bias,["mrgb","mycc"].includes(this.colorspace)&&this.loadBasis(this.basis),this.uniforms={light:{type:"vec3",needsUpdate:!0,size:3,value:[0,0,1]},specular_exp:{type:"float",needsUpdate:!1,size:1,value:10},bias:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.bias},scale:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.scale},base:{type:"vec3",needsUpdate:!0,size:this.nplanes},base1:{type:"vec3",needsUpdate:!1,size:this.nplanes},base2:{type:"vec3",needsUpdate:!1,size:this.nplanes}},this.lightWeights([0,0,1],"base")}lightWeights(t,e,i){let s;switch(this.type){case"ptm":s=tt.lightWeights(t);break;case"hsh":s=et.lightWeights(t);break;case"sh":s=it.lightWeights(t);break;case"rbf":s=nt.lightWeights(t,this);break;case"bln":s=rt.lightWeights(t,this)}this.setUniform(e,s,i)}baseLightOffset(t,e,i){return 3*(t*this.ndimensions+e)+i}basePixelOffset(t,e,i,s){return 3*(t*this.resolution*this.resolution+(e+i*this.resolution))+s}loadBasis(t){let e=new Uint8Array(t);this.basis=new Float32Array(t.length),new Float32Array(e.length);for(let t=0;t<this.nplanes+1;t++)for(let i=0;i<this.ndimensions;i++)for(let s=0;s<3;s++){let n=this.baseLightOffset(t,i,s);this.basis[n]=0==t?e[n]/255:(e[n]-127)/this.material.range[t-1]}}fragShaderSrc(t){let e="vec3",i=`\n\n\n#define np1 ${this.nplanes+1}\n\nin vec2 v_texcoord;\n\nconst mat3 T = mat3(8.1650e-01, 4.7140e-01, 4.7140e-01,\n\t-8.1650e-01, 4.7140e-01,  4.7140e-01,\n\t-1.6222e-08, -9.4281e-01, 4.7140e-01);\n\nuniform vec3 light;\nuniform float specular_exp;\nuniform vec3 bias[np1];\nuniform vec3 scale[np1];\n\nuniform ${e} base[np1];\nuniform ${e} base1[np1];\nuniform ${e} base2[np1];\n`;switch("mycc"==this.colorspace&&(i+=`\n\nconst int ny0 = ${this.yccplanes[0]};\nconst int ny1 = ${this.yccplanes[1]};\n`),this.colorspace){case"lrgb":i+=Z.render(this.njpegs);break;case"rgb":i+=K.render(this.njpegs);break;case"mrgb":i+=Q.render(this.njpegs);break;case"mycc":i+=J.render(this.njpegs,this.yccplanes[0])}if(i+="\n\nvec4 data() {\n\n","light"==this.mode)i+="\n\tvec4 color = render(base);\n\tcolor = srgb2linear(color);\n";else switch(i+="\n\tvec4 color;\n",this.normals?i+="\n\tvec3 normal = texture(normals, v_texcoord).xyz * 2.0 - 1.0;\n\tnormal = normalize(normal);\t\t\n\t//vec3 normal = (texture(normals, v_texcoord).zyx *2.0) - 1.0;\n\t//normal.z = sqrt(1.0 - normal.x*normal.x - normal.y*normal.y);\n":i+="\n\tvec3 normal;\n\tnormal.x = dot(render(base ).xyz, vec3(1));\n\tnormal.y = dot(render(base1).xyz, vec3(1));\n\tnormal.z = dot(render(base2).xyz, vec3(1));\n\tnormal = normalize(T * normal);\n",this.mode){case"normals":i+="\n\tnormal = (normal + 1.0)*0.5;\n\tcolor = vec4(normal.xyz, 1.0);\n";break;case"diffuse":"lrgb"==this.colorspace||"rgb"==this.colorspace?i+="\nvec4 diffuse = texture(plane0, v_texcoord);\nfloat s = dot(light, normal);\ncolor = vec4(s * diffuse.xyz, 1);\ncolor = srgb2linear(color);\n":i+="\ncolor = vec4(vec3(dot(light, normal)), 1);\n";break;case"gray_diffuse":i+="\ncolor = vec4(vec3(dot(light, normal)), 1);\n";break;default:i+="\n\tfloat s = pow(dot(light, normal), specular_exp);\n\t//color = vec4(render(base).xyz*s, 1.0);\n\tcolor = vec4(s, s, s, 1.0);\n"}return i+="\n\t\treturn color;\n}",i}}class Z{static render(t){let e="\nvec4 render(vec3 base[np1]) {\n\tfloat l = 0.0;\n";for(let i=1,s=0;i<t;i++,s+=3)e+=`\n\t{\n\t\tvec4 c = texture(plane${i}, v_texcoord);\n\t\tl += base[${s}].x*(c.x - bias[${i}].x)*scale[${i}].x;\n\t\tl += base[${s+1}].x*(c.y - bias[${i}].y)*scale[${i}].y;\n\t\tl += base[${s+2}].x*(c.z - bias[${i}].z)*scale[${i}].z;\n\t}\n`;return e+="\n\tvec3 basecolor = (texture(plane0, v_texcoord).xyz - bias[0])*scale[0];\n\n\treturn l*vec4(basecolor, 1);\n}\n",e}}class K{static render(t){let e="\nvec4 render(vec3 base[np1]) {\n\tvec4 rgb = vec4(0, 0, 0, 1);";for(let i=0;i<t;i++)e+=`\n\t{\n\t\tvec4 c = texture(plane${i}, v_texcoord);\n\t\trgb.x += base[${i}].x*(c.x - bias[${i}].x)*scale[${i}].x;\n\t\trgb.y += base[${i}].y*(c.y - bias[${i}].y)*scale[${i}].y;\n\t\trgb.z += base[${i}].z*(c.z - bias[${i}].z)*scale[${i}].z;\n\t}\n`;return e+="\n\treturn rgb;\n}\n",e}}class Q{static render(t){let e="\nvec4 render(vec3 base[np1]) {\n\tvec3 rgb = base[0];\n\tvec4 c;\n\tvec3 r;\n";for(let i=0;i<t;i++)e+=`\tc = texture(plane${i}, v_texcoord);\n\tr = (c.xyz - bias[${i}])* scale[${i}];\n\n\trgb += base[${i}*3+1]*r.x;\n\trgb += base[${i}*3+2]*r.y;\n\trgb += base[${i}*3+3]*r.z;\n`;return e+="\n\treturn vec4(rgb, 1);\n}\n",e}}class J{static render(t,e){let i="\nvec3 toRgb(vec3 ycc) {\n \tvec3 rgb;\n\trgb.g = ycc.r + ycc.b/2.0;\n\trgb.b = ycc.r - ycc.b/2.0 - ycc.g/2.0;\n\trgb.r = rgb.b + ycc.g;\n\treturn rgb;\n}\n\nvec4 render(vec3 base[np1]) {\n\tvec3 rgb = base[0];\n\tvec4 c;\n\tvec3 r;\n";for(let s=0;s<t;s++)i+=`\n\n\tc = texture(plane${s}, v_texcoord);\n\n\tr = (c.xyz - bias[${s}])* scale[${s}];\n`,i+=s<e?`\n\trgb.x += base[${s}*3+1].x*r.x;\n\trgb.y += base[${s}*3+2].y*r.y;\n\trgb.z += base[${s}*3+3].z*r.z;\n`:`\n\trgb.x += base[${s}*3+1].x*r.x;\n\trgb.x += base[${s}*3+2].x*r.y;\n\trgb.x += base[${s}*3+3].x*r.z;\n`;return i+="\t\n\treturn vec4(toRgb(rgb), 1);\n}\n",i}}class tt{static lightWeights(t){let e=[1,t[0],t[1],t[0]*t[0],t[0]*t[1],t[1]*t[1]],i=new Float32Array(18);for(let t=0;t<18;t++)i[3*t]=i[3*t+1]=i[3*t+2]=e[t];return i}}class et{static minElevation=.15;static lightWeights(t){let e=3.1415,i=Math.atan2(t[1],t[0]);i<0&&(i=2*e+i);let s=Math.min(Math.acos(t[2]),e/2-this.minElevation),n=Math.cos(i),r=Math.cos(s),o=r*r,a=[1/Math.sqrt(2*e),Math.sqrt(6/e)*(n*Math.sqrt(r-o)),Math.sqrt(3/(2*e))*(2*r-1),Math.sqrt(6/e)*(Math.sqrt(r-o)*Math.sin(i)),Math.sqrt(30/e)*(Math.cos(2*i)*(-r+o)),Math.sqrt(30/e)*(n*(2*r-1)*Math.sqrt(r-o)),Math.sqrt(5/(2*e))*(1-6*r+6*o),Math.sqrt(30/e)*((2*r-1)*Math.sqrt(r-o)*Math.sin(i)),Math.sqrt(30/e)*((-r+o)*Math.sin(2*i))],l=new Float32Array(27);for(let t=0;t<27;t++)l[3*t]=l[3*t+1]=l[3*t+2]=a[t];return l}}class it{static lightWeights(t){let e=3.1415,i=.5*Math.sqrt(3/e),s=.5*Math.sqrt(15/e),n=[.5/Math.sqrt(e),i*t[0],i*t[2],i*t[1],s*t[0]*t[1],s*t[0]*t[2],.5*Math.sqrt(5/e)*(3*t[2]*t[2]-1),s*t[1]*t[2],.5*s*(t[1]*t[1]-t[0]*t[0])],r=new Float32Array(27);for(let t=0;t<27;t++)r[3*t]=r[3*t+1]=r[3*t+2]=n[t];return r}}class st{constructor(t,e=1,i=5){this.samples=t,this.alpha=e,this.beta=2}distance(t,e){const i=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+s*s+n*n)}smoothMinDist(t){let e=0,i=0;for(const{dist:s}of t){const t=Math.exp(-this.beta*s);e+=s*t,i+=t}return e/i}findNeighbors(t,e,i){return this.samples.map(((s,n)=>({index:n,dist:this.distance(s,[t,e,i])}))).sort(((t,e)=>t.dist-e.dist))}rbf(t,e){return Math.exp(-e*t*t)}weights(t,e,i){const s=this.findNeighbors(t,e,i),n=this.smoothMinDist(s),r=this.alpha/n;let o=0,a=[];for(const{index:t,dist:e}of s){const i=this.rbf(e,r);a.push([t,i]),o+=i}for(let t of a)t[1]/=o;return a}}class nt{static lightWeights(t,e){let i=nt.rbf(t,e),s=e.nplanes,n=new Float32Array(3*(s+1));for(let t=0;t<s+1;t++)for(let s=0;s<3;s++)for(let r=0;r<i.length;r++){let o=e.baseLightOffset(t,i[r][0],s);n[3*t+s]+=i[r][1]*e.basis[o]}return n}static rbf(t,e){let i=new Array(e.ndimensions),s=new Array(e.ndimensions);for(let t=0;t<i.length;t++){let i=e.lights[3*t+0],n=e.lights[3*t+1],r=e.lights[3*t+2];s[t]=[i,n,r]}return new st(s,8,24).weights(t[0],t[1],t[2])}}class rt{static lightWeights(t,e){let i=e.nplanes,s=Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]),n=(t[0]+t[1])/s,r=(t[1]-t[0])/s;n=(n+1)/2,r=(r+1)/2,n*=e.resolution-1,r*=e.resolution-1;let o=Math.min(e.resolution-2,Math.max(0,Math.floor(n))),a=Math.min(e.resolution-2,Math.max(0,Math.floor(r))),l=n-o,h=r-a,c=(1-l)*(1-h),d=l*(1-h),u=(1-l)*h,p=l*h,m=new Float32Array(3*(i+1));for(let t=0;t<i+1;t++)for(let i=0;i<3;i++){let s=e.basePixelOffset(t,o,a,i),n=e.basePixelOffset(t,o+1,a,i),r=e.basePixelOffset(t,o,a+1,i),l=e.basePixelOffset(t,o+1,a+1,i);m[3*t+i]=c*e.basis[s]+d*e.basis[n]+u*e.basis[r]+p*e.basis[l]}return m}}class ot extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(!this.url)throw"Url option is required";this.shaders.rti=new Y({normals:this.normals}),this.setShader("rti"),this.addControl("light",[0,0]),this.worldRotation=0,this.loadJson(this.url)}imageUrl(t,e){let i=this.url.substring(0,this.url.lastIndexOf("/")+1);switch(this.layout.type){case"image":return i+e+".jpg";case"google":return i+e;case"deepzoom":return i+e+".dzi";case"tarzoom":return i+e+".tzi";case"itarzoom":return i+"planes.tzi";case"zoomify":return i+e+"/ImageProperties.xml";case"iip":return t;case"iiif":throw Error("Unimplemented");default:throw Error("Unknown layout: "+layout.type)}}setLight(t,e){this.setControl("light",t,e)}loadJson(t){(async()=>{let e=t;"iip"==this.layout.type&&(e=(this.server?this.server+"?FIF=":"")+t+"&obj=description");var i=await fetch(e);if(!i.ok)return void(this.status="Failed loading "+e+": "+i.statusText);let s=await i.json();this.layout.suffix=s.format,s.pixelSizeInMM&&(this.pixelSize=s.pixelSizeInMM),this.shader.init(s);let n=[];for(let e=0;e<this.shader.njpegs;e++){let i=this.layout.imageUrl(t,"plane_"+e);n.push(i);let s=new g({format:"vec3",isLinear:!0});this.rasters.push(s)}if(this.normals){let e=this.layout.imageUrl(t,"normals");n.push(e);let i=new g({format:"vec3",isLinear:!0});this.rasters.push(i)}this.layout.setUrls(n)})().catch((t=>{console.log(t),this.status=t}))}interpolateControls(){let t=super.interpolateControls();if(!t){let t=this.controls.light.current.value,e=s.rotate(t[0],t[1],this.worldRotation*Math.PI);this.shader.setLight([e.x,e.y])}return t}draw(t,e){return this.worldRotation=t.a+this.transform.a,super.draw(t,e)}}c.prototype.types.rti=t=>new ot(t);class at extends v{constructor(t){super({}),Object.assign(this,{modes:["light"],mode:"light",nplanes:null,scale:null,bias:null}),Object.assign(this,t),this.samplers=[{id:1,name:"u_texture_1",type:"vec3"},{id:2,name:"u_texture_2",type:"vec3"},{id:3,name:"u_texture_3",type:"vec3"}],this.uniforms={lights:{type:"vec2",needsUpdate:!0,size:2,value:[0,0]},min:{type:"vec3",needsUpdate:!0,size:3,value:[0,0,0]},max:{type:"vec3",needsUpdate:!0,size:3,value:[1,1,1]},layer1_weights:{type:"vec4",needsUpdate:!0,size:this.c*this.n/4},layer1_biases:{type:"vec4",needsUpdate:!0,size:this.n/4},layer2_weights:{type:"vec4",needsUpdate:!0,size:this.n*this.n/4},layer2_biases:{type:"vec4",needsUpdate:!0,size:this.n/4},layer3_weights:{type:"vec4",needsUpdate:!0,size:3*this.n/4},layer3_biases:{type:"vec3",needsUpdate:!0,size:1}}}createProgram(t){super.createProgram(t),this.position_location=t.getAttribLocation(this.program,"a_position"),this.texcoord_location=t.getAttribLocation(this.program,"a_texcoord")}setLight(t){this.setUniform("lights",t)}init(){this.lightWeights([0,0,1],"base")}setShaderInfo(t,e,i,s,n){this.samples=t,this.planes=e,this.n=i,this.c=s,this.colorspace=n}vertShaderSrc(t){return"#version 300 es\nin vec2 a_position;\nin vec2 a_texcoord;\nout vec2 v_texcoord;\nvoid main() {\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}"}fragShaderSrc(t){return`\nvec4 inputs[${this.c/4}];    // 12/4\nvec4 output1[${this.n/4}];  // 52/4\nvec4 output2[${this.n/4}];  // 52/4\nvec3 output3;\n\nin vec2 v_texcoord;\nuniform vec2 lights;\n\nuniform vec4 layer1_weights[${this.c*this.n/4}]; // 12*52/4\nuniform vec4 layer1_biases[${this.n/4}];  // 52/4\nuniform vec4 layer2_weights[${this.n*this.n/4}]; // 52*52/4\nuniform vec4 layer2_biases[${this.n/4}];  // 52/4\nuniform vec4 layer3_weights[${3*this.n/4}];  // 52*3/4\nuniform vec3 layer3_biases;\n\nuniform vec3 min[${this.planes/3}];\nuniform vec3 max[${this.planes/3}];\n\nfloat elu(float a){\n\treturn (a > 0.0) ? a : (exp(a) - 1.0);\n}\n\n\nvec4 relightCoeff(vec3 color_1, vec3 color_2, vec3 color_3) {\n\t// Rescaling features\n    color_1 = color_1 * (max[0] - min[0]) + min[0];\n    color_2 = color_2 * (max[1] - min[1]) + min[1];\n    color_3 = color_3 * (max[2] - min[2]) + min[2];\n\n\t// building input\n\tinputs[0] = vec4(color_1, color_2.x);\n\tinputs[1] = vec4(color_2.yz, color_3.xy);\n\tinputs[2] = vec4(color_3.z, lights, 0.0);\n\n\tfloat sum = 0.0;\n\n\t// layer 1 - 11 x 49\n\tfor (int i=0; i < ${this.n}; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.c/4}; j++){\n\t\t\tsum += dot(inputs[j], layer1_weights[${this.c/4}*i+j]);\n\t\t}\n\t\toutput1[i/4][i%4] = elu(sum + layer1_biases[i/4][i%4]);\n\t}\n\t\n\t// layer 2 - 49 x 49\n\tfor (int i=0; i < ${this.n}; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.n/4}; j++){\n\t\t\tsum += dot(output1[j], layer2_weights[${this.n/4}*i+j]);\n\t\t}\n\t\toutput2[i/4][i%4] = elu(sum + layer2_biases[i/4][i%4]);\n\t}\n\n\t// layer 3 - 49 x 3\n\tfor (int i=0; i < 3; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.n/4}; j++){\n\t\t\tsum += dot(output2[j], layer3_weights[${this.n/4}*i+j]);\n\t\t}\n\t\toutput3[i] = sum + layer3_biases[i];\n\t}\n\treturn vec4(output3.${this.colorspace}, 1.0);\n}\n\nvec4 relight(vec2 v) {\n\tvec3 color_1 = texture(u_texture_1, v).${this.colorspace};\n\tvec3 color_2 = texture(u_texture_2, v).${this.colorspace};\n\tvec3 color_3 = texture(u_texture_3, v).${this.colorspace};\n\treturn relightCoeff(color_1, color_2, color_3);\n}\n\n\nvec4 data() {\n\treturn relight(v_texcoord);\n}\nvec4 data1() {\n\tvec2 uv = v_texcoord;\n\tbool showDiff = false;\n\tbool showA = false;\n\tif(v_texcoord.x > 0.5) {\n\t\tshowDiff = true;\n\t\tuv.x -= 0.5;\n\t}\n\tif(v_texcoord.y > 0.5) {\n\t\tshowA = true;\n\t\tuv.y -= 0.5;\n\t}\n\tvec2 o = floor(uv*128.0)/128.0;\n\tfloat step = 1.0/256.0;\n\n\tvec4 a = vec4(0, 0, 0, 0);\n\tvec3 color_1 = vec3(0, 0, 0);\n\tvec3 color_2 = vec3(0, 0, 0);\n\tvec3 color_3 = vec3(0, 0, 0);\n\n\tfor(float y = 0.0; y <= step; y = y + step) {\n\t\tfor(float x = 0.0; x <= step; x = x + step) {\n\t\t\tvec2 d = o + vec2(x, y);\n\t\t\ta += 0.25*relight(d);\n\n\t\t\tcolor_1 += texture(u_texture_1, d).${this.colorspace};\n\t\t\tcolor_2 += texture(u_texture_2, d).${this.colorspace};\n\t\t\tcolor_3 += texture(u_texture_3, d).${this.colorspace};\n\t\t}\n\t}\n\tvec4 b = relightCoeff(0.25*color_1, 0.25*color_2, 0.25*color_3);\n\tfloat diff = 255.0*length((a - b).xyz);\n\tif(showDiff) {\n\t\tif(diff < 10.0) {\n\t\t\treturn vec4(0.0, 0.0, 0.0, 1.0);\n\t\t} else if (diff < 20.0) {\n\t\t\treturn vec4(0.0, 0.0, 1.0, 1.0);\n\t\t} else if(diff < 40.0) {\n\t\t\treturn vec4(0.0, 1.0, 0.0, 1.0);\n\t\t} else\n\t\t\treturn vec4(1.0, 0.0, 0.0, 1.0);\n\t} \n\tif(showA)\n\t\treturn a;\n\treturn b;\n}\n\n\t\t`}}class lt extends c{constructor(t){super(t||{}),this.currentRelightFraction=1,this.maxTiles=40,this.relighted=!1,this.convergenceSpeed=1.2,this.addControl("light",[0,0]),this.worldRotation=0,this.activeFramebuffer=null;let e=[null,this.layout.imageUrl(this.url,"plane_1"),this.layout.imageUrl(this.url,"plane_2"),this.layout.imageUrl(this.url,"plane_3")];this.layout.setUrls(e);for(let t of e){let t=new g({format:"vec3"});this.rasters.push(t)}this.imageShader=new v({label:"Rgb",samplers:[{id:0,name:"source",type:"vec3",load:!1}]}),this.neuralShader=new at,this.shaders={standard:this.imageShader,neural:this.neuralShader},this.setShader("neural"),this.neuralShader.setLight([0,0]),(async()=>{await this.loadNeural(this.url)})()}setLight(t,e){this.setControl("light",t,e)}loadTile(t,e){this.shader=this.neuralShader,super.loadTile(t,e)}async loadNeural(t){await this.initialize(t)}async initialize(t){const e=await this.loadJSON(t);this.max=e.max.flat(1),this.min=e.min.flat(1),this.width=e.width,this.height=e.height;let i={};for(let t=0;t<3;t++){let s="layer"+(t+1);i[s+"_weights"]=e.weights[t],i[s+"_biases"]=e.biases[t]}for(const[t,e]of Object.entries(i))this.neuralShader.setUniform(t,e);this.neuralShader.setUniform("min",this.min),this.neuralShader.setUniform("max",this.max);let s=e.samples,n=e.planes+2;for(;s%4!=0;)s++;for(;n%4!=0;)n++;this.neuralShader.setShaderInfo(e.samples,e.planes,s,n,e.colorspace),this.networkParameters=i}setCoords(){let t=this.gl,e=new Float32Array([-1,-1,-1,1,1,1,1,-1]);this.coords_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.coords_buffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);let i=new Float32Array([0,0,0,1,1,1,1,0]);this.texCoords_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texCoords_buffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)}async loadJSON(t){const e=await fetch(t);return await e.json()}draw(t,e){if("ready"!=this.status)return!0;if(this.worldRotation=t.a+this.transform.a,void 0!==this.networkParameters){let i=this.relightFraction;this.relighted&&(this.canvas.fps>1.5*this.canvas.targetfps?this.currentRelightFraction=Math.min(1,this.currentRelightFraction*this.convergenceSpeed):this.canvas.fps<.75*this.canvas.targetfps&&(this.currentRelightFraction=Math.max(this.currentRelightFraction/this.convergenceSpeed,1/128),this.convergenceSpeed=Math.max(1.05,Math.pow(this.convergenceSpeed,.9)),console.log("fps slow: ",this.canvas.fps,this.currentRelightFraction))),this.refineTimeout&&clearTimeout(this.refineTimeout),this.currentRelightFraction<.75&&0==this.refine&&(this.refineTimeout=setTimeout((()=>{this.emit("update"),this.refine=!0}),Math.max(400,4e3/this.canvas.fps))),this.relightFraction=this.refine?1:this.currentRelightFraction,this.relightFraction=Math.round(8*this.relightFraction)/8;let s=this.relightFraction!=i,n=Math.round((this.layout.tilesize||this.layout.width)*this.relightFraction),r=Math.round((this.layout.tilesize||this.layout.height)*this.relightFraction);this.refine=!1;let o=this.layout.available(e,t,this.transform,0,this.mipmapBias,this.tiles),a=Object.values(o);if(0==a.length)return;if(s)for(let t of a)t.neuralUpdated=!1;this.relighted=!1,this.totTiles=0,this.totPixels=0;for(let t of a)t.neuralUpdated&&!s||(this.relighted||(this.relighted=!0,this.preRelight([e.x,e.y,e.dx,e.dy],n,r,s)),this.relightTile(t,n,r,s),this.totPixels+=n*r,this.totTiles+=1);this.relighted&&this.postRelight(),this.relighted=this.relighted&&!this.refine}this.shader=this.imageShader;let i=super.draw(t,e);return this.shader=this.neuralShader,i}preRelight(t,e,i){let s=this.gl;if(this.neuralShader.program)s.useProgram(this.neuralShader.program);else{this.neuralShader.createProgram(s),s.useProgram(this.neuralShader.program);for(var n=0;n<this.neuralShader.samplers.length;n++)s.uniform1i(this.neuralShader.samplers[n].location,n)}this.neuralShader.updateUniforms(s),this.coords_buffer||this.setCoords(),s.bindBuffer(s.ARRAY_BUFFER,this.coords_buffer),s.vertexAttribPointer(this.neuralShader.position_location,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.texCoords_buffer),s.vertexAttribPointer(this.neuralShader.texcoord_location,2,s.FLOAT,!1,0,0),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.BLEND),this.framebuffer||(this.framebuffer=s.createFramebuffer()),this.activeFramebuffer=this.canvas.getActiveFramebuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this.framebuffer),this.backupViewport=t,s.viewport(0,0,e,i)}postRelight(){this.gl,this.canvas.setActiveFramebuffer(this.activeFramebuffer);let t=this.backupViewport;this.gl.viewport(t[0],t[1],t[2],t[3])}relightTile(t,e,i,s){let n=this.gl,r=null==t.tex[0];if(r){let e=t.tex[0]=n.createTexture();n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}(s||r)&&(n.bindTexture(n.TEXTURE_2D,t.tex[0]),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,i,0,n.RGBA,n.UNSIGNED_BYTE,null));for(var o=0;o<this.neuralShader.samplers.length;o++){let e=this.neuralShader.samplers[o].id;n.activeTexture(n.TEXTURE0+o),n.bindTexture(n.TEXTURE_2D,t.tex[e])}n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t.tex[0],0),n.drawArrays(n.TRIANGLE_FAN,0,4),t.neuralUpdated=!0}interpolateControls(){if(super.interpolateControls())return!0;let t=this.controls.light.current.value,e=s.rotate(t[0],t[1],this.worldRotation*Math.PI);t=[e.x,e.y],this.neuralShader.setLight(t);for(let[t,e]of this.tiles)e.neuralUpdated=!1;return!1}}c.prototype.types.neural=t=>new lt(t);class ht extends v{constructor(t){super(t),this.modes=["color","diffuse","specular","normals","monochrome"],this.mode="color",Object.assign(this,t);const e="linear"==this.colorspaces.kd?0:1,i="linear"==this.colorspaces.ks?0:1,s=t.brightness?t.brightness:1,n=t.gamma?t.gamma:2.2,r=t.alphaLimits?t.alphaLimits:[.01,.5],o=t.monochromeMaterial?t.monochromeMaterial:[.8,.79,.75],a=t.kAmbient?t.kAmbient:.02;this.uniforms={uLightInfo:{type:"vec4",needsUpdate:!0,size:4,value:[.1,.1,.9,0]},uAlphaLimits:{type:"vec2",needsUpdate:!0,size:2,value:r},uBrightnessGamma:{type:"vec2",needsUpdate:!0,size:2,value:[s,n]},uInputColorSpaceKd:{type:"int",needsUpdate:!0,size:1,value:e},uInputColorSpaceKs:{type:"int",needsUpdate:!0,size:1,value:i},uMonochromeMaterial:{type:"vec3",needsUpdate:!0,size:3,value:o},uKAmbient:{type:"float",needsUpdate:!0,size:1,value:a}},this.innerCode="",this.setMode(this.mode)}setLight(t){this.setUniform("uLightInfo",t)}setMode(t){switch(this.mode=t,t){case"color":this.innerCode="vec3 linearColor = (kd + ks * spec) * NdotL;\n\t\t\t\tlinearColor += kd * uKAmbient; // HACK! adding just a bit of ambient";break;case"diffuse":this.innerCode="vec3 linearColor = kd;";break;case"specular":this.innerCode="vec3 linearColor = clamp((ks * spec) * NdotL, 0.0, 1.0);";break;case"normals":this.innerCode="vec3 linearColor = (N+vec3(1.))/2.;\n\t\t\t\tapplyGamma = false;";break;case"monochrome":this.innerCode="vec3 linearColor = kd * NdotL + kd * uKAmbient;";break;default:throw console.log("ShaderBRDF: Unknown mode: "+t),Error("ShaderBRDF: Unknown mode: "+t)}this.needsUpdate=!0}fragShaderSrc(t){let e=-1!=this.samplers.findIndex((t=>"uTexKd"==t.name))&&"monochrome"!=this.mode,i=-1!=this.samplers.findIndex((t=>"uTexGloss"==t.name))&&"monochrome"!=this.mode;return`\n\n#define NULL_NORMAL vec3(0,0,0)\n#define SQR(x) ((x)*(x))\n#define PI (3.14159265359)\n#define ISO_WARD_EXPONENT (4.0)\n\nin vec2 v_texcoord;\n\nuniform vec4 uLightInfo; // [x,y,z,w] (if .w==0 => Directional, if w==1 => Spot)\nuniform vec2 uAlphaLimits;\nuniform vec2 uBrightnessGamma;\nuniform vec3 uMonochromeMaterial;\nuniform float uKAmbient;\n\nuniform int uInputColorSpaceKd; // 0: Linear; 1: sRGB\nuniform int uInputColorSpaceKs; // 0: Linear; 1: sRGB\n\nvec3 getNormal(const in vec2 texCoord) {\n\tvec3 n = texture(uTexNormals, texCoord).xyz;\n\tn = 2. * n - vec3(1.);\n\tfloat norm = length(n);\n\tif(norm < 0.5) return NULL_NORMAL;\n\telse return n/norm;\n}\n\nvec3 linear2sRGB(vec3 linearRGB) {\n    bvec3 cutoff = lessThan(linearRGB, vec3(0.0031308));\n    vec3 higher = vec3(1.055)*pow(linearRGB, vec3(1.0/2.4)) - vec3(0.055);\n    vec3 lower = linearRGB * vec3(12.92);\n    return mix(higher, lower, cutoff);\n}\n\nvec3 sRGB2Linear(vec3 sRGB) {\n    bvec3 cutoff = lessThan(sRGB, vec3(0.04045));\n    vec3 higher = pow((sRGB + vec3(0.055))/vec3(1.055), vec3(2.4));\n    vec3 lower = sRGB/vec3(12.92);\n    return mix(higher, lower, cutoff);\n}\n\nfloat ward(in vec3 V, in vec3 L, in vec3 N, in vec3 X, in vec3 Y, in float alpha) {\n\n\tvec3 H = normalize(V + L);\n\n\tfloat H_dot_N = dot(H, N);\n\tfloat sqr_alpha_H_dot_N = SQR(alpha * H_dot_N);\n\n\tif(sqr_alpha_H_dot_N < 0.00001) return 0.0;\n\n\tfloat L_dot_N_mult_N_dot_V = dot(L,N) * dot(N,V);\n\tif(L_dot_N_mult_N_dot_V <= 0.0) return 0.0;\n\n\tfloat spec = 1.0 / (4.0 * PI * alpha * alpha * sqrt(L_dot_N_mult_N_dot_V));\n\t\n\t//float exponent = -(SQR(dot(H,X)) + SQR(dot(H,Y))) / sqr_alpha_H_dot_N; // Anisotropic\n\tfloat exponent = -SQR(tan(acos(H_dot_N))) / SQR(alpha); // Isotropic\n\t\n\tspec *= exp( exponent );\n\n\treturn spec;\n}\n\n\nvec4 data() {\n\tvec3 N = getNormal(v_texcoord);\n\tif(N == NULL_NORMAL) {\n\t\treturn vec4(0.0);\n\t}\n\n\tvec3 L = (uLightInfo.w == 0.0) ? normalize(uLightInfo.xyz) : normalize(uLightInfo.xyz - gl_FragCoord.xyz);\n\tvec3 V = vec3(0.0,0.0,1.0);\n    vec3 H = normalize(L + V);\n\tfloat NdotL = max(dot(N,L),0.0);\n\n\tvec3 kd = ${e?"texture(uTexKd, v_texcoord).xyz":"uMonochromeMaterial"};\n\tvec3 ks = ${-1!=this.samplers.findIndex((t=>"uTexKs"==t.name))?"texture(uTexKs, v_texcoord).xyz":"vec3(0.0, 0.0, 0.0)"};\n\tif(uInputColorSpaceKd == 1) {\n\t\tkd = sRGB2Linear(kd);\n\t}\n\tif(uInputColorSpaceKs == 1) {\n\t\tks = sRGB2Linear(ks);\n\t}\n\tkd /= PI;\n\n\tfloat gloss = ${i?"texture(uTexGloss, v_texcoord).x":"0.0"};\n\tfloat minGloss = 1.0 - pow(uAlphaLimits[1], 1.0 / ISO_WARD_EXPONENT);\n\tfloat maxGloss = 1.0 - pow(uAlphaLimits[0], 1.0 / ISO_WARD_EXPONENT);\n\n\tfloat alpha = pow(1.0 - gloss * (maxGloss - minGloss) - minGloss, ISO_WARD_EXPONENT);\n\t\n\t\n\tvec3 e = vec3(0.0,0.0,1.0);\n\tvec3 T = normalize(cross(N,e));\n\tvec3 B = normalize(cross(N,T));\n\tfloat spec = ward(V, L, N, T, B, alpha);\n\t\n\tbool applyGamma = false;\n\n\t${this.innerCode}\n\n\tvec3 finalColor = applyGamma ? pow(linearColor * uBrightnessGamma[0], vec3(1.0/uBrightnessGamma[1])) : linearColor;\n\n\treturn vec4(finalColor, 1.0);\n}\n`}}class ct extends c{constructor(t){if(super(t=Object.assign({brightness:1,gamma:2.2,alphaLimits:[.01,.5],monochromeMaterial:[.8,.79,.75],kAmbient:.1},t)),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(!this.channels)throw"channels option is required";if(!this.channels.kd||!this.channels.normals)throw"kd and normals channels are required";this.colorspaces||(console.log("LayerBRDF: missing colorspaces: force both to linear"),this.colorspaces.kd="linear",this.colorspaces.ks="linear");let e=0,i=[],s=[],n={kd:{format:"vec3",name:"uTexKd"},ks:{format:"vec3",name:"uTexKs"},normals:{format:"vec3",name:"uTexNormals"},gloss:{format:"float",name:"uTexGloss"}};for(let t in this.channels)this.rasters.push(new g({format:n[t].format,isLinear:!0})),s.push({id:e,name:n[t].name}),i[e]=this.channels[t],e++;this.layout.setUrls(i),this.addControl("light",[0,0]);let r=new ht({label:"Rgb",samplers:s,colorspaces:this.colorspaces,brightness:this.brightness,gamma:this.gamma,alphaLimits:this.alphaLimits,monochromeMaterial:this.monochromeMaterial,kAmbient:this.kAmbient});this.shaders.brdf=r,this.setShader("brdf")}static projectToSphere(t){let e=t[0],i=t[1],s=e*e+i*i;if(s>1){let t=Math.sqrt(s);e/=t,i/=t,s=1}return[e,i,Math.sqrt(1-s)]}static projectToFlattenedSphere(t){const e=.8*.8,i=.8*Math.SQRT1_2,s=i*i;let n=Math.min(Math.max(t[0],-1),1),r=Math.min(Math.max(t[1],-1),1),o=0,a=n*n+r*r;o=a<s?Math.sqrt(e-a):s/Math.sqrt(a);let l=Math.sqrt(a+o*o);return[n/l,r/l,o/l]}setLight(t,e,i="linear"){this.setControl("light",t,e,i)}interpolateControls(){let t=super.interpolateControls(),e=ct.projectToFlattenedSphere(this.controls.light.current.value);return this.shader.setLight([e[0],e[1],e[2],0]),t}}c.prototype.types.brdf=t=>new ct(t);class dt extends v{constructor(t){super(t),this.samplers=[{id:0,name:"source0"},{id:1,name:"source1"}],this.uniforms={u_lens:{type:"vec4",needsUpdate:!0,size:4,value:[0,0,100,10]},u_width_height:{type:"vec2",needsUpdate:!0,size:2,value:[1,1]},u_border_color:{type:"vec4",needsUpdate:!0,size:4,value:[.8,.8,.8,1]},u_border_enable:{type:"bool",needsUpdate:!0,size:1,value:!1}},this.label="ShaderLens",this.needsUpdate=!0,this.overlayLayerEnabled=!1}setOverlayLayerEnabled(t){this.overlayLayerEnabled=t,this.needsUpdate=!0}setLensUniforms(t,e,i,s){this.setUniform("u_lens",t),this.setUniform("u_width_height",e),this.setUniform("u_border_color",i),this.setUniform("u_border_enable",s)}fragShaderSrc(t){let e="";return this.overlayLayerEnabled&&(e="vec4 c1 = texture(source1, v_texcoord);\n            if (r > u_lens.z) {\n                float k = (c1.r + c1.g + c1.b) / 3.0;\n                c1 = vec4(k, k, k, c1.a);\n            } else if (u_border_enable && r > innerBorderRadius) {\n                // Preserve border keeping c1 alpha at zero\n                c1.a = 0.0; \n            }\n            color = color * (1.0 - c1.a) + c1 * c1.a;\n            "),`\n\n        uniform vec4 u_lens; // [cx, cy, radius, border]\n        uniform vec2 u_width_height; // Keep wh to map to pixels. TexCoords cannot be integer unless using texture_rectangle\n        uniform vec4 u_border_color;\n        uniform bool u_border_enable;\n        in vec2 v_texcoord;\n\n        vec4 lensColor(in vec4 c_in, in vec4 c_border, in vec4 c_out,\n            float r, float R, float B) {\n            vec4 result;\n            if (u_border_enable) {\n                float B_SMOOTH = B < 8.0 ? B/8.0 : 1.0;\n                if (r<R-B+B_SMOOTH) {\n                    float t=smoothstep(R-B, R-B+B_SMOOTH, r);\n                    result = mix(c_in, c_border, t);\n                } else if (r<R-B_SMOOTH) {\n                    result = c_border;  \n                } else {\n                    float t=smoothstep(R-B_SMOOTH, R, r);\n                    result = mix(c_border, c_out, t);\n                }\n            } else {\n                result = (r<R) ? c_in : c_out;\n            }\n            return result;\n        }\n\n        vec4 data() {\n            vec4 color;\n            float innerBorderRadius = (u_lens.z - u_lens.w);\n            float dx = v_texcoord.x * u_width_height.x - u_lens.x;\n            float dy = v_texcoord.y * u_width_height.y - u_lens.y;\n            float r = sqrt(dx*dx + dy*dy);\n\n            vec4 c_in = texture(source0, v_texcoord);\n            vec4 c_out = u_border_color; c_out.a=0.0;\n            \n            color = lensColor(c_in, u_border_color, c_out, r, u_lens.z, u_lens.w);\n\n            ${e}\n            return color;\n        }\n        `}vertShaderSrc(t){return"#version 300 es\n \n\nin vec4 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\nvoid main() {\n\tgl_Position = a_position;\n    v_texcoord = a_texcoord;\n}"}}class ut extends x{constructor(t){if(super(t=Object.assign({overlay:!0,radius:100,borderColor:[.078,.078,.078,1],borderWidth:12,borderEnable:!1,dashboard:null,isLinear:!0},t)),!this.camera)throw console.log("Missing camera"),"Missing Camera";let e=new dt;2==this.layers.length&&e.setOverlayLayerEnabled(!0),this.shaders.lens=e,this.setShader("lens"),this.addControl("center",[0,0]),this.addControl("radius",[this.radius,0]),this.addControl("borderColor",this.borderColor),this.addControl("borderWidth",[this.borderWidth]),this.oldRadius=-9999,this.oldCenter=[-9999,-9999],this.useGL=!0,this.dashboard&&(this.dashboard.lensLayer=this)}setVisible(t){this.dashboard&&(this.dashboard.container.style.display=t?"block":"none"),super.setVisible(t)}removeOverlayLayer(){this.layers.length=1,this.shader.setOverlayLayerEnabled(!1)}setBaseLayer(t){t?(this.layers[0]=t,this.emit("update")):console.warn("Attempting to set null base layer")}setOverlayLayer(t){t?(this.layers[1]=t,this.layers[1].setVisible(!0),this.shader.setOverlayLayerEnabled(!0),this.regenerateFrameBuffers()):console.warn("Attempting to set null overlay layer")}regenerateFrameBuffers(){const t=this.layout.width,e=this.layout.height;this.deleteFramebuffers(),this.layout.width=t,this.layout.height=e,this.createFramebuffers()}setRadius(t,e=100,i="linear"){this.setControl("radius",[t,0],e,i)}getRadius(){return this.controls.radius.current.value[0]}setCenter(t,e,i=100,s="linear"){this.setControl("center",[t,e],i,s)}getCurrentCenter(){const t=this.controls.center.current.value;return{x:t[0],y:t[1]}}getTargetCenter(){const t=this.controls.center.target.value;return{x:t[0],y:t[1]}}getBorderColor(){return this.controls.borderColor.current.value}getBorderWidth(){return this.controls.borderWidth.current.value[0]}draw(t,e){let i=this.interpolateControls();const s=this.getCurrentCenter(),n=this.getRadius(),r=this.getBorderColor();this.dashboard&&(this.dashboard.update(s.x,s.y,n),this.oldCenter=s,this.oldRadius=n);for(let t of this.layers)if("ready"!=t.status)return!1;if(!this.shader)throw"Shader not specified!";let o=this.gl,a=this.getLensViewport(t,e),l=this.getOverlayLayerViewport(t,e);null!=l&&(a=this.joinViewports(a,l)),o.viewport(a.x,a.y,a.dx,a.dy),this.framebuffers.length&&this.layout.width==e.w&&this.layout.height==e.h||(this.deleteFramebuffers(),this.layout.width=e.w,this.layout.height=e.h,this.createFramebuffers());var h=[0,0,0,0];o.clearColor(h[0],h[1],h[2],h[3]);const c=this.canvas.getActiveFramebuffer();for(let e=0;e<this.layers.length;e++)o.bindFramebuffer(o.FRAMEBUFFER,this.framebuffers[e]),o.clear(o.COLOR_BUFFER_BIT),this.layers[e].draw(t,a);this.canvas.setActiveFramebuffer(c);const d=this.getLensInViewportCoords(t,e);this.shader.setLensUniforms(d,[e.w,e.h],r,this.borderEnable),this.prepareWebGL();for(let t=0;t<this.layers.length;t++)o.uniform1i(this.shader.samplers[t].location,t),o.activeTexture(o.TEXTURE0+t),o.bindTexture(o.TEXTURE_2D,this.textures[t]);const u=a.x/a.w,p=a.y/a.h,m=(a.x+a.dx)/a.w,f=(a.y+a.dy)/a.h;return this.updateTileBuffers(new Float32Array([-1,-1,0,-1,1,0,1,1,0,1,-1,0]),new Float32Array([u,p,u,f,m,f,m,p])),o.drawElements(o.TRIANGLES,6,o.UNSIGNED_SHORT,0),o.viewport(e.x,e.y,e.dx,e.dy),i}getLensViewport(t,e){const i=this.getCurrentCenter(),s=o.fromSceneToViewport(i,this.camera,this.useGL),n=this.getRadius()*t.z;return{x:Math.floor(s.x-n)-1,y:Math.floor(s.y-n)-1,dx:Math.ceil(2*n)+2,dy:Math.ceil(2*n)+2,w:e.w,h:e.h}}getOverlayLayerViewport(t,e){let i=null;if(2==this.layers.length){let t=this.layers[1].boundingBox();const s=o.fromSceneToViewport({x:t.xLow,y:t.yLow},this.camera,this.useGL),n=o.fromSceneToViewport({x:t.xHigh,y:t.yHigh},this.camera,this.useGL),r=Math.min(Math.max(0,Math.floor(s.x)),e.w),a=Math.min(Math.max(0,Math.floor(s.y)),e.h);i={x:r,y:a,dx:Math.min(Math.max(0,Math.ceil(n.x)),e.w)-r,dy:Math.min(Math.max(0,Math.ceil(n.y)),e.h)-a,w:e.w,h:e.h}}return i}joinViewports(t,e){const i=Math.min(t.x,e.x),s=Math.max(t.x+t.dx,e.x+e.dx),n=Math.min(t.y,e.y);return{x:i,y:n,dx:s-i,dy:Math.max(t.y+t.dy,e.y+e.dy)-n,w:t.w,h:t.h}}getLensInViewportCoords(t,e){const i=this.getCurrentCenter(),s=o.fromSceneToViewport(i,this.camera,this.useGL),n=this.getRadius();return[s.x,s.y,n*t.z,this.getBorderWidth()]}}c.prototype.types.lens=t=>new ut(t);class pt{static pan(t,e,i,s,n){let r=this.getAmountOfFocusContext(t,e,i,s);const o=s.x*r.x,a=s.y*r.y,l=-o*i.z*2*(1-r.x),h=-a*i.z*2*(1-r.y);i.x+=l,i.y+=h,e.position.x+=o,e.position.y+=a,Math.abs(e.position.x)>n.w/2&&(e.position.x=n.w/2*Math.sign(e.position.x)),Math.abs(e.position.y)>n.h/2&&(e.position.y=n.h/2*Math.sign(e.position.y))}static scale(t,e,i,s){const n=t.viewport,r=this.getRadiusRangeCanvas(n),o=e.radius*i.z,a=Math.max(0,Math.min(1,(o-r.min)/(r.max-r.min)));let l=1;if(s>1&&a>.5){const t=2*(a-.5);l=1*(1-t)+t/s}else if(s<1&&a<.5){const t=2*a;l=(1-t)/s+1*t}let h=s;const c=o*h;c<r.min?h=r.min/o:c>r.max&&(h=r.max/o),i.z*l<t.minZoom?l=t.minZoom/i.z:i.z*l>t.maxZoom&&(l=t.maxZoom/i.z),i.x+=e.position.x*i.z*(1-l),i.y+=e.position.y*i.z*(1-l),i.z=i.z*l,e.radius*=h}static adaptContext(t,e,i,s){const n=!0,r=o.fromSceneToViewportNoCamera(e.position,i,t,n);i.z=s,pt.adaptContextScale(t,e,i);const a=o.fromSceneToViewportNoCamera(e.position,i,t,n),l=[a.x-r.x,a.y-r.y];i.x-=l.x,i.y+=l.y,pt.adaptContextPosition(t,e,i)}static adaptContextScale(t,e,i){i.z;const s=this.getRadiusRangeCanvas(t),n=e.radius*i.z;n<s.min?i.z=s.min/e.radius:n>s.max&&(i.z=s.max/e.radius)}static adaptContextPosition(t,e,i){const s=this.getCanvasBorder(e,i);let n=this.getShrinkedBox(t,s);const r=o.fromSceneToViewportNoCamera(e.position,i,t,!0),a=Math.max(0,n.xLow-r.x),l=Math.min(0,n.xHigh-r.x);i.x+=0!=a?a:l;const h=Math.max(0,n.yLow-r.y),c=Math.min(0,n.yHigh-r.y);i.y+=0!=h?h:c}static getAmountOfFocusContext(t,e,i,s){const n=this.getCanvasBorder(e,i),r=this.getShrinkedBox(t,n),a=o.fromSceneToViewportNoCamera(e.position,i,t,!0),l=t.w/2-n,h=t.h/2-n;let c=s.x>0?Math.max(0,Math.min(l,r.xHigh-a.x))/l:Math.max(0,Math.min(l,a.x-r.xLow))/l;c=this.smoothstep(c,0,.75);let d=s.y>0?Math.max(0,Math.min(h,r.yHigh-a.y))/h:Math.max(0,Math.min(h,a.y-r.yLow))/h;d=this.smoothstep(d,0,.75);return{x:c/2+.5,y:d/2+.5}}static getCanvasBorder(t,e){return e.z*t.radius*1.5}static getShrinkedBox(t,e){return{xLow:e,yLow:e,xHigh:t.w-e,yHigh:t.h-e}}static getRadiusRangeCanvas(t){const e=.1*Math.min(t.w,t.h);return{min:e,max:3*e}}static smoothstep(t,e,i){if(t<e)return 0;if(t>i)return 1;{const s=(t-e)/(i-e);return s*s*(-2*s+3)}}}class mt extends R{constructor(t){if(super(t),!t.lensLayer)throw console.log("ControllerLens lensLayer option required"),"ControllerLens lensLayer option required";if(!t.camera)throw console.log("ControllerLens camera option required"),"ControllerLens camera option required";this.panning=!1,this.zooming=!1,this.initialDistance=0,this.startPos={x:0,y:0},this.oldCursorPos={x:0,y:0},this.useGL=!1}panStart(t){if(!this.active)return;const e=this.getScenePosition(t);this.panning=!1;const i=this.isInsideLens(e);this.lensLayer.visible&&i.inside&&(this.panning=!0,this.startPos=e,t.preventDefault())}panMove(t){if(this.getPixelPosition(t),!(Math.abs(t.offsetX)>64e3||Math.abs(t.offsetY)>64e3)&&this.panning){const e=this.getScenePosition(t),i=e.x-this.startPos.x,s=e.y-this.startPos.y,n=this.lensLayer.getTargetCenter();this.lensLayer.setCenter(n.x+i,n.y+s),this.startPos=e,t.preventDefault()}}panEnd(t){this.panning=!1,this.zooming=!1}pinchStart(t,e){if(!this.active)return;const i=this.getScenePosition(t),s=this.getScenePosition(e),n={x:.5*(i.x+s.x),y:.5*(i.y+s.y)};this.lensLayer.visible&&this.isInsideLens(n).inside&&(this.zooming=!0,this.initialDistance=this.distance(t,e),this.initialRadius=this.lensLayer.getRadius(),this.startPos=n,t.preventDefault())}pinchMove(t,e){if(!this.zooming)return;const i=this.distance(t,e)/(this.initialDistance+1e-5)*this.initialRadius;this.lensLayer.setRadius(i)}pinchEnd(t,e,i,s){this.zooming=!1}mouseWheel(t){if(!this.active)return;const e=this.getScenePosition(t);let i=!1;if(this.lensLayer.visible&&this.isInsideLens(e).inside){const s=(t.deltaY>0?1:-1)>0?1.2:1/1.2,n=this.lensLayer.getRadius();this.lensLayer.setRadius(n*s),this.startPos=e,i=!0,t.preventDefault()}return i}zoomStart(t){if(!this.lensLayer.visible)return;this.zooming=!0,this.oldCursorPos=t;const e=this.getScenePosition(t),i=this.getFocus(),s=i.radius,n=i.position;let r=e.x-n.x,o=e.y-n.y,a=Math.sqrt(r*r+o*o);this.deltaR=a-s}zoomMove(t){if(this.zooming){const e=this.getScenePosition(t),i=this.getFocus().position;let s={x:e.x-i.x,y:e.y-i.y},n=Math.sqrt(s.x*s.x+s.y*s.y);const r=this.camera.getCurrentTransform(performance.now()).z,o=pt.getRadiusRangeCanvas(this.camera.viewport),a=Math.max(o.min/r,n-this.deltaR);this.lensLayer.setRadius(a,this.zoomDelay)}}zoomEnd(){this.zooming=!1}getFocus(){return{position:this.lensLayer.getCurrentCenter(),radius:this.lensLayer.getRadius()}}isInsideLens(t){const e=this.lensLayer.getCurrentCenter(),i=t.x-e.x,s=t.y-e.y,n=Math.sqrt(i*i+s*s),r=this.lensLayer.getRadius(),o=n<r,a=this.camera.getCurrentTransform(performance.now()),l=this.lensLayer.getBorderWidth()/a.z;return{inside:o,border:o&&n>r-l}}getPixelPosition(t){const e={x:t.offsetX,y:t.offsetY};return o.fromCanvasHtmlToViewport(e,this.camera,this.useGL)}getScenePosition(t){const e={x:t.offsetX,y:t.offsetY};return o.fromCanvasHtmlToScene(e,this.camera,this.useGL)}distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}}class ft extends mt{static callUpdate(t){t.update()}constructor(t){if(super(t),Object.assign(this,{updateTimeInterval:50,updateDelay:100,zoomDelay:150,zoomAmount:1.5,priority:-100,enableDirectContextControl:!0},t),!t.lensLayer)throw console.log("ControllerFocusContext lensLayer option required"),"ControllerFocusContext lensLayer option required";if(!t.camera)throw console.log("ControllerFocusContext camera option required"),"ControllerFocusContext camera option required";if(!t.canvas)throw console.log("ControllerFocusContext canvas option required"),"ControllerFocusContext canvas option required";this.canvas.addEvent("updateSize",(()=>{const t=this.camera.boundingBox;this.maxDatasetSize=Math.max(t.width(),t.height()),this.minDatasetSize=Math.min(t.width(),t.height()),this.setDatasetDimensions(t.width(),t.height())})),this.imageSize={w:1,h:1},this.FocusContextEnabled=!0,this.centerToClickOffset={x:0,y:0},this.previousClickPos={x:0,y:0},this.currentClickPos={x:0,y:0},this.insideLens={inside:!1,border:!1},this.panning=!1,this.zooming=!1,this.panningCamera=!1,this.startPos={x:0,y:0},this.initialTransform=this.camera.getCurrentTransform(performance.now()),this.initialPinchDistance=1,this.initialPinchRadius=1,this.initialPinchPos={x:0,y:0},n(ft,"panStart","panEnd","pinchStart","pinchEnd")}panStart(t){if(!this.active)return;const e=this.getScenePosition(t);this.panning=!1,this.insideLens=this.isInsideLens(e);const i=this.getPixelPosition(t);if(this.lensLayer.visible&&this.insideLens.inside){const t=o.fromSceneToViewport(this.getFocus().position,this.camera,this.useGL);this.centerToClickOffset={x:i.x-t.x,y:i.y-t.y},this.currentClickPos={x:i.x,y:i.y},this.panning=!0}else this.enableDirectContextControl&&(this.startPos=i,this.initialTransform=this.camera.getCurrentTransform(performance.now()),this.camera.target=this.initialTransform.copy(),this.panningCamera=!0);t.preventDefault(),this.emit("panStart",Date.now()),this.timeOut=setInterval(this.update.bind(this),50)}panMove(t){if(!(Math.abs(t.offsetX)>64e3||Math.abs(t.offsetY)>64e3))if(this.currentClickPos=this.getPixelPosition(t),this.panning);else if(this.panningCamera){let t=this.initialTransform,e=this.currentClickPos.x-this.startPos.x,i=this.currentClickPos.y-this.startPos.y;this.camera.setPosition(this.updateDelay,t.x+e,t.y+i,t.z,t.a)}}pinchStart(t,e){if(!this.active)return;const i=this.getScenePosition(t),s=this.getScenePosition(e),n={x:.5*(i.x+s.x),y:.5*(i.y+s.y)};this.initialPinchPos={x:.5*(t.offsetX+e.offsetX),y:.5*(t.offsetY+e.offsetY)},this.insideLens=this.isInsideLens(n),this.zooming=!0,this.initialPinchDistance=this.distance(t,e),this.initialPinchRadius=this.lensLayer.getRadius(),t.preventDefault(),this.emit("pinchStart",Date.now())}pinchMove(t,e){if(this.zooming){const i=this.distance(t,e),s=i/(this.initialPinchDistance+1e-5);if(this.lensLayer.visible&&this.insideLens.inside){const t=s*this.initialPinchRadius/this.lensLayer.getRadius();this.updateRadiusAndScale(t)}else this.enableDirectContextControl&&(this.updateScale(this.initialPinchPos.x,this.initialPinchPos.y,s),this.initialPinchDistance=i)}}pinchEnd(t,e,i,s){this.zooming=!1,this.emit("pinchEnd",Date.now())}zoomStart(t){this.lensLayer.visible&&(super.zoomStart(t),this.timeOut=setInterval(this.zoomUpdate.bind(this),50))}zoomMove(t){if(this.zooming){this.oldCursorPos=t;let e=this.camera.getCurrentTransform(performance.now());const i=this.getScenePosition(t),s=this.getFocus(),n=s.position;let r={x:i.x-n.x,y:i.y-n.y},o=Math.sqrt(r.x*r.x+r.y*r.y);const a=pt.getRadiusRangeCanvas(this.camera.viewport),l=Math.max(a.min/e.z,o-this.deltaR)/s.radius;this.updateRadiusAndScale(l)}}zoomUpdate(){if(this.zooming){const t=this.getScenePosition(this.oldCursorPos),e=this.getFocus(),i=e.position;let s={x:t.x-i.x,y:t.y-i.y},n=Math.sqrt(s.x*s.x+s.y*s.y);const r=pt.getRadiusRangeCanvas(this.camera.viewport);let o=this.camera.getCurrentTransform(performance.now());const a=Math.max(r.min/o.z,n-this.deltaR)/e.radius;this.updateRadiusAndScale(a)}}zoomEnd(){this.lensLayer.visible&&(super.zoomEnd(),clearTimeout(this.timeOut))}mouseWheel(t){if(!this.active)return;const e=this.getScenePosition(t);this.insideLens=this.isInsideLens(e);const i=t.deltaY>0?this.zoomAmount:1/this.zoomAmount;if(this.lensLayer.visible&&this.insideLens.inside)this.updateRadiusAndScale(i);else if(this.enableDirectContextControl){const e=this.getPixelPosition(t);this.updateScale(e.x,e.y,1/i)}t.preventDefault()}updateRadiusAndScale(t){let e=this.getFocus();const i=performance.now();let s=this.camera.getCurrentTransform(i);pt.scale(this.camera,e,s,t),pt.adaptContextPosition(this.camera.viewport,e,s),this.camera.setPosition(this.zoomDelay,s.x,s.y,s.z,s.a),this.lensLayer.setRadius(e.radius,this.zoomDelay)}updateScale(t,e,i){const s=performance.now();let n=this.camera.getCurrentTransform(s);const r=o.fromCanvasHtmlToScene({x:t,y:e},this.camera,this.useGL),a=this.camera.maxZoom/n.z,l=this.camera.minZoom/n.z;i=Math.min(a,Math.max(l,i)),this.camera.deltaZoom(this.updateDelay,i,r.x,r.y)}panEnd(){this.panning&&clearTimeout(this.timeOut),this.panning=!1,this.panningCamera=!1,this.zooming=!1,this.emit("panEnd",Date.now())}update(){if(this.panning){let t=this.camera.getCurrentTransform(performance.now()),e=this.lastInteractionDelta();e.x/=t.z,e.y/=t.z;let i=this.getFocus();this.FocusContextEnabled?(pt.pan(this.camera.viewport,i,t,e,this.imageSize),this.camera.setPosition(this.updateDelay,t.x,t.y,t.z,t.a)):(i.position.x+=e.x,i.position.y+=e.y),this.lensLayer.setCenter(i.position.x,i.position.y,this.updateDelay),this.previousClickPos=[this.currentClickPos.x,this.currentClickPos.y]}}lastInteractionDelta(){let t={x:0,y:0};if(this.panning&&this.insideLens.inside){const e=o.fromSceneToViewport(this.getFocus().position,this.camera,this.useGL);t={x:this.currentClickPos.x-e.x-this.centerToClickOffset.x,y:this.currentClickPos.y-e.y-this.centerToClickOffset.y}}else t={x:this.currentClickPos.x-this.previousClickPos.x,y:this.currentClickPos.y-this.previousClickPos.y};return t}setDatasetDimensions(t,e){this.imageSize={w:t,h:e}}initLens(){const t=100/this.camera.getCurrentTransform(performance.now()).z;this.lensLayer.setRadius(t),this.lensLayer.setCenter(.5*this.imageSize.w,.5*this.imageSize.h)}}class gt{constructor(t,i){i=Object.assign({containerSpace:80,borderColor:[.078,.078,.078,1],borderWidth:12,layerSvgAnnotation:null},i),Object.assign(this,i),this.lensLayer=null,this.viewer=t,this.elements=[],this.container=document.createElement("div"),this.container.style="position: absolute; width: 50px; height: 50px; background-color: rgb(200, 0, 0, 0.0); pointer-events: none",this.container.classList.add("openlime-lens-dashboard"),this.viewer.containerElement.appendChild(this.container);const s=[255*this.borderColor[0],255*this.borderColor[1],255*this.borderColor[2],255*this.borderColor[3]];this.lensElm=e.createSVGElement("svg",{viewBox:"0 0 100 100"});const n=e.createSVGElement("circle",{cx:10,cy:10,r:50});n.setAttributeNS(null,"style",`position:absolute; visibility: visible; fill: none; stroke: rgb(${s[0]},${s[1]},${s[2]},${s[3]}); stroke-width: ${this.borderWidth}px;`),n.setAttributeNS(null,"shape-rendering","geometricPrecision"),this.lensElm.appendChild(n),this.container.appendChild(this.lensElm),this.setupCircleInteraction(n),this.lensBox={x:0,y:0,r:0,w:0,h:0},this.svgElement=null,this.svgMaskId="openlime-image-mask",this.svgMaskUrl=`url(#${this.svgMaskId})`,this.noupdate=!1}setupCircleInteraction(t){function e(t,e){return{offsetX:t.clientX-e.offsetLeft-e.clientLeft,offsetY:t.clientY-e.offsetTop-e.clientTop}}t.style.pointerEvents="auto",this.isCircleSelected=!1,this.viewer.containerElement.addEventListener("pointerdown",(i=>{if(t==i.target){if(this.isCircleSelected=!0,this.lensLayer.controllers[0]){const t=e(i,this.viewer.containerElement);this.lensLayer.controllers[0].zoomStart(t)}i.preventDefault(),i.stopPropagation()}})),this.viewer.containerElement.addEventListener("pointermove",(t=>{if(this.isCircleSelected){if(this.lensLayer.controllers[0]){const i=e(t,this.viewer.containerElement);this.lensLayer.controllers[0].zoomMove(i)}t.preventDefault(),t.stopPropagation()}})),this.viewer.containerElement.addEventListener("pointerup",(t=>{this.isCircleSelected&&(this.lensLayer.controllers[0]&&this.lensLayer.controllers[0].zoomEnd(),this.isCircleSelected=!1,t.preventDefault(),t.stopPropagation())}))}toggle(){this.container.classList.toggle("closed")}setLayerSvgAnnotation(t){this.layerSvgAnnotation=l,this.svgElement=this.layerSvgAnnotation.svgElement}createSvgLensMask(){if(null==this.svgElement&&this.setupSvgElement(),null==this.svgElement)return;const t=100;this.svgMask=e.createSVGElement("mask",{id:this.svgMaskId}),this.svgGroup=e.createSVGElement("g"),this.outMask=e.createSVGElement("rect",{id:"outside-lens-mask",x:-50,y:-50,width:t,height:t,style:"fill:black;"}),this.inMask=e.createSVGElement("circle",{id:"inside-lens-mask",cx:0,cy:0,r:50,style:"fill:white;"}),this.svgGroup.appendChild(this.outMask),this.svgGroup.appendChild(this.inMask),this.svgMask.appendChild(this.svgGroup),this.svgElement.appendChild(this.svgMask)}setupSvgElement(){if(this.layerSvgAnnotation)null==this.svgElement&&(this.svgElement=this.layerSvgAnnotation.svgElement);else{let t=this.viewer.canvas.overlayElement.shadowRoot;null==t&&(t=this.viewer.canvas.overlayElement.attachShadow({mode:"open"})),this.svgElement=t.querySelector("svg"),null==this.svgElement&&(this.svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgElement.classList.add("openlime-svgoverlay-mask"),this.svgElement.setAttributeNS(null,"style","pointer-events: none;"),t.appendChild(this.svgElement))}}setMaskOnSvgLayer(t){t.setAttributeNS(null,"mask",this.svgMaskUrl)}removeMaskFromSvgLayer(t){t.removeAttribute("mask")}append(t){this.container.appendChild(t)}setLensRenderingMode(t){this.inMask.setAttributeNS(null,"style",t)}setBackgroundRenderingMode(t){this.outMask.setAttributeNS(null,"style",t)}update(t,e,i){const s=o.fromSceneToCanvasHtml({x:t,y:e},this.viewer.camera,!1),n=performance.now();let r=this.viewer.camera.getCurrentTransform(n);const a=i*r.z,l=2*a+2*this.containerSpace,h=2*a+2*this.containerSpace,c={x:0,y:0};if(c.x=s.x-a-this.containerSpace,c.y=s.y-a-this.containerSpace,this.container.style.left=`${c.x}px`,this.container.style.top=`${c.y}px`,this.container.style.width=`${l}px`,this.container.style.height=`${h}px`,l!=this.lensBox.w||h!=this.lensBox.h){const t=Math.ceil(.5*l),e=Math.ceil(.5*h);this.lensElm.setAttributeNS(null,"viewBox",`0 0 ${l} ${h}`);const i=this.lensElm.querySelector("circle");i.setAttributeNS(null,"cx",t),i.setAttributeNS(null,"cy",e),i.setAttributeNS(null,"r",a-.5*this.borderWidth)}this.updateMask(r,s,a),this.lensBox={x:s.x,y:s.y,r:a,w:l,h:h}}updateMask(t,e,i){if(null==this.svgElement&&this.createSvgLensMask(),null==this.svgElement)return;const s=this.viewer.camera.viewport;if(null!=this.layerSvgAnnotation){const e=!0,i=this.layerSvgAnnotation.getSvgGroupTransform(t,e);this.svgGroup.setAttribute("transform",i)}else this.svgElement.setAttribute("viewBox",`${-s.w/2} ${-s.h/2} ${s.w} ${s.h}`);this.outMask.setAttribute("x",-s.w/2),this.outMask.setAttribute("y",-s.h/2),this.outMask.setAttribute("width",s.w),this.outMask.setAttribute("height",s.h),this.inMask.setAttributeNS(null,"cx",e.x-s.w/2),this.inMask.setAttributeNS(null,"cy",e.y-s.h/2),this.inMask.setAttributeNS(null,"r",i-this.borderWidth-2)}}class vt extends gt{constructor(t,i){super(t,i),i=Object.assign({toolSize:34,toolPadding:0,group:[-65,0],actions:{camera:{label:"camera",group:0,angle:-25,task:t=>{this.actions.camera.active||this.toggleLightController()}},light:{label:"light",group:0,angle:0,task:t=>{this.actions.light.active||this.toggleLightController()}},annoswitch:{label:"annoswitch",group:1,angle:0,type:"toggle",toggleClass:".openlime-lens-dashboard-annoswitch-bar",task:t=>{}},prev:{label:"prev",group:1,angle:25,task:t=>{}},down:{label:"down",group:1,angle:50,task:t=>{}},next:{label:"next",group:1,angle:75,task:t=>{}}},updateCb:null,updateEndCb:null},i),Object.assign(this,i),this.moving=!1,this.delay=400,this.timeout=null,this.noupdate=!1;const s=[255*this.borderColor[0],255*this.borderColor[1],255*this.borderColor[2],255*this.borderColor[3]];s[3]=.4,this.toolboxBkgSize=56,this.toolboxBkgPadding=4,this.toolboxBkg=new Object,this.toolboxBkg.svg=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n         <svg\n            viewBox="0 0 200 200"\n            fill="none"\n            version="1.1"\n            id="svg11"\n            xmlns="http://www.w3.org/2000/svg"\n            xmlns:svg="http://www.w3.org/2000/svg">\n           <path id="shape-dashboard-bkg" d="" stroke="none" fill="rgb(${s[0]},${s[1]},${s[2]},${s[3]})"/>\n         </svg>`,this.toolboxBkg.element=e.SVGFromString(this.toolboxBkg.svg),this.toolboxBkg.element.setAttributeNS(null,"style","position: absolute; top: 0px; left:0px;"),this.container.appendChild(this.toolboxBkg.element),this.actions.camera.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n        \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n        \n        <svg\n           viewBox="0 0 83.319054 83.319054"\n           version="1.1"\n           id="svg2495"\n           xmlns="http://www.w3.org/2000/svg"\n           xmlns:svg="http://www.w3.org/2000/svg">\n          <defs\n             id="defs2492" />\n          <g\n             id="layer1"\n             transform="translate(-69.000668,-98.39946)">\n            <g\n               id="g2458"\n               transform="matrix(0.35277777,0,0,0.35277777,46.261671,-65.803422)"\n               class="openlime-lens-dashboard-camera">\n              <path class="openlime-lens-dashboard-button-bkg"\n                 d="m 300.637,583.547 c 0,65.219 -52.871,118.09 -118.09,118.09 -65.219,0 -118.09,-52.871 -118.09,-118.09 0,-65.219 52.871,-118.09 118.09,-118.09 65.219,0 118.09,52.871 118.09,118.09 z"\n                 style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none"\n                 id="path50" />\n              <g\n                 id="g52">\n                <path\n                   d="M 123.445,524.445 H 241.652 V 642.648 H 123.445 Z"\n                   style="fill:#ffffff;fill-opacity:0;fill-rule:nonzero;stroke:#000000;stroke-width:16.7936;stroke-linecap:butt;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                   id="path54" />\n              </g>\n              <g\n                 id="g56"\n                 transform="scale(1,0.946694)">\n                <path\n                   d="m 190.449,581.031 h -15.793 c -0.011,7.563 0,27.472 0,27.472 0,0 -17.133,0 -25.609,0.025 v 15.779 c 8.476,-0.009 25.609,-0.009 25.609,-0.009 0,0 0,19.881 -0.011,27.485 h 15.793 c 0.011,-7.604 0.011,-27.485 0.011,-27.485 0,0 17.125,0 25.598,0 v -15.795 c -8.473,0 -25.598,0 -25.598,0 0,0 -0.023,-19.904 0,-27.472"\n                   style="fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:#000000;stroke-width:0.52673;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                   id="path58" />\n              </g>\n              <path\n                 d="m 269.254,557.93 22.332,21.437 c 2.098,2.071 2.195,5.344 0,7.504 l -22.332,21.008 c -1.25,1.25 -5.004,1.25 -6.254,-2.504 v -46.273 c 1.25,-3.672 5.004,-2.422 6.254,-1.172 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path60" />\n              <path\n                 d="M 95.844,607.395 73.508,585.957 c -2.094,-2.07 -2.192,-5.34 0,-7.504 l 22.336,-21.008 c 1.25,-1.25 5,-1.25 6.254,2.504 v 46.274 c -1.254,3.672 -5.004,2.422 -6.254,1.172 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path62" />\n              <path\n                 d="m 157.59,494.32 21.437,-22.332 c 2.071,-2.097 5.344,-2.191 7.504,0 l 21.008,22.332 c 1.25,1.254 1.25,5.004 -2.504,6.254 h -46.273 c -3.672,-1.25 -2.422,-5 -1.172,-6.254 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path64" />\n              <path\n                 d="m 207.055,671.785 -21.438,22.336 c -2.07,2.094 -5.344,2.191 -7.504,0 l -21.008,-22.336 c -1.25,-1.25 -1.25,-5 2.504,-6.25 h 46.274 c 3.672,1.25 2.422,5 1.172,6.25 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path66" />\n            </g>\n          </g>\n        </svg>',this.actions.light.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n        \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n        \n        <svg\n           viewBox="0 0 83.319054 83.320114"\n           version="1.1"\n           id="svg5698"\n           xmlns="http://www.w3.org/2000/svg"\n           xmlns:svg="http://www.w3.org/2000/svg">\n          <defs\n             id="defs5695" />\n          <g\n             id="layer1"\n             transform="translate(-104.32352,-59.017909)">\n            <g\n               id="g2477"\n               transform="matrix(0.35277777,0,0,0.35277777,-16.220287,-105.16169)"\n               class="openlime-lens-dashboard-light">\n              <path class="openlime-lens-dashboard-button-bkg"\n                 d="m 577.879,583.484 c 0,65.219 -52.871,118.09 -118.09,118.09 -65.219,0 -118.09,-52.871 -118.09,-118.09 0,-65.222 52.871,-118.093 118.09,-118.093 65.219,0 118.09,52.871 118.09,118.093 z"\n                 style="fill:#fbfbfb;fill-opacity:1;fill-rule:nonzero;stroke:none"\n                 id="path74" />\n              <path\n                 d="m 546.496,558.359 22.332,21.438 c 2.098,2.066 2.192,5.34 0,7.504 l -22.332,21.004 c -1.25,1.254 -5.004,1.254 -6.254,-2.5 v -46.274 c 1.25,-3.672 5.004,-2.422 6.254,-1.172 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path76" />\n              <path\n                 d="M 373.082,607.82 350.75,586.383 c -2.094,-2.067 -2.191,-5.34 0,-7.504 l 22.332,-21.004 c 1.254,-1.25 5.004,-1.25 6.254,2.5 v 46.277 c -1.25,3.672 -5,2.422 -6.254,1.168 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path78" />\n              <path\n                 d="m 434.832,494.75 21.438,-22.332 c 2.07,-2.098 5.339,-2.195 7.503,0 l 21.008,22.332 c 1.25,1.25 1.25,5.004 -2.504,6.254 h -46.273 c -3.672,-1.25 -2.422,-5.004 -1.172,-6.254 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path80" />\n              <path\n                 d="m 484.297,672.215 -21.438,22.332 c -2.07,2.098 -5.343,2.195 -7.507,0 l -21.004,-22.332 c -1.25,-1.25 -1.25,-5.004 2.504,-6.254 h 46.273 c 3.672,1.25 2.422,5.004 1.172,6.254 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path82" />\n              <path\n                 d="m 438.223,599.988 c 0,0 -2.161,-0.535 -3.684,0.227 -1.523,0.762 -0.789,8.773 -0.789,8.773 l 16.305,-0.222 c 0,0 -14.071,3.597 -15.383,6.296 -1.317,2.7 1.672,6.786 4.34,7.426 2.136,0.516 45.793,-13.426 46.808,-14.625 0.883,-1.039 1.446,-6.75 0.528,-7.648 -0.922,-0.899 -4.602,-0.789 -4.602,-0.789 0,0 -1.449,0.113 -0.133,-3.934 1.317,-4.051 15.254,-20.137 18.672,-30.262 3.293,-9.753 1.387,-22.531 -2.367,-28.683 -3.965,-6.504 -9.598,-10.688 -17.356,-13.723 -7.789,-3.051 -22.191,-4.773 -33.664,-1.578 -11.425,3.188 -20.32,8.988 -25.507,16.649 -4.657,6.878 -4.473,20.699 -2.895,26.097 1.578,5.403 17.621,25.426 19.199,29.473 1.578,4.051 0.528,6.523 0.528,6.523 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path84" />\n              <g\n                 id="g86"\n                 transform="scale(1,0.855493)">\n                <path\n                   d="m 438.223,701.337 c 0,0 -2.161,-0.626 -3.684,0.265 -1.523,0.89 -0.789,10.255 -0.789,10.255 l 16.305,-0.26 c 0,0 -14.071,4.205 -15.383,7.36 -1.317,3.155 1.672,7.931 4.34,8.68 2.136,0.603 45.793,-15.693 46.808,-17.095 0.883,-1.215 1.446,-7.89 0.528,-8.94 -0.922,-1.051 -4.602,-0.923 -4.602,-0.923 0,0 -1.449,0.133 -0.133,-4.598 1.317,-4.735 15.254,-23.538 18.672,-35.373 3.293,-11.402 1.387,-26.337 -2.367,-33.529 -3.965,-7.603 -9.598,-12.493 -17.356,-16.041 -7.789,-3.566 -22.191,-5.579 -33.664,-1.844 -11.425,3.725 -20.32,10.506 -25.507,19.46 -4.657,8.041 -4.473,24.196 -2.895,30.506 1.578,6.315 17.621,29.721 19.199,34.451 1.578,4.735 0.528,7.626 0.528,7.626 z"\n                   style="fill:none;stroke:#f8f8f8;stroke-width:8.1576;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.00677317"\n                   id="path88" />\n              </g>\n              <path\n                 d="m 435.59,631.598 c 0.394,3.714 14.992,14.851 20.91,15.414 5.914,0.562 5.125,0.898 9.336,-0.453 4.207,-1.348 17.617,-9.223 18.277,-10.571 1.68,-3.453 2.758,-6.976 1.313,-9.113 -1.449,-2.145 -3.946,-0.563 -6.574,0.227 -2.629,0.785 -13.805,5.734 -17.489,6.859 -2.89,0.883 -9.203,-0.563 -9.203,-0.563 0,0 32.012,-10.578 33.266,-12.933 1.316,-2.477 0.262,-6.977 -2.762,-7.539 -1.926,-0.36 -43.785,13.386 -44.836,15.074 -1.055,1.688 -2.238,3.598 -2.238,3.598 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path90" />\n              <g\n                 id="g92"\n                 transform="scale(1,0.855493)">\n                <path\n                   d="m 435.59,738.285 c 0.394,4.343 14.992,17.361 20.91,18.018 5.914,0.658 5.125,1.05 9.336,-0.529 4.207,-1.576 17.617,-10.781 18.277,-12.356 1.68,-4.037 2.758,-8.155 1.313,-10.653 -1.449,-2.507 -3.946,-0.657 -6.574,0.265 -2.629,0.918 -13.805,6.703 -17.489,8.018 -2.89,1.032 -9.203,-0.658 -9.203,-0.658 0,0 32.012,-12.365 33.266,-15.118 1.316,-2.895 0.262,-8.155 -2.762,-8.812 -1.926,-0.421 -43.785,15.648 -44.836,17.62 -1.055,1.973 -2.238,4.205 -2.238,4.205 z"\n                   style="fill:none;stroke:#f8f8f8;stroke-width:8.1576;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.00677317"\n                   id="path94" />\n              </g>\n              <path\n                 d="m 438.223,599.988 c 0,0 -2.161,-0.535 -3.684,0.227 -1.523,0.762 -0.789,8.773 -0.789,8.773 l 16.305,-0.222 c 0,0 -14.071,3.597 -15.383,6.296 -1.317,2.7 1.672,6.786 4.34,7.426 2.136,0.516 45.793,-13.426 46.808,-14.625 0.883,-1.039 1.446,-6.75 0.528,-7.648 -0.922,-0.899 -4.602,-0.789 -4.602,-0.789 0,0 -1.449,0.113 -0.133,-3.934 1.317,-4.051 15.254,-20.137 18.672,-30.262 3.293,-9.753 1.387,-22.531 -2.367,-28.683 -3.965,-6.504 -9.598,-10.688 -17.356,-13.723 -7.789,-3.051 -22.191,-4.773 -33.664,-1.578 -11.425,3.188 -20.32,8.988 -25.507,16.649 -4.657,6.878 -4.473,20.699 -2.895,26.097 1.578,5.403 17.621,25.426 19.199,29.473 1.578,4.051 0.528,6.523 0.528,6.523 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path96" />\n              <g\n                 id="g98"\n                 transform="scale(1,0.855493)">\n                <path\n                   d="m 438.223,701.337 c 0,0 -2.161,-0.626 -3.684,0.265 -1.523,0.89 -0.789,10.255 -0.789,10.255 l 16.305,-0.26 c 0,0 -14.071,4.205 -15.383,7.36 -1.317,3.155 1.672,7.931 4.34,8.68 2.136,0.603 45.793,-15.693 46.808,-17.095 0.883,-1.215 1.446,-7.89 0.528,-8.94 -0.922,-1.051 -4.602,-0.923 -4.602,-0.923 0,0 -1.449,0.133 -0.133,-4.598 1.317,-4.735 15.254,-23.538 18.672,-35.373 3.293,-11.402 1.387,-26.337 -2.367,-33.529 -3.965,-7.603 -9.598,-12.493 -17.356,-16.041 -7.789,-3.566 -22.191,-5.579 -33.664,-1.844 -11.425,3.725 -20.32,10.506 -25.507,19.46 -4.657,8.041 -4.473,24.196 -2.895,30.506 1.578,6.315 17.621,29.721 19.199,34.451 1.578,4.735 0.528,7.626 0.528,7.626 z"\n                   style="fill:none;stroke:#f8f8f8;stroke-width:8.1576;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.00677317"\n                   id="path100" />\n              </g>\n              <path\n                 d="m 435.59,631.598 c 0.394,3.714 14.992,14.851 20.91,15.414 5.914,0.562 5.125,0.898 9.336,-0.453 4.207,-1.348 17.617,-9.223 18.277,-10.571 1.68,-3.453 2.758,-6.976 1.313,-9.113 -1.449,-2.145 -3.946,-0.563 -6.574,0.227 -2.629,0.785 -13.805,5.734 -17.489,6.859 -2.89,0.883 -9.203,-0.563 -9.203,-0.563 0,0 32.012,-10.578 33.266,-12.933 1.316,-2.477 0.262,-6.977 -2.762,-7.539 -1.926,-0.36 -43.785,13.386 -44.836,15.074 -1.055,1.688 -2.238,3.598 -2.238,3.598 z"\n                 style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none"\n                 id="path102" />\n              <g\n                 id="g104"\n                 transform="scale(1,0.855493)">\n                <path\n                   d="m 435.59,738.285 c 0.394,4.343 14.992,17.361 20.91,18.018 5.914,0.658 5.125,1.05 9.336,-0.529 4.207,-1.576 17.617,-10.781 18.277,-12.356 1.68,-4.037 2.758,-8.155 1.313,-10.653 -1.449,-2.507 -3.946,-0.657 -6.574,0.265 -2.629,0.918 -13.805,6.703 -17.489,8.018 -2.89,1.032 -9.203,-0.658 -9.203,-0.658 0,0 32.012,-12.365 33.266,-15.118 1.316,-2.895 0.262,-8.155 -2.762,-8.812 -1.926,-0.421 -43.785,15.648 -44.836,17.62 -1.055,1.973 -2.238,4.205 -2.238,4.205 z"\n                   style="fill:none;stroke:#f8f8f8;stroke-width:8.1576;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.00677317"\n                   id="path106" />\n              </g>\n            </g>\n          </g>\n        </svg>',this.actions.annoswitch.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n      \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n      \n      <svg\n         viewBox="0 0 83.319054 83.320114"\n         version="1.1"\n         id="svg11415"\n         xml:space="preserve"\n         xmlns="http://www.w3.org/2000/svg"\n         xmlns:svg="http://www.w3.org/2000/svg"><defs\n           id="defs11412"><marker\n             style="overflow:visible"\n             id="TriangleStart"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135" /></marker><marker\n             style="overflow:visible"\n             id="TriangleStart-5"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135-3" /></marker></defs><g\n           id="g327"\n           transform="translate(129.83427,13.264356)"><g\n             id="g346"><path\n               d="m -46.51522,28.396234 c 0,23.007813 -18.65172,41.659526 -41.65953,41.659526 -23.00782,0 -41.65952,-18.651713 -41.65952,-41.659526 0,-23.00887 18.6517,-41.66059 41.65952,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n               style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n               id="path68"\n               class="openlime-lens-dashboard-button-bkg" /><g\n               aria-label="i"\n               id="text430"\n               style="font-size:50.8px;line-height:1.25;font-family:\'Palace Script MT\';-inkscape-font-specification:\'Palace Script MT\';font-variant-ligatures:none;letter-spacing:0px;word-spacing:0px;stroke-width:0.264583"\n               transform="matrix(1.9896002,0,0,1.9896002,-378.32178,-41.782121)"><path\n                 d="m 149.74343,19.295724 c -1.4224,1.1176 -2.5908,2.032 -3.5052,2.6416 0.3556,1.0668 0.8128,1.9304 1.9304,3.556 1.4224,-1.27 1.5748,-1.4224 3.302,-2.7432 -0.1524,-0.3048 -0.254,-0.508 -0.6604,-1.1684 -0.3048,-0.6096 -0.3556,-0.6096 -0.762,-1.6256 z m 1.9304,25.4 -0.8636,0.4572 c -3.5052,1.9304 -4.1148,2.1844 -4.7244,2.1844 -0.5588,0 -0.9144,-0.5588 -0.9144,-1.4224 0,-0.8636 0,-0.8636 1.6764,-7.5692 1.8796,-7.7216 1.8796,-7.7216 1.8796,-8.128 0,-0.3048 -0.254,-0.508 -0.6096,-0.508 -0.8636,0 -3.8608,1.6764 -8.0264,4.4704 l -0.1016,1.4224 c 3.0988,-1.6764 3.2512,-1.7272 3.7084,-1.7272 0.4064,0 0.6096,0.3048 0.6096,0.8636 0,0.7112 -0.1524,1.4224 -0.9144,4.318 -2.3876,8.8392 -2.3876,8.8392 -2.3876,10.16 0,1.2192 0.4572,2.032 1.2192,2.032 0.8636,0 2.2352,-0.6604 4.9276,-2.3876 0.9652,-0.6096 1.9304,-1.2192 2.8956,-1.8796 0.4572,-0.254 0.8128,-0.508 1.4224,-0.8636 z"\n                 style="font-weight:bold;font-family:Z003;-inkscape-font-specification:\'Z003 Bold\'"\n                 id="path495" /></g><path\n               style="fill:none;stroke:#000000;stroke-width:17.09477;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="M -66.121922,49.608737 -110.22757,7.1826674"\n               id="path465"\n               class="openlime-lens-dashboard-annoswitch-bar" /></g></g></svg>',this.actions.prev.svg='<svg\n      viewBox="0 0 83.319054 83.320114"\n      version="1.1"\n      id="svg11415"\n      xml:space="preserve"\n      xmlns="http://www.w3.org/2000/svg"\n      xmlns:svg="http://www.w3.org/2000/svg"><defs\n        id="defs11412"><marker\n          style="overflow:visible"\n          id="TriangleStart"\n          refX="0"\n          refY="0"\n          orient="auto-start-reverse"\n          markerWidth="5.3244081"\n          markerHeight="6.155385"\n          viewBox="0 0 5.3244081 6.1553851"\n          preserveAspectRatio="xMidYMid"><path\n            transform="scale(0.5)"\n            style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n            d="M 5.77,0 -2.88,5 V -5 Z"\n            id="path135" /></marker><marker\n          style="overflow:visible"\n          id="TriangleStart-5"\n          refX="0"\n          refY="0"\n          orient="auto-start-reverse"\n          markerWidth="5.3244081"\n          markerHeight="6.155385"\n          viewBox="0 0 5.3244081 6.1553851"\n          preserveAspectRatio="xMidYMid"><path\n            transform="scale(0.5)"\n            style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n            d="M 5.77,0 -2.88,5 V -5 Z"\n            id="path135-3" /></marker></defs><g\n        id="g417"\n        transform="matrix(3.3565779,0,0,3.3565779,129.92814,-51.220758)"><g\n          id="g335"><path\n            d="m -172.71351,100.60243 c 0,23.00781 -18.65172,41.65952 -41.65953,41.65952 -23.00782,0 -41.65952,-18.65171 -41.65952,-41.65952 0,-23.00887 18.6517,-41.66059 41.65952,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n            style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n            id="path68"\n            class="openlime-lens-dashboard-button-bkg"\n            transform="matrix(0.29792248,0,0,0.29792248,37.569341,-2.3002842)" /><path\n            style="fill:#030104"\n            d="m -35.494703,28.624414 c 0,-0.264 0.213,-0.474 0.475,-0.474 h 2.421 c 0.262,0 0.475,0.21 0.475,0.474 0,3.211 2.615,5.826 5.827,5.826 3.212,0 5.827,-2.615 5.827,-5.826 0,-3.214 -2.614,-5.826 -5.827,-5.826 -0.34,0 -0.68,0.028 -1.016,0.089 v 1.647 c 0,0.193 -0.116,0.367 -0.291,0.439 -0.181,0.073 -0.383,0.031 -0.521,-0.104 l -4.832,-3.273 c -0.184,-0.185 -0.184,-0.482 0,-0.667 l 4.833,-3.268 c 0.136,-0.136 0.338,-0.176 0.519,-0.104 0.175,0.074 0.291,0.246 0.291,0.438 v 1.487 c 0.34,-0.038 0.68,-0.057 1.016,-0.057 5.071,0 9.198,4.127 9.198,9.198 0,5.07 -4.127,9.197 -9.198,9.197 -5.07,10e-4 -9.197,-4.126 -9.197,-9.196 z"\n            id="path415" /></g></g></svg>',this.actions.down.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n        \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n        \n        <svg\n           viewBox="0 0 83.319054 83.320114"\n           version="1.1"\n           id="svg11415"\n           xml:space="preserve"\n           xmlns="http://www.w3.org/2000/svg"\n           xmlns:svg="http://www.w3.org/2000/svg"><defs\n             id="defs11412"><marker\n               style="overflow:visible"\n               id="TriangleStart"\n               refX="0"\n               refY="0"\n               orient="auto-start-reverse"\n               markerWidth="5.3244081"\n               markerHeight="6.155385"\n               viewBox="0 0 5.3244081 6.1553851"\n               preserveAspectRatio="xMidYMid"><path\n                 transform="scale(0.5)"\n                 style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                 d="M 5.77,0 -2.88,5 V -5 Z"\n                 id="path135" /></marker><marker\n               style="overflow:visible"\n               id="TriangleStart-5"\n               refX="0"\n               refY="0"\n               orient="auto-start-reverse"\n               markerWidth="5.3244081"\n               markerHeight="6.155385"\n               viewBox="0 0 5.3244081 6.1553851"\n               preserveAspectRatio="xMidYMid"><path\n                 transform="scale(0.5)"\n                 style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                 d="M 5.77,0 -2.88,5 V -5 Z"\n                 id="path135-3" /></marker></defs><g\n             id="g4652"\n             transform="translate(145.46385,95.197966)"><g\n               id="g4846"\n               transform="translate(-126.60931,52.756264)"><path\n                 d="m 64.464511,-106.29364 c 0,23.007813 -18.65172,41.659526 -41.65953,41.659526 -23.0078196,0 -41.659526,-18.651713 -41.659526,-41.659526 0,-23.00887 18.6517064,-41.66059 41.659526,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n                 style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n                 id="path68"\n                 class="openlime-lens-dashboard-button-bkg" /><g\n                 id="g2392-5"\n                 transform="matrix(0.26458333,0,0,0.26458333,-283.58108,-263.57207)"><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:40;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1072.4033,509.27736 h 171.1826"\n                   id="path351-6" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1185.0215,568.3701 h 59.6026"\n                   id="path351-3-2" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1184.2167,621.15576 h 59.6026"\n                   id="path351-3-2-0" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:40;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1072.4033,679.59496 h 171.1826"\n                   id="path351-3-6-7-1" /><path\n                   style="display:inline;fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:11.4448;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#TriangleStart-5)"\n                   d="m 1074.9115,570.87447 54.1203,-0.0275"\n                   id="path1366-2" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:14;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1080.0425,521.28147 v 54.87857"\n                   id="path1402-7" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n                   d="m 1150.8866,623.00688 0.3956,-5.02729"\n                   id="path2545" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1185.0215,567.71656 h 59.6026"\n                   id="path2720" /></g></g></g></svg>',this.actions.next.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n      \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n      \n      <svg\n         viewBox="0 0 83.319054 83.320114"\n         version="1.1"\n         id="svg11415"\n         xml:space="preserve"\n         xmlns="http://www.w3.org/2000/svg"\n         xmlns:svg="http://www.w3.org/2000/svg"><defs\n           id="defs11412"><marker\n             style="overflow:visible"\n             id="TriangleStart"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135" /></marker></defs><g\n           id="g4652"\n           transform="translate(-12.647874,74.762541)"><path\n             d="m 95.96693,-33.101955 c 0,23.007813 -18.65172,41.6595258 -41.65953,41.6595258 -23.00782,0 -41.659526,-18.6517128 -41.659526,-41.6595258 0,-23.008872 18.651706,-41.660586 41.659526,-41.660586 23.00781,0 41.65953,18.651714 41.65953,41.660586 z"\n             style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n             id="path68"\n             class="openlime-lens-dashboard-button-bkg" /><g\n             id="g4636"\n             transform="translate(173.74831,-50.897484)"><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:10.5833;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -142.08694,-4.7366002 h 45.292059"\n               id="path351" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:10.5833;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -142.08694,40.326598 h 45.292059"\n               id="path351-3-6-7" /><path\n               style="display:inline;fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:3.20746;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#TriangleStart)"\n               d="m -136.09942,8.7192481 0.008,14.9721889"\n               id="path1366" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:3.70417;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="M -136.07283,-1.5605128 V 24.204958"\n               id="path1402" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:7.9375;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -111.69142,24.864565 h 15.76985"\n               id="path351-3-2-0-3" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:7.9375;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -111.37623,10.725444 h 15.76986"\n               id="path2720-9" /></g></g></svg>',queueMicrotask?queueMicrotask((()=>{this.init()})):setTimeout((()=>{this.init()}),0)}init(){this.container.style.display="block",this.container.style.margin="0";for(let[t,e]of Object.entries(this.actions))this.addAction(e);this.actions.camera.active=this.actions.camera.element.classList.toggle("openlime-lens-dashboard-camera-active"),this.actions.light.active=!1,this.setActionEnabled("camera"),this.setActionEnabled("light"),this.setActionEnabled("annoswitch"),this.setActionEnabled("next")}static degToRadians(t){return t*(Math.PI/180)}static polarToCartesian(t,e,i,s){const n=(s-90)*Math.PI/180;return{x:t+i*Math.cos(n),y:e+i*Math.sin(n)}}static describeArc(t,e,i,s,n,r){const o=vt.polarToCartesian(t,e,i+s,r),a=vt.polarToCartesian(t,e,i+s,n),l=vt.polarToCartesian(t,e,i,r),h=vt.polarToCartesian(t,e,i,n),c=r-n<=180?"0":"1";return["M",o.x,o.y,"A",i+s,i+s,0,c,0,a.x,a.y,"L",h.x,h.y,"A",i,i,1,c,1,l.x,l.y].join(" ")}setToolboxBkg(t,e,i){const s=this.toolboxBkg.element;s.setAttributeNS(null,"viewBox",`0 0 ${e} ${i}`);const n=s.querySelector("#shape-dashboard-bkg");this.containerSpace;const r=this.toolboxBkgSize,o=.5*e,a=.5*i;n.setAttributeNS(null,"d",vt.describeArc(o,a,t,r,-110,110))}addAction(t){if(t.element=e.SVGFromString(t.svg),t.element.style=`position:absolute; height: ${this.toolSize}px; margin: 0`,t.element.classList.add("openlime-lens-dashboard-button"),"toggle"==t.type){t.element.querySelector(t.toggleClass).style.visibility="hidden",t.active=!1}t.element.addEventListener("click",(e=>{if("toggle"==t.type){t.active=!t.active;const e=t.element.querySelector(t.toggleClass);t.active?e.style.visibility="visible":e.style.visibility="hidden",this.noupdate=!0}t.task(e),e.preventDefault()})),this.container.appendChild(t.element)}getAction(t){let e=null;for(let[i,s]of Object.entries(this.actions))if(s.label===t){e=s;break}return e}setActionEnabled(t,e=!0){const i=this.getAction(t);i&&i.element.classList.toggle("enabled",e)}toggleLightController(){let t=this.actions.light.element.classList.toggle("openlime-lens-dashboard-light-active");this.actions.light.active=t,this.actions.camera.active=this.actions.camera.element.classList.toggle("openlime-lens-dashboard-camera-active");for(let e of Object.values(this.viewer.canvas.layers))for(let i of e.controllers)"light"==i.control&&(i.active=!0,i.activeModifiers=t?[0,2,4]:[2,4])}setToggleClassVisibility(t){for(let[e,i]of Object.entries(this.actions))if("toggle"==i.type&&i.active){const e=i.element.querySelector(i.toggleClass);e.style.visibility=t?"visible":"hidden"}}setToolboxElm(t,e,i){this.setToolboxBkg(t-this.borderWidth-2,e,i),this.first=!1;const s=2*Math.asin((.5*this.toolSize+this.toolPadding)/t);for(let n=0;n<this.group.length;n++){const r=Object.entries(this.actions).filter((([t,e])=>e.group==n));Math.abs(this.group[n])>90&&r.reverse();let o=0;for(let[a,l]of r){const r=this.toolSize,a=this.toolSize,h=vt.degToRadians(this.group[n])+o*s;let c=.5*e+(t+.5*this.toolSize+this.toolboxBkgPadding)*Math.sin(h)-a/2,d=.5*i-(t+.5*this.toolSize+this.toolboxBkgPadding)*Math.cos(h)-r/2;l.element.style.left=`${c}px`,l.element.style.top=`${d}px`,o++}}}update(t,e,i){if(this.noupdate)return void(this.noupdate=!1);super.update(t,e,i);const s={x:this.lensBox.x,y:this.lensBox.y},n=this.lensBox.r,r=this.lensBox.w,o=this.lensBox.h;this.updateCb&&this.updateCb(s.x,s.y,n,r,o,this.viewer.camera.viewport.w,this.viewer.camera.viewport.h),this.moving||(this.toggle(),this.moving=!0),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{this.toggle(),this.moving=!1,this.setToolboxElm(n,r,o),this.updateEndCb&&this.updateEndCb(s.x,s.y,n,r,o,this.viewer.camera.viewport.w,this.viewer.camera.viewport.h)}),this.delay)}}class yt{constructor(){this.audio=null,this.isPlaying=!1,this.isPaused=!1,this.isMuted=!1,this.previousVolume=1,this.playStartTime=null,this.playDuration=0,n(yt,"started","ended")}async play(t,e=1){if(this.isPlaying||this.isPaused)this.isPaused&&await this.continue();else{this.audio=new Audio(t),this.audio.playbackRate=e,this.audio.volume=this.previousVolume,this.isPlaying=!0,this.isPaused=!1,this.playStartTime=Date.now(),this.playDuration=0,this.audio.onplay=()=>{this.setMute(this.isMuted),this.emit("started")},this.audio.onended=()=>{this.isPlaying=!1,this.updatePlayDuration(),this.emit("ended")};try{return await this.audio.play(),new Promise((t=>{const e=this.audio.onended;this.audio.onended=()=>{e.call(this),t()}}))}catch(t){throw console.error("Error playing audio:",t),this.isPlaying=!1,t}}}pause(){!this.isPaused&&this.audio&&(this.audio.pause(),this.isPaused=!0,this.updatePlayDuration())}async continue(){if(this.isPaused&&this.audio){this.isPaused=!1,this.playStartTime=Date.now(),this.audio.onplay=()=>{this.setMute(this.isMuted),this.emit("started")};try{return await this.audio.play(),new Promise((t=>{const e=this.audio.onended;this.audio.onended=()=>{e.call(this),t()}}))}catch(t){throw console.error("Error continuing audio:",t),this.isPaused=!0,t}}else console.log("No paused audio to continue.")}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0,this.audio.onplay=null,this.audio.onended=null,this.isPlaying=!1,this.isPaused=!1,this.updatePlayDuration())}updatePlayDuration(){if(this.playStartTime){const t=Date.now();this.playDuration+=t-this.playStartTime,this.playStartTime=null}}getPlayDuration(){return this.playDuration}setVolume(t){this.audio?t>=0&&t<=1?(this.audio.volume=t,this.previousVolume=t):console.log("Volume must be between 0.0 and 1.0"):console.log("No audio loaded.")}async silence(t){return new Promise((e=>setTimeout(e,t)))}setMute(t){this.isMuted=t,this.audio&&(this.isMuted?(this.previousVolume=this.audio.volume,this.audio.volume=0):this.audio.volume=this.previousVolume)}emit(t){this[`${t}Signal`]&&this[`${t}Signal`].emit()}}class xt extends w{constructor(t){super(t=Object.assign({overlayElement:null,shadow:!0,svgElement:null,svgGroup:null,onClick:null,classes:{"":{stroke:"#000",label:""}},annotationUpdate:null},t));for(const[t,e]of Object.entries(this.classes))this.style+=`[data-class=${t}] { `+Object.entries(e).map((t=>`${t[0]}: ${t[1]};`)).join("\n")+"}";this.style+=".openlime-svgoverlay { position:absolute; top:0px; left:0px;}"}createOverlaySVGElement(){this.svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgElement.classList.add("openlime-svgoverlay"),this.svgGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgElement.append(this.svgGroup);let t=this.overlayElement;if(this.shadow&&(t=this.overlayElement.shadowRoot?this.overlayElement.shadowRoot:this.overlayElement.attachShadow({mode:"open"})),this.style){const e=document.createElement("style");e.textContent=this.style,t.append(e)}t.appendChild(this.svgElement)}setVisible(t){this.svgElement&&(this.svgElement.style.display=t?"block":"none"),super.setVisible(t)}clearSelected(){this.svgElement||this.createOverlaySVGElement(),this.svgGroup.querySelectorAll("[data-annotation]").forEach((t=>t.classList.remove("selected"))),super.clearSelected()}setSelected(t,e=!0){for(let i of this.svgElement.querySelectorAll(`[data-annotation="${t.id}"]`))i.classList.toggle("selected",e);super.setSelected(t,e)}newAnnotation(t){let i=e.createSVGElement("svg");return t||(t=new b({element:i,selector_type:"SvgSelector"})),super.newAnnotation(t)}draw(t,e){if(!this.svgElement)return!0;this.svgElement.setAttribute("viewBox",`${-e.w/2} ${-e.h/2} ${e.w} ${e.h}`);const i=this.getSvgGroupTransform(t);return this.svgGroup.setAttribute("transform",i),!0}getSvgGroupTransform(t,e=!1){let i=this.transform.compose(t),s=this.boundingBox().corner(0);return i=o.reflectY(i),e?`translate(${-s.x} ${-s.y})  scale(${1/i.z} ${1/i.z}) rotate(${i.a} 0 0) translate(${-i.x} ${-i.y})`:`translate(${i.x} ${i.y}) rotate(${-i.a} 0 0) scale(${i.z} ${i.z}) translate(${s.x} ${s.y})`}prefetch(t){if(this.svgElement||this.createOverlaySVGElement(),this.visible&&"ready"==this.status&&"string"!=typeof this.annotations){this.boundingBox();for(let e of this.annotations){if(!e.ready&&"string"==typeof e.svg){let t=(new DOMParser).parseFromString(e.svg,"image/svg+xml").documentElement;e.elements=[...t.children],e.ready=!0}if(this.annotationUpdate&&this.annotationUpdate(e,t),e.needsUpdate){e.needsUpdate=!1;for(let t of this.svgGroup.querySelectorAll(`[data-annotation="${e.id}"]`))t.remove();if(e.visible)for(let t of e.elements){let i=t;i.setAttribute("data-annotation",e.id),i.setAttribute("data-class",e.class),i.classList.add("openlime-annotation"),this.selected.has(e.id)&&i.classList.add("selected"),this.svgGroup.appendChild(i),i.onpointerdown=t=>{if(0==t.button){if(t.preventDefault(),t.stopPropagation(),this.onClick&&this.onClick(e))return;if(this.selected.has(e.id))return;this.clearSelected(),this.setSelected(e,!0)}}}}}}}}c.prototype.types.svg_annotations=t=>new xt(t);class bt{tap(t){let i=e.createSVGElement("circle",{cx:t.x,cy:t.y,r:10,class:"point"});return this.annotation.elements.push(i),!0}}class wt{constructor(t){Object.assign(this,t)}tap(t){const e=this.template(t.x,t.y);let i=(new DOMParser).parseFromString(e,"image/svg+xml").documentElement;return this.annotation.elements[0]=i,!0}}class Et{constructor(){this.points=[]}create(t){if(this.points.push(t),1==this.points.length)return saveCurrent,this.path=e.createSVGElement("path",{d:`M${t.x} ${t.y}`,class:"line"}),this.path;let i=this.path.getAttribute("d");this.path.setAttribute("d",i+` L${t.x} ${t.y}`),this.path.points=this.points}undo(){if(!this.points.length)return;this.points.pop();let t=this.points.map(((t,e)=>`${0==e?"M":"L"}${t.x} ${t.y}`)).join(" ");this.path.setAttribute("d",t),this.points.length<2&&(this.points=[],this.annotation.elements=this.annotation.elements.filter((t=>t!=this.path)))}}class Tt{constructor(){this.origin=null,this.box=null}create(t){return this.origin=t,this.box=e.createSVGElement("rect",{x:t.x,y:t.y,width:0,height:0,class:"rect"}),this.box}adjust(t){let e=this.origin;this.box.setAttribute("x",Math.min(e.x,t.x)),this.box.setAttribute("width",Math.abs(t.x-e.x)),this.box.setAttribute("y",Math.min(e.y,t.y)),this.box.setAttribute("height",Math.abs(t.y-e.y))}finish(t){return this.box}}class St{constructor(){this.origin=null,this.circle=null}create(t){return this.origin=t,this.circle=e.createSVGElement("circle",{cx:t.x,cy:t.y,r:0,class:"circle"}),this.circle}adjust(t){let e=this.origin,i=Math.hypot(t.x-e.x,t.y-e.y);this.circle.setAttribute("r",i)}finish(){return this.circle}}class kt{constructor(){this.history=[]}create(t){for(let e of this.annotation.elements)if(e.points&&!(e.points.length<2)){if(kt.distance(e.points[0],t)/t.pixelSize<5)return e.points.reverse(),this.path=e,this.path.setAttribute("d",kt.svgPath(e.points)),void(this.history=[this.path.points.length]);if(kt.distanceToLast(e.points,t)<5)return this.path=e,this.adjust(t),void(this.history=[this.path.points.length])}this.path=e.createSVGElement("path",{d:`M${t.x} ${t.y}`,class:"line"}),this.path.points=[t],this.history=[this.path.points.length],this.annotation.elements.push(this.path)}tap(t){return this.path?(this.adjust(t)&&(this.history=[this.path.points.length-1]),!0):(this.create(t),!1)}doubleTap(t){return!!this.path&&(this.adjust(t)&&(this.history=[this.path.points.length-1],this.path=null),!1)}hover(t,e){}quit(){}adjust(t){return!(kt.distanceToLast(this.path.points,t)/t.pixelSize<4)&&(this.path.points.push(t),this.path.getAttribute("d"),this.path.setAttribute("d",kt.svgPath(this.path.points)),!0)}finish(){return this.path.setAttribute("d",kt.svgPath(this.path.points)),!0}undo(){return!(!this.path||!this.history.length)&&(this.path.points=this.path.points.slice(0,this.history.pop()),this.path.setAttribute("d",kt.svgPath(this.path.points)),!0)}redo(){return!1}static svgPath(t){let e=function(t,e){let i=Math.pow(e,2);var s=function(e,n){var o,a,l,h,c,d,u,p,m,f;let g=t[e],v=t[n];a=g.x,l=g.y,f=(d=v.x-a)*d+(u=v.y-l)*u;let y=i;for(var x=e+1;x<n;x++){let e=t[x];0!==d||0!==u?(p=((e.x-a)*d+(e.y-l)*u)/f)>1?(h=e.x-v.x,c=e.y-v.y):p>0?(h=e.x-(a+d*p),c=e.y-(l+u*p)):(h=e.x-a,c=e.y-l):(h=e.x-a,c=e.y-l),(m=h*h+c*c)>y&&(o=x,y=m)}y>i&&(o-e>1&&s(e,o),r.push(t[o]),n-o>1&&s(o,n))},n=t.length-1,r=[t[0]];return s(0,n),r.push(t[n]),r}(t,1.5*t[0].pixelSize),i=function(t,e,i){e*=3.1415/180;let s,n,r,o,a,l,h=[];if(t.length<=2)return t.map((t=>[t.x,t.y]));let c=t[0],d=t[t.length-1],u=0,p=!1,m=Math.hypot(c.x-d.x,c.y-d.y);for(m<Math.SQRT2&&(d=c,u=0,c=t[t.length-2],p=!0),h.push([t[u].x,t[u].y]);u<t.length-1;u++){let d=t[u],p=t[u+1],b=Math.abs((g=d.x-c.x,v=d.y-c.y,y=p.x-d.x,x=p.y-d.y,a=Math.sqrt(g*g+v*v),a>0?(s=g/a,n=v/a):(s=1,n=0),l=Math.sqrt(y*y+x*x),l>0?(r=y/l,o=x/l):(r=1,o=0),Math.acos(s*r+n*o)));if(0!==a)if(b<e){i&&(a=Math.min(a,l),l=a);let t=(s+r)/2,e=(n+o)/2;if(m=Math.sqrt(t*t+e*e),0===m)h.push([d.x,d.y]);else{if(t/=m,e/=m,h.length>0){var f=h[h.length-1];f.push(d.x-t*a*.25),f.push(d.y-e*a*.25)}h.push([d.x,d.y,d.x+t*l*.25,d.y+e*l*.25])}}else h.push([d.x,d.y]);c=d}var g,v,y,x;if(p){for(c=[],u=0;u<h[0].length;u++)c.push(h[0][u]);h.push(c)}else h.push([t[t.length-1].x,t[t.length-1].y]);return h}(e,90,!0);return function(t){let e,i=t[0],s=[`M${i[0].toFixed(1)} ${i[1].toFixed(1)}`];for(let n=0;n<t.length-1;n++)i=t[n],e=t[n+1],2==i.length?s.push(`l${(e[0]-i[0]).toFixed(1)} ${(e[1]-i[1]).toFixed(1)}`):4==i.length?s.push(`q${(i[2]-i[0]).toFixed(1)} ${(i[3]-i[1]).toFixed(1)} ${(e[0]-i[0]).toFixed(1)} ${(e[1]-i[1]).toFixed(1)}`):s.push(`c${(i[2]-i[0]).toFixed(1)} ${(i[3]-i[1]).toFixed(1)} ${(i[4]-i[0]).toFixed(1)} ${(i[5]-i[1]).toFixed(1)} ${(e[0]-i[0]).toFixed(1)} ${(e[1]-i[1]).toFixed(1)}`);return s.join(" ")}(i)}static distanceToLast(t,e){let i=t[t.length-1];return kt.distance(i,e)}static distance(t,e){let i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}}class Ct{create(t,e){this.erased=!1,this.erase(t,e)}adjust(t,e){this.erase(t,e)}finish(t,e){return this.erase(t,e)}tap(t,e){return this.erase(t,e)}erase(t,e){for(let i of this.annotation.elements){if(i==e.originSrc){i.points=[],this.erased=!0;continue}let s=i.points;if(s&&s.length){if(kt.distanceToLast(s,t)<10)this.erased=!0,s.pop();else{if(!(kt.distance(s[0],t)<10))continue;this.erased=!0,s.shift()}s.length<=2?(i.points=[],i.setAttribute("d",""),this.annotation.needsUpdate=!0,this.erased=!0):i.setAttribute("d",kt.svgPath(s))}}return this.annotation.elements=this.annotation.elements.filter((t=>!t.points||t.points.length>2)),this.erased}}t.AudioPlayer=yt,t.BoundingBox=i,t.Camera=p,t.Canvas=d,t.Color=f,t.Colormap=class{constructor(t=[new f(0,0,0,1),new f(1,1,1,1)],e=""){e=Object.assign({domain:[0,1],lowColor:null,highColor:null,description:"",type:"linear"},e),Object.assign(this,e);const i=t.length;this.lowColor||(this.lowColor=t[0]),this.highColor||(this.highColor=t[i-1]);const s=this.domain.length;if(i<2&&2!=s&&this.nval!=s&&this.domain[s-1]<=this.domain[0])throw Error("Colormap colors/domain bad format");const n=(this.domain[s-1]-this.domain[0])/(i-1);this.xarr=[],this.rarr=[],this.garr=[],this.barr=[],this.aarr=[];for(let e=0;e<i;e++)2==s?this.xarr.push(this.domain[0]+e*n):this.xarr.push(this.domain[e]),this.rarr.push(t[e].r),this.garr.push(t[e].g),this.barr.push(t[e].b),this.aarr.push(t[e].a);this.rspline=new m(this.xarr,this.rarr),this.gspline=new m(this.xarr,this.garr),this.bspline=new m(this.xarr,this.barr),this.aspline=new m(this.xarr,this.aarr)}static clamp=(t,e,i)=>Math.min(Math.max(t,e),i);rangeDomain(){return[this.domain[0],this.domain[this.domain.length-1]]}bar(t){if(t<this.xarr[0])return this.lowColor;if(t>this.xarr[this.xarr.length-1])return this.highColor;const e=new f(this.rarr[0],this.garr[0],this.barr[0],this.aarr[0]);for(let i=0;i<this.xarr.length-1;i++)t>this.xarr[i]&&t<=this.xarr[i+1]&&(e.r=this.rarr[i],e.g=this.garr[i],e.b=this.barr[i],e.a=this.aarr[i]);return e}linear(t){if(t<this.xarr[0])return this.lowColor;if(t>this.xarr[this.xarr.length-1])return this.highColor;const e=new f(this.rarr[0],this.garr[0],this.barr[0],this.aarr[0]);for(let i=0;i<this.xarr.length-1;i++)t>this.xarr[i]&&t<=this.xarr[i+1]&&(e.r=(this.rarr[i+1]-this.rarr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.rarr[i],e.g=(this.garr[i+1]-this.garr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.garr[i],e.b=(this.barr[i+1]-this.barr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.barr[i],e.a=(this.aarr[i+1]-this.aarr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.aarr[i]);return e}spline(t){return t<this.xarr[0]?this.lowColor:t>this.xarr[this.xarr.length-1]?this.highColor:new f(this.rspline.at(t),this.gspline.at(t),this.bspline.at(t),this.aspline.at(t))}at(t){let e=null;switch(this.type){case"linear":e=this.linear(t);break;case"spline":e=this.spline(t);break;case"bar":e=this.bar(t);break;default:throw Error("Interpolant type not exist")}return e}sample(t){let e=this.xarr[0],i=this.xarr[this.xarr.length-1],s=new Uint8Array(4*t),n=(i-e)/t;for(let i=0;i<t;i++){let t=this.at(e+i*n).toRGBA();s[4*i+0]=t[0],s[4*i+1]=t[1],s[4*i+2]=t[2],s[4*i+3]=t[3]}return{min:e,max:i,buffer:s}}},t.ColormapLegend=class{constructor(t,e,i){i=Object.assign({nticks:6,legendWidth:25,textColor:"#fff",class:"openlime-legend"},i),Object.assign(this,i),this.viewer=t,this.colorscale=e,this.container=document.querySelector(`.${this.class}`),this.container||(this.container=document.createElement("div"),this.container.classList.add(this.class)),this.scale=document.createElement("div"),this.scale.style=`display: flex; border-radius: 20px; height: 22px; color: ${this.textColor}; \n\t\tfont-weight: bold; overflow: hidden; margin: 0px 2px 4px 0px; background-color: #7c7c7c; \n\t\tfont-family: Arial,Helvetica,sans-serif; font-size:12px;\n\t\tborder: 1px solid #000;`,this.container.appendChild(this.scale),this.viewer.containerElement.appendChild(this.container);const s=e.rangeDomain(),n=document.createElement("div");n.style=`display: flex; align-items: center; justify-content: center; \n\t\tbackground: ${e.linear(s[0]).toHex()}; width: ${this.legendWidth}%; margin: 0`,n.textContent=e.description,this.scale.appendChild(n),"linear"==this.colorscale.type&&this.legendLinear(),"bar"==this.colorscale.type&&this.legendBar()}legendLinear(){const t=this.colorscale.rangeDomain(),e=(t[1]-t[0])/this.nticks,i=(100-this.legendWidth)/this.nticks;let s=t[0];for(let n=0;n<this.nticks;n++){let r=t[0]+e*n,o=n<this.nticks-1?t[0]+e*(n+.5):r;const a=this.colorscale.at(r),l=this.colorscale.at(s),h=this.colorscale.at(o),c=document.createElement("div"),d=`background: linear-gradient(to right, ${l.toHex()}, ${a.toHex()}, ${h.toHex()})`;c.style=`display: flex; align-items: center; justify-content: center; \n\t\t\t${d};\twidth: ${i}%; margin: 0`,c.textContent=r.toFixed(1),this.scale.appendChild(c),s=o}}legendBar(){const t=(100-this.legendWidth)/this.colorscale.domain.length;for(let e=0;e<this.colorscale.xarr.length;e++){const i=new f(this.colorscale.rarr[e],this.colorscale.garr[e],this.colorscale.barr[e],this.colorscale.aarr[e]),s=this.colorscale.xarr[e],n=document.createElement("div"),r=`background: ${i.toHex()}`;n.style=`display: flex; align-items: center; justify-content: center; \n\t\t\t${r};\twidth: ${t}%; margin: 0`,n.textContent=s.toFixed(1),this.scale.appendChild(n)}}},t.Controller=R,t.Controller2D=M,t.ControllerFocusContext=ft,t.ControllerLens=mt,t.ControllerPanZoom=A,t.CoordinateSystem=o,t.Draggable=class{constructor(t,e,i={}){if(this.options={top:null,bottom:20,left:null,right:20,handleSize:10,handleGap:5,zindex:200,handleColor:"#f0f0f0b3",dragOpacity:.6},Object.assign(this.options,i),this.element=t,this.parent="string"==typeof e?document.querySelector(e):e,!this.element||!this.parent)throw new Error("Draggable requires valid element and parent");null!==this.options.left&&(this.options.right=null),null!==this.options.top&&(this.options.bottom=null),this.setupContextMenu(),this.createElements(),this.setupDragEvents(),this.appendChild(this.element),this.setupResizeHandler()}setupContextMenu(){window.setCtxMenu||(window.addEventListener("contextmenu",(t=>t.preventDefault())),window.setCtxMenu=!0)}createElements(){const{handleGap:t,zindex:e,handleColor:i,handleSize:s}=this.options;this.container=document.createElement("div"),this.container.classList.add("openlime-draggable"),this.container.style.display="flex",this.container.style.gap=`${t}px`,this.container.style.position="absolute",this.container.style.zIndex=e,this.container.style.touchAction="none",this.container.style.visibility="visible",this.handle=document.createElement("div"),this.handle.style.borderRadius="4px",this.handle.style.backgroundColor=i,this.handle.style.padding="0",this.handle.style.width=`${s}px`,this.handle.style.height=`${s}px`,this.handle.style.zIndex=e+5,this.handle.style.cursor="grab",this.container.appendChild(this.handle),this.parent.appendChild(this.container)}setupResizeHandler(){let t;window.addEventListener("resize",(()=>{clearTimeout(t),t=setTimeout((()=>this.updatePosition()),100)}))}setupDragEvents(){let t,e,i=!1;const s=s=>{if(!i)return;s.preventDefault();const n=Math.max(0,Math.min(s.clientX-t,this.parent.offsetWidth-this.container.offsetWidth)),r=Math.max(0,Math.min(s.clientY-e,this.parent.offsetHeight-this.container.offsetHeight));this.container.style.left=`${n}px`,this.container.style.top=`${r}px`,this.options.left=n,this.options.right=null,this.options.top=r,this.options.bottom=null},n=()=>{i&&(this.container.style.opacity="1.0",this.handle.style.cursor="grab",i=!1,document.removeEventListener("pointermove",s))};this.handle.addEventListener("pointerdown",(n=>{n.preventDefault(),i=!0,this.container.style.opacity=this.options.dragOpacity,this.handle.style.cursor="grabbing",t=n.clientX-this.container.offsetLeft,e=n.clientY-this.container.offsetTop,document.addEventListener("pointermove",s)})),document.addEventListener("pointerup",n),document.addEventListener("pointercancel",n)}appendChild(t){return t&&(t.style.position="unset",this.container.appendChild(t),this.updatePosition()),this}updatePosition(){const t=this.container.offsetWidth,e=this.container.offsetHeight,i=this.parent.offsetWidth,s=this.parent.offsetHeight;let n=0,r=0;return null!==this.options.top?n=this.options.top:null!==this.options.bottom&&(n=s-this.options.bottom-e),null!==this.options.left?r=this.options.left:null!==this.options.right&&(r=i-this.options.right-t),n=Math.max(0,Math.min(n,s-e)),r=Math.max(0,Math.min(r,i-t)),this.container.style.top=`${n}px`,this.container.style.left=`${r}px`,this}show(){return this.container.style.visibility="visible",this}hide(){return this.container.style.visibility="hidden",this}setHandleColor(t){return this.options.handleColor=t,this.handle.style.backgroundColor=t,this}},t.EditorSvgAnnotation=class{constructor(t,e,i){this.layer=e,Object.assign(this,{viewer:t,panning:!1,tool:null,startPoint:null,currentLine:[],annotation:null,priority:2e4,classes:{"":{stroke:"#000",label:""},class1:{stroke:"#770",label:""},class2:{stroke:"#707",label:""},class3:{stroke:"#777",label:""},class4:{stroke:"#070",label:""},class5:{stroke:"#007",label:""},class6:{stroke:"#077",label:""}},tools:{point:{img:'<svg width=24 height=24><circle cx=12 cy=12 r=3 fill="red" stroke="gray"/></svg>',tooltip:"New point",tool:bt},pin:{template:(t,e)=>`<svg xmlns='http://www.w3.org/2000/svg' x='${t}' y='${e}' width='4%' height='4%' class='pin'\n\t\t\t\t\t\tviewBox='0 0 18 18'><path d='M 0,0 C 0,0 4,0 8,0 12,0 16,4 16,8 16,12 12,16 8,16 4,16 0,12 0,8 0,4 0,0 0,0 Z'/><text class='pin-text' x='7' y='8'>${this.annotation.idx}</text></svg>`,tooltip:"New pin",tool:wt},pen:{img:'<svg width=24 height=24><circle cx=12 cy=12 r=3 fill="red" stroke="gray"/></svg>',tooltip:"New polyline",tool:Et},line:{img:'<svg width=24 height=24>\n\t\t\t\t\t\t<path d="m 4.7,4.5 c 0.5,4.8 0.8,8.5 3.1,11 2.4,2.6 4.2,-4.8 6.3,-5 2.7,-0.3 5.1,9.3 5.1,9.3" stroke-width="3" fill="none" stroke="grey"/>\n\t\t\t\t\t\t<path d="m 4.7,4.5 c 0.5,4.8 0.8,8.5 3.1,11 2.4,2.6 4.2,-4.8 6.3,-5 2.7,-0.3 5.1,9.3 5.1,9.3" stroke-width="1" fill="none" stroke="red"/></svg>',tooltip:"New line",tool:kt},erase:{img:"",tooltip:"Erase lines",tool:Ct},box:{img:'<svg width=24 height=24><rect x=5 y=5 width=14 height=14 fill="red" stroke="gray"/></svg>',tooltip:"New box",tool:Tt},circle:{img:'<svg width=24 height=24><circle cx=12 cy=12 r=7 fill="red" stroke="gray"/></svg>',tooltip:"New circle",tool:St}},annotation:null,enableState:!1,customState:null,customData:null,editWidget:null,selectedCallback:null,createCallback:null,updateCallback:null,deleteCallback:null},i),e.style+=Object.entries(this.classes).map((t=>(console.assert(t[1].hasOwnProperty("stroke"),"Classes needs a stroke property"),`[data-class=${t[0]}] { stroke:${t[1].stroke}; }`))).join("\n"),t.pointerManager.onEvent(this),document.addEventListener("keyup",(t=>this.keyUp(t)),!1),e.addEvent("selected",(t=>{t&&t!=this.annotation&&(this.selectedCallback&&this.selectedCallback(t),this.showEditWidget(t))})),e.annotationsEntry=()=>{let t={html:'<div class="openlime-tools"></div>',list:[],classes:"openlime-annotations",status:()=>"active",oncreate:()=>{Array.isArray(e.annotations)&&e.createAnnotationsList();let i={add:{action:()=>{this.createAnnotation()},title:"New annotation"},edit:{action:()=>{this.toggleEditWidget()},title:"Edit annotations"},export:{action:()=>{this.exportAnnotations()},title:"Export annotations"},trash:{action:()=>{this.deleteSelected()},title:"Delete selected annotations"}};(async()=>{for(const[e,s]of Object.entries(i)){let i=await j.appendIcon(t.element.firstChild,".openlime-"+e);i.setAttribute("title",s.title),i.addEventListener("click",s.action)}})()}};return e.annotationsListEntry=t,t}}createAnnotation(){let t=this.layer.newAnnotation();this.customData&&this.customData(t),this.enableState&&this.setAnnotationCurrentState(t),t.idx=this.layer.annotations.length,t.publish=1,t.label=t.description=t.class="";let e={id:t.id,idx:t.idx,label:t.label,description:t.description,class:t.class,svg:null,publish:t.publish,data:t.data};if(this.enableState&&(e={...e,state:t.state}),this.createCallback){this.createCallback(e)||alert("Failed to create annotation!")}this.layer.setSelected(t)}toggleEditWidget(){if(this.annotation)return this.hideEditWidget();let t=this.layer.selected.values().next().value;if(!t)return;let e=this.layer.getAnnotationById(t);this.showEditWidget(e)}updateEditWidget(){let t=this.annotation,e=this.editWidget;t.class||(t.class=""),e.querySelector("[name=label]").value=t.label||"",e.querySelector("[name=description]").value=t.description||"",e.querySelector("[name=idx]").value=t.idx||"",Object.entries(t.data).map((t=>{e.querySelector(`[name=data-data-${t[0]}]`).value=t[1]||""})),e.querySelector("[name=classes]").value=t.class,e.querySelector("[name=publish]").checked=1==t.publish,e.classList.remove("hidden");let i=e.querySelector(".openlime-select-button");i.textContent=this.classes[t.class].label,i.style.background=this.classes[t.class].stroke}showEditWidget(t){this.annotation=t,this.setTool(null),this.setActiveTool(),this.layer.annotationsListEntry.element.querySelector(".openlime-edit").classList.add("active"),(async()=>{await this.createEditWidget(),this.updateEditWidget()})()}hideEditWidget(){this.annotation=null,this.setTool(null),this.editWidget.classList.add("hidden"),this.layer.annotationsListEntry.element.querySelector(".openlime-edit").classList.remove("active")}async createEditWidget(){if(this.editWidget)return;let t=`\n\t\t\t\t<div class="openlime-annotation-edit">\n\t\t\t\t\t<label for="label">Title:</label> <input name="label" type="text"><br>\n\t\t\t\t\t<label for="description">Description:</label><br>\n\t\t\t\t\t<textarea name="description" cols="30" rows="5"></textarea><br>\n\t\t\t\t\t<span>Class:</span> \n\t\t\t\t\t<div class="openlime-select">\n\t\t\t\t\t\t<input type="hidden" name="classes" value=""/>\n\t\t\t\t\t\t<div class="openlime-select-button"></div>\n\t\t\t\t\t\t<ul class="openlime-select-menu">\n\t\t\t\t\t\t${Object.entries(this.classes).map((t=>`<li data-class="${t[0]}" style="background:${t[1].stroke};">${t[1].label}</li>`)).join("\n")}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<label for="idx">Index:</label> <input name="idx" type="text"><br>\t\n\t\t\t\t\t${Object.entries(this.annotation.data).map((t=>{let e=t[0];return`<label for="data-data-${t[0]}">${e}:</label> <input name="data-data-${t[0]}" type="text"><br>`})).join("\n")}\n\t\t\t\t\t<br>\n\t\t\t\t\t<span><button class="openlime-state">SAVE</button></span>\n\t\t\t\t\t<span><input type="checkbox" name="publish" value=""> Publish</span><br>\n\t\t\t\t\t<div class="openlime-annotation-edit-tools"></div>\n\t\t\t\t</div>`,e=document.createElement("template");e.innerHTML=t.trim();let i=e.content.firstChild,s=i.querySelector(".openlime-select"),n=i.querySelector(".openlime-select-button"),r=i.querySelector("ul"),o=i.querySelectorAll("li"),a=i.querySelector("[name=classes]");i.querySelector(".openlime-state").addEventListener("click",(t=>{this.enableState&&this.setAnnotationCurrentState(this.annotation),this.saveCurrent(),this.saveAnnotation()})),n.addEventListener("click",(t=>{t.stopPropagation();for(let t of o)t.classList.remove("selected");s.classList.toggle("active")})),r.addEventListener("click",(t=>{t.stopPropagation(),a.value=t.srcElement.getAttribute("data-class"),a.dispatchEvent(new Event("change")),n.style.background=this.classes[a.value].stroke,n.textContent=t.srcElement.textContent,s.classList.toggle("active")})),document.addEventListener("click",(t=>{s.classList.remove("active")})),document.querySelector(".openlime-layers-menu").appendChild(i);let l=i.querySelector(".openlime-annotation-edit-tools"),h=await j.appendIcon(l,".openlime-pin");h.addEventListener("click",(t=>{this.setTool("pin"),this.setActiveTool(h)}));let c=await j.appendIcon(l,".openlime-draw");c.addEventListener("click",(t=>{this.setTool("line"),this.setActiveTool(c)}));let d=await j.appendIcon(l,".openlime-erase");d.addEventListener("click",(t=>{this.setTool("erase"),this.setActiveTool(d)})),(await j.appendIcon(l,".openlime-undo")).addEventListener("click",(t=>{this.undo()})),(await j.appendIcon(l,".openlime-redo")).addEventListener("click",(t=>{this.redo()}));let u=i.querySelector("[name=label]");u.addEventListener("blur",(t=>{this.annotation.label!=u.value&&this.saveCurrent(),this.saveAnnotation()}));let p=i.querySelector("[name=description]");p.addEventListener("blur",(t=>{this.annotation.description!=p.value&&this.saveCurrent(),this.saveAnnotation()}));let m=i.querySelector("[name=idx]");m.addEventListener("blur",(t=>{if(this.annotation.idx!=m.value){const t=this.annotation.elements[0];if(t){const e=t.querySelector(".pin-text");e&&(e.textContent=m.value)}this.saveCurrent()}this.saveAnnotation()})),Object.entries(this.annotation.data).map((t=>{let e=i.querySelector(`[name=data-data-${t[0]}]`);e.addEventListener("blur",(i=>{this.annotation.data[t[0]]!=e.value&&this.saveCurrent(),this.saveAnnotation()}))}));let f=i.querySelector("[name=classes]");f.addEventListener("change",(t=>{this.annotation.class!=f.value&&this.saveCurrent(),this.saveAnnotation()}));let g=i.querySelector("[name=publish]");g.addEventListener("change",(t=>{this.annotation.publish!=g.value&&this.saveCurrent(),this.saveAnnotation()})),i.classList.add("hidden"),this.editWidget=i}setAnnotationCurrentState(t){t.state=window.structuredClone(this.viewer.canvas.getState()),this.customState&&this.customState(t)}saveAnnotation(){let t=this.editWidget,e=this.annotation;e.label=t.querySelector("[name=label]").value||"",e.description=t.querySelector("[name=description]").value||"",e.idx=t.querySelector("[name=idx]").value||"0",Object.entries(e.data).map((i=>{e.data[i[0]]=t.querySelector(`[name=data-data-${i[0]}]`).value||""})),e.publish=t.querySelector("[name=publish]").checked?1:0;let i=t.querySelector("[name=classes]");e.class=i.value||"",t.querySelector(".openlime-select-button").style.background=this.classes[e.class].stroke;for(let t of this.annotation.elements)t.setAttribute("data-class",e.class);let s={id:e.id,idx:e.idx,label:e.label,description:e.description,class:e.class,publish:e.publish,data:e.data};this.enableState&&(s={...s,state:e.state});let n=new XMLSerializer;if(s.svg=`<svg xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t${e.elements.map((t=>(t.classList.remove("selected"),n.serializeToString(t)))).join("\n")}  \n\t\t\t\t</svg>`,this.updateCallback){if(!this.updateCallback(s))return void alert("Failed to update annotation")}let r=document.createElement("template");r.innerHTML=this.layer.createAnnotationEntry(e);let o=r.content.firstChild;this.layer.annotationsListEntry.element.parentElement.querySelector(`[data-annotation="${e.id}"]`).replaceWith(o),this.layer.setSelected(e)}deleteSelected(){let t=this.layer.selected.values().next().value;t&&this.deleteAnnotation(t)}deleteAnnotation(t){let e=this.layer.getAnnotationById(t);if(this.deleteCallback){if(!confirm(`Deleting annotation ${e.label}, are you sure?`))return;if(!this.deleteCallback(e))return void alert("Failed to delete this annotation.")}this.layer.svgGroup.querySelectorAll(`[data-annotation="${e.id}"]`).forEach((t=>t.remove())),this.layer.annotationsListEntry.element.parentElement.querySelector(".openlime-list").querySelectorAll(`[data-annotation="${e.id}"]`).forEach((t=>t.remove())),this.layer.annotations=this.layer.annotations.filter((t=>t!==e)),this.layer.clearSelected(),this.hideEditWidget()}exportAnnotations(){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");const i=this.layer.boundingBox();t.setAttribute("viewBox",`0 0 ${i.xHigh-i.xLow} ${i.yHigh-i.yLow}`);let s=e.createSVGElement("style");s.textContent=this.layer.style,t.appendChild(s);let n=new XMLSerializer;for(let e of this.layer.annotations)for(let i of e.elements){if("path"==i.tagName){let t=i.getAttribute("d");i.setAttribute("d",t.replaceAll(","," "))}t.appendChild(i.cloneNode())}let r=n.serializeToString(t);var o=document.createElement("a");o.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(r)),o.setAttribute("download","annotations.svg"),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}setActiveTool(t){if(!this.editWidget)return;this.editWidget.querySelector(".openlime-annotation-edit-tools").querySelectorAll("svg").forEach((t=>t.classList.remove("active"))),t&&t.classList.add("active")}setTool(t){if(this.tool=t,this.factory&&this.factory.quit&&this.factory.quit(),t){if(!t in this.tools)throw"Unknown editor tool: "+t;this.factory=new this.tools[t].tool(this.tools[t]),this.factory.annotation=this.annotation,this.factory.layer=this.layer}document.querySelector(".openlime-overlay").classList.toggle("erase","erase"==t),document.querySelector(".openlime-overlay").classList.toggle("crosshair",t&&"erase"!=t)}undo(){let t=this.annotation;if(t){if(this.factory&&this.factory.undo&&this.factory.undo())return t.needsUpdate=!0,void this.viewer.redraw();if(t.history&&t.history.length){t.future.push(this.annoToData(t));let e=t.history.pop();this.dataToAnno(e,t),t.needsUpdate=!0,this.viewer.redraw(),this.updateEditWidget()}}}redo(){let t=this.annotation;if(t){if(this.factory&&this.factory.redo&&this.factory.redo())return t.needsUpdate=!0,void this.viewer.redraw();if(t.future&&t.future.length){t.history.push(this.annoToData(t));let e=t.future.pop();this.dataToAnno(e,t),t.needsUpdate=!0,this.viewer.redraw(),this.updateEditWidget()}}}saveCurrent(){let t=this.annotation;t.history||(t.history=[]),t.history.push(this.annoToData(t)),t.future=[]}annoToData(t){let e={};for(let i of["id","label","description","class","publish","data"])e[i]=`${t[i]||""}`;return e.elements=t.elements.map((t=>{let e=t.cloneNode();return e.points=t.points,e})),e}dataToAnno(t,e){for(let i of["id","label","description","class","publish","data"])e[i]=`${t[i]}`;e.elements=t.elements.map((t=>{let e=t.cloneNode();return e.points=t.points,e}))}keyUp(t){if(!t.defaultPrevented)switch(t.key){case"Escape":this.tool&&(this.setActiveTool(),this.setTool(null),t.preventDefault());break;case"Delete":this.deleteSelected();break;case"Backspace":break;case"z":t.ctrlKey&&this.undo();break;case"Z":t.ctrlKey&&this.redo()}}panStart(t){if(1!=t.buttons||t.ctrlKey||t.altKey||t.shiftKey||t.metaKey)return;if(!["line","erase","box","circle"].includes(this.tool))return;this.panning=!0,t.preventDefault(),this.saveCurrent();const e=this.mapToSvg(t);this.factory.create(e,t),this.annotation.needsUpdate=!0,this.viewer.redraw()}panMove(t){if(!this.panning)return!1;const e=this.mapToSvg(t);this.factory.adjust(e,t)}panEnd(t){if(!this.panning)return!1;this.panning=!1;const e=this.mapToSvg(t);this.factory.finish(e,t)?this.saveAnnotation():this.annotation.history.pop(),this.annotation.needsUpdate=!0,this.viewer.redraw()}fingerHover(t){if("line"!=this.tool)return;t.preventDefault();const e=this.mapToSvg(t);this.factory.hover(e,t),this.annotation.needsUpdate=!0,this.viewer.redraw()}fingerSingleTap(t){if(!["point","pin","line","erase"].includes(this.tool))return;t.preventDefault(),this.saveCurrent();const e=this.mapToSvg(t);this.factory.tap(e,t)?this.saveAnnotation():this.annotation.history.pop(),this.annotation.needsUpdate=!0,this.viewer.redraw()}fingerDoubleTap(t){if(!["line"].includes(this.tool))return;t.preventDefault(),this.saveCurrent();const e=this.mapToSvg(t);this.factory.doubleTap(e,t)?this.saveAnnotation():this.annotation.history.pop(),this.annotation.needsUpdate=!0,this.viewer.redraw()}mapToSvg(t){const e={x:t.offsetX,y:t.offsetY},i=this.layer.transform,s=!1,n=this.layer.boundingBox(),r={w:n.width(),h:n.height()};let a=o.fromCanvasHtmlToImage(e,this.viewer.camera,i,r,s);e.x+=1;let l=o.fromCanvasHtmlToImage(e,this.viewer.camera,i,r,s);return a.pixelSize=Math.abs(l.x-a.x),a}},t.FocusContext=pt,t.GeoreferenceManager=class{constructor(t,e){if(!t||!e)throw new Error("Viewer and layer are required");this.viewer=t,this.camera=t.camera,this.layer=e,this.earthRadius=6378137,this.imageSize=Math.max(this.layer.width,this.layer.height),this.minZoom=0,this.maxZoom=19,this.setupViewer()}setupViewer(){this.camera.setGeoPosition=(t,e,i)=>{const s=this.geoToScene(t,e),n=Math.min(this.maxZoom,Math.max(this.minZoom,i)),r=void 0!==n?1/Math.pow(2,n):this.camera.getCurrentTransform(performance.now()).z;this.camera.setPosition(250,-s.x*r,-s.y*r,r,0)},this.camera.getGeoPosition=()=>{const t=this.camera.getCurrentTransform(performance.now()),e=this.sceneToGeo(-t.x/t.z,-t.y/t.z),i=Math.log2(1/t.z),s=Math.min(this.maxZoom,Math.max(this.minZoom,i));return{lat:e.lat,lon:e.lon,zoom:s}}}geoToWebMercator(t,e){const i=(t=Math.max(Math.min(t,85.051129),-85.051129))*Math.PI/180,s=e*Math.PI/180;return{x:this.earthRadius*s,y:this.earthRadius*Math.log(Math.tan(Math.PI/4+i/2))}}webMercatorToGeo(t,e){const i=t/this.earthRadius,s=2*Math.atan(Math.exp(e/this.earthRadius))-Math.PI/2,n=180*i/Math.PI;return{lat:180*s/Math.PI,lon:n}}webMercatorToScene(t,e){const i=Math.PI*this.earthRadius,s=this.layer.width/(2*i);return{x:t*s,y:e*s}}sceneToWebMercator(t,e){const i=2*(Math.PI*this.earthRadius)/this.layer.width;return{x:t*i,y:e*i}}geoToScene(t,e){const i=this.geoToWebMercator(t,e);return this.webMercatorToScene(i.x,i.y)}sceneToGeo(t,e){const i=this.sceneToWebMercator(t,e);return this.webMercatorToGeo(i.x,i.y)}canvasToGeo(t,e){const i=o.fromCanvasHtmlToScene({x:t,y:e},this.camera,!0);return this.sceneToGeo(i.x,i.y)}flyTo(t,e,i,s=500,n="linear"){if(!this.viewer||!this.camera)throw new Error("Viewer not initialized");const r=this.geoToScene(t,e),o=Math.min(this.maxZoom,Math.max(this.minZoom,i)),a=1/Math.pow(2,o);this.camera.setPosition(s,-r.x*a,-r.y*a,a,0,n)}getCurrentPosition(){const t=this.camera.getCurrentTransform(performance.now()),e=this.sceneToGeo(-t.x/t.z,-t.y/t.z),i=Math.log2(1/t.z),s=Math.min(this.maxZoom,Math.max(this.minZoom,i));return{lat:e.lat,lon:e.lon,zoom:s}}},t.HSH=et,t.Layer=c,t.LayerAnnotation=w,t.LayerAnnotationImage=T,t.LayerBRDF=ct,t.LayerCombiner=x,t.LayerHDR=O,t.LayerImage=y,t.LayerLens=ut,t.LayerMaskedImage=S,t.LayerMultispectral=B,t.LayerNeuralRTI=lt,t.LayerRTI=ot,t.LayerSvgAnnotation=xt,t.Layout=a,t.LayoutTileImages=E,t.LayoutTiles=k,t.LensDashboard=gt,t.LensDashboardNavigator=class extends gt{constructor(t,i){super(t,i),i=Object.assign({toolboxHeight:22,toolboxGap:5,actions:{camera:{label:"camera",cb_task:()=>{},task:t=>{this.actions.camera.active||this.toggleLightController(),this.actions.camera.cb_task()}},light:{label:"light",cb_task:()=>{},task:t=>{this.actions.light.active||this.toggleLightController(),this.actions.light.cb_task()}},annoswitch:{label:"annoswitch",type:"toggle",toggleClass:".openlime-lens-dashboard-annoswitch-bar",task:t=>{}},prev:{label:"prev",task:t=>{}},down:{label:"down",task:t=>{}},next:{label:"next",task:t=>{}}},updateCb:null,updateEndCb:null},i),Object.assign(this,i),this.moving=!1,this.delay=400,this.timeout=null,this.noupdate=!1,this.angleToolbar=Math.PI/180*30,this.container.style.display="block",this.container.style.margin="0";const s=document.createElement("div");s.style="text-align: center; color: #fff",s.classList.add("openlime-lens-dashboard-toolbox-header"),s.innerHTML="MOVE";const n=document.createElement("div");n.style="text-align: center; color: #fff",n.classList.add("openlime-lens-dashboard-toolbox-header"),n.innerHTML="INFO",this.toolbox1=document.createElement("div"),this.toolbox1.style="z-index: 10; position: absolute; padding: 4px; left: 0px; width: fit-content; background-color: rgb(20, 20, 20, 1.0); border-radius: 10px; gap: 8px",this.toolbox1.classList.add("openlime-lens-dashboard-toolbox"),this.container.appendChild(this.toolbox1),this.toolbox1.appendChild(s),this.toolbox2=document.createElement("div"),this.toolbox2.style="z-index: 10; position: absolute; padding: 4px; right: 0px; width: fit-content; background-color: rgb(20, 20, 20, 1.0); border-radius: 10px; gap: 8px",this.toolbox2.classList.add("openlime-lens-dashboard-toolbox"),this.container.appendChild(this.toolbox2),this.toolbox2.appendChild(n),this.tools1=document.createElement("div"),this.tools1.style=`display: flex; justify-content: center; height: ${this.toolboxHeight}px`,this.tools1.classList.add("openlime-lens-dashboard-toolbox-tools"),this.toolbox1.appendChild(this.tools1),this.tools2=document.createElement("div"),this.tools2.style=`display: flex; justify-content: center; height: ${this.toolboxHeight}px`,this.tools2.classList.add("openlime-lens-dashboard-toolbox-tools"),this.toolbox2.appendChild(this.tools2),this.actions.camera.svg='\x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n\n<svg\n   viewBox="0 0 83.319054 83.319054"\n   version="1.1"\n   id="svg2495"\n   xml:space="preserve"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg"><defs\n     id="defs2492" /><path\n     d="m 83.319059,41.66005 c 0,23.007824 -18.651718,41.659533 -41.659532,41.659533 C 18.651716,83.319583 -4.9557762e-6,64.667874 -4.9557762e-6,41.66005 -4.9557762e-6,18.651185 18.651716,-5.2882463e-4 41.659527,-5.2882463e-4 64.667341,-5.2882463e-4 83.319059,18.651185 83.319059,41.66005 Z"\n     style="fill:#fbfbfb;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n     id="path74"\n     class="openlime-lens-dashboard-button-bkg" /><g\n     id="g1"\n     class="openlime-lens-dashboard-camera"><path\n       stroke="#000000"\n       stroke-width="9.03222"\n       d="M 41.659527,5.5306402 V 32.627305 m 0,18.064443 v 27.096665"\n       id="path1"\n       style="fill:none" /><path\n       stroke="#000000"\n       stroke-linecap="round"\n       stroke-linejoin="round"\n       stroke-width="9.03222"\n       d="M 30.36925,16.820917 41.659527,5.5306402 52.949804,16.820917 M 30.36925,66.498136 41.659527,77.788413 52.949804,66.498136 M 16.820917,30.36925 5.5306402,41.659527 16.820917,52.949804 M 66.498136,30.36925 77.788413,41.659527 66.498136,52.949804 M 12.304806,41.659527 h 58.709441"\n       id="path2"\n       style="fill:none" /></g></svg>',this.actions.light.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n\x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n\n<svg\n   viewBox="0 0 83.319054 83.320114"\n   version="1.1"\n   id="svg5698"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <defs\n     id="defs5695" />\n  <path\n     d="m 83.319055,41.660582 c 0,23.00782 -18.651715,41.659529 -41.659525,41.659529 C 18.65172,83.320111 -8.5009768e-7,64.668402 -8.5009768e-7,41.660582 -8.5009768e-7,18.651717 18.65172,3.1357422e-6 41.65953,3.1357422e-6 64.66734,3.1357422e-6 83.319055,18.651717 83.319055,41.660582 Z"\n     style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n     id="path74"\n     class="openlime-lens-dashboard-button-bkg" />\n  <g\n     id="g1"\n     transform="matrix(1.4106801,0,0,1.4106801,-164.24813,-100.38311)"\n     class="openlime-lens-dashboard-light">\n    <path\n       d="m 137.44618,117.65204 c 0.139,1.31022 5.28885,5.23911 7.37659,5.43772 2.08632,0.19826 1.80798,0.31679 3.29353,-0.15981 1.48413,-0.47554 6.21488,-3.25367 6.44772,-3.72921 0.59266,-1.21814 0.97296,-2.46098 0.46319,-3.21487 -0.51117,-0.7567 -1.39206,-0.19861 -2.31916,0.0801 -0.92745,0.27693 -4.87009,2.02282 -6.16973,2.4197 -1.01952,0.3115 -3.24661,-0.19862 -3.24661,-0.19862 0,0 11.29312,-3.73168 11.7355,-4.56247 0.46426,-0.87383 0.0924,-2.46133 -0.97437,-2.65959 -0.67945,-0.127 -15.44637,4.72228 -15.81714,5.31777 -0.37218,0.59549 -0.78952,1.26929 -0.78952,1.26929 z"\n       style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.352778"\n       id="path90"/>\n    <path\n       d="m 138.37505,106.50074 c 0,0 -0.76236,-0.18874 -1.29964,0.0801 -0.53728,0.26882 -0.27834,3.09492 -0.27834,3.09492 l 5.75204,-0.0783 c 0,0 -4.96393,1.26894 -5.42678,2.22109 -0.46461,0.9525 0.58985,2.39395 1.53106,2.61973 0.75353,0.18203 16.15475,-4.7364 16.51282,-5.15938 0.3115,-0.36653 0.51012,-2.38125 0.18627,-2.69804 -0.32527,-0.31715 -1.62349,-0.27834 -1.62349,-0.27834 0,0 -0.51117,0.0399 -0.0469,-1.38783 0.46461,-1.4291 5.38128,-7.103886 6.58707,-10.675761 1.1617,-3.440642 0.4893,-7.948436 -0.83503,-10.118725 -1.39876,-2.294466 -3.38596,-3.770489 -6.12281,-4.841169 -2.74778,-1.076325 -7.82849,-1.683808 -11.87591,-0.556683 -4.03048,1.124655 -7.16844,3.170766 -8.9983,5.873397 -1.64289,2.426405 -1.57797,7.302147 -1.02129,9.206441 0.55668,1.906058 6.2163,8.96973 6.77298,10.39742 0.55668,1.4291 0.18627,2.30117 0.18627,2.30117 z"\n       style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.352778"\n       id="path96"/>\n  </g>\n</svg>',this.actions.annoswitch.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n      \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n      \n      <svg\n         viewBox="0 0 83.319054 83.320114"\n         version="1.1"\n         id="svg11415"\n         xml:space="preserve"\n         xmlns="http://www.w3.org/2000/svg"\n         xmlns:svg="http://www.w3.org/2000/svg"><defs\n           id="defs11412"><marker\n             style="overflow:visible"\n             id="TriangleStart"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135" /></marker><marker\n             style="overflow:visible"\n             id="TriangleStart-5"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135-3" /></marker></defs><g\n           id="g327"\n           transform="translate(129.83427,13.264356)"><g\n             id="g346"><path\n               d="m -46.51522,28.396234 c 0,23.007813 -18.65172,41.659526 -41.65953,41.659526 -23.00782,0 -41.65952,-18.651713 -41.65952,-41.659526 0,-23.00887 18.6517,-41.66059 41.65952,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n               style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n               id="path68"\n               class="openlime-lens-dashboard-button-bkg" /><g\n               aria-label="i"\n               id="text430"\n               style="font-size:50.8px;line-height:1.25;font-family:\'Palace Script MT\';-inkscape-font-specification:\'Palace Script MT\';font-variant-ligatures:none;letter-spacing:0px;word-spacing:0px;stroke-width:0.264583"\n               transform="matrix(1.9896002,0,0,1.9896002,-378.32178,-41.782121)"><path\n                 d="m 149.74343,19.295724 c -1.4224,1.1176 -2.5908,2.032 -3.5052,2.6416 0.3556,1.0668 0.8128,1.9304 1.9304,3.556 1.4224,-1.27 1.5748,-1.4224 3.302,-2.7432 -0.1524,-0.3048 -0.254,-0.508 -0.6604,-1.1684 -0.3048,-0.6096 -0.3556,-0.6096 -0.762,-1.6256 z m 1.9304,25.4 -0.8636,0.4572 c -3.5052,1.9304 -4.1148,2.1844 -4.7244,2.1844 -0.5588,0 -0.9144,-0.5588 -0.9144,-1.4224 0,-0.8636 0,-0.8636 1.6764,-7.5692 1.8796,-7.7216 1.8796,-7.7216 1.8796,-8.128 0,-0.3048 -0.254,-0.508 -0.6096,-0.508 -0.8636,0 -3.8608,1.6764 -8.0264,4.4704 l -0.1016,1.4224 c 3.0988,-1.6764 3.2512,-1.7272 3.7084,-1.7272 0.4064,0 0.6096,0.3048 0.6096,0.8636 0,0.7112 -0.1524,1.4224 -0.9144,4.318 -2.3876,8.8392 -2.3876,8.8392 -2.3876,10.16 0,1.2192 0.4572,2.032 1.2192,2.032 0.8636,0 2.2352,-0.6604 4.9276,-2.3876 0.9652,-0.6096 1.9304,-1.2192 2.8956,-1.8796 0.4572,-0.254 0.8128,-0.508 1.4224,-0.8636 z"\n                 style="font-weight:bold;font-family:Z003;-inkscape-font-specification:\'Z003 Bold\'"\n                 id="path495" /></g><path\n               style="fill:none;stroke:#000000;stroke-width:17.09477;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="M -66.121922,49.608737 -110.22757,7.1826674"\n               id="path465"\n               class="openlime-lens-dashboard-annoswitch-bar" /></g></g></svg>',this.actions.prev.svg='<svg\n               viewBox="0 0 83.319054 83.320114"\n               version="1.1"\n               id="svg11415"\n               xml:space="preserve"\n               xmlns="http://www.w3.org/2000/svg"\n               xmlns:svg="http://www.w3.org/2000/svg"><defs\n                 id="defs11412"><marker\n                   style="overflow:visible"\n                   id="TriangleStart"\n                   refX="0"\n                   refY="0"\n                   orient="auto-start-reverse"\n                   markerWidth="5.3244081"\n                   markerHeight="6.155385"\n                   viewBox="0 0 5.3244081 6.1553851"\n                   preserveAspectRatio="xMidYMid"><path\n                     transform="scale(0.5)"\n                     style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                     d="M 5.77,0 -2.88,5 V -5 Z"\n                     id="path135" /></marker><marker\n                   style="overflow:visible"\n                   id="TriangleStart-5"\n                   refX="0"\n                   refY="0"\n                   orient="auto-start-reverse"\n                   markerWidth="5.3244081"\n                   markerHeight="6.155385"\n                   viewBox="0 0 5.3244081 6.1553851"\n                   preserveAspectRatio="xMidYMid"><path\n                     transform="scale(0.5)"\n                     style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                     d="M 5.77,0 -2.88,5 V -5 Z"\n                     id="path135-3" /></marker></defs><g\n                 id="g417"\n                 transform="matrix(3.3565779,0,0,3.3565779,129.92814,-51.220758)"><g\n                   id="g335"><path\n                     d="m -172.71351,100.60243 c 0,23.00781 -18.65172,41.65952 -41.65953,41.65952 -23.00782,0 -41.65952,-18.65171 -41.65952,-41.65952 0,-23.00887 18.6517,-41.66059 41.65952,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n                     style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n                     id="path68"\n                     class="openlime-lens-dashboard-button-bkg"\n                     transform="matrix(0.29792248,0,0,0.29792248,37.569341,-2.3002842)" /><path\n                     style="fill:#030104"\n                     d="m -35.494703,28.624414 c 0,-0.264 0.213,-0.474 0.475,-0.474 h 2.421 c 0.262,0 0.475,0.21 0.475,0.474 0,3.211 2.615,5.826 5.827,5.826 3.212,0 5.827,-2.615 5.827,-5.826 0,-3.214 -2.614,-5.826 -5.827,-5.826 -0.34,0 -0.68,0.028 -1.016,0.089 v 1.647 c 0,0.193 -0.116,0.367 -0.291,0.439 -0.181,0.073 -0.383,0.031 -0.521,-0.104 l -4.832,-3.273 c -0.184,-0.185 -0.184,-0.482 0,-0.667 l 4.833,-3.268 c 0.136,-0.136 0.338,-0.176 0.519,-0.104 0.175,0.074 0.291,0.246 0.291,0.438 v 1.487 c 0.34,-0.038 0.68,-0.057 1.016,-0.057 5.071,0 9.198,4.127 9.198,9.198 0,5.07 -4.127,9.197 -9.198,9.197 -5.07,10e-4 -9.197,-4.126 -9.197,-9.196 z"\n                     id="path415" /></g></g></svg>',this.actions.down.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n        \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n        \n        <svg\n           viewBox="0 0 83.319054 83.320114"\n           version="1.1"\n           id="svg11415"\n           xml:space="preserve"\n           xmlns="http://www.w3.org/2000/svg"\n           xmlns:svg="http://www.w3.org/2000/svg"><defs\n             id="defs11412"><marker\n               style="overflow:visible"\n               id="TriangleStart"\n               refX="0"\n               refY="0"\n               orient="auto-start-reverse"\n               markerWidth="5.3244081"\n               markerHeight="6.155385"\n               viewBox="0 0 5.3244081 6.1553851"\n               preserveAspectRatio="xMidYMid"><path\n                 transform="scale(0.5)"\n                 style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                 d="M 5.77,0 -2.88,5 V -5 Z"\n                 id="path135" /></marker><marker\n               style="overflow:visible"\n               id="TriangleStart-5"\n               refX="0"\n               refY="0"\n               orient="auto-start-reverse"\n               markerWidth="5.3244081"\n               markerHeight="6.155385"\n               viewBox="0 0 5.3244081 6.1553851"\n               preserveAspectRatio="xMidYMid"><path\n                 transform="scale(0.5)"\n                 style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n                 d="M 5.77,0 -2.88,5 V -5 Z"\n                 id="path135-3" /></marker></defs><g\n             id="g4652"\n             transform="translate(145.46385,95.197966)"><g\n               id="g4846"\n               transform="translate(-126.60931,52.756264)"><path\n                 d="m 64.464511,-106.29364 c 0,23.007813 -18.65172,41.659526 -41.65953,41.659526 -23.0078196,0 -41.659526,-18.651713 -41.659526,-41.659526 0,-23.00887 18.6517064,-41.66059 41.659526,-41.66059 23.00781,0 41.65953,18.65172 41.65953,41.66059 z"\n                 style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n                 id="path68"\n                 class="openlime-lens-dashboard-button-bkg" /><g\n                 id="g2392-5"\n                 transform="matrix(0.26458333,0,0,0.26458333,-283.58108,-263.57207)"><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:40;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1072.4033,509.27736 h 171.1826"\n                   id="path351-6" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1185.0215,568.3701 h 59.6026"\n                   id="path351-3-2" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1184.2167,621.15576 h 59.6026"\n                   id="path351-3-2-0" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:40;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1072.4033,679.59496 h 171.1826"\n                   id="path351-3-6-7-1" /><path\n                   style="display:inline;fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:11.4448;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#TriangleStart-5)"\n                   d="m 1074.9115,570.87447 54.1203,-0.0275"\n                   id="path1366-2" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:14;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1080.0425,521.28147 v 54.87857"\n                   id="path1402-7" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"\n                   d="m 1150.8866,623.00688 0.3956,-5.02729"\n                   id="path2545" /><path\n                   style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:30;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n                   d="m 1185.0215,567.71656 h 59.6026"\n                   id="path2720" /></g></g></g></svg>',this.actions.next.svg='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n      \x3c!-- Created with Inkscape (http://www.inkscape.org/) --\x3e\n      \n      <svg\n         viewBox="0 0 83.319054 83.320114"\n         version="1.1"\n         id="svg11415"\n         xml:space="preserve"\n         xmlns="http://www.w3.org/2000/svg"\n         xmlns:svg="http://www.w3.org/2000/svg"><defs\n           id="defs11412"><marker\n             style="overflow:visible"\n             id="TriangleStart"\n             refX="0"\n             refY="0"\n             orient="auto-start-reverse"\n             markerWidth="5.3244081"\n             markerHeight="6.155385"\n             viewBox="0 0 5.3244081 6.1553851"\n             preserveAspectRatio="xMidYMid"><path\n               transform="scale(0.5)"\n               style="fill:context-stroke;fill-rule:evenodd;stroke:context-stroke;stroke-width:1pt"\n               d="M 5.77,0 -2.88,5 V -5 Z"\n               id="path135" /></marker></defs><g\n           id="g4652"\n           transform="translate(-12.647874,74.762541)"><path\n             d="m 95.96693,-33.101955 c 0,23.007813 -18.65172,41.6595258 -41.65953,41.6595258 -23.00782,0 -41.659526,-18.6517128 -41.659526,-41.6595258 0,-23.008872 18.651706,-41.660586 41.659526,-41.660586 23.00781,0 41.65953,18.651714 41.65953,41.660586 z"\n             style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.352778"\n             id="path68"\n             class="openlime-lens-dashboard-button-bkg" /><g\n             id="g4636"\n             transform="translate(173.74831,-50.897484)"><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:10.5833;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -142.08694,-4.7366002 h 45.292059"\n               id="path351" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:10.5833;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -142.08694,40.326598 h 45.292059"\n               id="path351-3-6-7" /><path\n               style="display:inline;fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:3.20746;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#TriangleStart)"\n               d="m -136.09942,8.7192481 0.008,14.9721889"\n               id="path1366" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:3.70417;stroke-linecap:butt;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="M -136.07283,-1.5605128 V 24.204958"\n               id="path1402" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:7.9375;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -111.69142,24.864565 h 15.76985"\n               id="path351-3-2-0-3" /><path\n               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:7.9375;stroke-linecap:round;stroke-linejoin:miter;stroke-dasharray:none;stroke-opacity:1"\n               d="m -111.37623,10.725444 h 15.76986"\n               id="path2720-9" /></g></g></svg>';for(let[t,i]of Object.entries(this.actions)){if(i.element=e.SVGFromString(i.svg),i.element.style="height: 100%; margin: 0 5px",i.element.classList.add("openlime-lens-dashboard-button"),"toggle"==i.type){i.element.querySelector(i.toggleClass).style.visibility="hidden",i.active=!1}i.element.addEventListener("pointerdown",(t=>{if("toggle"==i.type){i.active=!i.active;const t=i.element.querySelector(i.toggleClass);i.active?t.style.visibility="visible":t.style.visibility="hidden",this.noupdate=!0}i.task(t),t.preventDefault()}))}this.tools1.appendChild(this.actions.camera.element),this.tools1.appendChild(this.actions.light.element),this.tools2.appendChild(this.actions.annoswitch.element),this.tools2.appendChild(this.actions.prev.element),this.tools2.appendChild(this.actions.down.element),this.tools2.appendChild(this.actions.next.element),this.actions.camera.active=this.actions.camera.element.classList.toggle("openlime-lens-dashboard-camera-active"),this.actions.light.active=!1,this.setActionEnabled("camera"),this.setActionEnabled("light"),this.setActionEnabled("annoswitch"),this.setActionEnabled("next")}getAction(t){let e=null;for(let[i,s]of Object.entries(this.actions))if(s.label===t){e=s;break}return e}setActionEnabled(t,e=!0){const i=this.getAction(t);i&&i.element.classList.toggle("enabled",e)}toggleLightController(){let t=this.actions.light.element.classList.toggle("openlime-lens-dashboard-light-active");this.actions.light.active=t,this.actions.camera.active=this.actions.camera.element.classList.toggle("openlime-lens-dashboard-camera-active");for(let e of Object.values(this.viewer.canvas.layers))for(let i of e.controllers)"light"==i.control&&(i.active=!0,i.activeModifiers=t?[0,2,4]:[2,4])}update(t,e,i){if(this.noupdate)return void(this.noupdate=!1);super.update(t,e,i);const s={x:this.lensBox.x,y:this.lensBox.y},n=this.lensBox.r,r=this.lensBox.w,o=this.lensBox.h,a=this.toolbox1.clientWidth,l=this.toolbox1.clientHeight,h=this.toolbox2.clientWidth,c=this.toolbox2.clientHeight;let d=n*Math.sin(this.angleToolbar),u=n*Math.cos(this.angleToolbar),p=this.containerSpace+n-d-a/2-this.toolboxGap,m=this.containerSpace+n+u-l/2;this.toolbox1.style.left=`${p}px`,this.toolbox1.style.top=`${m}px`;let f=this.containerSpace+n+d-h/2+this.toolboxGap,g=this.containerSpace+n+u-c/2;this.toolbox2.style.left=`${f}px`,this.toolbox2.style.top=`${g}px`,this.updateCb&&this.updateCb(s.x,s.y,n,r,o,this.viewer.camera.viewport.w,this.viewer.camera.viewport.h),this.moving||(this.toggle(),this.moving=!0),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{this.toggle(),this.moving=!1,this.updateEndCb&&this.updateEndCb(s.x,s.y,n,r,o,this.viewer.camera.viewport.w,this.viewer.camera.viewport.h)}),this.delay)}},t.LensDashboardNavigatorRadial=vt,t.LightSphereController=class{constructor(t,e){e=Object.assign({width:128,height:128,top:60,right:0,thetaMin:0,colorSpot:"#ffffff",colorBkg:"#0000ff",colorMark:"#ff0000"},e),Object.assign(this,e),this.parent=t,this.layers=[],"string"==typeof this.parent&&(this.parent=document.querySelector(this.parent)),this.lightDir=[0,0],this.containerElement=document.createElement("div"),this.containerElement.style=`padding: 0; position: absolute; width: ${this.width}px; height: ${this.height}px; top:${this.top}px; right:${this.right}px; z-index: 200; touch-action: none; visibility: visible;`,this.containerElement.classList.add("openlime-lsc"),this.width,this.dlCanvas=document.createElement("canvas"),this.dlCanvas.width=this.width,this.dlCanvas.height=this.height,this.dlCanvasCtx=this.dlCanvas.getContext("2d"),this.dlGradient="",this.containerElement.appendChild(this.dlCanvas),this.parent.appendChild(this.containerElement),this.r=.5*this.width,this.thetaMinRad=this.thetaMin/180*Math.PI,this.rmax=this.r*Math.cos(this.thetaMinRad),this.interactLightDir(.5*this.width,.5*this.height),this.pointerDown=!1,this.dlCanvas.addEventListener("pointerdown",(t=>{this.pointerDown=!0;const e=this.dlCanvas.getBoundingClientRect();let i=this.dlCanvas.width*(t.clientX-e.left)/e.width,s=this.dlCanvas.height*(t.clientY-e.top)/e.height;this.interactLightDir(i,s),t.preventDefault()})),this.dlCanvas.addEventListener("pointermove",(t=>{if(this.pointerDown){const e=this.dlCanvas.getBoundingClientRect();let i=this.dlCanvas.width*(t.clientX-e.left)/e.width,s=this.dlCanvas.height*(t.clientY-e.top)/e.height;this.interactLightDir(i,s),t.preventDefault()}})),this.dlCanvas.addEventListener("pointerup",(t=>{this.pointerDown=!1})),this.dlCanvas.addEventListener("pointerout",(t=>{this.pointerDown=!1}))}addLayer(t){this.layers.push(t)}show(){return this.containerElement.style.visibility="visible"}hide(){return this.containerElement.style.visibility="hidden"}computeGradient(){const t=(this.lightDir[0]+1)*this.dlCanvas.width*.5,e=(1-this.lightDir[1])*this.dlCanvas.height*.5;this.dlGradient=this.dlCanvasCtx.createRadialGradient(t,e,this.dlCanvas.height/8,t,e,this.dlCanvas.width/1.2),this.dlGradient.addColorStop(0,this.colorSpot),this.dlGradient.addColorStop(1,this.colorBkg)}interactLightDir(t,e){let i=t-this.r,s=this.r-e;const n=Math.atan2(s,i);let r=Math.sqrt(i*i+s*s);r=r>this.rmax?this.rmax:r,i=r*Math.cos(this.thetaMinRad)*Math.cos(n),s=r*Math.cos(this.thetaMinRad)*Math.sin(n),t=i+this.r,e=this.r-s,this.lightDir[0]=2*(t/this.dlCanvas.width-.5),this.lightDir[1]=2*(1-e/this.dlCanvas.height-.5);for(const t of this.layers)t.controls.light&&t.setControl("light",this.lightDir,5);this.computeGradient(),this.drawLightSelector(t,e)}drawLightSelector(t,e){this.dlCanvasCtx.clearRect(0,0,this.dlCanvas.width,this.dlCanvas.height),this.dlCanvasCtx.beginPath(),this.dlCanvasCtx.arc(this.dlCanvas.width/2,this.dlCanvas.height/2,this.dlCanvas.width/2,0,2*Math.PI),this.dlCanvasCtx.fillStyle=this.dlGradient,this.dlCanvasCtx.fill(),this.dlCanvasCtx.beginPath(),this.dlCanvasCtx.arc(t,e,this.dlCanvas.width/30,0,2*Math.PI),this.dlCanvasCtx.strokeStyle=this.colorMark,this.dlCanvasCtx.lineWidth=2,this.dlCanvasCtx.stroke()}},t.MultispectralUI=class{constructor(t,e={}){this.layer=t,this.options={containerId:null,showPresets:!0,showSingleBand:!0,floatingPanel:!0,...e},this.uiElements={},"ready"===t.status?this.initialize():t.addEvent("ready",(()=>this.initialize()))}initialize(){let t,e;if(this.options.containerId){if(t=document.getElementById(this.options.containerId),e=t,!t)return void console.error(`Container element with ID '${this.options.containerId}' not found`)}else{if(!this.options.floatingPanel)return void console.error("No container specified and floating panel disabled");{let i;this.layer.viewer&&this.layer.viewer.containerElement?i=this.layer.viewer.containerElement:(i=document.querySelector(".openlime"),i||(console.warn("OpenLIME container not found, using body as fallback"),i=document.body)),"static"===getComputedStyle(i).position&&(i.style.position="relative"),t=document.createElement("div"),t.className="ms-controls",t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.padding="10px",t.style.borderRadius="5px",t.style.color="white",t.style.zIndex="1000",t.style.width="250px",t.style.maxHeight="80vh",t.style.overflowY="auto",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",t.style.fontFamily="Arial, sans-serif",i.appendChild(t),e=i}}this.container=t,this.targetContainer=e,this.createHeader(),this.options.showPresets&&this.createPresetSelector(),this.options.showSingleBand&&this.createSingleBandControls(),this.setupResizeHandler()}setupResizeHandler(){this.options.floatingPanel&&this.container&&(this.initialContainerRect=this.targetContainer.getBoundingClientRect(),this.resizeHandler=()=>{if(!document.contains(this.container)||!document.contains(this.targetContainer))return void window.removeEventListener("resize",this.resizeHandler);const t=this.targetContainer.getBoundingClientRect(),e=this.container.getBoundingClientRect();t.width<300?this.container.style.width=Math.max(.8*t.width,150)+"px":this.container.style.width="250px";const i=e.right-t.right;if(i>0){const t=parseInt(this.container.style.right)||10;this.container.style.right=t+i+10+"px"}},window.addEventListener("resize",this.resizeHandler),this.resizeHandler())}createHeader(){const t=document.createElement("div");t.style.marginBottom="10px";const e=document.createElement("h3");e.textContent="Multispectral Controls",e.style.margin="0 0 5px 0",e.style.fontSize="16px",e.style.fontWeight="bold",t.appendChild(e);const i=document.createElement("div");i.textContent=`${this.layer.getBandCount()} bands: ${Math.min(...this.layer.getWavelengths())}nm - ${Math.max(...this.layer.getWavelengths())}nm`,i.style.fontSize="12px",i.style.color="#ccc",t.appendChild(i),this.container.appendChild(t)}createPresetSelector(){const t=document.createElement("div");t.style.marginBottom="15px";const e=document.createElement("label");e.textContent="Analysis Presets",e.style.display="block",e.style.marginBottom="5px",e.style.fontSize="14px",e.style.fontWeight="bold",t.appendChild(e);const i=document.createElement("select");i.style.width="100%",i.style.padding="5px",i.style.backgroundColor="#333",i.style.color="white",i.style.border="1px solid #555",i.style.borderRadius="3px";const s=document.createElement("option");s.value="",s.textContent="-- Select Preset --",i.appendChild(s);this.layer.getAvailablePresets().forEach((t=>{const e=document.createElement("option");e.value=t;const s=t.replace(/([A-Z])/g," $1").replace(/^./,(t=>t.toUpperCase()));e.textContent=s,i.appendChild(e)}));const n=document.createElement("button");n.textContent="Apply",n.style.width="100%",n.style.marginTop="5px",n.style.padding="5px",n.style.backgroundColor="#555",n.style.color="white",n.style.border="none",n.style.borderRadius="3px",n.style.cursor="pointer";const r=()=>{const t=i.value;t&&(this.layer.applyPreset(t),"rgb"!==this.layer.getMode()&&this.layer.setMode("rgb"))};n.addEventListener("click",(()=>{r()})),t.appendChild(i),t.appendChild(n),this.container.appendChild(t),this.uiElements.presetSelector=i}createSingleBandControls(){const t=document.createElement("div");t.style.marginBottom="15px";const e=document.createElement("label");e.textContent="Single Band View",e.style.display="block",e.style.marginBottom="5px",e.style.fontSize="14px",e.style.fontWeight="bold",t.appendChild(e);const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.marginBottom="5px";const s=document.createElement("span");s.textContent="Wavelength:",s.style.width="80px",s.style.fontSize="12px";const n=document.createElement("select");n.style.flex="1",n.style.padding="3px",n.style.backgroundColor="#333",n.style.color="white",n.style.border="1px solid #555",n.style.borderRadius="3px";this.layer.getWavelengths().forEach(((t,e)=>{const i=document.createElement("option");i.value=e,i.textContent=`${t}nm`,n.appendChild(i)})),i.appendChild(s),i.appendChild(n),t.appendChild(i);const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center";const o=document.createElement("span");o.textContent="Output Channel:",o.style.width="80px",o.style.fontSize="12px";const a=document.createElement("select");a.style.flex="1",a.style.padding="3px",a.style.backgroundColor="#333",a.style.color="white",a.style.border="1px solid #555",a.style.borderRadius="3px";[{value:0,label:"Gray"},{value:1,label:"Red"},{value:2,label:"Green"},{value:3,label:"Blue"}].forEach((t=>{const e=document.createElement("option");e.value=t.value,e.textContent=t.label,a.appendChild(e)})),r.appendChild(o),r.appendChild(a),t.appendChild(r);const l=document.createElement("button");l.textContent="Apply",l.style.width="100%",l.style.marginTop="5px",l.style.padding="5px",l.style.backgroundColor="#555",l.style.color="white",l.style.border="none",l.style.borderRadius="3px",l.style.cursor="pointer",l.addEventListener("click",(()=>{const t=parseInt(n.value),e=parseInt(a.value);this.layer.setSingleBand(t,e),this.uiElements.modeSelector&&(this.uiElements.modeSelector.value="single_band")})),t.appendChild(l),this.container.appendChild(t),this.uiElements.wavelengthSelector=n,this.uiElements.channelSelector=a}destroy(){this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.container&&this.options.floatingPanel&&this.targetContainer&&this.targetContainer.removeChild(this.container),this.uiElements={},this.container=null,this.targetContainer=null}},t.PointerManager=z,t.Raster=g,t.Raster16Bit=I,t.RenderingMode={draw:"fill:white;",hide:"fill:black;"},t.Ruler=V,t.ScaleBar=q,t.Shader=v,t.ShaderAnisotropicDiffusion=class extends v{constructor(t={}){super(Object.assign({kappa:.03,iterations:3,lambda:.1,normalStrength:1.2,uniforms:{kappa:{type:"float",value:.03,needsUpdate:!0},iterations:{type:"int",value:3,needsUpdate:!0},lambda:{type:"float",value:.1,needsUpdate:!0},normalStrength:{type:"float",value:1.2,needsUpdate:!0}},samplers:[{id:0,name:"source",label:"Normal Map",samplers:[{id:0,type:"color"}]}],label:"Anisotropic Diffusion",modes:["perona-malik","weickert"],mode:"perona-malik"},t)),void 0!==t.kappa&&this.setUniform("kappa",t.kappa),void 0!==t.iterations&&this.setUniform("iterations",t.iterations),void 0!==t.lambda&&this.setUniform("lambda",t.lambda),void 0!==t.normalStrength&&this.setUniform("normalStrength",t.normalStrength)}fragShaderSrc(t){return`\nuniform float kappa;\nuniform int iterations;\nuniform float lambda;\nuniform float normalStrength;\n\nin vec2 v_texcoord;\n\n// Calculate texture offset based on tile size\nvec2 texelSize = vec2(1.0) / tileSize;\n\n// Edge-stopping functions from Perona-Malik algorithm\nfloat g1(float gradient, float k) {\n  return exp(-pow(gradient/k, 2.0));\n}\n\nfloat g2(float gradient, float k) {\n  return 1.0 / (1.0 + pow(gradient/k, 2.0));\n}\n\n  // Extract grayscale value from normal map, giving more weight to z component\nfloat normalToGray(vec3 normal) {\n  // Heavily favor the blue channel (z component) since it contains the depth information\n  return dot(normal, vec3(0.15, 0.15, 0.7));\n}\n\nvec4 data() {\n  // Sample the center pixel color (normal map)\n  vec4 centerColor = texture(source, v_texcoord);\n  ${this.isLinear?"":"centerColor = srgb2linear(centerColor);"}\n  // Convert normal to working grayscale image\n  // Adjust normal vector to be in [-1,1] range\n  vec3 normal = centerColor.rgb * 2.0 - 1.0;\n  normal = normalize(normal);\n  \n  // Extract grayscale value with emphasis on z component\n  // Map to 0-1 range for better visualization\n  float intensity = (normalToGray(normal) + 1.0) * 0.5;\n  \n  // Store the original intensity before diffusion for later use\n  float originalIntensity = intensity;\n  \n  // Initial image for diffusion\n  float currentIntensity = intensity;\n  \n  // Perform multiple iterations of anisotropic diffusion\n  for (int i = 0; i < 20; i++) {\n    if (i >= iterations) break; // Handle dynamic loop limit\n    \n    // Sample the 4-connected neighborhood\n    vec4 vN = texture(source, v_texcoord + texelSize * vec2(0.0, -1.0));\n     ${this.isLinear?"":"vN = srgb2linear(vN);"}\n    vec4 vS = texture(source, v_texcoord + texelSize * vec2(0.0, 1.0));\n     ${this.isLinear?"":"vS = srgb2linear(vS);"}\n    vec4 vE = texture(source, v_texcoord + texelSize * vec2(1.0, 0.0));\n     ${this.isLinear?"":"vE = srgb2linear(vE);"}\n    vec4 vW = texture(source, v_texcoord + texelSize * vec2(-1.0, 0.0));\n     ${this.isLinear?"":"vW = srgb2linear(vW);"}\n\n    vec3 normalN = vN.rgb * 2.0 - 1.0;\n    vec3 normalS = vS.rgb * 2.0 - 1.0;\n    vec3 normalE = vE.rgb * 2.0 - 1.0;\n    vec3 normalW = vW.rgb * 2.0 - 1.0;\n    \n    // Convert to grayscale with normalization to 0-1 range\n    float n = (normalToGray(normalN) + 1.0) * 0.5;\n    float s = (normalToGray(normalS) + 1.0) * 0.5;\n    float e = (normalToGray(normalE) + 1.0) * 0.5;\n    float w = (normalToGray(normalW) + 1.0) * 0.5;\n    \n    // Calculate gradients (using normalized intensity values)\n    float gradN = abs(n - currentIntensity);\n    float gradS = abs(s - currentIntensity);\n    float gradE = abs(e - currentIntensity);\n    float gradW = abs(w - currentIntensity);\n    \n    // Apply edge-stopping function\n    float mode = ${"perona-malik"===this.mode?"1.0":"0.0"};\n    float cN = mix(g2(gradN, kappa), g1(gradN, kappa), mode);\n    float cS = mix(g2(gradS, kappa), g1(gradS, kappa), mode);\n    float cE = mix(g2(gradE, kappa), g1(gradE, kappa), mode);\n    float cW = mix(g2(gradW, kappa), g1(gradW, kappa), mode);\n    \n    // Update intensity with weighted contributions\n    float laplacian = cN * (n - currentIntensity) +\n                     cS * (s - currentIntensity) +\n                     cE * (e - currentIntensity) +\n                     cW * (w - currentIntensity);\n                     \n    currentIntensity += lambda * laplacian;\n  }\n  \n  // Enhance contrast in the final result\n  float enhancedIntensity = currentIntensity * normalStrength;\n  \n  // Combine with original intensity to preserve details\n  float mixFactor = 0.6; // 60% diffused result, 40% original\n  enhancedIntensity = mix(originalIntensity, enhancedIntensity, mixFactor);\n  \n  // Custom contrast enhancement to bring out inscriptions\n  // Apply contrast and brightness adjustment\n  float adjustedIntensity = enhancedIntensity;\n  \n  // Invert the image for better visibility of inscriptions\n  adjustedIntensity = 1.0 - adjustedIntensity;\n  \n  // Significantly enhance brightness and contrast\n  adjustedIntensity = pow(adjustedIntensity, 0.5); // Increase brightness (gamma correction)\n  adjustedIntensity = smoothstep(0.1, 0.6, adjustedIntensity); // Enhance contrast with bigger bright areas\n  \n  // Boost brightness again\n  adjustedIntensity = adjustedIntensity * 1.3;\n  adjustedIntensity = clamp(adjustedIntensity, 0.0, 1.0);\n  \n  // Return grayscale result with good visibility\n  return vec4(vec3(adjustedIntensity), centerColor.a);\n}`}setKappa(t){this.setUniform("kappa",t)}setIterations(t){this.setUniform("iterations",t)}setLambda(t){t=Math.min(.25,Math.max(0,t)),this.setUniform("lambda",t)}setNormalStrength(t){this.setUniform("normalStrength",t)}},t.ShaderBRDF=ht,t.ShaderCombiner=class extends v{constructor(t){super(t),this.mode="mean",this.samplers=[{id:0,name:"source1",type:"vec3"},{id:1,name:"source2",type:"vec3"}],this.modes=["first","second","mean","diff"],this.operations={first:"color = c1;",second:"color = c2;",mean:"color = (c1 + c2)/2.0;",diff:"color = vec4(c2.rgb - c1.rgb, c1.a);"}}fragShaderSrc(t){return`\n\nin vec2 v_texcoord;\n\nvec4 data() {\n\tvec4 c1 = texture(source1, v_texcoord);\n\tvec4 c2 = texture(source2, v_texcoord);\n\tvec4 color;\n\t${this.operations[this.mode]};\n\treturn color;\n}\n`}vertShaderSrc(t){return"#version 300 es\n\n\nin vec4 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = a_position;\n\tv_texcoord = a_texcoord;\n}"}},t.ShaderEdgeDetection=class extends v{constructor(t={}){super(Object.assign({threshold:.1,colorEdges:!1,uniforms:{threshold:{type:"float",value:.1,needsUpdate:!0},colorEdges:{type:"bool",value:!1,needsUpdate:!0}},samplers:[{id:0,name:"source",label:"Color",samplers:[{id:0,type:"color"}]}],label:"Edge Detection",modes:["sobel","prewitt"],mode:"sobel"},t)),void 0!==t.threshold&&this.setUniform("threshold",t.threshold),void 0!==t.colorEdges&&this.setUniform("colorEdges",t.colorEdges)}fragShaderSrc(t){return`\n\nuniform float threshold;\nuniform bool colorEdges;\n\nin vec2 v_texcoord;\n\n// Calculate texture offset based on tile size\nvec2 texelSize = vec2(1.0) / tileSize;\n\nvec4 data() {\n  // Sample the 3x3 neighborhood around the current pixel\n  vec4 tl = texture(source, v_texcoord + texelSize * vec2(-1, -1));\n  vec4 t  = texture(source, v_texcoord + texelSize * vec2( 0, -1));\n  vec4 tr = texture(source, v_texcoord + texelSize * vec2( 1, -1));\n  vec4 l  = texture(source, v_texcoord + texelSize * vec2(-1,  0));\n  vec4 c  = texture(source, v_texcoord);\n  vec4 r  = texture(source, v_texcoord + texelSize * vec2( 1,  0));\n  vec4 bl = texture(source, v_texcoord + texelSize * vec2(-1,  1));\n  vec4 b  = texture(source, v_texcoord + texelSize * vec2( 0,  1));\n  vec4 br = texture(source, v_texcoord + texelSize * vec2( 1,  1));\n  \n  // Convert to grayscale for edge detection\n  float tlGray = dot(tl.rgb, vec3(0.299, 0.587, 0.114));\n  float tGray  = dot(t.rgb, vec3(0.299, 0.587, 0.114));\n  float trGray = dot(tr.rgb, vec3(0.299, 0.587, 0.114));\n  float lGray  = dot(l.rgb, vec3(0.299, 0.587, 0.114));\n  float cGray  = dot(c.rgb, vec3(0.299, 0.587, 0.114));\n  float rGray  = dot(r.rgb, vec3(0.299, 0.587, 0.114));\n  float blGray = dot(bl.rgb, vec3(0.299, 0.587, 0.114));\n  float bGray  = dot(b.rgb, vec3(0.299, 0.587, 0.114));\n  float brGray = dot(br.rgb, vec3(0.299, 0.587, 0.114));\n  \n  float gx, gy;\n  \n  // Different convolution kernels based on mode\n  if (${"sobel"===this.mode?"true":"false"}) {\n      // Sobel operator\n      gx = -1.0 * tlGray + 1.0 * trGray +\n           -2.0 * lGray  + 2.0 * rGray  +\n           -1.0 * blGray + 1.0 * brGray;\n           \n      gy = -1.0 * tlGray + -2.0 * tGray + -1.0 * trGray +\n            1.0 * blGray +  2.0 * bGray +  1.0 * brGray;\n  } else {\n      // Prewitt operator\n      gx = -1.0 * tlGray + 1.0 * trGray +\n           -1.0 * lGray  + 1.0 * rGray  +\n           -1.0 * blGray + 1.0 * brGray;\n           \n      gy = -1.0 * tlGray + -1.0 * tGray + -1.0 * trGray +\n            1.0 * blGray +  1.0 * bGray +  1.0 * brGray;\n  }\n  \n  // Calculate edge magnitude\n  float g = sqrt(gx * gx + gy * gy);\n  \n  // Apply threshold\n  float edge = step(threshold, g);\n  \n  // Output either edge intensity or colored edges\n  if (colorEdges) {\n      return vec4(c.rgb * edge, c.a);\n  } else {\n      return vec4(vec3(edge), c.a);\n  }\n}`}setThreshold(t){this.setUniform("threshold",t)}setColorEdges(t){this.setUniform("colorEdges",t)}},t.ShaderFilter=_,t.ShaderFilterBrightness=class extends _{constructor(t){super(t),this.uniforms[this.uniformName("brightness")]={type:"float",needsUpdate:!0,size:1,value:t?.brightness||1},this.uniforms[this.uniformName("enable")]={type:"bool",needsUpdate:!0,size:1,value:!0},this.modes.brightness=[{id:"linear",enable:!0,src:"\n                // Linear brightness adjustment\n                vec3 adjustBrightnessLinear(vec3 color, float brightness) {\n                    return color * brightness;\n                }\n                "},{id:"preserve_saturation",enable:!1,src:"\n                // Brightness adjustment that preserves saturation by adjusting in HSL space\n                vec3 adjustBrightnessPreserveSaturation(vec3 color, float brightness) {\n                    // Convert RGB to HSL-like space\n                    float maxChannel = max(max(color.r, color.g), color.b);\n                    float minChannel = min(min(color.r, color.g), color.b);\n                    float luminance = (maxChannel + minChannel) / 2.0;\n                    \n                    // Skip complex HSL conversion and just scale while preserving relative color relationships\n                    if (maxChannel > 0.0) {\n                        float scaleFactor = brightness;\n                        // Adjust scale to prevent oversaturation\n                        if (brightness > 1.0) {\n                            float headroom = (1.0 - luminance) / luminance;\n                            scaleFactor = min(brightness, 1.0 + headroom);\n                        }\n                        return color * scaleFactor;\n                    }\n                    \n                    return color;\n                }\n                "}]}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col) {\n                if(!${this.uniformName("enable")}) return col;\n                // Skip processing if fully transparent\n                if (col.a <= 0.0) return col;\n                \n                // Convert to linear space for proper brightness adjustment\n                vec3 adjustedColor;\n                \n                // Use the active brightness mode\n                ${this.modes.brightness.find((t=>"linear"===t.id&&t.enable))?`adjustedColor = adjustBrightnessLinear(col.rgb, ${this.uniformName("brightness")});`:`adjustedColor = adjustBrightnessPreserveSaturation(col.rgb, ${this.uniformName("brightness")});`}\n                \n                // Clamp to prevent overflow\n                adjustedColor = clamp(adjustedColor, 0.0, 1.0);\n                \n                // Convert back to sRGB space\n                return vec4(adjustedColor, col.a);\n            }`}setBrightness(t){const e=Math.max(0,Math.min(2,t));this.setUniform("brightness",e)}setBrightnessMethod(t){this.setMode("brightness",t)}},t.ShaderFilterColormap=class extends _{constructor(t,e){if(super(e),e=Object.assign({inDomain:[],channelWeights:[1/3,1/3,1/3],maxSteps:256},e),Object.assign(this,e),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const i=this.colorscale.rangeDomain(),s=(this.inDomain[1]-this.inDomain[0])/(i[1]-i[0]),n=(this.inDomain[0]-i[0])/(i[1]-i[0]);this.samplers=[{name:`${this.samplerName("colormap")}`}],this.uniforms[this.uniformName("channel_weigths")]={type:"vec3",needsUpdate:!0,size:3,value:this.channelWeights},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:s},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:n}}async createTextures(t){const e=this.colorscale.sample(this.maxSteps);let i=t.LINEAR;"bar"==this.colorscale.type&&(i=t.NEAREST);const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,e.buffer),this.getSampler("colormap").tex=s}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                if(col.a == 0.0) return col;\n                float v = dot(col.rgb, ${this.uniformName("channel_weigths")});\n                float cv = v*${this.uniformName("scale")} + ${this.uniformName("bias")};\n\n                if(cv >= 1.0) return ${this.uniformName("high_color")};\n                if(cv <= 0.0) return ${this.uniformName("low_color")};\n\n                return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n            }`}},t.ShaderFilterGrayscale=class extends _{constructor(t){super(t),this.uniforms[this.uniformName("weights")]={type:"vec3",needsUpdate:!0,size:3,value:[.2126,.7152,.0722]},this.uniforms[this.uniformName("enable")]={type:"bool",needsUpdate:!0,size:1,value:!0},this.modes.grayscale=[{id:"luminance",enable:!0,src:"\n                // Luminance-based grayscale (perceptual)\n                float grayscaleLuminance(vec3 color, vec3 weights) {\n                    return dot(color, weights);\n                }\n                "},{id:"average",enable:!1,src:"\n                // Simple average grayscale\n                float grayscaleAverage(vec3 color) {\n                    return (color.r + color.g + color.b) / 3.0;\n                }\n                "}]}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col) {\n                if(!${this.uniformName("enable")}) return col;\n                // Skip processing if fully transparent\n                if (col.a <= 0.0) return col;\n                float gray;\n                \n                // Use the active grayscale mode\n                ${this.modes.grayscale.find((t=>"luminance"===t.id&&t.enable))?`gray = grayscaleLuminance(col.rgb, ${this.uniformName("weights")});`:"gray = grayscaleAverage(col.rgb);"}\n                \n                // Apply grayscale conversion\n                vec3 grayRGB = vec3(gray);\n                \n                return vec4(grayRGB, col.a);\n            }`}setGrayscaleMethod(t){this.setMode("grayscale",t)}},t.ShaderFilterOpacity=class extends _{constructor(t,e){super(e),this.uniforms[this.uniformName("opacity")]={type:"float",needsUpdate:!0,size:1,value:t}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                return vec4(col.rgb, col.a * ${this.uniformName("opacity")});\n            }`}},t.ShaderFilterTest=class extends _{constructor(t){super(t),this.uniforms[this.uniformName("nodata_col")]={type:"vec4",needsUpdate:!0,size:4,value:[1,1,0,1]}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                return col.a > 0.0 ? col : ${this.uniformName("nodata_col")};\n            }`}},t.ShaderFilterVector=class extends _{constructor(t,e){if(super(e),e=Object.assign({inDomain:[],maxSteps:256,arrowColor:[0,0,0,1]},e),Object.assign(this,e),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const i=this.colorscale.rangeDomain(),s=Math.sqrt((this.inDomain[1]*this.inDomain[1]+this.inDomain[0]*this.inDomain[0])/(i[1]*i[1]+i[0]*i[0]));this.modes={normalize:[{id:"off",enable:!0,src:`const bool ${this.modeName("arrowNormalize")} = false;`},{id:"on",enable:!1,src:`const bool ${this.modeName("arrowNormalize")} = true;`}],arrow:[{id:"mag",enable:!0,src:`const int ${this.modeName("arrowColor")} = 0;`},{id:"col",enable:!1,src:`const int ${this.modeName("arrowColor")} = 1;`}],field:[{id:"none",enable:!0,src:`const int ${this.modeName("fieldColor")} = 0;`},{id:"mag",enable:!1,src:`const int ${this.modeName("fieldColor")} = 1;`}]},this.samplers=[{name:`${this.samplerName("colormap")}`}],this.uniforms[this.uniformName("arrow_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.arrowColor},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:s},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:0}}async createTextures(t){const e=this.colorscale.sample(this.maxSteps);let i=t.LINEAR;"bar"==this.colorscale.type&&(i=t.NEAREST);const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,e.buffer),this.getSampler("colormap").tex=s}fragDataSrc(t){return`\n        // 2D vector field visualization by Matthias Reitinger, @mreitinger\n        // Based on "2D vector field visualization by Morgan McGuire, http://casual-effects.com", https://www.shadertoy.com/view/4s23DG\n        \n        const float ARROW_TILE_SIZE = 16.0;\n        const float ISQRT2 = 0.70710678118; // 1/sqrt(2)\n\n        // Computes the center pixel of the tile containing pixel pos\n        vec2 arrowTileCenterCoord(vec2 pos) {\n            return (floor(pos / ARROW_TILE_SIZE) + 0.5) * ARROW_TILE_SIZE;\n        }\n\n        // Computes the distance from a line segment\n        float line3(vec2 a, vec2 b, vec2 c) {\n            vec2 ab = a - b;\n            vec2 cb = c - b;\n            float d = dot(ab, cb);\n            float len2 = dot(cb, cb);\n            float t = 0.0;\n            if (len2 != 0.0) {\n              t = clamp(d / len2, 0.0, 1.0);\n            }\n            vec2 r = b + cb * t;\n            return distance(a, r);\n        }\n\n        // Computes the signed distance from a line segment\n        float line(vec2 p, vec2 p1, vec2 p2) {\n            vec2 center = (p1 + p2) * 0.5;\n            float len = length(p2 - p1);\n            vec2 dir = (p2 - p1) / len;\n            vec2 rel_p = p - center;\n            float dist1 = abs(dot(rel_p, vec2(dir.y, -dir.x)));\n            float dist2 = abs(dot(rel_p, dir)) - 0.5*len;\n            return max(dist1, dist2);\n        }\n        \n        // v = field sampled at arrowTileCenterCoord(p), scaled by the length\n        // desired in pixels for arrows\n        // Returns a signed distance from the arrow\n        float arrow(vec2 p, vec2 v) {\n            if (${this.modeName("arrowNormalize")}) v = normalize(v);\n            v *= ARROW_TILE_SIZE * 0.5; // Change from [-1,1] to pixels\n            // Make everything relative to the center, which may be fractional\n            p -= arrowTileCenterCoord(p);\n                \n            float mag_v = length(v), mag_p = length(p);\n            \n            if (mag_v > 0.0) {\n                // Non-zero velocity case\n                vec2 dir_v = normalize(v);\n                \n                // We can't draw arrows larger than the tile radius, so clamp magnitude.\n                // Enforce a minimum length to help see direction\n                mag_v = clamp(mag_v, 2.0, ARROW_TILE_SIZE * 0.4);\n        \n                // Arrow tip location\n                v = dir_v * mag_v;\n        \n                // Signed distance from shaft\n                float shaft = line3(p, v, -v);\n                // Signed distance from head\n                float head = min(line3(p, v, 0.4*v + 0.2*vec2(-v.y, v.x)),\n                                 line3(p, v, 0.4*v + 0.2*vec2(v.y, -v.x)));\n                return min(shaft, head);\n            } else {\n                // Signed distance from the center point\n                return mag_p;\n            }\n        }\n        \n        vec4 lookupColormap(float cv) {            \n            if(cv >= 1.0) \n                return ${this.uniformName("high_color")};\n            else if(cv <= 0.0) \n                return ${this.uniformName("low_color")};\n            return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n        }\n\n        vec4 ${this.functionName()}(vec4 col){\n            if(col.a == 0.0) return col;\n\n            vec2 p = v_texcoord*tileSize; // point in pixel\n            vec2 pc_coord = arrowTileCenterCoord(p)/tileSize; // center coordinate\n            vec4 pc_val = texture(source, pc_coord); // [0..1] - lookup color in center\n            float s = 2.0;\n            float b = -1.0;\n            vec2 uvc = vec2(pc_val.x*s+b, pc_val.y*s+b); // [-1..1]\n            vec2 uvr =  vec2(col.r*s+b, col.g*s+b); // [-1..1]\n\n            // Colors\n            float vc = length(uvc)*ISQRT2;\n            float cvc = vc*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            float vr = length(uvr)*ISQRT2;\n            float cvr = vr*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            vec4 cmapc = lookupColormap(cvc);\n            vec4 cmapr = lookupColormap(cvr);\n                \n            // Arrow            \n            float arrow_dist = arrow(p, uvc);\n            \n            vec4 arrow_col = cmapc;\n            vec4 field_col = vec4(0.0, 0.0, 0.0, 0.0);\n\n            switch (${this.modeName("arrowColor")}) {\n                case 0:\n                    arrow_col = cmapc;\n                    break;\n                case 1:\n                    arrow_col = ${this.uniformName("arrow_color")};               \n                    break;\n            }\n\n            switch (${this.modeName("fieldColor")}) {\n                case 0:\n                    field_col = vec4(0.0, 0.0, 0.0, 0.0);\n                    break;\n                case 1:\n                    field_col = cmapr;              \n                    break;\n            }\n\n            float t = clamp(arrow_dist, 0.0, 1.0);\n            return  mix(arrow_col, field_col, t);\n        }`}},t.ShaderFilterVectorGlyph=class extends _{constructor(t,e,i){if(super(i),i=Object.assign({inDomain:[],maxSteps:256,glyphColor:[0,0,0,1],glyphsStride:80,glyphsSize:[304,64]},i),Object.assign(this,i),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");if(this.glyphsUrl=e,0==this.glyphsUrl.length)throw Error("glyphUrl is empty: no items to display");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const s=this.colorscale.rangeDomain(),n=Math.sqrt((this.inDomain[1]*this.inDomain[1]+this.inDomain[0]*this.inDomain[0])/(s[1]*s[1]+s[0]*s[0])),r=this.glyphsStride-this.glyphsSize[1],o=Math.round((this.glyphsSize[0]+r)/this.glyphsStride);this.modes={normalize:[{id:"off",enable:!0,src:`const bool ${this.modeName("glyphNormalize")} = false;`},{id:"on",enable:!1,src:`const bool ${this.modeName("glyphNormalize")} = true;`}],glyph:[{id:"mag",enable:!0,src:`const int ${this.modeName("glyphColor")} = 0;`},{id:"col",enable:!1,src:`const int ${this.modeName("glyphColor")} = 1;`}],field:[{id:"none",enable:!0,src:`const int ${this.modeName("fieldColor")} = 0;`},{id:"mag",enable:!1,src:`const int ${this.modeName("fieldColor")} = 1;`}]},this.samplers=[{name:`${this.samplerName("colormap")}`},{name:`${this.samplerName("glyphs")}`}],this.uniforms[this.uniformName("glyph_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.glyphColor},this.uniforms[this.uniformName("glyph_count")]={type:"float",needsUpdate:!0,size:1,value:o},this.uniforms[this.uniformName("glyph_wh")]={type:"float",needsUpdate:!0,size:1,value:this.glyphsSize[1]},this.uniforms[this.uniformName("glyph_stride")]={type:"float",needsUpdate:!0,size:1,value:this.glyphsStride},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:n},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:0}}async createTextures(t){const i=await e.rasterizeSVG(this.glyphsUrl,this.glyphsSize),s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),this.getSampler("glyphs").tex=s;const n=this.colorscale.sample(this.maxSteps);let r=t.LINEAR;"bar"==this.colorscale.type&&(r=t.NEAREST);const o=t.createTexture();t.bindTexture(t.TEXTURE_2D,o),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,r),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,n.buffer),this.getSampler("colormap").tex=o}fragDataSrc(t){return`\n        // 2D vector glyph visualization\n        \n        const float GLYPH_TILE_SIZE = 16.0;\n        const float ISQRT2 = 0.70710678118; // 1/sqrt(2)\n\n        // Computes the center pixel of the tile containing pixel pos\n        vec2 glyphTileCenterCoord(vec2 pos) {\n            return (floor(pos / GLYPH_TILE_SIZE) + 0.5) * GLYPH_TILE_SIZE;\n        }\n\n        float glyph(vec2 p, vec2 v) {\n            if (${this.modeName("glyphNormalize")}) v = normalize(v);\n            \n            // Make everything relative to the center, which may be fractional\n            p -= glyphTileCenterCoord(p);\n                \n            float mag_v = length(v), mag_p = length(p);\n            \n            if (mag_v > 0.0) {\n                // Non-zero velocity case\n                vec2 dir_v = normalize(v);\n                \n                float level = floor((1.0-mag_v*ISQRT2) * ${this.uniformName("glyph_count")});\n                level = min(level, ${this.uniformName("glyph_count")} - 1.0);\n\n                mat2 rotm = mat2(\n                    dir_v[1], dir_v[0], // first column\n                    -dir_v[0], dir_v[1]  // second column\n                );\n            \n                float scaleToGlyph =  ${this.uniformName("glyph_wh")} / GLYPH_TILE_SIZE;\n                vec2 pp = rotm * p; // p on axys with origin in tile center and aligned with direction dir_v\n                pp += vec2(GLYPH_TILE_SIZE * 0.5, GLYPH_TILE_SIZE * 0.5); // pp in [0, GLYPH_TILE_SIZE]\n                pp *= scaleToGlyph; // pp in [0, glyph_wh]\n                pp.x += level * ${this.uniformName("glyph_stride")}; // apply stride\n                pp.y = ${this.uniformName("glyph_wh")} - pp.y - 1.0; // invert y-axis\n                //vec4 g = texelFetch(${this.samplerName("glyphs")}, ivec2(pp), 0);\n                float w = ${this.uniformName("glyph_stride")}*(${this.uniformName("glyph_count")} -1.0) + ${this.uniformName("glyph_wh")};\n                float h = ${this.uniformName("glyph_wh")};\n                vec2 ppnorm = pp/vec2(w,h);\n                vec4 g = texture(${this.samplerName("glyphs")}, ppnorm);\n                return 1.0-g.a;\n\n            } else {\n                // Signed distance from the center point\n                return mag_p;\n            }\n        }\n        \n        vec4 lookupColormap(float cv) {            \n            if(cv >= 1.0) \n                return ${this.uniformName("high_color")};\n            else if(cv <= 0.0) \n                return ${this.uniformName("low_color")};\n            return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n        }\n\n        vec4 ${this.functionName()}(vec4 col){\n            if(col.a == 0.0) return col;\n\n            vec2 p = v_texcoord*tileSize; // point in pixel\n            vec2 pc_coord = glyphTileCenterCoord(p)/tileSize; // center coordinate\n            vec4 pc_val = texture(source, pc_coord); // [0..1] - lookup color in center\n            float s = 2.0;\n            float b = -1.0;\n            vec2 uvc = vec2(pc_val.x*s+b, pc_val.y*s+b); // [-1..1]\n            vec2 uvr =  vec2(col.r*s+b, col.g*s+b); // [-1..1]\n\n            // Colors\n            float vc = length(uvc)*ISQRT2;\n            float cvc = vc*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            float vr = length(uvr)*ISQRT2;\n            float cvr = vr*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            vec4 cmapc = lookupColormap(cvc);\n            vec4 cmapr = lookupColormap(cvr);\n                \n            // Glyph            \n            float glyph_dist = glyph(p, uvc);\n\n            vec4 glyph_col = cmapc;\n            vec4 field_col = vec4(0.0, 0.0, 0.0, 0.0);\n\n            switch (${this.modeName("glyphColor")}) {\n                case 0:\n                    glyph_col = cmapc;\n                    break;\n                case 1:\n                    glyph_col = ${this.uniformName("glyph_color")};               \n                    break;\n            }\n\n            switch (${this.modeName("fieldColor")}) {\n                case 0:\n                    field_col = vec4(0.0, 0.0, 0.0, 0.0);\n                    break;\n                case 1:\n                    field_col = cmapr;              \n                    break;\n            }\n\n            float t = clamp(glyph_dist, 0.0, 1.0);\n            return  mix(glyph_col, field_col, t);\n        }`}},t.ShaderGammaFilter=class extends _{constructor(t){super(t),this.uniforms[this.uniformName("gamma")]={type:"float",needsUpdate:!0,size:1,value:2.2}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                float igamma = 1.0/${this.uniformName("gamma")};\n                return vec4(pow(col.r, igamma), pow(col.g, igamma), pow(col.b, igamma), col.a);\n            }`}},t.ShaderHDR=$,t.ShaderMultispectral=D,t.ShaderNeural=at,t.ShaderRTI=Y,t.Skin=j,t.TextToSpeechPlayer=class{constructor(t){this.config={language:"it-IT",rate:1,volume:1,cleanText:!0,voiceSelected:-1},t&&Object.assign(this.config,t),this.voice=null,this.isSpeaking=!1,this.currentUtterance=null,this.isOfflineCapable=!1,this.resumeTimer=null,this.timeoutTimer=null,this.isPaused=!1,this.previousVolume=this.config.volume,this.intentionalStop=!1,this._resolveCurrentSpeech=null,window.speechSynthesis||console.error("Speech Synthesis API is not supported in this browser")}async initialize(){try{if(!window.speechSynthesis)throw new Error("Speech Synthesis API is not supported in this browser");return await this.warmUpSpeechSynthesis(),await this.loadVoice(),this.checkOfflineCapability(),this.setupPageListeners(),console.log("TextToSpeechPlayer initialized successfully"),console.log(`Offline capable: ${this.isOfflineCapable}`),!0}catch(t){throw console.error("Failed to initialize TextToSpeechPlayer:",t),t}}async warmUpSpeechSynthesis(){return new Promise((t=>{try{const e=new SpeechSynthesisUtterance(" ");e.volume=0,e.rate=2,e.onend=()=>{t()},e.onerror=()=>{t()},setTimeout(t,500),window.speechSynthesis.speak(e)}catch(e){console.warn("Failed to warm up speech synthesis",e),t()}}))}setupPageListeners(){window.addEventListener("beforeunload",(()=>{this.stopSpeaking()})),document.addEventListener("visibilitychange",(()=>{document.hidden&&this.stopSpeaking()}))}activate(){this.isSpeaking=!0}async loadVoice(){return console.log(`Loading voice for language: ${this.config.language}`),new Promise(((t,e)=>{const i=window.speechSynthesis,s=()=>{let s=i.getVoices();if(0===s.length)return console.warn("No voices available for this browser"),void e(new Error("No voices available for this browser"));if(this.config.voiceSelected>=0&&this.config.voiceSelected<s.length)this.voice=s[this.config.voiceSelected];else{const t=this.config.language.substring(0,2);this.voice=s.find((e=>e.lang.startsWith(t)))}this.voice?(console.log(`Voice loaded: ${this.voice.name}`),t(this.voice)):(console.warn(`No suitable voice found for language: ${this.config.language}`),e(new Error(`No voice available for ${this.config.language}`)))};i.getVoices().length>0?s():(i.onvoiceschanged=()=>{s(),i.onvoiceschanged=null},setTimeout((()=>{this.voice||(console.warn("Timeout while waiting for voices to load"),s())}),1e3))}))}checkOfflineCapability(){this.voice?this.isOfflineCapable=this.voice.localService:this.isOfflineCapable=!1}cleanTextForSpeech(t){if(!t)return"";let e=t.replace(/<[^>]+class=(\"omissis\"|"omissis")[^>]*>[\s\S]*?<\/[^>]+>/g,"");return e=e.replace(/<br\s*\/?>/gi," "),e=e.replace(/<\/?[^>]+(>|$)/g,""),e=e.replace(/\\[nrt]/g," "),e.trim()}async speakText(t){if(this.stopSpeaking(),!t)return void console.warn("No text provided to speak");if(!this.voice)return void console.error("Voice not loaded. Please initialize TextToSpeechPlayer first.");if(!this.isOfflineCapable&&!navigator.onLine)return void console.error("No internet connection and offline speech is not available.");this.isSpeaking=!0,this.isPaused=!1;let e=t;if(this.config.cleanText&&(e=this.cleanTextForSpeech(t)),!e)return console.warn("Text is empty after cleaning"),void(this.isSpeaking=!1);console.log("Attempting to speak:",e);const i=window.speechSynthesis;i.cancel(),this.intentionalStop=!1;try{this.currentUtterance=new SpeechSynthesisUtterance(e),this.currentUtterance.lang=this.config.language,this.currentUtterance.voice=this.voice,this.currentUtterance.rate=this.config.rate,this.currentUtterance.volume=this.config.volume,await new Promise(((t,s)=>{this._resolveCurrentSpeech=t,this.currentUtterance.onend=()=>{t("completed")},this.currentUtterance.onerror=e=>{this.intentionalStop&&"interrupted"===e.error?(console.log("Speech intentionally interrupted"),t("interrupted")):(console.error("Speech error:",e),s(e))},i.speak(this.currentUtterance),!this.isPaused&&i.speaking&&(i.pause(),i.resume());const n=Math.max(5e3,100*e.length);this.timeoutTimer=setTimeout((()=>{i.speaking&&this.isSpeaking&&(console.warn("Speech synthesis taking too long. Resetting..."),this.intentionalStop=!0,this.stopSpeaking(),t("timeout"))}),n),this.resumeTimer=setInterval((()=>{i.speaking?this.isPaused||(i.pause(),i.resume()):(clearInterval(this.resumeTimer),this.resumeTimer=null)}),1e4)}))}catch(t){this.intentionalStop&&"interrupted"===t.error||console.error("Error during speech:",t)}finally{this.isSpeaking&&this.stopSpeaking()}}pauseSpeaking(t){if(!window.speechSynthesis||!this.isSpeaking)return void console.log("No speech in progress to pause/resume");const e=window.speechSynthesis;t&&!this.isPaused?(e.pause(),this.isPaused=!0,this.resumeTimer&&(clearInterval(this.resumeTimer),this.resumeTimer=null)):!t&&this.isPaused&&(e.resume(),this.isPaused=!1,this.resumeTimer=setInterval((()=>{e.speaking?(e.pause(),e.resume()):(clearInterval(this.resumeTimer),this.resumeTimer=null)}),1e4))}mute(t){t?(this.previousVolume=this.config.volume,this.config.volume=0):this.config.volume=this.previousVolume,this.currentUtterance&&(this.currentUtterance.volume=this.config.volume)}stopSpeaking(){const t=window.speechSynthesis;if(this.intentionalStop=!0,t&&t.speaking)try{t.cancel()}catch(t){console.error("Error cancelling speech:",t)}this.resumeTimer&&(clearInterval(this.resumeTimer),this.resumeTimer=null),this.timeoutTimer&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null),this._resolveCurrentSpeech&&(this._resolveCurrentSpeech("stopped"),this._resolveCurrentSpeech=null),this.currentUtterance=null,this.isSpeaking=!1,this.isPaused=!1}},t.Tile=r,t.Transform=s,t.UIBasic=W,t.UIDialog=X,t.Units=H,t.Util=e,t.Viewer=F,Object.defineProperty(t,"__esModule",{value:!0})}));
