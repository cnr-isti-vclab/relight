!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).OpenLIME=t.OpenLIME||{})}(this,(function(t){"use strict";window.structuredClone="function"==typeof structuredClone?structuredClone:function(t){return JSON.parse(JSON.stringify(t))};class e{static padZeros(t,e){for(t=t.toString();t.length<e;)t="0"+t;return t}static printSrcCode(t){let i=1,s="";for(let r of t.split(/\r\n|\r|\n/)){s+=e.padZeros(i,5)+"   "+r+"\n",i++}console.log(s)}static createSVGElement(t,e){let i=document.createElementNS("http://www.w3.org/2000/svg",t);if(e)for(const[t,s]of Object.entries(e))i.setAttribute(t,s);return i}static SVGFromString(t){return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement}static async loadSVG(t){let i=await fetch(t);if(!i.ok){const t=`An error has occured: ${i.status}`;throw new Error(t)}let s=await i.text(),r=null;if(!e.isSVGString(s)){throw new Error(`${t} is not an SVG file`)}return r=e.SVGFromString(s),r}static async loadHTML(t){let e=await fetch(t);if(!e.ok){const t=`An error has occured: ${e.status}`;throw new Error(t)}return await e.text()}static async loadJSON(t){let e=await fetch(t);if(!e.ok){const t=`An error has occured: ${e.status}`;throw new Error(t)}return await e.json()}static async loadImage(t){return new Promise(((e,i)=>{const s=new Image;s.addEventListener("load",(()=>e(s))),s.addEventListener("error",(t=>i(t))),s.src=t}))}static async appendImg(t,i,s=null){const r=await e.loadImage(i);return s&&r.classList.add(s),t.appendChild(r),r}static async appendImgs(t,i,s=null){for(const r of i){const i=await e.loadImage(r);s&&i.classList.add(s),t.appendChild(i)}}static isSVGString(t){return null!=t&&null!=t&&(t=(t=t.toString().replace(/\s*<!Entity\s+\S*\s*(?:"|')[^"]+(?:"|')\s*>/gim,"")).replace(/<!--([\s\S]*?)-->/g,""),Boolean(t)&&/^\s*(?:<\?xml[^>]*>\s*)?(?:<!doctype svg[^>]*\s*(?:\[?(?:\s*<![^>]*>\s*)*\]?)*[^>]*>\s*)?(?:<svg[^>]*>[^]*<\/svg>|<svg[^/>]*\/\s*>)\s*$/i.test(t))}static computeSDF(t,e,i,s=.25,r=8){function n(t,e,i,s,r,n,o){for(let l=0;l<e;l++){for(let r=0;r<i;r++)s[r]=t[r*e+l];a(s,r,n,o,i);for(let s=0;s<i;s++)t[s*e+l]=r[s]}for(let l=0;l<i;l++){for(let i=0;i<e;i++)s[i]=t[l*e+i];a(s,r,n,o,e);for(let i=0;i<e;i++)t[l*e+i]=Math.sqrt(r[i])}}function a(t,e,i,s,r){i[0]=0,s[0]=-l,s[1]=+l;for(let e=1,a=0;e<r;e++){for(var n=(t[e]+e*e-(t[i[a]]+i[a]*i[a]))/(2*e-2*i[a]);n<=s[a];)a--,n=(t[e]+e*e-(t[i[a]]+i[a]*i[a]))/(2*e-2*i[a]);a++,i[a]=e,s[a]=n,s[a+1]=+l}for(let n=0,a=0;n<r;n++){for(;s[a+1]<n;)a++;e[n]=(n-i[a])*(n-i[a])+t[i[a]]}}var o=new Uint8ClampedArray(t);const l=1e20,h=Math.max(e,i),c=Array(e*i),d=Array(e*i),u=Array(h),m=Array(h),p=Array(h+1),f=Array(h);for(let t=0;t<e*i;t++){var g=o[t]/255;c[t]=1===g?0:0===g?l:Math.pow(Math.max(0,.5-g),2),d[t]=1===g?l:0===g?0:Math.pow(Math.max(0,g-.5),2)}n(c,e,i,u,m,f,p),n(d,e,i,u,m,f,p);const v=window.Float32Array?new Float32Array(e*i):new Array(e*i);for(let t=0;t<e*i;t++)v[t]=Math.min(Math.max(1-((c[t]-d[t])/r+s),0),1);return v}static async rasterizeSVG(t,i=[64,64]){const s=await e.loadSVG(t),r=s.getAttribute("width"),n=s.getAttribute("height"),a=document.createElement("canvas");a.width=i[0],a.height=i[1],s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%");const o=a.getContext("2d"),l=(new XMLSerializer).serializeToString(s),h=window.URL||window.webkitURL||window,c=new Image,d=new Blob([l],{type:"image/svg+xml;charset=utf-8"}),u=h.createObjectURL(d);return c.src=u,new Promise(((t,e)=>{c.onload=()=>{const e=i[0]/i[1],s=r/n;let a=0,l=0;s<e?(l=i[1],a=l*s):(a=i[0],l=a/s);let d=.5*(i[1]-l),m=.5*(i[0]-a);o.translate(m,d),o.drawImage(c,0,0),h.revokeObjectURL(u);const p=o.getImageData(0,0,i[0],i[1]);t(p)},c.onerror=t=>e(t)}))}}class i{constructor(t){Object.assign(this,{xLow:1e20,yLow:1e20,xHigh:-1e20,yHigh:-1e20}),Object.assign(this,t)}fromArray(t){this.xLow=t[0],this.yLow=t[1],this.xHigh=t[2],this.yHigh=t[3]}toEmpty(){this.xLow=1e20,this.yLow=1e20,this.xHigh=-1e20,this.yHigh=-1e20}isEmpty(){return this.xLow>this.xHigh||this.yLow>this.yHigh}toArray(){return[this.xLow,this.yLow,this.xHigh,this.yHigh]}toString(){return this.xLow.toString()+" "+this.yLow.toString()+" "+this.xHigh.toString()+" "+this.yHigh.toString()}mergeBox(t){null!=t&&(this.isEmpty()?Object.assign(this,t):(this.xLow=Math.min(this.xLow,t.xLow),this.yLow=Math.min(this.yLow,t.yLow),this.xHigh=Math.max(this.xHigh,t.xHigh),this.yHigh=Math.max(this.yHigh,t.yHigh)))}mergePoint(t){this.xLow=Math.min(this.xLow,t.x),this.yLow=Math.min(this.yLow,t.y),this.xHigh=Math.max(this.xHigh,t.x),this.yHigh=Math.max(this.yHigh,t.y)}shift(t,e){this.xLow+=t,this.yLow+=e,this.xHigh+=t,this.yHigh+=e}quantize(t){this.xLow=Math.floor(this.xLow/t),this.yLow=Math.floor(this.yLow/t),this.xHigh=Math.floor((this.xHigh-1)/t)+1,this.yHigh=Math.floor((this.yHigh-1)/t)+1}width(){return this.xHigh-this.xLow}height(){return this.yHigh-this.yLow}center(){return{x:(this.xLow+this.xHigh)/2,y:(this.yLow+this.yHigh)/2}}corner(t){let e=this.toArray();return{x:e[0+(1&t)<<1],y:e[1+(2&t)]}}intersects(t){return xLow<=t.xHigh&&xHigh>=t.xLow&&yLow<=t.yHigh&&yHigh>=t.yLow}print(){console.log("BOX="+this.xLow.toFixed(2)+", "+this.yLow.toFixed(2)+", "+this.xHigh.toFixed(2)+", "+this.yHigh.toFixed(2))}}class s{constructor(t){Object.assign(this,{x:0,y:0,z:1,a:0,t:0}),this.t||(this.t=performance.now()),"object"==typeof t&&Object.assign(this,t)}copy(){let t=new s;return Object.assign(t,this),t}apply(t,e){let i=s.rotate(t,e,this.a);return{x:i.x*this.z+this.x,y:i.y*this.z+this.y}}inverse(){let t=s.rotate(this.x/this.z,this.y/this.z,-this.a);return new s({x:-t.x,y:-t.y,z:1/this.z,a:-this.a,t:this.t})}static normalizeAngle(t){for(;t>360;)t-=360;for(;t<0;)t+=360;return t}static rotate(t,e,i){return i=Math.PI*(i/180),{x:Math.cos(i)*t-Math.sin(i)*e,y:Math.sin(i)*t+Math.cos(i)*e}}compose(t){let e=this.copy(),i=t;e.z*=i.z,e.a+=i.a;var r=s.rotate(e.x,e.y,i.a);return e.x=r.x*i.z+i.x,e.y=r.y*i.z+i.y,e}transformBox(t){let e=new i;for(let i=0;i<4;i++){let s=t.corner(i),r=this.apply(s.x,s.y);e.mergePoint(r)}return e}getInverseBox(t){let e=this.inverse(),s=[{x:t.x,y:t.y},{x:t.x+t.dx,y:t.y},{x:t.x,y:t.y+t.dy},{x:t.x+t.dx,y:t.y+t.dy}],r=new i;for(let i of s){let s=e.apply(i.x-t.w/2,-i.y+t.h/2);r.mergePoint(s)}return r}static interpolate(t,e,i,r){console.assert(!isNaN(t.x)),console.assert(!isNaN(e.x));const n=new s;let a=e.t-t.t;if(i<t.t)Object.assign(n,t);else if(i>e.t||a<.001)Object.assign(n,e);else{let s=(i-t.t)/a;switch(r){case"ease-out":s=1-Math.pow(1-s,2);break;case"ease-in-out":s=s<.5?2*s*s:1-Math.pow(-2*s+2,2)/2}let o=1-s;for(let i of["x","y","z","a"])n[i]=o*t[i]+s*e[i]}return n.t=i,n}projectionMatrix(t){let e=this.z,i=2/t.dx,s=2/t.dy,r=i*this.x+2/t.dx*(t.w/2-t.x)-1,n=s*this.y+2/t.dy*(t.h/2-t.y)-1,a=Math.PI*this.a/180;return[Math.cos(a)*i*e,Math.sin(a)*s*e,0,0,-Math.sin(a)*i*e,Math.cos(a)*s*e,0,0,0,0,1,0,r,n,0,1]}sceneToViewportCoords(t,e){return[e[0]*this.z+this.x-t.x+t.w/2,e[1]*this.z-this.y+t.y+t.h/2]}viewportToSceneCoords(t,e){return[(e[0]+t.x-t.w/2-this.x)/this.z,(e[1]-t.y-t.h/2+this.y)/this.z]}print(t="",e=0){const i=e;console.log(t+" x:"+this.x.toFixed(i)+", y:"+this.y.toFixed(i)+", z:"+this.z.toFixed(i)+", a:"+this.a.toFixed(i)+", t:"+this.t.toFixed(i))}}function r(t,...e){t.prototype.allSignals||(t.prototype.allSignals=[]),t.prototype.allSignals=[...t.prototype.allSignals,...e],t.prototype.initSignals=function(){this.signals=Object.fromEntries(this.allSignals.map((t=>[t,[]])))},t.prototype.addEvent=function(t,e){this.signals||this.initSignals(),this.signals[t].push(e)},t.prototype.once=function(t,e){if(!e||"function"!=typeof e)return void console.error("Callback must be a function");const i=(...s)=>{this.removeEvent(t,i),e.apply(this,s)};this.addEvent(t,i)},t.prototype.removeEvent=function(t,e){if(!this.signals)return this.initSignals(),!1;if(!this.signals[t])return!1;if(void 0===e){const e=this.signals[t].length>0;return this.signals[t]=[],e}const i=this.signals[t].length;return this.signals[t]=this.signals[t].filter((t=>t!==e)),i>this.signals[t].length},t.prototype.emit=function(t,...e){this.signals||this.initSignals();const i=[...this.signals[t]];for(let t of i)t(...e)}}class n{constructor(t){Object.assign(this,{viewport:null,bounded:!0,minScreenFraction:1,maxFixedZoom:2,maxZoom:2,minZoom:1,boundingBox:new i}),Object.assign(this,t),this.target=new s(this.target),this.source=this.target.copy(),this.easing="linear"}copy(){let t=new n;return Object.assign(t,this),t}setViewport(t){if(this.viewport){let e=Math.sqrt(t.w/this.viewport.w*(t.h/this.viewport.h));this.viewport=t;const{x:i,y:s,z:r,a:n}=this.target;this.setPosition(0,i,s,r*e,n)}else this.viewport=t}glViewport(){let t=window.devicePixelRatio,e={};for(let i in this.viewport)e[i]=this.viewport[i]*t;return e}mapToScene(t,e,i){t-=this.viewport.w/2,e-=this.viewport.h/2,t-=i.x,e-=i.y,t/=i.z,e/=i.z;let r=s.rotate(t,e,-i.a);return{x:r.x,y:r.y}}sceneToCanvas(t,e,i){let r=s.rotate(t,e,i.a);return{x:t=r.x*i.z+i.x-this.viewport.x+this.viewport.w/2,y:e=r.y*i.z-i.y+this.viewport.y+this.viewport.h/2}}setPosition(t,e,i,r,n,a){if(this.easing=a||this.easing,this.bounded){const t=this.viewport.dx,a=this.viewport.dy;let o=new s({x:e,y:i,z:r,a:n,t:0}).transformBox(this.boundingBox);const l=o.width(),h=o.height(),c=Math.abs(l-t)/2;e=Math.min(Math.max(-c,e),c);const d=Math.abs(h-a)/2;i=Math.min(Math.max(-d,i),d)}let o=performance.now();this.source=this.getCurrentTransform(o),n=s.normalizeAngle(n),this.source.a=s.normalizeAngle(this.source.a),n-this.source.a>180&&(this.source.a+=360),this.source.a-n>180&&(this.source.a-=360),Object.assign(this.target,{x:e,y:i,z:r,a:n,t:o+t}),console.assert(!isNaN(this.target.x)),this.emit("update")}pan(t,e,i){let s=performance.now(),r=this.getCurrentTransform(s);r.x+=e,r.y+=i,this.setPosition(t,r.x,r.y,r.z,r.a)}zoom(t,e,i,s){i||(i=0),s||(s=0);let r=performance.now(),n=this.getCurrentTransform(r);this.bounded&&(e=Math.min(Math.max(e,this.minZoom),this.maxZoom)),n.x+=(n.x+i)*(n.z-e)/n.z,n.y+=(n.y+s)*(n.z-e)/n.z,this.setPosition(t,n.x,n.y,e,n.a)}rotate(t,e){let i=performance.now(),s=this.getCurrentTransform(i);this.setPosition(t,s.x,s.y,s.z,this.target.a+e)}deltaZoom(t,e,i=0,r=0){let n=performance.now(),a=this.getCurrentTransform(n);e*=this.target.z/a.z,this.bounded&&(a.z*e<this.minZoom&&(e=this.minZoom/a.z),a.z*e>this.maxZoom&&(e=this.maxZoom/a.z));let o=s.rotate(i,r,a.a);a.x+=o.x*a.z*(1-e),a.y+=o.y*a.z*(1-e),this.setPosition(t,a.x,a.y,a.z*e,a.a)}getCurrentTransform(t){return t>this.target.t&&(this.easing="linear"),s.interpolate(this.source,this.target,t,this.easing)}getGlCurrentTransform(t){const e=this.getCurrentTransform(t);return e.x*=window.devicePixelRatio,e.y*=window.devicePixelRatio,e.z*=window.devicePixelRatio,e}fit(t,e){if(t.isEmpty())return;e||(e=0);let i=this.viewport.dx,s=this.viewport.dy,r=t.width(),n=t.height(),a=t.center(),o=Math.min(i/r,s/n);this.setPosition(e,-a.x*o,-a.y*o,o,0)}fitCameraBox(t){this.fit(this.boundingBox,t)}updateBounds(t,e){this.boundingBox=t;const i=this.viewport.dx,s=this.viewport.dy;let r=this.boundingBox.width(),n=this.boundingBox.height();this.minZoom=Math.min(i/r,s/n)*this.minScreenFraction,this.maxZoom=e>0?this.maxFixedZoom/e:this.maxFixedZoom,this.maxZoom=Math.max(this.minZoom,this.maxZoom)}}r(n,"update");class a{constructor(){Object.assign(this,{index:null,bbox:null,level:null,x:null,y:null,w:null,h:null,start:null,end:null,tex:[],missing:null,time:null,priority:null,size:null})}}class o{static fromViewportToCanvasHtml(t,e,i){const s=this.getViewport(e,i);let r=this.invertY(t,s);return i?this.scale(r,1/window.devicePixelRatio):r}static fromCanvasHtmlToViewport(t,e,i){let s=i?this.scale(t,window.devicePixelRatio):t;const r=this.getViewport(e,i);return this.invertY(s,r)}static fromViewportToLayer(t,e,i,s){const r=this.getCurrentTransform(e,s).inverse(),n=i.inverse();return this.getFromViewportToCenterTransform(e,s).compose(r.compose(n)).apply(t.x,t.y)}static fromLayerToViewport(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).apply(t.x,t.y)}static fromLayerToCenter(t,e,i,s){const r=this.getCurrentTransform(e,s);return i.compose(r).apply(t.x,t.y)}static fromLayerToImage(t,e){let i={x:t.x+e.w/2,y:t.y+e.h/2};return this.invertY(i,e)}static fromCanvasHtmlToScene(t,e,i){let s=this.fromCanvasHtmlToViewport(t,e,i);const r=this.getFromViewportToCenterTransform(e,i),n=this.getCurrentTransform(e,i).inverse();return r.compose(n).apply(s.x,s.y)}static fromSceneToCanvasHtml(t,e,i){let s=this.fromSceneToViewport(t,e,i);return this.fromViewportToCanvasHtml(s,e,i)}static fromSceneToViewport(t,e,i){const s=this.getFromViewportToCenterTransform(e,i).inverse();return this.getCurrentTransform(e,i).compose(s).apply(t.x,t.y)}static fromSceneToViewportNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(i).inverse();return e.compose(s).apply(t.x,t.y)}static fromViewportToScene(t,e,i){const s=this.getFromViewportToCenterTransform(e,i),r=this.getCurrentTransform(e,i).inverse();return s.compose(r).apply(t.x,t.y)}static fromViewportToSceneNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(i),r=e.inverse();return s.compose(r).apply(t.x,t.y)}static fromCanvasHtmlToImage(t,e,i,s,r){let n=this.fromCanvasHtmlToScene(t,e,r);return n=i.inverse().apply(n.x,n.y),n=this.fromLayerToImage(n,s),n}static fromViewportBoxToImageBox(t,e,r,n,a){let l=new s({x:-r.w/2,y:-r.h/2}),h=e.inverse(),c=n.inverse(),d=new s({x:a.w/2,y:a.h/2}),u=l.compose(h.compose(c.compose(d))),m=new i;for(let e=0;e<4;++e){let i=t.corner(e);i=u.apply(i.x,i.y),i=o.invertY(i,a),m.mergePoint(i)}return m}static fromLayerBoxToSceneBox(t,e){return e.transformBox(t)}static fromSceneBoxToLayerBox(t,e){return e.inverse().transformBox(t)}static fromLayerBoxToViewportBox(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).transformBox(t)}static fromViewportBoxToLayerBox(t,e,i,s){return this.getFromLayerToViewportTransform(e,i,s).inverse().transformBox(t)}static getFromViewportToCenterTransform(t,e){const i=this.getViewport(t,e);return this.getFromViewportToCenterTransformNoCamera(i)}static getFromViewportToCenterTransformNoCamera(t){return new s({x:t.x-t.w/2,y:t.y-t.h/2,z:1,a:0,t:0})}static reflectY(t){return new s({x:t.x,y:-t.y,z:t.z,a:t.a,t:t.t})}static getFromLayerToViewportTransform(t,e,i){const s=this.getCurrentTransform(t,i),r=this.getFromViewportToCenterTransform(t,i).inverse();return e.compose(s.compose(r))}static getFromLayerToViewportTransformNoCamera(t,e,i){const s=this.getFromViewportToCenterTransformNoCamera(e).inverse();return i.compose(t.compose(s))}static scale(t,e){return{x:t.x*e,y:t.y*e}}static invertY(t,e){return{x:t.x,y:e.h-t.y}}static getViewport(t,e){return e?t.glViewport():t.viewport}static getCurrentTransform(t,e){return e?t.getGlCurrentTransform(performance.now()):t.getCurrentTransform(performance.now())}}class l{constructor(t,e,i){if("image"!=e){if(e in this.types)return this.types[e](t,e,i);if(null==e)return;throw"Layout type: "+e+" unknown, or module not loaded"}this.setDefaults(e),this.init(t,e,i)}getTileSize(){return[this.width,this.height]}setDefaults(t){Object.assign(this,{type:t,width:0,height:0,suffix:"jpg",urls:[],status:null,subdomains:"abc"})}init(t,e,i){i&&Object.assign(this,i),"string"==typeof t&&this.setUrls([t]),this.width&&this.height&&(this.status="ready")}setUrls(t){this.urls=t,this.getTileURL=(t,e)=>this.urls[t],this.status="ready",this.emit("ready")}imageUrl(t,e){return t.substring(0,t.lastIndexOf("/")+1)+e+".jpg"}getTileURL(t,e){throw Error("Layout not defined or ready.")}boundingBox(){return new i({xLow:-this.width/2,yLow:-this.height/2,xHigh:this.width/2,yHigh:this.height/2})}tileCoords(t){let e=this.width,i=this.height;var s=new Float32Array([0,1,0,0,1,0,1,1]);return{coords:new Float32Array([-e/2,-i/2,0,-e/2,i/2,0,e/2,i/2,0,e/2,-i/2,0]),tcoords:s}}newTile(t){let e=new a;return e.index=t,e}needed(t,e,i,s,r,n,a=8){let o=n.get(0)||this.newTile(0);return o.time=performance.now(),o.priority=10,null===o.missing?[o]:[]}available(t,e,i,s,r,n){let a={};return n.has(0)&&0==n.get(0).missing&&(a[0]=n.get(0)),a}getViewportBox(t,e,s){const r=new i({xLow:t.x,yLow:t.y,xHigh:t.x+t.dx,yHigh:t.y+t.dy});return o.fromViewportBoxToImageBox(r,e,t,s,{w:this.width,h:this.height})}}l.prototype.types={},r(l,"ready","updateSize");const h=new class{constructor(t){Object.assign(this,{capacity:536870912,size:0,maxRequest:6,requested:0,maxRequestsRate:0,requestRateTimeout:null,lastRequestTimestamp:performance.now(),maxPrefetch:8388608,prefetched:0}),Object.assign(this,t),this.layers=[]}setCandidates(t){this.layers.includes(t)||this.layers.push(t),setTimeout((()=>{this.update()}),0)}rateLimited(){if(this.requested>this.maxRequest)return!0;if(0==this.maxRequestsRate)return!1;let t=performance.now(),e=1e3/this.maxRequestsRate,i=t-this.lastRequestTimestamp;return!(i>e)&&(this.requestRateTimeout||(this.requestRateTimeout=setTimeout((()=>{this.requestRateTimeout=null,this.update()}),e-i+10)),!0)}update(){if(this.rateLimited())return;let t=this.findBestCandidate();if(t){for(;this.size>this.capacity;){let e=this.findWorstTile();if(!e){console.log("BIG problem in the cache");break}if(!(e.tile.time<t.tile.time))return;this.dropTile(e.layer,e.tile)}console.assert(t!=t.layer.queue[0]),t.layer.queue.shift(),this.lastRequestTimestamp=performance.now(),this.loadTile(t.layer,t.tile)}}findBestCandidate(){let t=null;for(let e of this.layers){for(;e.queue.length>0&&e.tiles.has(e.queue[0].index);)e.queue.shift();if(!e.queue.length)continue;let i=e.queue[0];(!t||i.time>t.tile.time+1||i.priority>t.tile.priority)&&(t={layer:e,tile:i})}return t}findWorstTile(){let t=null;for(let e of this.layers)for(let i of e.tiles.values())0==i.missing&&(!t||i.time<t.tile.time||i.time==t.tile.time&&i.priority<t.tile.priority)&&(t={layer:e,tile:i});return t}loadTile(t,e){this.requested++,(async()=>{t.loadTile(e,(t=>{this.size+=t,this.requested--,this.update()}))})()}dropTile(t,e){this.size-=e.size,t.dropTile(e)}flushLayer(t){if(this.layers.includes(t))for(let e of t.tiles.values())this.dropTile(t,e)}};class c{constructor(t){if(t.type){let e=t.type;if(delete t.type,e in this.types)return this.types[e](t);throw"Layer type: "+e+"  module has not been loaded"}this.init(t)}init(t){if(Object.assign(this,{transform:new s,viewport:null,debug:!1,visible:!0,zindex:0,overlay:!1,rasters:[],layers:[],controls:{},controllers:[],shaders:{},layout:"image",shader:null,gl:null,width:0,height:0,prefetchBorder:1,mipmapBias:.4,pixelSize:0,tiles:new Map,queue:[],requested:new Map}),Object.assign(this,t),this.sourceLayer&&(this.tiles=this.sourceLayer.tiles),this.transform=new s(this.transform),"string"==typeof this.layout){let t={width:this.width,height:this.height};this.server&&(t.server=this.server),this.setLayout(new l(null,this.layout,t))}else this.setLayout(this.layout)}setViewport(t){this.viewport=t,this.emit("update")}addShaderFilter(t){if(!this.shader)throw"Shader not implemented";this.shader.addFilter(t)}removeShaderFilter(t){if(!this.shader)throw"Shader not implemented";this.shader.removeFilter(t)}clearShaderFilters(){if(!this.shader)throw"Shader not implemented";this.shader.clearFilters()}setState(t,e,i="linear"){if("controls"in t)for(const[s,r]of Object.entries(t.controls))this.setControl(s,r,e,i);"mode"in t&&t.mode&&this.setMode(t.mode)}getState(t=null){const e={controls:{}};for(const[i,s]of Object.entries(this.controls))(!t||"controls"in t&&i in t.controls)&&(e.controls[i]=s.current.value);return t&&!("mode"in t)||this.getMode()&&(e.mode=this.getMode()),e}setLayout(t){this.layout=t;let e=()=>{this.status="ready",this.setupTiles(),this.emit("ready"),this.emit("update")};"ready"==t.status?e():t.addEvent("ready",e),this.layout.addEvent("updateSize",(()=>{this.shader&&this.shader.setTileSize(this.layout.getTileSize()),this.emit("updateSize")}))}setTransform(t){this.transform=t,this.emit("updateSize")}setShader(t){if(!t in this.shaders)throw"Unknown shader: "+t;this.shader=this.shaders[t],this.setupTiles(),this.shader.addEvent("update",(()=>{this.emit("update")}))}getMode(){return this.shader?this.shader.mode:null}getModes(){return this.shader?this.shader.modes:[]}setMode(t){this.shader.setMode(t),this.emit("update")}setVisible(t){this.visible=t,this.previouslyNeeded=null,this.emit("update")}setZindex(t){this.zindex=t,this.emit("update")}static computeLayersMinScale(t,e){if(null==t||null==t)return console.log("ASKING SCALE INFO ON NO LAYERS"),1;let i=1;for(let s of Object.values(t))if(!e||s.visible){let t=s.scale();i=Math.min(i,t)}return i}scale(){return this.transform.z}pixelSizePerMM(){return this.pixelSize*this.transform.z}boundingBox(){let t=this.layout.boundingBox();return null!=this.transform&&null!=this.transform&&(t=this.transform.transformBox(t)),t}static computeLayersBBox(t,e){if(null==t||null==t){return console.log("ASKING BBOX INFO ON NO LAYERS"),new i}let s=new i;for(let i of Object.values(t))if((!e||i.visible)&&i.layout.width){const t=i.boundingBox();s.mergeBox(t)}return s}getControl(t){let e=this.controls[t]?this.controls[t]:null;if(e){let t=performance.now();this.interpolateControl(e,t)}return e}addControl(t,e){if(this.controls[t])throw new Error('Control "$name" already exist!');let i=performance.now();this.controls[t]={source:{value:e,t:i},target:{value:e,t:i},current:{value:e,t:i},easing:"linear"}}setControl(t,e,i,s="linear"){let r=performance.now(),n=this.controls[t];this.interpolateControl(n,r),n.source.value=[...n.current.value],n.source.t=r,n.target.value=[...e],n.target.t=r+i,n.easing=s,this.emit("update")}interpolateControls(){let t=performance.now(),e=!0;for(let i of Object.values(this.controls))e=this.interpolateControl(i,t)&&e;return e}interpolateControl(t,e){let i=t.source,s=t.target,r=t.current;if(r.t=e,e<i.t)return r.value=[...i.value],!1;if(e>s.t-1e-4){let t=r.value.every(((t,e)=>t===s.value[e]));return r.value=[...s.value],t}let n=s.t-i.t,a=(e-i.t)/n;switch(t.easing){case"ease-out":a=1-Math.pow(1-a,2);break;case"ease-in-out":a=a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2}let o=1-a;r.value=[];for(let t=0;t<i.value.length;t++)r.value[t]=o*i.value[t]+a*s.value[t];return!1}dropTile(t){for(let e=0;e<t.tex.length;e++)t.tex[e]&&this.gl.deleteTexture(t.tex[e]);this.tiles.delete(t.index)}clear(){this.ibuffer=this.vbuffer=null,h.flushLayer(this),this.tiles=new Map,this.setupTiles(),this.queue=[],this.previouslyNeeded=!1}draw(t,e){if("ready"!=this.status)return!0;if(!this.shader)throw"Shader not specified!";let i=this.interpolateControls(),s=e;this.viewport&&(e=this.viewport,this.gl.viewport(e.x,e.y,e.dx,e.dy)),this.prepareWebGL();let r=this.layout.available(e,t,this.transform,0,this.mipmapBias,this.tiles),n=(t=this.transform.compose(t)).projectionMatrix(e);this.gl.uniformMatrix4fv(this.shader.matrixlocation,this.gl.FALSE,n),this.updateAllTileBuffers(r);let a=this.shader.samplers.length;for(const t of this.shader.filters)for(let e=0;e<t.samplers.length;e++)this.gl.uniform1i(t.samplers[e].location,a),this.gl.activeTexture(this.gl.TEXTURE0+a),this.gl.bindTexture(this.gl.TEXTURE_2D,t.samplers[e].tex),a++;let o=0;for(let t of Object.values(r))this.drawTile(t,o),++o;return this.vieport&&this.gl.viewport(s.x,s.y,s.dx,s.dy),i}drawTile(t,e){if(0!=t.missing)throw"Attempt to draw tile still missing textures";let i=this.gl;for(var s=0;s<this.shader.samplers.length;s++){let e=this.shader.samplers[s].id;i.uniform1i(this.shader.samplers[s].location,s),i.activeTexture(i.TEXTURE0+s),i.bindTexture(i.TEXTURE_2D,t.tex[e])}const r=this.getTileByteOffset(e);i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,r)}getTileByteOffset(t){return 6*t*2}updateTileBuffers(t,e){let i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.coordattrib,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.coordattrib),i.bindBuffer(i.ARRAY_BUFFER,this.tbuffer),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.vertexAttribPointer(this.shader.texattrib,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.shader.texattrib)}updateAllTileBuffers(t){let e=this.gl,i=Object.values(t).length;if(0==i)return;const s=new Uint16Array(6*i),r=new Float32Array(12*i),n=new Float32Array(8*i);let a=0;for(let e of Object.values(t)){let t=this.layout.tileCoords(e);r.set(t.coords,12*a),n.set(t.tcoords,8*a);const i=4*a;e.indexBufferByteOffset=2*a*6,s.set([i+3,i+2,i+1,i+3,i+1,i+0],6*a),++a}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.vertexAttribPointer(this.shader.coordattrib,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.shader.coordattrib),e.bindBuffer(e.ARRAY_BUFFER,this.tbuffer),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.vertexAttribPointer(this.shader.texattrib,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.shader.texattrib)}setupTiles(){if(this.shader&&this.layout&&"ready"==this.layout.status)for(let t of this.tiles){t.missing=this.shader.samplers.length;for(let e of this.shader.samplers)t.tex[e.id]&&t.missing--}}prepareWebGL(){let t=this.gl;this.ibuffer||(this.ibuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ibuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([3,2,1,3,1,0]),t.STATIC_DRAW),this.vbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),t.STATIC_DRAW),this.tbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.tbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,1,0]),t.STATIC_DRAW)),this.shader.needsUpdate&&(this.shader.debug=this.debug,this.shader.createProgram(t)),t.useProgram(this.shader.program),this.shader.updateUniforms(t)}sameNeeded(t,e){if(t.level!=e.level)return!1;for(let i of["xLow","xHigh","yLow","yHigh"])if(t.pyramid[t.level][i]!=e.pyramid[t.level][i])return!1;return!0}prefetch(t,e){if(this.viewport&&(e=this.viewport),0!=this.layers.length)for(let i of this.layers)i.prefetch(t,e);if(0!=this.rasters.length&&"ready"==this.status){if("object"!=typeof this.layout)throw"AH!";this.queue=this.layout.needed(e,t,this.transform,this.prefetchBorder,this.mipmapBias,this.tiles),h.setCandidates(this)}}async loadTile(t,e){if(this.tiles.has(t.index))throw"AAARRGGHHH double tile!";if(this.requested.has(t.index))return console.log("Warning: double request!"),void e("Double tile request");if(this.tiles.set(t.index,t),this.requested.set(t.index,!0),"itarzoom"==this.layout.type){t.url=this.layout.getTileURL(null,t);let s={};t.end&&(s.headers={range:`bytes=${t.start}-${t.end}`,"Accept-Encoding":"indentity"});var i=await fetch(t.url,s);if(!i.ok)return void e("Failed loading "+t.url+": "+i.statusText);let r=await i.blob(),n=0;for(let e of this.shader.samplers){let i=this.rasters[e.id],s=r.slice(t.offsets[n],t.offsets[n+1]);const a=await i.blobToImage(s,this.gl);let o=i.loadTexture(this.gl,a),l=a.width*a.height*3;t.size+=l,t.tex[e.id]=o,t.w=a.width,t.h=a.height,n++}return t.missing=0,this.emit("update"),this.requested.delete(t.index),void(e&&e(t.size))}t.missing=this.shader.samplers.length;for(let i of this.shader.samplers){let s=this.rasters[i.id];t.url=this.layout.getTileURL(i.id,t);const[r,n]=await s.loadImage(t,this.gl);"image"==this.layout.type&&(this.layout.width=s.width,this.layout.height=s.height,this.layout.emit("updateSize")),t.size+=n,t.tex[i.id]=r,t.missing--,t.missing<=0&&(this.emit("update"),this.requested.delete(t.index),0==this.requested.size&&this.emit("loaded"),e&&e(n))}}}c.prototype.types={},r(c,"ready","update","loaded","updateSize"),window.structuredClone="function"==typeof structuredClone?structuredClone:function(t){return JSON.parse(JSON.stringify(t))};class d{constructor(t,e,i,s){Object.assign(this,{canvasElement:null,preserveDrawingBuffer:!1,gl:null,overlayElement:null,camera:i,layers:{},targetfps:30,fps:0,timing:[16],timingLength:5,overBudget:0,signals:{update:[],updateSize:[],ready:[]}}),Object.assign(this,s),this.init(t,e);for(let t in this.layers)this.addLayer(t,new c(this.layers[t]));this.camera.addEvent("update",(()=>this.emit("update")))}addRenderTiming(t){for(this.timing.push(t);this.timing.length>this.timingLength;)this.timing.shift();this.overBudget=this.timing.filter((t=>t>1e3/this.targetfps)).length/this.timingLength,this.fps=1e3/(this.timing.reduce(((t,e)=>t+e),0)/this.timing.length)}init(t,e){if(!t)throw"Missing element parameter";if("string"==typeof t&&!(t=document.querySelector(t)))throw"Could not find dom element.";if(!e)throw"Missing element parameter";if("string"==typeof e&&!(e=document.querySelector(e)))throw"Could not find dom element.";if(!t.tagName)throw"Element is not a DOM element";if("CANVAS"!=t.tagName)throw"Element is not a canvas element";this.canvasElement=t,this.overlayElement=e;let i={antialias:!1,depth:!1,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=this.gl||t.getContext("webgl2",i)||t.getContext("webgl",i)||t.getContext("experimental-webgl",i),!this.gl)throw"Could not create a WebGL context";t.addEventListener("webglcontextlost",(t=>{console.log("Context lost."),t.preventDefault()}),!1),t.addEventListener("webglcontextrestored",(()=>{this.restoreWebGL()}),!1),document.addEventListener("visibilitychange",(t=>{this.gl.isContextLost()&&this.restoreWebGL()}))}setState(t,e,i="linear"){if("camera"in t){const s=t.camera;this.camera.setPosition(e,s.x,s.y,s.z,s.a,i)}if("layers"in t)for(const[s,r]of Object.entries(t.layers))if(s in this.layers){this.layers[s].setState(r,e,i)}}getState(t=null){let e={};if(!t||t.camera){let t=performance.now(),i=this.camera.getCurrentTransform(t);e.camera={x:i.x,y:i.y,z:i.z,a:i.a}}e.layers={};for(let i of Object.values(this.layers)){const s=window.structuredClone(t);t&&t.layers&&Object.assign(s,t.layers[i.id]),e.layers[i.id]=i.getState(s)}return e}restoreWebGL(){let t={antialias:!1,depth:!1,preserveDrawingBuffer:this.preserveDrawingBuffer};this.gl=this.gl||this.canvasElement.getContext("webgl2",t)||this.canvasElement.getContext("webgl",t)||this.canvasElement.getContext("experimental-webgl",t);for(let t of Object.values(this.layers))t.gl=this.gl,t.clear(),t.shader&&t.shader.restoreWebGL(this.gl);this.prefetch(),this.emit("update")}addLayer(t,e){console.assert(!(t in this.layers),"Duplicated layer id"),e.id=t,e.addEvent("ready",(()=>{Object.values(this.layers).every((t=>"ready"==t.status))&&this.emit("ready"),this.prefetch()})),e.addEvent("update",(()=>{this.emit("update")})),e.addEvent("updateSize",(()=>{this.updateSize()})),e.gl=this.gl,e.canvas=this,e.overlayElement=this.overlayElement,this.layers[t]=e,this.prefetch()}removeLayer(t){t.clear(),delete this.layers[t.id],delete h.layers[t],this.prefetch()}updateSize(){let t=c.computeLayersBBox(this.layers,false),e=c.computeLayersMinScale(this.layers,false);null!=t&&this.camera.viewport&&this.camera.updateBounds(t,e),this.emit("updateSize")}draw(t){let e=this.gl,i=this.camera.glViewport();e.viewport(i.x,i.y,i.dx,i.dy);var s=[0,0,0,0];e.clearColor(s[0],s[1],s[2],s[3],s[4]),e.clear(e.COLOR_BUFFER_BIT),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND);let r=this.camera.getGlCurrentTransform(t);this.prefetch(r);let n=Object.values(this.layers).sort(((t,e)=>t.zindex-e.zindex)),a=!0;for(let t of n)t.visible&&(a=t.draw(r,i)&&a);return a&&r.t>=this.camera.target.t}prefetch(t){t||(t=this.camera.getGlCurrentTransform(performance.now()));for(let e in this.layers){let i=this.layers[e];i.visible&&"ready"==i.status&&i.prefetch(t,this.camera.glViewport())}}}r(d,"update","updateSize","ready");class m{constructor(t,e){this.xs=t,this.ys=e,this.ks=this.getNaturalKs(new Float64Array(this.xs.length))}getNaturalKs(t){const e=this.xs.length-1,i=m.zerosMat(e+1,e+2);for(let t=1;t<e;t++)i[t][t-1]=1/(this.xs[t]-this.xs[t-1]),i[t][t]=2*(1/(this.xs[t]-this.xs[t-1])+1/(this.xs[t+1]-this.xs[t])),i[t][t+1]=1/(this.xs[t+1]-this.xs[t]),i[t][e+1]=3*((this.ys[t]-this.ys[t-1])/((this.xs[t]-this.xs[t-1])*(this.xs[t]-this.xs[t-1]))+(this.ys[t+1]-this.ys[t])/((this.xs[t+1]-this.xs[t])*(this.xs[t+1]-this.xs[t])));return i[0][0]=2/(this.xs[1]-this.xs[0]),i[0][1]=1/(this.xs[1]-this.xs[0]),i[0][e+1]=3*(this.ys[1]-this.ys[0])/((this.xs[1]-this.xs[0])*(this.xs[1]-this.xs[0])),i[e][e-1]=1/(this.xs[e]-this.xs[e-1]),i[e][e]=2/(this.xs[e]-this.xs[e-1]),i[e][e+1]=3*(this.ys[e]-this.ys[e-1])/((this.xs[e]-this.xs[e-1])*(this.xs[e]-this.xs[e-1])),m.solve(i,t)}getIndexBefore(t){let e=0,i=this.xs.length,s=0;for(;e<i;)s=Math.floor((e+i)/2),this.xs[s]<t&&s!==e?e=s:i=this.xs[s]>=t&&s!==i?s:e;return e===this.xs.length-1?this.xs.length-1:e+1}at(t){let e=this.getIndexBefore(t);const i=(t-this.xs[e-1])/(this.xs[e]-this.xs[e-1]),s=this.ks[e-1]*(this.xs[e]-this.xs[e-1])-(this.ys[e]-this.ys[e-1]),r=-this.ks[e]*(this.xs[e]-this.xs[e-1])+(this.ys[e]-this.ys[e-1]);return(1-i)*this.ys[e-1]+i*this.ys[e]+i*(1-i)*(s*(1-i)+r*i)}static solve(t,e){const i=t.length;let s=0,r=0;for(;s<i&&r<=i;){let e=0,n=-1/0;for(let a=s;a<i;a++){const i=Math.abs(t[a][r]);i>n&&(e=a,n=i)}if(0===t[e][r])r++;else{m.swapRows(t,s,e);for(let e=s+1;e<i;e++){const n=t[e][r]/t[s][r];t[e][r]=0;for(let a=r+1;a<=i;a++)t[e][a]-=t[s][a]*n}s++,r++}}for(let s=i-1;s>=0;s--){var n=0;t[s][s]&&(n=t[s][i]/t[s][s]),e[s]=n;for(let e=s-1;e>=0;e--)t[e][i]-=t[e][s]*n,t[e][s]=0}return e}static zerosMat(t,e){const i=[];for(let s=0;s<t;s++)i.push(new Float64Array(e));return i}static swapRows(t,e,i){let s=t[e];t[e]=t[i],t[i]=s}}class p{constructor(t,e,i,s){if("string"==typeof t)if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){let r=t.substring(1).split("");3==r.length&&(r=[r[0],r[0],r[1],r[1],r[2],r[2]]),r="0x"+r.join("")+"FF",t=p.normalizedRGBA(r>>24),e=p.normalizedRGBA(r>>16),i=p.normalizedRGBA(r>>8),s=p.normalizedRGBA(r)}else if(/^#([A-Fa-f0-9]{4}){1,2}$/.test(t)){let r=t.substring(1).split("");r="0x"+r.join(""),t=p.normalizedRGBA(r>>24),e=p.normalizedRGBA(r>>16),i=p.normalizedRGBA(r>>8),s=p.normalizedRGBA(r)}else if(/^rgb\(/.test(t)){let r=t.split("(")[1].split(")")[0];r=r.split(","),t=p.clamp(r[0]/255),e=p.clamp(r[1]/255),i=p.clamp(r[2]/255),s=1}else{if(!/^rgba\(/.test(t))throw Error("Value is not a color");{let r=t.split("(")[1].split(")")[0];r=r.split(","),t=p.clamp(r[0]/255),e=p.clamp(r[1]/255),i=p.clamp(r[2]/255),s=p.clamp(r[3]/255)}}this.r=t,this.g=e,this.b=i,this.a=s}static clamp=(t,e=0,i=1)=>Math.min(Math.max(t,e),i);static hex(t){var e=t.toString(16).toUpperCase();return 1==e.length?"0"+e:e}static normalizedRGBA(t){return p.clamp((255&t)/255)}static rgbToHex(t,e,i){return"#"+(16777216|(i|e<<8|t<<16)).toString(16).substring(1).toUpperCase()}static rgbToHexa(t,e,i,s){return"#"+p.hex(t)+p.hex(e)+p.hex(i)+p.hex(s)}value(){return[this.r,this.g,this.b,this.a]}toRGB(){const t=[255*this.r,255*this.g,255*this.b];return t.forEach(((t,e,i)=>{i[e]=p.clamp(Math.round(t),0,255)})),t}toHex(){const t=this.toRGB();return p.rgbToHex(t[0],t[1],t[2])}toHexa(){const t=this.toRGBA();return p.rgbToHexa(t[0],t[1],t[2],t[3])}toRGBA(){const t=[255*this.r,255*this.g,255*this.b,255*this.a];return t.forEach(((t,e,i)=>{i[e]=p.clamp(Math.round(t),0,255)})),t}}class f{constructor(t){Object.assign(this,{format:"vec3"}),Object.assign(this,t)}async loadImage(t,e){let i,s=new URL(t.url,window.location.href).origin!==window.location.origin;if(t.end||"undefined"==typeof createImageBitmap){let r={};r.headers={range:`bytes=${t.start}-${t.end}`,"Accept-Encoding":"indentity",mode:s?"cors":"same-origin"};let n=await fetch(t.url,r);if(!n.ok)return void callback("Failed loading "+t.url+": "+n.statusText);if(206!=n.status)throw"The server doesn't support partial content requests (206).";let a=await n.blob();i=await this.blobToImage(a,e)}else i=document.createElement("img"),s&&(i.crossOrigin=""),i.onerror=function(t){console.log("Texture loading error!")},i.src=t.url,await new Promise(((t,e)=>{i.onload=()=>{t()}}));return[this.loadTexture(e,i),i.width*i.height*3]}async blobToImage(t,e){let i;if("undefined"!=typeof createImageBitmap){var s="undefined"!=typeof InstallTrigger;i=s?await createImageBitmap(t):await createImageBitmap(t,{imageOrientation1:"flipY"})}else{let e=window.URL||window.webkitURL;i=document.createElement("img"),i.onerror=function(t){console.log("Texture loading error!")},i.src=e.createObjectURL(t),await new Promise(((t,e)=>{i.onload=()=>t()})),e.revokeObjectURL(i.src)}return i}loadTexture(t,e){this.width=e.width,this.height=e.height;var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);let s=t.RGBA;switch(this.format){case"vec3":s=t.RGB;break;case"vec4":s=t.RGBA;break;case"float":s=t.LUMINANCE}return t.texImage2D(t.TEXTURE_2D,0,s,s,t.UNSIGNED_BYTE,e),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.width>1024||this.height>1024?(t.generateMipmap(t.TEXTURE_2D),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)):t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i}}class g{constructor(t){Object.assign(this,{version:100,debug:!1,samplers:[],uniforms:{},label:null,program:null,modes:[],mode:null,needsUpdate:!0,tileSize:[0,0]}),r(g,"update"),Object.assign(this,t),this.filters=[]}clearFilters(){this.filters=[],this.needsUpdate=!0,this.emit("update")}addFilter(t){t.shader=this,this.filters.push(t),this.needsUpdate=!0,t.needsUpdate=!0,this.emit("update")}removeFilter(t){this.filters=this.filters.filter((e=>e.name!=t)),this.needsUpdate=!0,this.emit("update")}setMode(t){if(-1==this.modes.indexOf(t))throw Error("Unknown mode: "+t);this.mode=t,this.needsUpdate=!0}restoreWebGL(t){this.createProgram(t)}setTileSize(t){this.tileSize=t,this.needsUpdate=!0}setUniform(t,e){let i=this.getUniform(t);if(!i)throw new Error(`Unknown '${t}'. It is not a registered uniform.`);if("number"!=typeof e&&"boolean"!=typeof e||i.value!=e){if(Array.isArray(e)&&Array.isArray(i.value)&&e.length==i.value.length){let t=!0;for(let s=0;s<e.length;s++)if(e[s]!=i.value[s]){t=!1;break}if(t)return}i.value=e,i.needsUpdate=!0,this.emit("update")}}completeFragShaderSrc(t){let e=!(t instanceof WebGLRenderingContext),i=(e?"#version 300 es":"")+"\n";i+="precision highp float;\n",i+="precision highp int;\n",i+=`const vec2 tileSize = vec2(${this.tileSize[0]}.0, ${this.tileSize[1]}.0);\n`,i+=this.fragShaderSrc()+"\n";for(let t of this.filters)i+=`\t\t// Filter: ${t.name}\n`,i+=t.fragModeSrc()+"\n",i+=t.fragSamplerSrc()+"\n",i+=t.fragUniformSrc()+"\n",i+=t.fragDataSrc()+"\n\n";i+=`\n\t\t${e?"out":""} vec4 color;\n\t\tvoid main() { \n\t\t\tcolor = data();\n\t\t\t`;for(let t of this.filters)i+=`color=${t.functionName()}(color);\n`;return i+=(e?"":"gl_FragColor = color;")+"\n\t\t}",i}createProgram(t){let i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,this.vertShaderSrc(t)),t.compileShader(i);let s=t.getShaderParameter(i,t.COMPILE_STATUS);if(!s)throw e.printSrcCode(this.vertShaderSrc(t)),console.log(t.getShaderInfoLog(i)),Error("Failed vertex shader compilation: see console log and ask for support.");this.debug&&e.printSrcCode(this.vertShaderSrc(t));let r=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(r,this.completeFragShaderSrc(t)),t.compileShader(r),this.program&&t.deleteProgram(this.program);let n=t.createProgram();if(t.getShaderParameter(r,t.COMPILE_STATUS),s=t.getShaderParameter(r,t.COMPILE_STATUS),!s)throw e.printSrcCode(this.completeFragShaderSrc(t)),console.log(t.getShaderInfoLog(r)),Error("Failed fragment shader compilation: see console log and ask for support.");if(this.debug&&e.printSrcCode(this.completeFragShaderSrc(t)),t.attachShader(n,i),t.attachShader(n,r),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){var a=t.getProgramInfoLog(n);throw new Error("Could not compile WebGL program. \n\n"+a)}for(let e of this.samplers)e.location=t.getUniformLocation(n,e.name);for(let e of this.filters)for(let i of e.samplers)i.location=t.getUniformLocation(n,i.name);this.coordattrib=t.getAttribLocation(n,"a_position"),t.vertexAttribPointer(this.coordattrib,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.coordattrib),this.texattrib=t.getAttribLocation(n,"a_texcoord"),t.vertexAttribPointer(this.texattrib,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.texattrib),this.matrixlocation=t.getUniformLocation(n,"u_matrix"),this.program=n,this.needsUpdate=!1;for(let t of Object.values(this.allUniforms()))t.location=null,t.needsUpdate=!0;for(let e of this.filters)e.prepare(t)}getUniform(t){let e=this.uniforms[t];if(e)return e;for(let i of this.filters)if(e=i.uniforms[t],e)return e;return e}allUniforms(){const t=this.uniforms;for(let e of this.filters)Object.assign(t,e.uniforms);return t}updateUniforms(t){for(const[e,i]of Object.entries(this.allUniforms()))if(i.location||(i.location=t.getUniformLocation(this.program,e)),i.location&&i.needsUpdate){let e=i.value;switch(i.type){case"vec4":t.uniform4fv(i.location,e);break;case"vec3":t.uniform3fv(i.location,e);break;case"vec2":t.uniform2fv(i.location,e);break;case"float":t.uniform1f(i.location,e);break;case"int":case"bool":t.uniform1i(i.location,e);break;case"mat3":t.uniformMatrix3fv(i.location,!1,e);break;case"mat4":t.uniformMatrix4fv(i.location,!1,e);break;default:throw Error("Unknown uniform type: "+u.type)}i.needsUpdate=!1}}vertShaderSrc(t){let e=!(t instanceof WebGLRenderingContext);return`${e?"#version 300 es":""}\n\nprecision highp float; \nprecision highp int; \n\nuniform mat4 u_matrix;\n${e?"in":"attribute"} vec4 a_position;\n${e?"in":"attribute"} vec2 a_texcoord;\n\n${e?"out":"varying"} vec2 v_texcoord;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_matrix * a_position;\n\t\t\t\tv_texcoord = a_texcoord;\n\t\t\t} `}fragShaderSrc(t){let e=!(t instanceof WebGLRenderingContext);return`\n\nuniform sampler2D kd;\n\n${e?"in":"varying"} vec2 v_texcoord;\n\nvec4 data() {\n\treturn texture${e?"":"2D"}(kd, v_texcoord);\n}\n`}}class v extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(this.url)this.layout.setUrls([this.url]);else if(0==this.layout.urls.length)throw"Missing options.url parameter";const e=null!=this.format?this.format:"vec4";let i=new f({format:e});this.rasters.push(i);let s=new g({label:"Rgb",samplers:[{id:0,name:"kd",type:e}]});this.shaders={standard:s},this.setShader("standard")}}c.prototype.types.image=t=>new v(t);class y extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";this.textures=[],this.framebuffers=[],this.status="ready"}draw(t,e){for(let t of this.layers)if("ready"!=t.status)return;if(!this.shader)throw"Shader not specified!";let i=e.dx,s=e.dy;this.framebuffers.length&&this.layout.width==i&&this.layout.height==s||(this.deleteFramebuffers(),this.layout.width=i,this.layout.height=s,this.createFramebuffers());let r=this.gl;var n=[0,0,0,0];r.clearColor(n[0],n[1],n[2],n[3]);for(let e=0;e<this.layers.length;e++)r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffers[e]),r.clear(r.COLOR_BUFFER_BIT),this.layers[e].draw(t,{x:0,y:0,dx:i,dy:s,w:i,h:s}),r.bindFramebuffer(r.FRAMEBUFFER,null);this.prepareWebGL();for(let t=0;t<this.layers.length;t++)r.uniform1i(this.shader.samplers[t].location,t),r.activeTexture(r.TEXTURE0+t),r.bindTexture(r.TEXTURE_2D,this.textures[t]);this.updateTileBuffers(new Float32Array([-1,-1,0,-1,1,0,1,1,0,1,-1,0]),new Float32Array([0,0,0,1,1,1,1,0])),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}createFramebuffers(){let t=this.gl;for(let e=0;e<this.layers.length;e++){const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);const s=0,r=t.RGBA,n=0,a=t.RGBA,o=t.UNSIGNED_BYTE;t.texImage2D(t.TEXTURE_2D,s,r,this.layout.width,this.layout.height,n,a,o,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const l=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,l),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.bindFramebuffer(t.FRAMEBUFFER,null),this.textures[e]=i,this.framebuffers[e]=l}}deleteFramebuffers(){}boundingBox(){let t=c.computeLayersBBox(this.layers,!1);return null!=this.transform&&null!=this.transform&&(t=this.transform.transformBox(t)),t}scale(){let t=c.computeLayersMinScale(this.layers,!1);return t*=this.transform.z,t}}c.prototype.types.combiner=t=>new y(t);class x{constructor(t){Object.assign(this,{id:x.UUID(),code:null,label:null,description:null,class:null,target:null,svg:null,image:null,region:null,data:{},style:null,bbox:null,visible:!0,state:null,ready:!1,needsUpdate:!0,editing:!1},t),this.label||(this.label=""),this.elements=[]}static UUID(){return"axxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}getBBoxFromElements(){let t=null;if(this.elements.length){let{x:e,y:s,width:r,height:n}=this.elements[0].getBBox();for(let t of this.elements){const{sx:i,sy:a,swidth:o,sheight:l}=t.getBBox();e=Math.min(e,i),s=Math.min(e,a),r=Math.max(r+e,i+o)-e,n=Math.max(n+s,a+l)-s}t=new i({xLow:e,yLow:s,xHigh:e+r,yHigh:s+r})}else if(null==this.region)t=new i;else{const e=this.region;t=new i({xLow:e.x,yLow:e.y,xHigh:e.x+e.w,yHigh:e.y+e.h})}return t}static fromJsonLd(t){if("Annotation"!=t.type)throw"Not a jsonld annotation.";let e={id:t.id},i={identifying:"code",identifying:"label",describing:"description",classifying:"class"};for(let s of t.body){let t=i[s.purpose];t&&(e[t]=s.value)}let s=t.target&&t.target.selector;if(s){if("SvgSelector"!==s.type)throw"Unsupported selector: "+s.type;e.svg=s.value,e.elements=[]}return new x(e)}toJsonLd(){let t=[];(null!==this.code&&t.push({type:"TextualBody",value:this.code,purpose:"indentifying"}),null!==this.class&&t.push({type:"TextualBody",value:this.class,purpose:"classifying"}),null!==this.description&&t.push({type:"TextualBody",value:this.description,purpose:"describing"}),this.id,this.target&&(target.selector.source=this.target),this.element)&&(new XMLSerializer).serializeToString(this.element)}}class w extends c{constructor(t){super(t=Object.assign({style:null,annotations:[],selected:new Set,overlay:!0,annotationsListEntry:null},t)),"string"==typeof this.annotations&&(async()=>{await this.loadAnnotations(this.annotations)})()}async loadAnnotations(t){const e=new Headers;e.append("pragma","no-cache"),e.append("cache-control","no-cache");var i=await fetch(t,{method:"GET",headers:e});if(i.ok)if(this.annotations=await i.json(),"error"!=this.annotations.status){this.annotations=this.annotations.map((t=>new x(t)));for(let t of this.annotations)1!=t.publish&&(t.visible=!1);this.annotationsListEntry&&this.createAnnotationsList(),this.emit("update"),this.status="ready",this.emit("ready"),this.emit("loaded")}else alert("Failed to load annotations: "+this.annotations.msg);else this.status="Failed loading "+this.url+": "+i.statusText}newAnnotation(t){t||(t=new x),this.annotations.push(t);let e=this.createAnnotationEntry(t),i=document.createElement("template");return i.innerHTML=e.trim(),this.annotationsListEntry.element.parentElement.querySelector(".openlime-list").appendChild(i.content.firstChild),this.clearSelected(),t}annotationsEntry(){return this.annotationsListEntry={html:"",list:[],classes:"openlime-annotations",status:()=>"active",oncreate:()=>{Array.isArray(this.annotations)&&this.createAnnotationsList()}}}createAnnotationsList(){let t="";for(let e of this.annotations)t+=this.createAnnotationEntry(e);let e=this.annotationsListEntry.element.parentElement.querySelector(".openlime-list");e.innerHTML=t,e.addEventListener("click",(t=>{let e=t.srcElement.closest("svg");if(e){let t=e.closest("[data-annotation]");t.classList.toggle("hidden");let i=t.getAttribute("data-annotation"),s=this.getAnnotationById(i);s.visible=!s.visible,s.needsUpdate=!0,this.emit("update")}let i=t.srcElement.getAttribute("data-annotation");if(i){this.clearSelected();let t=this.getAnnotationById(i);this.setSelected(t,!0)}}))}createAnnotationEntry(t){return`<a href="#" data-annotation="${t.id}" class="openlime-entry ${0==t.visible?"hidden":""}">${t.label||""}\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="openlime-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="openlime-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>\n\t\t\t</a>`}getAnnotationById(t){for(const e of this.annotations)if(e.id==t)return e;return null}clearSelected(){this.annotationsListEntry.element.parentElement.querySelectorAll("[data-annotation]").forEach((t=>t.classList.remove("selected"))),this.selected.clear()}setSelected(t,e=!0){this.annotationsListEntry.element.parentElement.querySelector(`[data-annotation="${t.id}"]`).classList.toggle("selected",e),e?this.selected.add(t.id):this.selected.delete(t.id),this.emit("selected",t)}}r(w,"selected","loaded");class b extends l{constructor(t,e,s){super(t,null,s),this.setDefaults(e),this.init(t,e,s),this.tileDescriptors=[],this.box=new i,null!=t&&this.loadDescriptors(t)}getTileSize(){return[0,0]}async loadDescriptors(t){let e=await fetch(t);if(e.ok)if(this.tileDescriptors=await e.json(),"error"!=this.tileDescriptors.status){this.tileDescriptors=this.tileDescriptors.map((t=>new x(t)));for(let t of this.tileDescriptors)1!=t.publish&&(t.visible=!1);this.computeBoundingBox(),this.emit("updateSize"),null==this.path&&this.setPathFromUrl(t),this.status="ready",this.emit("ready")}else alert("Failed to load annotations: "+this.tileDescriptors.msg);else this.status="Failed loading "+t+": "+e.statusText}computeBoundingBox(){this.box=new i;for(let t of this.tileDescriptors){let e=t.region,s=new i({xLow:e.x,yLow:e.y,xHigh:e.x+e.w,yHigh:e.y+e.h});this.box.mergeBox(s)}}boundingBox(){return this.box}setPathFromUrl(t){const e=t.split("/"),i=e.length;this.path="";for(let t=0;t<i-1;++t)this.path+=e[t]+"/";this.getTileURL=(t,e)=>this.path+"/"+this.tileDescriptors[e.index].image}setTileDescriptors(t){this.tileDescriptors=t,this.status="ready",this.emit("ready")}getTileURL(t,e){return this.path+"/"+this.tileDescriptors[t].image}setTileVisible(t,e){this.tileDescriptors[t].visible=e}setAllTilesVisible(t){const e=this.tileCount();for(let i=0;i<e;++i)this.tileDescriptors[i].visible=t}index(t,e,i){return e}tileCoords(t){const e=this.tileDescriptors[t.index].region,i=e.x,s=e.y,r=i+e.w,n=s+e.h;return{coords:new Float32Array([i,s,0,i,n,0,r,n,0,r,s,0]),tcoords:new Float32Array([0,1,0,0,1,0,1,1])}}needed(t,e,i,s,r,n,a=8){const o=this.getViewportBox(t,e,i);let l=[],h=performance.now();const c=this.tileCount();for(let t=0;t<c;t++){let e=this.index(0,t,0),i=n.get(e)||this.newTile(e);this.intersects(o,e,true)&&(i.time=h,i.priority=this.tileDescriptors[e].visible?10:1,null===i.missing&&l.push(i))}let d=o.center();return l.sort((function(t,e){return Math.abs(t.x-d[0])+Math.abs(t.y-d[1])-Math.abs(e.x-d[0])-Math.abs(e.y-d[1])})),l}available(t,e,i,s,r,n){const a=this.getViewportBox(t,e,i);let o=[];const l=this.tileCount();for(let t=0;t<l;t++){let e=this.index(0,t,0);if(this.tileDescriptors[e].visible&&this.intersects(a,e,true)&&n.has(e)){let t=n.get(e);0==t.missing&&(o[e]=t)}}return o}newTile(t){let e=new a;e.index=t;let i=this.tileDescriptors[t];return e.image=i.image,Object.assign(e,i.region),e}intersects(t,e,i=!0){const s=this.tileDescriptors[e].region,r=s.x,n=s.y,a=r+s.w,o=n+s.h,l=i?-t.yHigh:t.yLow,h=i?-t.yLow:t.yHigh;return r<t.xHigh&&n<h&&a>t.xLow&&o>l}tileCount(){return this.tileDescriptors.length}}l.prototype.types.tile_images=(t,e,i)=>new b(t,e,i);class E extends w{constructor(t){const e=t.url;null==t.path&&console.log("WARNING MISSING ANNOTATION PATH, SET TO ./annot/"),super(t);const i=null!=this.format?this.format:"vec4";this.addEvent("loaded",(()=>{t.path?this.layout.path=t.path:null!=e&&this.layout.setPathFromUrl(path);for(let t of this.annotations){let t=new f({format:i});this.rasters.push(t)}console.log("Set "+this.annotations.length+" annotations into layout"),this.setupShader(i),this.layout.setTileDescriptors(this.annotations)}))}length(){return this.annotations.length}setTileVisible(t,e){this.layout.setTileVisible(t,e)}setAllTilesVisible(t){this.layout.setAllTilesVisible(t)}drawTile(t,e){if(0!=t.missing)throw"Attempt to draw tile still missing textures";const i=t.index;let s=this.gl,r=this.shader.samplers[i].id;s.uniform1i(this.shader.samplers[i].location,i),s.activeTexture(s.TEXTURE0+i),s.bindTexture(s.TEXTURE_2D,t.tex[r]);const n=this.getTileByteOffset(e);s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,n)}setupShader(t){let e=[],i=this.rasters.length;for(let s=0;s<i;++s)e.push({id:s,name:"kd",type:t});let s=new g({label:"Rgb",samplers:e});s.fragShaderSrc=function(t){let e=!(t instanceof WebGLRenderingContext);return`\n\nuniform sampler2D kd;\n\n${e?"in":"varying"} vec2 v_texcoord;\n\nvec4 data() {\n\treturn texture${e?"":"2D"}(kd, v_texcoord);\n}\n`},this.shaders={standard:s},this.setShader("standard")}}c.prototype.types.annotation_image=t=>new E(t);class T extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(this.url)this.layout.setUrls([this.url]);else if(0==this.layout.urls.length)throw"Missing options.url parameter";const e=null!=this.format?this.format:"vec4";let i=new f({format:e});this.rasters.push(i);let s=new g({label:"Rgb",samplers:[{id:0,name:"kd",type:e}]});s.fragShaderSrc=function(t){return`\n\t\t\n\t\tuniform sampler2D kd;\n\n\t\t${!(t instanceof WebGLRenderingContext)?"in":"varying"} vec2 v_texcoord;\n\n\t\tvec2 bilinear_masked_scalar(sampler2D field, vec2 uv) {\n\t\t\tvec2 px = uv*tileSize;\n\t\t\tivec2 iuv = ivec2(floor( px ));\n\t\t\tvec2 fuv = fract(px);\n\t\t\tint i0 = iuv.x;\n\t\t\tint j0 = iuv.y;\n\t\t\tint i1 = i0+1>=int(tileSize.x) ? i0 : i0+1;\n\t\t\tint j1 = j0+1>=int(tileSize.y) ? j0 : j0+1;\n\t\t  \n\t\t\tfloat f00 = texelFetch(field, ivec2(i0, j0), 0).r;\n\t\t\tfloat f10 = texelFetch(field, ivec2(i1, j0), 0).r;\n\t\t\tfloat f01 = texelFetch(field, ivec2(i0, j1), 0).r;\n\t\t\tfloat f11 = texelFetch(field, ivec2(i1, j1), 0).r;\n\n\t\t\t// FIXME Compute weights of valid\n\t\t  \n\t\t\tvec2 result_masked_scalar;\n\t\t\tresult_masked_scalar.y = f00*f01*f10*f11;\n\t\t\tresult_masked_scalar.y = result_masked_scalar.y > 0.0 ? 1.0 : 0.0;\n\n\t\t\tconst float scale = 255.0/254.0;\n\t\t\tconst float bias  = -1.0/254.0;\n\t\t\tresult_masked_scalar.x = mix(mix(f00, f10, fuv.x), mix(f01, f11, fuv.x), fuv.y);\n\t\t\tresult_masked_scalar.x = result_masked_scalar.y * (scale * result_masked_scalar.x + bias);\t\t  \n\t\t\treturn result_masked_scalar;\n\t\t  }\n\t\t  \n\t\t  vec4 data() { \n\t\t\tvec2  masked_scalar = bilinear_masked_scalar(kd, v_texcoord);\n\t\t\treturn masked_scalar.y > 0.0 ?  vec4(masked_scalar.x, masked_scalar.x, masked_scalar.x, masked_scalar.y) :  vec4(1.0, 0.0, 0.0, masked_scalar.y);\n\t\t  }\n\t\t`},this.shaders={scalarimage:s},this.setShader("scalarimage"),this.rasters[0].loadTexture=this.loadTexture.bind(this)}draw(t,e){return super.draw(t,e)}loadTexture(t,e){this.rasters[0].width=e.width,this.rasters[0].height=e.height;var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,t.LUMINANCE,t.UNSIGNED_BYTE,e),i}}c.prototype.types.maskedimage=t=>new T(t);class _ extends l{constructor(t,e,i){super(t,null,i),this.setDefaults(e),this.init(t,e,i)}setDefaults(t){super.setDefaults(t),Object.assign(this,{tilesize:256,overlap:0,nlevels:1,qbox:[],bbox:[],urls:[],cachelevels:10})}setUrls(t){this.urls=t,(async()=>{switch(this.type){case"google":await this.initGoogle();break;case"deepzoom1px":await this.initDeepzoom(!0);break;case"deepzoom":await this.initDeepzoom(!1);break;case"zoomify":await this.initZoomify();break;case"iiif":await this.initIIIF();break;case"iip":await this.initIIP();break;case"tarzoom":await this.initTarzoom();break;case"itarzoom":await this.initITarzoom()}this.initBoxes(),this.status="ready",this.emit("ready")})().catch((t=>{console.log(t),this.status=t}))}imageUrl(t,e){let i=t.substring(0,t.lastIndexOf("/")+1);switch(this.type){case"image":return i+e+".jpg";case"google":return i+e;case"deepzoom":return i+e+".dzi";case"tarzoom":return i+e+".tzi";case"itarzoom":return i+"planes.tzi";case"zoomify":return i+e+"/ImageProperties.xml";case"iip":return t+"&SDS="+e.substring(e.lastIndexOf("_")+1,e.length);case"iiif":throw Error("Unimplemented");default:throw Error("Unknown layout: "+this.type)}}getTileSize(){return[this.tilesize,this.tilesize]}index(t,e,i){let s=0;for(let e=0;e<t;e++)s+=this.qbox[e].xHigh*this.qbox[e].yHigh;return s+i*this.qbox[t].xHigh+e}reverseIndex(t){let e=t,i=0;for(let e=0;e<this.qbox.length;e++){let s=this.qbox[e].xHigh*this.qbox[e].yHigh;if(t-s<0)break;t-=s,i++}let s=this.qbox[i].xHigh,r=Math.floor(t/s),n=t%s;return console.assert(this.index(i,n,r)==e),{level:i,x:n,y:r}}initBoxes(){this.qbox=[],this.bbox=[];var t=this.width,e=this.height;if("image"==this.type)return this.qbox[0]=new i({xLow:0,yLow:0,xHigh:1,yHigh:1}),this.bbox[0]=new i({xLow:0,yLow:0,xHigh:t,yHigh:e}),this.emit("updateSize"),1;for(let s=this.nlevels-1;s>=0;s--)this.qbox[s]=new i({xLow:0,yLow:0,xHigh:0,yHigh:0}),this.bbox[s]=new i({xLow:0,yLow:0,xHigh:t,yHigh:e}),this.qbox[s].yHigh=Math.ceil(e/this.tilesize),this.qbox[s].xHigh=Math.ceil(t/this.tilesize),t>>>=1,e>>>=1;this.emit("updateSize")}tileCoords(t){let{level:e,x:i,y:s}=t;this.width,this.height;var r=new Float32Array([0,1,0,0,1,0,1,1]);let n=new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),a=this.nlevels-1-e,o=this.tilesize*(1<<a),l=o,h=o;o*(i+1)>this.width&&(l=this.width-o*i,"google"==this.type&&(r[4]=r[6]=l/o)),o*(s+1)>this.height&&(h=this.height-o*s,"google"==this.type&&(r[1]=r[7]=h/o));var c=this.qbox[e].xHigh-1,d=this.qbox[e].yHigh-1,u=this.overlap;if(u){let t=u/(l/(1<<a)+(0==i?0:u)+(i==c?0:u)),e=u/(h/(1<<a)+(0==s?0:u)+(s==d?0:u));r[0]=r[2]=0==i?0:t,r[3]=r[5]=0==s?0:e,r[4]=r[6]=i==c?1:1-t,r[1]=r[7]=s==d?1:1-e}let m=r[1];r[1]=r[7]=r[3],r[3]=r[5]=m;for(let t=0;t<n.length;t+=3)n[t]=n[t]*l+o*i-this.width/2,n[t+1]=-n[t+1]*h-o*s+this.height/2;return{coords:n,tcoords:r}}newTile(t){let e=super.newTile(t);return e.index=t,Object.assign(e,this.reverseIndex(t)),e}needed(t,e,i,s,r,n,a=8){let o=this.neededBox(t,e,i,0,r),l=[],h=performance.now();for(let t=0;t<=o.level;t++){let e=o.pyramid[t],i=[];for(let s=e.yLow;s<e.yHigh;s++)for(let r=e.xLow;r<e.xHigh;r++){let e=this.index(t,r,s),a=n.get(e)||this.newTile(e);a.time=h,a.priority=o.level-t,a.priority>this.cachelevels||null===a.missing&&i.push(a)}let s=e.center();i.sort((function(t,e){return Math.abs(t.x-s.x)+Math.abs(t.y-s.y)-Math.abs(e.x-s.x)-Math.abs(e.y-s.y)})),l=l.concat(i)}return l}available(t,e,i,s,r,n){let a=this.neededBox(t,e,i,0,r),o={},l={},h=a.level,c=a.pyramid[h];for(let t=c.yLow;t<c.yHigh;t++)for(let e=c.xLow;e<c.xHigh;e++){let i=h;for(;i>=0;){let s=h-i,r=this.index(i,e>>s,t>>s);if(n.has(r)&&0==n.get(r).missing){o[r]=n.get(r);break}{let r=e>>s+1<<1,n=t>>s+1<<1;l[this.index(i,r,n)]=1,l[this.index(i,r+1,n)]=1,l[this.index(i,r+1,n+1)]=1,l[this.index(i,r,n+1)]=1}i--}}for(let t in l)t in o&&(o[t].complete=!1);return o}neededBox(t,e,s,r,n){if("image"==this.type)return{level:0,pyramid:[new i({xLow:0,yLow:0,xHigh:1,yHigh:1})]};let a=Math.max(0,Math.min(Math.floor(-Math.log2(e.z)+n),this.nlevels-1)),o=this.nlevels-1-a;const l=this.getViewportBox(t,e,s);let h=[];for(let t=0;t<=o;t++){let e=this.nlevels-1-t,s=this.tilesize*Math.pow(2,e),n=new i(l);n.quantize(s),n.xLow=Math.max(n.xLow-r,this.qbox[t].xLow),n.yLow=Math.max(n.yLow-r,this.qbox[t].yLow),n.xHigh=Math.min(n.xHigh+r,this.qbox[t].xHigh),n.yHigh=Math.min(n.yHigh+r,this.qbox[t].yHigh),h[t]=n}return{level:o,pyramid:h}}getTileURL(t,e){throw Error("Layout not defined or ready.")}async initImage(){this.getTileURL=(t,e)=>this.urls[t],this.nlevels=1,this.tilesize=0}async initGoogle(){if(!this.width||!this.height)throw"Google rasters require to specify width and height";this.tilesize=256,this.overlap=0;let t=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(t)/Math.LN2)+1,this.urls[0].includes("{")?this.getTileURL=(t,e)=>{let i={s:this.subdomains?this.subdomains[Math.abs(e.x+e.y)%this.subdomains.length]:"",...e,z:e.level};return this.urls[t].replace(/{(.+?)}/g,((t,e)=>i[e]))}:this.getTileURL=(t,e)=>this.urls[t]+"/"+e.level+"/"+e.y+"/"+e.x+"."+this.suffix}async initDeepzoom(t){let e=this.urls.filter((t=>t))[0];var i=await fetch(e);if(!i.ok)throw this.status="Failed loading "+e+": "+i.statusText,new Error(this.status);let s=await i.text(),r=(new window.DOMParser).parseFromString(s,"text/xml").documentElement;this.suffix=r.getAttribute("Format"),this.tilesize=parseInt(r.getAttribute("TileSize")),this.overlap=parseInt(r.getAttribute("Overlap"));let n=r.querySelector("Size");this.width=parseInt(n.getAttribute("Width")),this.height=parseInt(n.getAttribute("Height"));let a=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(a)/Math.LN2)+1,this.urls=this.urls.map((t=>t?t.substr(0,t.lastIndexOf("."))+"_files/":null)),this.skiplevels=0,t&&(this.skiplevels=Math.ceil(Math.log(this.tilesize)/Math.LN2)),this.getTileURL=(t,e)=>this.urls[t]+(e.level+this.skiplevels)+"/"+e.x+"_"+e.y+"."+this.suffix}async initTarzoom(){this.tarzoom=[];for(let e of this.urls){var t=await fetch(e);if(!t.ok)throw this.status="Failed loading "+e+": "+t.statusText,new Error(this.status);let i=await t.json();i.url=e.substr(0,e.lastIndexOf("."))+".tzb",Object.assign(this,i),this.tarzoom.push(i)}this.getTileURL=(t,e)=>{const i=this.tarzoom[t];return e.start=i.offsets[e.index],e.end=i.offsets[e.index+1],i.url}}async initITarzoom(){const t=this.urls[0];var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.json();Object.assign(this,i),this.url=t.substr(0,t.lastIndexOf("."))+".tzb",this.getTileURL=(t,e)=>{let i=e.index*this.stride;e.start=this.offsets[i],e.end=this.offsets[i+this.stride],e.offsets=[];for(let t=0;t<this.stride+1;t++)e.offsets.push(this.offsets[i+t]-e.start);return this.url}}async initZoomify(){const t=this.urls[0];this.overlap=0;var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.text(),s=(new window.DOMParser).parseFromString(i,"text/xml").documentElement;if(this.tilesize=parseInt(s.getAttribute("TILESIZE")),this.width=parseInt(s.getAttribute("WIDTH")),this.height=parseInt(s.getAttribute("HEIGHT")),!this.tilesize||!this.height||!this.width)throw"Missing parameter files for zoomify!";let r=Math.max(this.width,this.height)/this.tilesize;this.nlevels=Math.ceil(Math.log(r)/Math.LN2)+1,this.getTileURL=(e,i)=>this.urls[e].substr(0,t.lastIndexOf("/"))+"/TileGroup"+(i.index>>8)+"/"+i.level+"-"+i.x+"-"+i.y+"."+this.suffix}async initIIIF(){const t=this.urls[0];this.overlap=0;var e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.json();this.width=i.width,this.height=i.height,this.nlevels=i.tiles[0].scaleFactors.length,this.tilesize=i.tiles[0].width,this.getTileURL=(e,i)=>{const s=this.urls[e].substr(0,t.lastIndexOf("/"));let r=this.tilesize;parseInt(this.nlevels-1-i.level);let n=Math.pow(2,i.level),a=i.x*r*n,o=i.y*r*n,l=Math.min(r*n,this.width-a),h=Math.min(r*n,this.height-o),c=r;a+r*n>this.width&&(c=(this.width-a+n-1)/n);let d=r;return o+r*n>this.height&&(d=(this.height-o+n-1)/n),`${s}/${a},${o},${l},${h}/${c},${d}/0/default.jpg`}}async initIIP(){const t=(this.server?this.server+"?FIF=":"")+this.urls[0]+"&obj=Max-size&obj=Tile-size&obj=Resolution-number";let e=await fetch(t);if(!e.ok)throw this.status="Failed loading "+t+": "+e.statusText,new Error(this.status);let i=await e.text(),s=i.split("Tile-size:");return s[1]?(this.tilesize=parseInt(s[1].split(" ")[0]),s=i.split("Max-size:"),s[1]?(s=s[1].split("\n")[0].split(" "),this.width=parseInt(s[0]),this.height=parseInt(s[1]),this.nlevels=parseInt(i.split("Resolution-number:")[1]),void(this.getTileURL=(t,e)=>{let i=e.y*this.qbox[e.level].xHigh+e.x,s="JTL";return"webp"==this.suffix?s="WTL":"png"==this.suffix&&(s="PTL"),(this.server?this.server+"?FIF=":"")+this.urls[t]+"&"+s+"="+e.level+","+i})):null):null}}const S=(t,e,i)=>new _(t,e,i);for(let t of["google","deepzoom1px","deepzoom","zoomify","iiif","iip","tarzoom","itarzoom"])l.prototype.types[t]=S;class L{constructor(t){t=Object.assign({},t),Object.assign(this,t),this.name=this.constructor.name,this.uniforms={},this.samplers=[],this.needsUpdate=!0,this.shader=null,this.modes={}}setMode(t,e){if(!this.shader)throw Error("Shader not registered");if(Object.keys(this.modes).length>0){const i=this.modes[t];if(!i)throw Error(`Mode "${t}" not exist!`);i.map((t=>{t.enable=t.id==e})),this.shader.needsUpdate=!0}}prepare(t){this.needsUpdate&&this.createTextures&&this.createTextures(t),this.needsUpdate=!1}fragModeSrc(){let t="";for(const e of Object.keys(this.modes))for(const i of this.modes[e])i.enable&&(t+=i.src+"\n");return t}setUniform(t,e){if(!this.shader)throw Error("Shader not registered");this.shader.setUniform(this.uniformName(t),e)}fragSamplerSrc(){let t="";for(let e of this.samplers)t+=`\n            uniform sampler2D ${e.name};`;return t}fragUniformSrc(){let t="";for(const[e,i]of Object.entries(this.uniforms))t+=`\n            uniform ${this.uniforms[e].type} ${e};`;return t}fragDataSrc(t){return null}functionName(){return this.name+"_data"}samplerName(t){return`${this.name}_${t}`}uniformName(t){return`u_${this.name}_${t}`}modeName(t){return`m_${this.name}_${t}`}getSampler(t){const e=this.samplerName(t);return this.samplers.find((t=>t.name==e))}}class R{constructor(t){Object.assign(this,{active:!0,debug:!1,panDelay:50,zoomDelay:200,priority:0,activeModifiers:[0]}),Object.assign(this,t)}modifierState(t){let e=0;return t.ctrlKey&&(e+=1),t.shiftKey&&(e+=2),t.altKey&&(e+=4),e}captureEvents(){this.capture=!0}releaseEvents(){this.capture=!1}panStart(t){}panMove(t){}panEnd(t){}pinchStart(t,e){}pinchMove(t,e){}pinchEnd(t,e){}mouseWheel(t){}fingerSingleTap(t){}fingerDoubleTap(t){}}function M(t,e,i){return Math.max(e,Math.min(i,t))}class C extends R{constructor(t,e){super(e),Object.assign(this,{relative:!1,speed:2,start_x:0,start_y:0,current_x:0,current_y:0,onPanStart:null,onPanEnd:null},e),this.callback=t,this.box||(this.box=new i({xLow:-.99,yLow:-.99,xHigh:.99,yHigh:.99})),this.panning=!1}setPosition(t,e){this.current_x=t,this.current_y=e,this.callback(t,e)}project(t){let e=t.target.getBoundingClientRect();return[2*t.offsetX/e.width-1,2*(1-t.offsetY/e.height)-1]}rangeCoords(t){let[e,i]=this.project(t);return this.relative&&(e=M(this.speed*(e-this.start_x)+this.current_x,-1,1),i=M(this.speed*(i-this.start_y)+this.current_y,-1,1)),[e,i]}panStart(t){if(this.active&&this.activeModifiers.includes(this.modifierState(t))){if(this.relative){let[e,i]=this.project(t);this.start_x=e,this.start_y=i}this.onPanStart&&this.onPanStart(...this.rangeCoords(t)),this.callback(...this.rangeCoords(t)),this.panning=!0,t.preventDefault()}}panMove(t){if(!this.panning)return!1;this.callback(...this.rangeCoords(t))}panEnd(t){if(!this.panning)return!1;if(this.panning=!1,this.relative){let[e,i]=this.project(t);this.current_x=M(this.speed*(e-this.start_x)+this.current_x,-1,1),this.current_y=M(this.speed*(i-this.start_y)+this.current_y,-1,1)}this.onPanEnd&&this.onPanEnd(...this.rangeCoords(t))}fingerSingleTap(t){this.active&&this.activeModifiers.includes(this.modifierState(t))&&(this.relative||(this.callback(...this.rangeCoords(t)),t.preventDefault()))}}class A extends R{constructor(t,e){super(e),this.camera=t,this.zoomAmount=1.2,this.controlZoom=!1,this.panning=!1,this.initialTransform=null,this.startMouse=null,this.zooming=!1,this.initialDistance=0,this.useGLcoords=!1,e&&Object.assign(this,e)}panStart(t){if(!this.active||this.panning||!this.activeModifiers.includes(this.modifierState(t)))return;this.panning=!0,this.startMouse=o.fromCanvasHtmlToViewport({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords);let e=performance.now();this.initialTransform=this.camera.getCurrentTransform(e),this.camera.target=this.initialTransform.copy(),t.preventDefault()}panMove(t){if(!this.panning)return;let e=this.initialTransform;const i=o.fromCanvasHtmlToViewport({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords);let s=i.x-this.startMouse.x,r=i.y-this.startMouse.y;this.camera.setPosition(this.panDelay,e.x+s,e.y+r,e.z,e.a)}panEnd(t){this.panning=!1}distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}pinchStart(t,e){this.zooming=!0,this.initialDistance=Math.max(30,this.distance(t,e)),t.preventDefault()}pinchMove(t,e){if(!this.zooming)return;let i=t.target.getBoundingClientRect(),s=t.clientX-i.left,r=t.clientY-i.top,n=e.target.getBoundingClientRect(),a=e.clientX-n.left,l=e.clientY-n.top;const h=this.distance(t,e),c=o.fromCanvasHtmlToScene({x:(s+a)/2,y:(r+l)/2},this.camera,this.useGLcoords),d=h/this.initialDistance;this.camera.deltaZoom(this.zoomDelay,d,c.x,c.y),this.initialDistance=h,t.preventDefault()}pinchEnd(t,e,i,s){this.zooming=!1,t.preventDefault()}mouseWheel(t){if(this.controlZoom&&!t.ctrlKey)return void this.emit("nowheel");let e=-t.deltaY/53;const i=o.fromCanvasHtmlToScene({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords),s=Math.pow(this.zoomAmount,e);this.camera.deltaZoom(this.zoomDelay,s,i.x,i.y),t.preventDefault()}fingerDoubleTap(t){}fingerDoubleTap(t){if(!this.active||!this.activeModifiers.includes(this.modifierState(t)))return;const e=o.fromCanvasHtmlToScene({x:t.offsetX,y:t.offsetY},this.camera,this.useGLcoords),i=this.zoomAmount;this.camera.deltaZoom(this.zoomDelay,i,e.x,e.y)}}r(A,"nowheel");class z{constructor(t,e){this.target=t,Object.assign(this,{pinchMaxInterval:250,idleTime:60}),e&&Object.assign(this,e),this.idleTimeout=null,this.idling=!1,this.currentPointers=[],this.eventObservers=new Map,this.ppmm=z.getPixelsPerMM(),this.target.style.touchAction="none",this.target.addEventListener("pointerdown",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointermove",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointerup",(t=>this.handleEvent(t)),!1),this.target.addEventListener("pointercancel",(t=>this.handleEvent(t)),!1),this.target.addEventListener("wheel",(t=>this.handleEvent(t)),!1),this.startIdle()}static get ANYPOINTER(){return-1}static splitStr(t){return t.trim().split(/\s+/g)}static getPixelsPerMM(){const t=window.devicePixelRatio||1,e=document.createElement("div");e.style.width="1in",e.style.height="1in",e.style.position="absolute",e.style.left="-100%",e.style.top="-100%",document.body.appendChild(e);const i=e.offsetWidth*t;document.body.removeChild(e);return i/25.4}on(t,e,i=z.ANYPOINTER){return t=z.splitStr(t),"function"==typeof e&&((e=Object.fromEntries(t.map((t=>[t,e])))).priority=-1e3),t.forEach((t=>{if(i==z.ANYPOINTER)this.broadcastOn(t,e);else{const s=this.currentPointers[i];if(!s)throw new Error("Bad Index");s.on(t,e)}})),e}off(t,e,i=z.ANYPOINTER){i==z.ANYPOINTER?this.broadcastOff(t,e):z.splitStr(t).forEach((t=>{const s=this.currentPointers[i];if(!s)throw new Error("Bad Index");s.off(t,e)}))}onEvent(t){const e=["fingerHover","fingerSingleTap","fingerDoubleTap","fingerHold","mouseWheel","wentIdle","activeAgain"];if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!e.some((e=>"function"==typeof t[e])))throw new Error("Event handler properties are wrong or missing");for(let i of e)"function"==typeof t[i]&&this.on(i,t);t.panStart&&this.onPan(t),t.pinchStart&&this.onPinch(t)}onPan(t){if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!["panStart","panMove","panEnd"].every((e=>"function"==typeof t[e])))throw new Error("Pan handler is missing one of this functions: panStart, panMove or panEnd");t.fingerMovingStart=e=>{t.panStart(e),e.defaultPrevented&&(this.on("fingerMoving",(e=>{t.panMove(e)}),e.idx),this.on("fingerMovingEnd",(e=>{t.panEnd(e)}),e.idx))},this.on("fingerMovingStart",t)}onPinch(t){if(!t.hasOwnProperty("priority"))throw new Error("Event handler has not priority property");if(!["pinchStart","pinchMove","pinchEnd"].every((e=>"function"==typeof t[e])))throw new Error("Pinch handler is missing one of this functions: pinchStart, pinchMove or pinchEnd");t.fingerDown=e=>{const i=this.currentPointers.filter((t=>t&&t.idx!=e.idx&&t.status==t.stateEnum.DETECT));if(0==i.length)return;const s=[];for(let t of i){let e=null;for(let i of t.eventHistory.toArray())"fingerDown"==i.fingerType&&(e=i);e&&s.push(e)}s.sort(((t,e)=>e.timeStamp-t.timeStamp));for(let i of s){if(e.timeStamp-i.timeStamp>this.pinchMaxInterval)break;if(t.pinchStart(e,i),!e.defaultPrevented)break;clearTimeout(this.currentPointers[e.idx].timeout),clearTimeout(this.currentPointers[i.idx].timeout),this.on("fingerMovingStart",(t=>t.preventDefault()),e.idx),this.on("fingerMovingStart",(t=>t.preventDefault()),i.idx),this.on("fingerMoving",(s=>i&&t.pinchMove(e=s,i)),e.idx),this.on("fingerMoving",(s=>e&&t.pinchMove(e,i=s)),i.idx),this.on("fingerMovingEnd",(s=>{i&&t.pinchEnd(s,i),e=i=null}),e.idx),this.on("fingerMovingEnd",(s=>{e&&t.pinchEnd(e,s),e=i=null}),i.idx);break}},this.on("fingerDown",t)}broadcastOn(t,e){this.eventObservers.has(t)||this.eventObservers.set(t,new Set),this.eventObservers.get(t).add(e)}broadcastOff(t,e){z.splitStr(t).forEach((t=>{if(this.eventObservers.has(t))if(e){const i=this.eventObservers.get(t);i.delete(e),0===i.size&&this.eventObservers.delete(t)}else this.eventObservers.delete(t)}))}broadcast(t){if(!this.eventObservers.has(t.fingerType))return;const e=Array.from(this.eventObservers.get(t.fingerType));e.sort(((t,e)=>e.priority-t.priority));for(const i of e)if(i[t.fingerType](t),t.defaultPrevented)break}addCurrPointer(t){let e=-1;for(let t=0;t<this.currentPointers.length&&e<0;t++)null==this.currentPointers[t]&&(e=t);return e<0?(this.currentPointers.push(t),e=this.currentPointers.length-1):this.currentPointers[e]=t,e}removeCurrPointer(t){for(this.currentPointers[t]=null;this.currentPointers.length>0&&null==this.currentPointers[this.currentPointers.length-1];)this.currentPointers.pop()}startIdle(){this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=setTimeout((()=>{this.broadcast({fingerType:"wentIdle"}),this.idling=!0}),1e3*this.idleTime)}handleEvent(t){this.idling?(this.broadcast({fingerType:"activeAgain"}),this.idling=!1):this.startIdle(),"pointerdown"==t.type&&this.target.setPointerCapture(t.pointerId),"pointercancel"==t.type&&console.log(t);let e=!1;for(let i=0;i<this.currentPointers.length&&!e;i++){const s=this.currentPointers[i];s&&(e=s.handleEvent(t),s.isDone()&&this.removeCurrPointer(i))}if(!e){e=new D(this,t.pointerId,{ppmm:this.ppmm}).handleEvent(t)}}}class D{constructor(t,e,i){this.parent=t,this.pointerId=e,Object.assign(this,{ppmm:3}),i&&Object.assign(this,i),this.eventHistory=new U(10),this.isActive=!1,this.startTap=0,this.threshold=15,this.eventObservers=new Map,this.isDown=!1,this.done=!1,this.stateEnum={IDLE:0,DETECT:1,HOVER:2,MOVING_START:3,MOVING:4,MOVING_END:5,HOLD:6,TAPS_DETECT:7,SINGLE_TAP:8,DOUBLE_TAP_DETECT:9,DOUBLE_TAP:10},this.status=this.stateEnum.IDLE,this.timeout=null,this.holdTimeoutThreshold=600,this.tapTimeoutThreshold=100,this.oldDownPos={clientX:0,clientY:0},this.movingThreshold=1,this.idx=this.parent.addCurrPointer(this)}static distance(t,e,i,s){return Math.sqrt((i-t)**2+(s-e)**2)}distanceMM(t,e,i,s){return D.distance(t,e,i,s)/this.ppmm}on(t,e){this.eventObservers.set(t,e)}off(t){this.eventObservers.has(t)&&this.eventObservers.delete(t)}addToHistory(t){this.eventHistory.push(t)}prevPointerEvent(){return this.eventHistory.last()}handlePointerDown(t){this.startTap=t.timeStamp}handlePointerUp(t){t.timeStamp,this.startTap}isLikelySamePointer(t){let e=this.pointerId==t.pointerId;if(!e&&!this.isDown&&"pointerdown"==t.type){const i=this.prevPointerEvent();i&&(e=t.pointerType==i.pointerType&&this.distanceMM(t.clientX,t.clientY,i.clientX,i.clientY)<this.threshold)}return e}emit(t){this.eventObservers.has(t.fingerType)&&(this.eventObservers.get(t.fingerType)[t.fingerType](t),t.defaultPrevented)||this.parent.broadcast(t)}createOutputEvent(t,e){const i=t;i.fingerType=e,i.originSrc=this.originSrc,i.speedX=0,i.speedY=0,i.idx=this.idx;const s=this.prevPointerEvent();if(s&&"pointermove"==t.type){const t=i.timeStamp-s.timeStamp;t>0&&(i.speedX=(i.clientX-s.clientX)/t*1e3,i.speedY=(i.clientY-s.clientY)/t*1e3)}return i}processEvent(t){let e=0;if("pointerdown"==t.type&&(this.oldDownPos.clientX=t.clientX,this.oldDownPos.clientY=t.clientY,this.isDown=!0),"pointerup"!=t.type&&"pointercancel"!=t.type||(this.isDown=!1),"pointermove"==t.type&&this.isDown&&(e=this.distanceMM(t.clientX,t.clientY,this.oldDownPos.clientX,this.oldDownPos.clientY)),"wheel"!=t.type){switch(this.status){case this.stateEnum.HOVER:case this.stateEnum.IDLE:if("pointermove"==t.type)this.emit(this.createOutputEvent(t,"fingerHover")),this.status=this.stateEnum.HOVER,this.originSrc=t.composedPath()[0];else if("pointerdown"==t.type){if(this.status=this.stateEnum.DETECT,this.emit(this.createOutputEvent(t,"fingerDown")),t.defaultPrevented){this.status=this.stateEnum.MOVING;break}this.originSrc=t.composedPath()[0],this.timeout=setTimeout((()=>{this.emit(this.createOutputEvent(t,"fingerHold")),t.defaultPrevented&&(this.status=this.stateEnum.IDLE)}),this.holdTimeoutThreshold)}break;case this.stateEnum.DETECT:"pointercancel"==t.type?(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerHold"))):"pointermove"==t.type&&e>this.movingThreshold?(clearTimeout(this.timeout),this.status=this.stateEnum.MOVING,this.emit(this.createOutputEvent(t,"fingerMovingStart"))):"pointerup"==t.type&&(clearTimeout(this.timeout),this.status=this.stateEnum.TAPS_DETECT,this.timeout=setTimeout((()=>{this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerSingleTap"))}),this.tapTimeoutThreshold));break;case this.stateEnum.TAPS_DETECT:"pointerdown"==t.type?(clearTimeout(this.timeout),this.status=this.stateEnum.DOUBLE_TAP_DETECT,this.timeout=setTimeout((()=>{this.emit(this.createOutputEvent(t,"fingerHold")),t.defaultPrevented&&(this.status=this.stateEnum.IDLE)}),this.tapTimeoutThreshold)):"pointermove"==t.type&&e>this.movingThreshold&&(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerHover")));break;case this.stateEnum.DOUBLE_TAP_DETECT:"pointerup"!=t.type&&"pointercancel"!=t.type||(clearTimeout(this.timeout),this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerDoubleTap")));break;case this.stateEnum.DOUBLE_TAP_DETECT:"pointermove"==t.type&&e>this.movingThreshold&&(this.status=this.stateEnum.MOVING,this.emit(this.createOutputEvent(t,"fingerMovingStart")));break;case this.stateEnum.MOVING:"pointermove"==t.type?this.emit(this.createOutputEvent(t,"fingerMoving")):"pointerup"!=t.type&&"pointercancel"!=t.type||(this.status=this.stateEnum.IDLE,this.emit(this.createOutputEvent(t,"fingerMovingEnd")));break;default:console.log("ERROR "+this.status),console.log(t)}this.addToHistory(t)}else this.emit(this.createOutputEvent(t,"mouseWheel"))}handleEvent(t){let e=!1;return this.isLikelySamePointer(t)&&(this.pointerId=t.pointerId,this.processEvent(t),e=!0),e}isDone(){return this.status==this.stateEnum.IDLE}}class U{constructor(t){if("number"!=typeof t||!Number.isInteger(t)||t<1)throw new TypeError("Invalid capacity");this.buffer=new Array(t),this.capacity=t,this.first=0,this.size=0}clear(){this.first=0,this.size=0}empty(){return 0==this.size}size(){return this.size}capacity(){return this.capacity}first(){let t=null;return this.size>0&&(t=this.buffer[this.first]),t}last(){let t=null;return this.size>0&&(t=this.buffer[(this.first+this.size-1)%this.capacity]),t}enqueue(t){this.first=this.first>0?this.first-1:this.first=this.capacity-1,this.buffer[this.first]=t,this.size<this.capacity&&this.size++}push(t){this.size===this.capacity?(this.buffer[this.first]=t,this.first=(this.first+1)%this.capacity):(this.buffer[(this.first+this.size)%this.capacity]=t,this.size++)}dequeue(){if(0==this.size)throw new RangeError("Dequeue on empty buffer");const t=this.buffer[(this.first+this.size-1)%this.capacity];return this.size--,t}pop(){return this.dequeue()}shift(){if(0==this.size)throw new RangeError("Shift on empty buffer");const t=this.buffer[this.first];return this.first==this.capacity-1?this.first=0:this.first++,this.size--,t}get(t,e){if(0===this.size&&0===t&&(void 0===e||0===e))return[];if("number"!=typeof t||!Number.isInteger(t)||t<0)throw new TypeError("Invalid start value");if(t>=this.size)throw new RangeError("Start index past end of buffer: "+t);if(void 0===e)return this.buffer[(this.first+t)%this.capacity];if("number"!=typeof e||!Number.isInteger(e)||e<0)throw new TypeError("Invalid end value");if(e>=this.size)throw new RangeError("End index past end of buffer: "+e);const i=[];for(let s=t;s<=e;s++)i.push(this.buffer[(this.first+s)%this.capacity]);return i}toArray(){return 0==this.size?[]:this.get(0,this.size-1)}}class I{constructor(t,e){if(Object.assign(this,{background:null,autofit:!0,canvas:{},camera:new n,idleTime:60}),"string"==typeof t&&(t=document.querySelector(t)),!t)throw"Missing element parameter";Object.assign(this,e),this.background&&(t.style.background=this.background),this.containerElement=t,this.canvasElement=t.querySelector("canvas"),this.canvasElement||(this.canvasElement=document.createElement("canvas"),t.prepend(this.canvasElement)),this.overlayElement=document.createElement("div"),this.overlayElement.classList.add("openlime-overlay"),this.containerElement.appendChild(this.overlayElement),this.canvas=new d(this.canvasElement,this.overlayElement,this.camera,this.canvas),this.canvas.addEvent("update",(()=>{this.redraw()})),this.autofit&&this.canvas.addEvent("updateSize",(()=>this.camera.fitCameraBox(0))),this.pointerManager=new z(this.overlayElement,{idleTime:this.idleTime}),this.canvasElement.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),new ResizeObserver((t=>{for(let e of t)this.resize(e.contentRect.width,e.contentRect.height)})).observe(this.canvasElement),this.resize(this.canvasElement.clientWidth,this.canvasElement.clientHeight)}addController(t){this.pointerManager.onEvent(t)}addLayer(t,e){this.canvas.addLayer(t,e),this.redraw()}removeLayer(t){"string"==typeof t&&(t=this.canvas.layers[t]),t&&(this.canvas.removeLayer(t),this.redraw())}resize(t,e){if(0==t||0==e)return;this.canvasElement.width=t*window.devicePixelRatio,this.canvasElement.height=e*window.devicePixelRatio;let i={x:0,y:0,dx:t,dy:e,w:t,h:e};this.camera.setViewport(i),this.canvas.updateSize(),this.emit("resize",i),this.canvas.prefetch(),this.redraw()}redraw(){this.animaterequest||(this.animaterequest=requestAnimationFrame((t=>{this.draw(t)})),this.requestTime=performance.now())}draw(t){t||(t=performance.now()),this.animaterequest=null;let e=performance.now()-this.requestTime;this.canvas.addRenderTiming(e),this.camera.viewport,this.camera.getCurrentTransform(t),this.canvas.draw(t)||this.redraw(),this.emit("draw")}}r(I,"draw"),r(I,"resize");let O="skin/skin.svg",F=null;class ${static setUrl(t){O=t}static async loadSvg(){var t=await fetch(O);if(!t.ok)throw Error("Failed loading "+O+": "+t.statusText);let e=await t.text(),i=new DOMParser;F=i.parseFromString(e,"image/svg+xml").documentElement}static async getElement(t){return F||await $.loadSvg(),F.querySelector(t).cloneNode(!0)}static async appendIcon(t,e){let i=null,s=null;if("string"==typeof e){i=await $.getElement(e),(e=document.createElementNS("http://www.w3.org/2000/svg","svg")).appendChild(i),document.body.appendChild(e),s=i.getBBox();let t=i.transform.baseVal;0==t.numberOfItems&&t.appendItem(e.createSVGTransform()),t.getItem(0).setTranslate(-s.x,-s.y)}else document.body.appendChild(e),s=e.getBBox();return e.setAttribute("viewBox",`-5 -5 ${s.width+10} ${s.height+10}`),e.setAttribute("preserveAspectRatio","xMidYMid meet"),t.appendChild(e),e}}class P{constructor(t){this.units=["km","m","cm","mm","m"],this.allUnits={"m":.001,mm:1,cm:10,m:1e3,km:1e6,in:254,ft:3048},this.precision=2,t&&Object.assign(t,this)}format(t,e){if(0==t)return"";if(e)return(t/this.allUnits[e]).toFixed(this.precision)+e;let i=null,s=100;for(let e of this.units){let r=this.allUnits[e],n=t<=0?0:Math.abs(Math.log10(t/r)-1);n<s&&(i=e,s=n)}return this.format(t,i)}}class k extends P{constructor(t,i,s){super(s),s=Object.assign(this,{pixelSize:t,viewer:i,width:200,fontSize:24,precision:0},s),Object.assign(this,s),this.svg=e.createSVGElement("svg",{viewBox:`0 0 ${this.width} 30`}),this.svg.classList.add("openlime-scale"),this.line=e.createSVGElement("line",{x1:5,y1:26.5,x2:this.width-5,y2:26.5}),this.text=e.createSVGElement("text",{x:"50%",y:"16px","dominant-basiline":"middle","text-anchor":"middle"}),this.text.textContent="",this.svg.appendChild(this.line),this.svg.appendChild(this.text),this.viewer.containerElement.appendChild(this.svg),this.viewer.addEvent("draw",(()=>{this.updateScale()}))}updateScale(){let t=this.viewer.camera.target.z;if(t==this.lastScaleZoom)return;this.lastScaleZoom=t;let e=this.bestLength(this.width/2,this.width,this.pixelSize,t),i=this.width-e.length;this.line.setAttribute("x1",i/2),this.line.setAttribute("x2",this.width-i/2),this.text.textContent=this.format(e.label)}bestLength(t,e,i,s){i/=s;let r=Math.pow(10,Math.floor(Math.log(e*i)/Math.log(10))),n=r/i;if(n>t)return{length:n,label:r};let a=2*n;if(a>t)return{length:a,label:2*r};let o=5*n;return o>t?{length:o,label:5*r}:{length:0,label:0}}}class N extends P{constructor(t,e,i){super(i),Object.assign(this,{viewer:t,camera:t.camera,overlay:t.overlayElement,pixelSize:e,enabled:!1,priority:100,measure:null,history:[],fontSize:18,markerSize:8,cursor:"crosshair",svg:null,first:null,second:null}),i&&Object.assign(this,i)}start(){this.enabled=!0,this.previousCursor=this.overlay.style.cursor,this.overlay.style.cursor=this.cursor,this.svg||(this.svg=e.createSVGElement("svg",{class:"openlime-ruler"}),this.svgGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.append(this.svgGroup),this.overlay.appendChild(this.svg),this.viewer.addEvent("draw",(()=>this.update())),this.update())}end(){this.enabled=!1,this.overlay.style.cursor=this.previousCursor,this.clear()}clear(){this.svgGroup.replaceChildren([]),this.measure=null,this.history=[]}update(){if(!this.history.length)return;let t=this.camera.getGlCurrentTransform(performance.now()),e=this.camera.glViewport();this.svg.setAttribute("viewBox",`${-e.w/2} ${-e.h/2} ${e.w} ${e.h}`);let i=0,s=0;this.svgGroup.setAttribute("transform",`translate(${t.x} ${t.y}) rotate(${-t.a} 0 0) scale(${t.z} ${t.z}) translate(${i} ${s})`);for(let e of this.history)this.updateMeasure(e,t)}createMarker(t,i){let s=e.createSVGElement("path");return this.svgGroup.appendChild(s),s}updateMarker(t,e,i,s){let r=`M ${e-s} ${i} L ${e+s} ${i} M ${e} ${i-s} L ${e} ${i+s}`;t.setAttribute("d",r)}updateText(t,e){t.text.setAttribute("font-size",e+"px");let i=t.x1-t.x2,s=t.y1-t.y2,r=Math.sqrt(i*i+s*s);r>0&&(i/=r,s/=r),i<0&&(i=-i,s=-s);let n=(t.x1+t.x2)/2,a=(t.y1+t.y2)/2;s/i<0?(n-=.25*s*e,a+=i*e):(a-=.25*e,n+=.25*e),t.text.setAttribute("x",n),t.text.setAttribute("y",a),t.text.textContent=this.format(r*this.pixelSize)}createMeasure(t,i){let s={marker1:this.createMarker(t,i),x1:t,y1:i,marker2:this.createMarker(t,i),x2:t,y2:i};return s.line=e.createSVGElement("line",{x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2}),this.svgGroup.appendChild(s.line),s.text=e.createSVGElement("text"),s.text.textContent="",this.svgGroup.appendChild(s.text),s}updateMeasure(t,e){let i=window.devicePixelRatio*this.markerSize/e.z;this.updateMarker(t.marker1,t.x1,t.y1,i),this.updateMarker(t.marker2,t.x2,t.y2,i);let s=window.devicePixelRatio*this.fontSize/e.z;this.updateText(t,s);for(let e of["x1","y1","x2","y2"])t.line.setAttribute(e,t[e])}fingerSingleTap(t){if(!this.enabled)return!1;let e=this.camera.getCurrentTransform(performance.now()),{x:i,y:s}=this.camera.mapToScene(t.layerX,t.layerY,e);this.measure?(this.measure.x2=i,this.measure.y2=s,this.measure=null):(this.measure=this.createMeasure(i,s),this.history.push(this.measure)),this.update(),t.preventDefault()}fingerHover(t){if(!this.enabled||!this.measure)return!1;let e=this.camera.getCurrentTransform(performance.now()),{x:i,y:s}=this.camera.mapToScene(t.layerX,t.layerY,e);this.measure.x2=i,this.measure.y2=s,this.update(),t.preventDefault()}}class B{constructor(t,e){let i=t.camera;Object.assign(this,{viewer:t,camera:t.camera,skin:"skin/skin.svg",autoFit:!0,actions:{home:{title:"Home",display:!0,key:"Home",task:t=>{i.boundingBox&&i.fitCameraBox(250)}},fullscreen:{title:"Fullscreen",display:!0,key:"f",task:t=>{this.toggleFullscreen()}},layers:{title:"Layers",display:!0,key:"Escape",task:t=>{this.toggleLayers()}},zoomin:{title:"Zoom in",display:!1,key:"+",task:t=>{i.deltaZoom(250,1.25,0,0)}},zoomout:{title:"Zoom out",display:!1,key:"-",task:t=>{i.deltaZoom(250,.8,0,0)}},rotate:{title:"Rotate",display:!1,key:"r",task:t=>{i.rotate(250,-45)}},light:{title:"Light",display:"auto",key:"l",task:t=>{this.toggleLightController()}},ruler:{title:"Ruler",display:!1,task:t=>{this.toggleRuler()}},help:{title:"Help",display:!1,key:"?",task:t=>{this.toggleHelp(this.actions.help)},html:"<p>Help here!</p>"},snapshot:{title:"Snapshot",display:!1,task:t=>{this.snapshot()}}},postInit:()=>{},pixelSize:null,unit:null,attribution:null,lightcontroller:null,showLightDirections:!1,enableTooltip:!0,controlZoomMessage:null,menu:[]}),Object.assign(this,e),this.autoFit&&this.viewer.canvas.addEvent("updateSize",(()=>this.viewer.camera.fitCameraBox(0))),this.panzoom=new A(this.viewer.camera,{priority:-1e3,activeModifiers:[0,1],controlZoom:null!=this.controlZoomMessage}),this.controlZoomMessage&&this.panzoom.addEvent("nowheel",(()=>{this.showOverlayMessage(this.controlZoomMessage)})),this.viewer.pointerManager.onEvent(this.panzoom),this.menu.push({section:"Layers"});for(let[t,e]of Object.entries(this.viewer.canvas.layers)){let i=[];for(let s of e.getModes()){let r={button:s,mode:s,layer:t,onclick:()=>{e.setMode(s)},status:()=>e.getMode()==s?"active":""};"specular"==s&&e.shader.setSpecularExp&&(r.list=[{slider:"",oninput:t=>{e.shader.setSpecularExp(t.target.value)}}]),i.push(r)}let s={button:e.label||t,onclick:()=>{this.setLayer(e)},status:()=>e.visible?"active":"",layer:t};i.length>1&&(s.list=i),e.annotations&&(s.list=[],s.list.push(e.annotationsEntry())),this.menu.push(s)}let s=new C(((t,e)=>{for(let i of r)i.setLight([t,e],0);this.showLightDirections&&this.updateLightDirections(t,e),this.emit("lightdirection",[t,e,Math.sqrt(1-t*t+e*e)])}),{active:!1,activeModifiers:[2,4],control:"light",onPanStart:this.showLightDirections?()=>{Object.values(this.viewer.canvas.layers).filter((t=>null!=t.annotations)).forEach((t=>t.setVisible(!1))),this.enableLightDirections(!0)}:null,onPanEnd:this.showLightDirections?()=>{Object.values(this.viewer.canvas.layers).filter((t=>null!=t.annotations)).forEach((t=>t.setVisible(!0))),this.enableLightDirections(!1)}:null,relative:!0});s.priority=0,this.viewer.pointerManager.onEvent(s),this.lightcontroller=s;let r=[];for(let[t,e]of Object.entries(this.viewer.canvas.layers))e.controls.light&&r.push(e);if(r.length){this.createLightDirections();for(let t of r)s.setPosition(.5,.5),t.controllers.push(s)}queueMicrotask?queueMicrotask((()=>{this.init()})):setTimeout((()=>{this.init()}),0)}showOverlayMessage(t,e=2e3){if(this.overlayMessage)return clearTimeout(this.overlayMessage.timeout),void(this.overlayMessage.timeout=setTimeout((()=>this.destroyOverlayMessage()),e));let i=document.createElement("div");i.classList.add("openlime-overlaymsg"),i.innerHTML=`<p>${t}</p>`,this.viewer.containerElement.appendChild(i),this.overlayMessage={background:i,timeout:setTimeout((()=>this.destroyOverlayMessage()),e)}}destroyOverlayMessage(){this.overlayMessage.background.remove(),this.overlayMessage=null}getMenuLayerEntry(t){return this.menu.find((e=>e.layer==t))}createLightDirections(){this.lightDirections=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.lightDirections.setAttribute("viewBox","-100, -100, 200 200"),this.lightDirections.setAttribute("preserveAspectRatio","xMidYMid meet"),this.lightDirections.style.display="none",this.lightDirections.classList.add("openlime-lightdir");for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){let i=document.createElementNS("http://www.w3.org/2000/svg","line");i.pos=[35*t,35*e],this.lightDirections.appendChild(i)}this.viewer.containerElement.appendChild(this.lightDirections)}updateLightDirections(t,e){let i=[...this.lightDirections.children];for(let s of i){let i=s.pos[0],r=s.pos[1];s.setAttribute("x1",.6*i-0*t),s.setAttribute("y1",.6*r+0*e),s.setAttribute("x2",i/.6+60*t),s.setAttribute("y2",r/.6-60*e)}}enableLightDirections(t){this.lightDirections.style.display=t?"block":"none"}init(){(async()=>{if(document.addEventListener("keydown",(t=>this.keyDown(t)),!1),document.addEventListener("keyup",(t=>this.keyUp(t)),!1),this.createMenu(),this.updateMenu(),this.viewer.canvas.addEvent("update",(()=>this.updateMenu())),this.actions.light&&"auto"===this.actions.light.display&&(this.actions.light.display=!0),this.skin&&await this.loadSkin(),this.setupActions(),this.pixelSize)this.scalebar=new k(this.pixelSize,this.viewer);else if(this.viewer.canvas.layers[Object.keys(this.viewer.canvas.layers)[0]].pixelSize){let t=this.viewer.canvas.layers[Object.keys(this.viewer.canvas.layers)[0]].pixelSizePerMM();this.scalebar=new k(t,this.viewer)}if(this.attribution){var t=document.createElement("p");t.classList.add("openlime-attribution"),t.innerHTML=this.attribution,this.viewer.containerElement.appendChild(t)}for(let t of Object.values(this.viewer.canvas.layers)){this.setLayer(t);break}this.actions.light&&this.actions.light.active&&this.toggleLightController(),this.actions.layers&&this.actions.layers.active&&this.toggleLayers(),this.postInit()})().catch((t=>{throw console.log(t),Error("Something failed")}))}keyDown(t){}keyUp(t){if((t.target==document.body||null==t.target.closest("input, textarea"))&&!t.defaultPrevented)for(const e of Object.values(this.actions))if("key"in e&&e.key==t.key)return t.preventDefault(),void e.task(t)}async loadSkin(){let t=document.createElement("div");t.classList.add("openlime-toolbar"),this.viewer.containerElement.appendChild(t);for(let[i,s]of Object.entries(this.actions))if(!0===s.display&&("icon"in s?"string"==typeof s.icon&&(e.isSVGString(s.icon)?s.icon=e.SVGFromString(s.icon):s.icon=await e.loadSVG(s.icon),s.icon.classList.add("openlime-button")):s.icon=".openlime-"+i,s.element=await $.appendIcon(t,s.icon),this.enableTooltip)){let t=document.createElementNS("http://www.w3.org/2000/svg","title");t.textContent=s.title,s.element.appendChild(t)}}setupActions(){for(let[t,e]of Object.entries(this.actions)){let t=e.element;t&&t.addEventListener("click",(t=>{e.task(t),t.preventDefault()}))}let t=document.querySelectorAll(".openlime-layers-button");for(let e of t){let t=e.getAttribute("data-layer");t&&e.addEventListener("click",(()=>{this.setLayer(this.viewer.layers[t])}))}}toggleLightController(t){let e=this.viewer.containerElement.classList.toggle("openlime-light-active",t);this.lightActive=e;for(let t of Object.values(this.viewer.canvas.layers))for(let i of t.controllers)"light"==i.control&&(i.active=!0,i.activeModifiers=e?[0,2,4]:[2,4])}toggleFullscreen(){let t=this.viewer.canvasElement,e=this.viewer.containerElement;e.classList.toggle("openlime-fullscreen-active")?(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e):((document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen).call(document),document.querySelector(".openlime-scale > line"),this.viewer.resize(t.offsetWidth,t.offsetHeight));this.viewer.resize(t.offsetWidth,t.offsetHeight)}toggleRuler(){this.ruler||(this.ruler=new N(this.viewer,this.pixelSize),this.viewer.pointerManager.onEvent(this.ruler)),this.ruler.enabled?this.ruler.end():this.ruler.start()}toggleHelp(t,e){t.dialog?t.dialog.toggle(e):(t.dialog=new j(this.viewer.containerElement,{modal:!0,class:"openlime-help-dialog"}),t.dialog.setContent(t.html))}snapshot(){var t=document.createElement("a");t.setAttribute("href",this.viewer.canvas.canvasElement.toDataURL()),t.setAttribute("download","snapshot.png"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}createEntry(t){"id"in t||(t.id="entry_"+this.entry_count++);let e=`id="${t.id}"`,i="tooltip"in t?`title="${t.tooltip}"`:"",s="classes"in t?t.classes:"",r="";if("title"in t)r+=`<h2 ${e} class="openlime-title ${s}" ${i}>${t.title}</h2>`;else if("section"in t)r+=`<h3 ${e} class="openlime-section ${s}" ${i}>${t.section}</h3>`;else if("html"in t)r+=`<div ${e} class="${s}">${t.html}</div>`;else if("button"in t){r+=`<a href="#" ${e} ${"group"in t?`data-group="${t.group}"`:""} ${"layer"in t?`data-layer="${t.layer}"`:""} ${"mode"in t?`data-mode="${t.mode}"`:""} ${i} class="openlime-entry ${s}">${t.button}</a>`}else if("slider"in t){r+=`<input type="range" min="1" max="100" value="${"value"in t?t.value:50}" class="openlime-slider ${s}" ${e}>`}if("list"in t){let e=`<div class="openlime-list ${s}">`;for(let i of t.list)e+=this.createEntry(i);e+="</div>",r+=e}return r}addEntryCallbacks(t){if(t.element=this.layerMenu.querySelector("#"+t.id),t.onclick&&t.element.addEventListener("click",(e=>{t.onclick()})),t.oninput&&t.element.addEventListener("input",t.oninput),t.oncreate&&t.oncreate(),"list"in t)for(let e of t.list)this.addEntryCallbacks(e)}updateEntry(t){let e=t.status?t.status():"";if(t.element.classList.toggle("active","active"==e),"list"in t)for(let e of t.list)this.updateEntry(e)}updateMenu(){for(let t of this.menu)this.updateEntry(t)}createMenu(){this.entry_count=0;let t='<div class="openlime-layers-menu">';for(let e of this.menu)t+=this.createEntry(e);t+="</div>";let e=document.createElement("template");e.innerHTML=t.trim(),this.layerMenu=e.content.firstChild,this.viewer.containerElement.appendChild(this.layerMenu);for(let t of this.menu)this.addEntryCallbacks(t)}toggleLayers(){this.layerMenu.classList.toggle("open")}setLayer(t){if("string"==typeof t&&(t=this.viewer.canvas.layers[t]),t.overlay)t.setVisible(!t.visible);else for(let e of Object.values(this.viewer.canvas.layers))if(!e.overlay){e.setVisible(e==t);for(let i of e.controllers)"light"==i.control&&(i.active=this.lightActive&&e==t)}this.updateMenu(),this.viewer.redraw()}}class j{constructor(t,e){Object.assign(this,{dialog:null,content:null,container:t,modal:!1,class:null,visible:!1,backdropEvents:!0},e),this.create()}create(){let t=document.createElement("div");t.classList.add("openlime-dialog-background");let e=document.createElement("div");e.classList.add("openlime-dialog"),this.class&&e.classList.add(this.class),(async()=>{let t=await $.appendIcon(e,".openlime-close");t.classList.add("openlime-close"),t.addEventListener("click",(()=>this.hide()))})();let i=document.createElement("div");i.classList.add("openlime-dialog-content"),e.append(i),this.modal?(this.backdropEvents&&t.addEventListener("click",(e=>{e.target==t&&this.hide()})),t.appendChild(e),this.container.appendChild(t),this.element=t):(this.container.appendChild(e),this.element=e),this.dialog=e,this.content=i,this.hide()}setContent(t){"string"==typeof t?this.content.innerHTML=t:this.content.replaceChildren(t)}show(){this.element.classList.remove("hidden"),this.visible=!0}hide(){this.element.classList.add("hidden"),this.visible=!1,this.emit("closed")}fade(t){this.element.classList.toggle("fading")}toggle(t){this.element.classList.toggle("hidden",t),this.visible=!this.visible}}r(j,"closed"),r(B,"lightdirection");class H extends g{constructor(t){super({}),Object.assign(this,{modes:["light","normals","diffuse","specular"],mode:"normal",type:["ptm","hsh","sh","rbf","bln"],colorspaces:["lrgb","rgb","mrgb","mycc"],nplanes:null,yccplanes:null,njpegs:null,material:null,lights:null,sigma:null,ndimensions:null,scale:null,bias:null,basis:null,lweights:null}),Object.assign(this,t),this.relight&&this.init(this.relight),this.setMode("light")}setMode(t){if(!this.modes.includes(t))throw Error("Unknown mode: "+t);this.mode=t,"light"!=t&&(this.lightWeights([.612,.354,.707],"base"),this.lightWeights([-.612,.354,.707],"base1"),this.lightWeights([0,-.707,.707],"base2")),this.needsUpdate=!0}setLight(t){if(!this.uniforms.light)throw"Shader not initialized, wait on layer ready event for setLight.";let e=t[0],i=t[1],s=Math.sqrt(e*e+i*i);s>1&&(e/=s,i/=s),t=[e,i,Math.sqrt(Math.max(0,1-e*e-i*i))],"light"==this.mode&&this.lightWeights(t,"base"),this.setUniform("light",t)}setSpecularExp(t){this.setUniform("specular_exp",t)}init(t){for(Object.assign(this,t),"mycc"==this.colorspace?this.nplanes=this.yccplanes[0]+this.yccplanes[1]+this.yccplanes[2]:this.yccplanes=[0,0,0],this.planes=[],this.njpegs=0;3*this.njpegs<this.nplanes;)this.njpegs++;for(let t=0;t<this.njpegs;t++)this.samplers.push({id:t,name:"plane"+t,type:"vec3"});this.normals&&this.samplers.push({id:this.njpegs,name:"normals",type:"vec3"}),this.material=this.materials[0],this.lights&&(this.lights,new Float32Array(this.lights)),"rbf"==this.type&&(this.ndimensions=this.lights.length/3),"bilinear"==this.type&&(this.ndimensions=this.resolution*this.resolution,this.type="bln"),this.scale=this.material.scale,this.bias=this.material.bias,["mrgb","mycc"].includes(this.colorspace)&&this.loadBasis(this.basis),this.uniforms={light:{type:"vec3",needsUpdate:!0,size:3,value:[0,0,1]},specular_exp:{type:"float",needsUpdate:!1,size:1,value:10},bias:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.bias},scale:{type:"vec3",needsUpdate:!0,size:this.nplanes/3,value:this.scale},base:{type:"vec3",needsUpdate:!0,size:this.nplanes},base1:{type:"vec3",needsUpdate:!1,size:this.nplanes},base2:{type:"vec3",needsUpdate:!1,size:this.nplanes}},this.lightWeights([0,0,1],"base")}lightWeights(t,e,i){let s;switch(this.type){case"ptm":s=class{static lightWeights(t){let e=[1,t[0],t[1],t[0]*t[0],t[0]*t[1],t[1]*t[1]],i=new Float32Array(18);for(let t=0;t<18;t++)i[3*t]=i[3*t+1]=i[3*t+2]=e[t];return i}}.lightWeights(t);break;case"hsh":s=G.lightWeights(t);break;case"sh":s=class{static lightWeights(t){let e=3.1415,i=.5*Math.sqrt(3/e),s=.5*Math.sqrt(15/e),r=[.5/Math.sqrt(e),i*t[0],i*t[2],i*t[1],s*t[0]*t[1],s*t[0]*t[2],.5*Math.sqrt(5/e)*(3*t[2]*t[2]-1),s*t[1]*t[2],.5*s*(t[1]*t[1]-t[0]*t[0])],n=new Float32Array(27);for(let t=0;t<27;t++)n[3*t]=n[3*t+1]=n[3*t+2]=r[t];return n}}.lightWeights(t);break;case"rbf":s=X.lightWeights(t,this);break;case"bln":s=class{static lightWeights(t,e){let i=e.nplanes,s=Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]),r=(t[0]+t[1])/s,n=(t[1]-t[0])/s;r=(r+1)/2,n=(n+1)/2,r*=e.resolution-1,n*=e.resolution-1;let a=Math.min(e.resolution-2,Math.max(0,Math.floor(r))),o=Math.min(e.resolution-2,Math.max(0,Math.floor(n))),l=r-a,h=n-o,c=(1-l)*(1-h),d=l*(1-h),u=(1-l)*h,m=l*h,p=new Float32Array(3*(i+1));for(let t=0;t<i+1;t++)for(let i=0;i<3;i++){let s=e.basePixelOffset(t,a,o,i),r=e.basePixelOffset(t,a+1,o,i),n=e.basePixelOffset(t,a,o+1,i),l=e.basePixelOffset(t,a+1,o+1,i);p[3*t+i]=c*e.basis[s]+d*e.basis[r]+u*e.basis[n]+m*e.basis[l]}return p}}.lightWeights(t,this)}this.setUniform(e,s,i)}baseLightOffset(t,e,i){return 3*(t*this.ndimensions+e)+i}basePixelOffset(t,e,i,s){return 3*(t*this.resolution*this.resolution+(e+i*this.resolution))+s}loadBasis(t){let e=new Uint8Array(t);this.basis=new Float32Array(t.length),new Float32Array(e.length);for(let t=0;t<this.nplanes+1;t++)for(let i=0;i<this.ndimensions;i++)for(let s=0;s<3;s++){let r=this.baseLightOffset(t,i,s);this.basis[r]=0==t?e[r]/255:(e[r]-127)/this.material.range[t-1]}}fragShaderSrc(t){let e=!(t instanceof WebGLRenderingContext),i=`\n\n\n#define np1 ${this.nplanes+1}\n\n${e?"in":"varying"} vec2 v_texcoord;\n\nconst mat3 T = mat3(8.1650e-01, 4.7140e-01, 4.7140e-01,\n\t-8.1650e-01, 4.7140e-01,  4.7140e-01,\n\t-1.6222e-08, -9.4281e-01, 4.7140e-01);\n\nuniform vec3 light;\nuniform float specular_exp;\nuniform vec3 bias[np1];\nuniform vec3 scale[np1];\n\nuniform vec3 base[np1];\nuniform vec3 base1[np1];\nuniform vec3 base2[np1];\n`;for(let t=0;t<this.njpegs;t++)i+=`\nuniform sampler2D plane${t};\n`;switch(this.normals&&(i+="\nuniform sampler2D normals;\n"),"mycc"==this.colorspace&&(i+=`\n\nconst int ny0 = ${this.yccplanes[0]};\nconst int ny1 = ${this.yccplanes[1]};\n`),this.colorspace){case"lrgb":i+=class{static render(t,e){let i="\nvec4 render(vec3 base[np1]) {\n\tfloat l = 0.0;\n";for(let s=1,r=0;s<t;s++,r+=3)i+=`\n\t{\n\t\tvec4 c = texture${e?"":"2D"}(plane${s}, v_texcoord);\n\t\tl += base[${r}].x*(c.x - bias[${s}].x)*scale[${s}].x;\n\t\tl += base[${r+1}].x*(c.y - bias[${s}].y)*scale[${s}].y;\n\t\tl += base[${r+2}].x*(c.z - bias[${s}].z)*scale[${s}].z;\n\t}\n`;return i+=`\n\tvec3 basecolor = (texture${e?"":"2D"}(plane0, v_texcoord).xyz - bias[0])*scale[0];\n\n\treturn l*vec4(basecolor, 1);\n}\n`,i}}.render(this.njpegs,e);break;case"rgb":i+=class{static render(t,e){let i="\nvec4 render(vec3 base[np1]) {\n\tvec4 rgb = vec4(0, 0, 0, 1);";for(let s=0;s<t;s++)i+=`\n\t{\n\t\tvec4 c = texture${e?"":"2D"}(plane${s}, v_texcoord);\n\t\trgb.x += base[${s}].x*(c.x - bias[${s}].x)*scale[${s}].x;\n\t\trgb.y += base[${s}].y*(c.y - bias[${s}].y)*scale[${s}].y;\n\t\trgb.z += base[${s}].z*(c.z - bias[${s}].z)*scale[${s}].z;\n\t}\n`;return i+="\n\treturn rgb;\n}\n",i}}.render(this.njpegs,e);break;case"mrgb":i+=class{static render(t,e){let i="\nvec4 render(vec3 base[np1]) {\n\tvec3 rgb = base[0];\n\tvec4 c;\n\tvec3 r;\n";for(let s=0;s<t;s++)i+=`\tc = texture${e?"":"2D"}(plane${s}, v_texcoord);\n\tr = (c.xyz - bias[${s}])* scale[${s}];\n\n\trgb += base[${s}*3+1]*r.x;\n\trgb += base[${s}*3+2]*r.y;\n\trgb += base[${s}*3+3]*r.z;\n`;return i+="\n\treturn vec4(rgb, 1);\n}\n",i}}.render(this.njpegs,e);break;case"mycc":i+=class{static render(t,e,i){let s="\nvec3 toRgb(vec3 ycc) {\n \tvec3 rgb;\n\trgb.g = ycc.r + ycc.b/2.0;\n\trgb.b = ycc.r - ycc.b/2.0 - ycc.g/2.0;\n\trgb.r = rgb.b + ycc.g;\n\treturn rgb;\n}\n\nvec4 render(vec3 base[np1]) {\n\tvec3 rgb = base[0];\n\tvec4 c;\n\tvec3 r;\n";for(let r=0;r<t;r++)s+=`\n\n\tc = texture${i?"":"2D"}(plane${r}, v_texcoord);\n\n\tr = (c.xyz - bias[${r}])* scale[${r}];\n`,s+=r<e?`\n\trgb.x += base[${r}*3+1].x*r.x;\n\trgb.y += base[${r}*3+2].y*r.y;\n\trgb.z += base[${r}*3+3].z*r.z;\n`:`\n\trgb.x += base[${r}*3+1].x*r.x;\n\trgb.x += base[${r}*3+2].x*r.y;\n\trgb.x += base[${r}*3+3].x*r.z;\n`;return s+="\t\n\treturn vec4(toRgb(rgb), 1);\n}\n",s}}.render(this.njpegs,this.yccplanes[0],e)}if(i+="\n\nvec4 data() {\n\n","light"==this.mode)i+="\n\tvec4 color = render(base);\n";else switch(i+="\n\tvec4 color;\n",this.normals?i+=`\n\tvec3 normal = (texture${e?"":"2D"}(normals, v_texcoord).zyx *2.0) - 1.0;\n\tnormal.z = sqrt(1.0 - normal.x*normal.x - normal.y*normal.y);\n`:i+="\n\tvec3 normal;\n\tnormal.x = dot(render(base ).xyz, vec3(1));\n\tnormal.y = dot(render(base1).xyz, vec3(1));\n\tnormal.z = dot(render(base2).xyz, vec3(1));\n\tnormal = normalize(T * normal);\n",this.mode){case"normals":i+="\n\tnormal = (normal + 1.0)/2.0;\n\tcolor = vec4(0.0, normal.xy, 1);\n";break;case"diffuse":"lrgb"==this.colorspace||"rgb"==this.colorspace?i+=`\nvec4 diffuse = texture${e?"":"2D"}(plane0, v_texcoord);\nfloat s = dot(light, normal);\ncolor = vec4(s * diffuse.xyz, 1);\n`:i+="\ncolor = vec4(vec3(dot(light, normal)), 1);\n";break;default:i+="\n\tfloat s = pow(dot(light, normal), specular_exp);\n\t//color = vec4(render(base).xyz*s, 1.0);\n\tcolor = vec4(s, s, s, 1.0);\n"}return i+="return color;\n}",i}}class G{static minElevation=.15;static lightWeights(t){let e=3.1415,i=Math.atan2(t[1],t[0]);i<0&&(i=2*e+i);let s=Math.min(Math.acos(t[2]),e/2-this.minElevation),r=Math.cos(i),n=Math.cos(s),a=n*n,o=[1/Math.sqrt(2*e),Math.sqrt(6/e)*(r*Math.sqrt(n-a)),Math.sqrt(3/(2*e))*(2*n-1),Math.sqrt(6/e)*(Math.sqrt(n-a)*Math.sin(i)),Math.sqrt(30/e)*(Math.cos(2*i)*(-n+a)),Math.sqrt(30/e)*(r*(2*n-1)*Math.sqrt(n-a)),Math.sqrt(5/(2*e))*(1-6*n+6*a),Math.sqrt(30/e)*((2*n-1)*Math.sqrt(n-a)*Math.sin(i)),Math.sqrt(30/e)*((-n+a)*Math.sin(2*i))],l=new Float32Array(27);for(let t=0;t<27;t++)l[3*t]=l[3*t+1]=l[3*t+2]=o[t];return l}}class q{constructor(t,e=1,i=5){this.samples=t,this.alpha=e,this.beta=2}distance(t,e){const i=t[0]-e[0],s=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(i*i+s*s+r*r)}smoothMinDist(t){let e=0,i=0;for(const{dist:s}of t){const t=Math.exp(-this.beta*s);e+=s*t,i+=t}return e/i}findNeighbors(t,e,i){return this.samples.map(((s,r)=>({index:r,dist:this.distance(s,[t,e,i])}))).sort(((t,e)=>t.dist-e.dist))}rbf(t,e){return Math.exp(-e*t*t)}weights(t,e,i){const s=this.findNeighbors(t,e,i),r=this.smoothMinDist(s),n=this.alpha/r;let a=0,o=[];for(const{index:t,dist:e}of s){const i=this.rbf(e,n);o.push([t,i]),a+=i}for(let t of o)t[1]/=a;return o}}class X{static lightWeights(t,e){let i=X.rbf(t,e),s=e.nplanes,r=new Float32Array(3*(s+1));for(let t=0;t<s+1;t++)for(let s=0;s<3;s++)for(let n=0;n<i.length;n++){let a=e.baseLightOffset(t,i[n][0],s);r[3*t+s]+=i[n][1]*e.basis[a]}return r}static rbf(t,e){let i=new Array(e.ndimensions),s=new Array(e.ndimensions);for(let t=0;t<i.length;t++){let i=e.lights[3*t+0],r=e.lights[3*t+1],n=e.lights[3*t+2];s[t]=[i,r,n]}return new q(s,8,24).weights(t[0],t[1],t[2])}}class V extends c{constructor(t){if(super(t),0!=Object.keys(this.rasters).length)throw"Rasters options should be empty!";if(!this.url)throw"Url option is required";this.shaders.rti=new H({normals:this.normals}),this.setShader("rti"),this.addControl("light",[0,0]),this.worldRotation=0,this.loadJson(this.url)}imageUrl(t,e){let i=this.url.substring(0,this.url.lastIndexOf("/")+1);switch(this.layout.type){case"image":return i+e+".jpg";case"google":return i+e;case"deepzoom":return i+e+".dzi";case"tarzoom":return i+e+".tzi";case"itarzoom":return i+"planes.tzi";case"zoomify":return i+e+"/ImageProperties.xml";case"iip":return t;case"iiif":throw Error("Unimplemented");default:throw Error("Unknown layout: "+layout.type)}}setLight(t,e){this.setControl("light",t,e)}loadJson(t){(async()=>{let e=t;"iip"==this.layout.type&&(e=(this.server?this.server+"?FIF=":"")+t+"&obj=description");var i=await fetch(e);if(!i.ok)return void(this.status="Failed loading "+e+": "+i.statusText);let s=await i.json();this.layout.suffix=s.format,s.pixelSizeInMM&&(this.pixelSize=s.pixelSizeInMM),this.shader.init(s);let r=[];for(let e=0;e<this.shader.njpegs;e++){let i=this.layout.imageUrl(t,"plane_"+e);r.push(i);let s=new f({format:"vec3"});this.rasters.push(s)}if(this.normals){let e=this.layout.imageUrl(t,"normals");r.push(e);let i=new f({format:"vec3"});this.rasters.push(i)}this.layout.setUrls(r)})().catch((t=>{console.log(t),this.status=t}))}interpolateControls(){let t=super.interpolateControls();if(!t){let t=this.controls.light.current.value,e=s.rotate(t[0],t[1],this.worldRotation*Math.PI);this.shader.setLight([e.x,e.y])}return t}draw(t,e){return this.worldRotation=t.a+this.transform.a,super.draw(t,e)}}c.prototype.types.rti=t=>new V(t);class W extends g{constructor(t){super({}),Object.assign(this,{modes:["light"],mode:"light",nplanes:null,scale:null,bias:null}),Object.assign(this,t),this.samplers=[{id:1,name:"u_texture_1",type:"vec3"},{id:2,name:"u_texture_2",type:"vec3"},{id:3,name:"u_texture_3",type:"vec3"}],this.uniforms={lights:{type:"vec2",needsUpdate:!0,size:2,value:[0,0]},min:{type:"vec3",needsUpdate:!0,size:3,value:[0,0,0]},max:{type:"vec3",needsUpdate:!0,size:3,value:[1,1,1]},layer1_weights:{type:"vec4",needsUpdate:!0,size:this.c*this.n/4},layer1_biases:{type:"vec4",needsUpdate:!0,size:this.n/4},layer2_weights:{type:"vec4",needsUpdate:!0,size:this.n*this.n/4},layer2_biases:{type:"vec4",needsUpdate:!0,size:this.n/4},layer3_weights:{type:"vec4",needsUpdate:!0,size:3*this.n/4},layer3_biases:{type:"vec3",needsUpdate:!0,size:1}}}createProgram(t){super.createProgram(t),this.position_location=t.getAttribLocation(this.program,"a_position"),this.texcoord_location=t.getAttribLocation(this.program,"a_texcoord")}setLight(t){this.setUniform("lights",t)}init(){this.lightWeights([0,0,1],"base")}setShaderInfo(t,e,i,s,r){this.samples=t,this.planes=e,this.n=i,this.c=s,this.colorspace=r}vertShaderSrc(t){return"#version 300 es\nin vec2 a_position;\nin vec2 a_texcoord;\nout vec2 v_texcoord;\nvoid main() {\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}"}fragShaderSrc(t){return`\nvec4 inputs[${this.c/4}];    // 12/4\nvec4 output1[${this.n/4}];  // 52/4\nvec4 output2[${this.n/4}];  // 52/4\nvec3 output3;\n\nin vec2 v_texcoord;\nuniform sampler2D u_texture_1;\nuniform sampler2D u_texture_2;\nuniform sampler2D u_texture_3;\nuniform vec2 lights;\n\nuniform vec4 layer1_weights[${this.c*this.n/4}]; // 12*52/4\nuniform vec4 layer1_biases[${this.n/4}];  // 52/4\nuniform vec4 layer2_weights[${this.n*this.n/4}]; // 52*52/4\nuniform vec4 layer2_biases[${this.n/4}];  // 52/4\nuniform vec4 layer3_weights[${3*this.n/4}];  // 52*3/4\nuniform vec3 layer3_biases;\n\nuniform vec3 min[${this.planes/3}];\nuniform vec3 max[${this.planes/3}];\n\nfloat elu(float a){\n\treturn (a > 0.0) ? a : (exp(a) - 1.0);\n}\n\n\nvec4 relightCoeff(vec3 color_1, vec3 color_2, vec3 color_3) {\n\t// Rescaling features\n    color_1 = color_1 * (max[0] - min[0]) + min[0];\n    color_2 = color_2 * (max[1] - min[1]) + min[1];\n    color_3 = color_3 * (max[2] - min[2]) + min[2];\n\n\t// building input\n\tinputs[0] = vec4(color_1, color_2.x);\n\tinputs[1] = vec4(color_2.yz, color_3.xy);\n\tinputs[2] = vec4(color_3.z, lights, 0.0);\n\n\tfloat sum = 0.0;\n\n\t// layer 1 - 11 x 49\n\tfor (int i=0; i < ${this.n}; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.c/4}; j++){\n\t\t\tsum += dot(inputs[j], layer1_weights[${this.c/4}*i+j]);\n\t\t}\n\t\toutput1[i/4][i%4] = elu(sum + layer1_biases[i/4][i%4]);\n\t}\n\t\n\t// layer 2 - 49 x 49\n\tfor (int i=0; i < ${this.n}; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.n/4}; j++){\n\t\t\tsum += dot(output1[j], layer2_weights[${this.n/4}*i+j]);\n\t\t}\n\t\toutput2[i/4][i%4] = elu(sum + layer2_biases[i/4][i%4]);\n\t}\n\n\t// layer 3 - 49 x 3\n\tfor (int i=0; i < 3; i++){\n\t\tsum = 0.0;\n\t\tfor (int j=0; j < ${this.n/4}; j++){\n\t\t\tsum += dot(output2[j], layer3_weights[${this.n/4}*i+j]);\n\t\t}\n\t\toutput3[i] = sum + layer3_biases[i];\n\t}\n\treturn vec4(output3.${this.colorspace}, 1.0);\n}\n\nvec4 relight(vec2 v) {\n\tvec3 color_1 = texture(u_texture_1, v).${this.colorspace};\n\tvec3 color_2 = texture(u_texture_2, v).${this.colorspace};\n\tvec3 color_3 = texture(u_texture_3, v).${this.colorspace};\n\treturn relightCoeff(color_1, color_2, color_3);\n}\n\n\nvec4 data() {\n\treturn relight(v_texcoord);\n}\nvec4 data1() {\n\tvec2 uv = v_texcoord;\n\tbool showDiff = false;\n\tbool showA = false;\n\tif(v_texcoord.x > 0.5) {\n\t\tshowDiff = true;\n\t\tuv.x -= 0.5;\n\t}\n\tif(v_texcoord.y > 0.5) {\n\t\tshowA = true;\n\t\tuv.y -= 0.5;\n\t}\n\tvec2 o = floor(uv*128.0)/128.0;\n\tfloat step = 1.0/256.0;\n\n\tvec4 a = vec4(0, 0, 0, 0);\n\tvec3 color_1 = vec3(0, 0, 0);\n\tvec3 color_2 = vec3(0, 0, 0);\n\tvec3 color_3 = vec3(0, 0, 0);\n\n\tfor(float y = 0.0; y <= step; y = y + step) {\n\t\tfor(float x = 0.0; x <= step; x = x + step) {\n\t\t\tvec2 d = o + vec2(x, y);\n\t\t\ta += 0.25*relight(d);\n\n\t\t\tcolor_1 += texture(u_texture_1, d).${this.colorspace};\n\t\t\tcolor_2 += texture(u_texture_2, d).${this.colorspace};\n\t\t\tcolor_3 += texture(u_texture_3, d).${this.colorspace};\n\t\t}\n\t}\n\tvec4 b = relightCoeff(0.25*color_1, 0.25*color_2, 0.25*color_3);\n\tfloat diff = 255.0*length((a - b).xyz);\n\tif(showDiff) {\n\t\tif(diff < 10.0) {\n\t\t\treturn vec4(0.0, 0.0, 0.0, 1.0);\n\t\t} else if (diff < 20.0) {\n\t\t\treturn vec4(0.0, 0.0, 1.0, 1.0);\n\t\t} else if(diff < 40.0) {\n\t\t\treturn vec4(0.0, 1.0, 0.0, 1.0);\n\t\t} else\n\t\t\treturn vec4(1.0, 0.0, 0.0, 1.0);\n\t} \n\tif(showA)\n\t\treturn a;\n\treturn b;\n}\n\n\t\t`}}class Y extends c{constructor(t){super(t||{}),this.currentRelightFraction=1,this.maxTiles=40,this.relighted=!1,this.convergenceSpeed=1.2,this.addControl("light",[0,0]),this.worldRotation=0;let e=[null,this.layout.imageUrl(this.url,"plane_1"),this.layout.imageUrl(this.url,"plane_2"),this.layout.imageUrl(this.url,"plane_3")];this.layout.setUrls(e);for(let t of e){let t=new f({format:"vec3"});this.rasters.push(t)}this.imageShader=new g({label:"Rgb",samplers:[{id:0,name:"kd",type:"vec3",load:!1}]}),this.neuralShader=new W,this.shaders={standard:this.imageShader,neural:this.neuralShader},this.setShader("neural"),this.neuralShader.setLight([0,0]),(async()=>{await this.loadNeural(this.url)})()}setLight(t,e){this.setControl("light",t,e)}loadTile(t,e){this.shader=this.neuralShader,super.loadTile(t,e)}async loadNeural(t){await this.initialize(t)}async initialize(t){const e=await this.loadJSON(t);this.max=e.max.flat(1),this.min=e.min.flat(1),this.width=e.width,this.height=e.height;let i={};for(let t=0;t<3;t++){let s="layer"+(t+1);i[s+"_weights"]=e.weights[t],i[s+"_biases"]=e.biases[t]}for(const[t,e]of Object.entries(i))this.neuralShader.setUniform(t,e);this.neuralShader.setUniform("min",this.min),this.neuralShader.setUniform("max",this.max);let s=e.samples,r=e.planes+2;for(;s%4!=0;)s++;for(;r%4!=0;)r++;this.neuralShader.setShaderInfo(e.samples,e.planes,s,r,e.colorspace),this.networkParameters=i}setCoords(){let t=this.gl,e=new Float32Array([-1,-1,-1,1,1,1,1,-1]);this.coords_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.coords_buffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);let i=new Float32Array([0,0,0,1,1,1,1,0]);this.texCoords_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texCoords_buffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)}async loadJSON(t){const e=await fetch(t);return await e.json()}draw(t,e){if("ready"!=this.status)return!0;if(this.worldRotation=t.a+this.transform.a,void 0!==this.networkParameters){let i=this.relightFraction;this.relighted&&(this.canvas.fps>1.5*this.canvas.targetfps?this.currentRelightFraction=Math.min(1,this.currentRelightFraction*this.convergenceSpeed):this.canvas.fps<.75*this.canvas.targetfps&&(this.currentRelightFraction=Math.max(this.currentRelightFraction/this.convergenceSpeed,1/128),this.convergenceSpeed=Math.max(1.05,Math.pow(this.convergenceSpeed,.9)),console.log("fps slow: ",this.canvas.fps,this.currentRelightFraction))),this.refineTimeout&&clearTimeout(this.refineTimeout),this.currentRelightFraction<.75&&0==this.refine&&(this.refineTimeout=setTimeout((()=>{this.emit("update"),this.refine=!0}),Math.max(400,4e3/this.canvas.fps))),this.relightFraction=this.refine?1:this.currentRelightFraction,this.relightFraction=Math.round(8*this.relightFraction)/8;let s=this.relightFraction!=i,r=Math.round((this.layout.tilesize||this.layout.width)*this.relightFraction),n=Math.round((this.layout.tilesize||this.layout.height)*this.relightFraction);this.refine=!1;let a=this.layout.available(e,t,this.transform,0,this.mipmapBias,this.tiles),o=Object.values(a);if(0==o.length)return;if(s)for(let t of o)t.neuralUpdated=!1;this.relighted=!1,this.totTiles=0,this.totPixels=0;for(let t of o)t.neuralUpdated&&!s||(this.relighted||(this.relighted=!0,this.preRelight([e.x,e.y,e.dx,e.dy],r,n,s)),this.relightTile(t,r,n,s),this.totPixels+=r*n,this.totTiles+=1);this.relighted&&this.postRelight(),this.relighted=this.relighted&&!this.refine}this.shader=this.imageShader;let i=super.draw(t,e);return this.shader=this.neuralShader,i}preRelight(t,e,i){let s=this.gl;if(this.neuralShader.program)s.useProgram(this.neuralShader.program);else{this.neuralShader.createProgram(s),s.useProgram(this.neuralShader.program);for(var r=0;r<this.neuralShader.samplers.length;r++)s.uniform1i(this.neuralShader.samplers[r].location,r)}this.neuralShader.updateUniforms(s),this.coords_buffer||this.setCoords(),s.bindBuffer(s.ARRAY_BUFFER,this.coords_buffer),s.vertexAttribPointer(this.neuralShader.position_location,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.texCoords_buffer),s.vertexAttribPointer(this.neuralShader.texcoord_location,2,s.FLOAT,!1,0,0),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.BLEND),this.framebuffer||(this.framebuffer=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,this.framebuffer),this.backupViewport=t,s.viewport(0,0,e,i)}postRelight(){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null);let e=this.backupViewport;this.gl.viewport(e[0],e[1],e[2],e[3])}relightTile(t,e,i,s){let r=this.gl,n=null==t.tex[0];if(n){let e=t.tex[0]=r.createTexture();r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)}(s||n)&&(r.bindTexture(r.TEXTURE_2D,t.tex[0]),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,i,0,r.RGBA,r.UNSIGNED_BYTE,null));for(var a=0;a<this.neuralShader.samplers.length;a++){let e=this.neuralShader.samplers[a].id;r.activeTexture(r.TEXTURE0+a),r.bindTexture(r.TEXTURE_2D,t.tex[e])}r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t.tex[0],0),r.drawArrays(r.TRIANGLE_FAN,0,4),t.neuralUpdated=!0}interpolateControls(){if(super.interpolateControls())return!0;let t=this.controls.light.current.value,e=s.rotate(t[0],t[1],this.worldRotation*Math.PI);t=[e.x,e.y],this.neuralShader.setLight(t);for(let[t,e]of this.tiles)e.neuralUpdated=!1;return!1}}c.prototype.types.neural=t=>new Y(t),t.BoundingBox=i,t.Camera=n,t.Canvas=d,t.Color=p,t.Colormap=class{constructor(t=[new p(0,0,0,1),new p(1,1,1,1)],e=""){e=Object.assign({domain:[0,1],lowColor:null,highColor:null,description:"",type:"linear"},e),Object.assign(this,e);const i=t.length;this.lowColor||(this.lowColor=t[0]),this.highColor||(this.highColor=t[i-1]);const s=this.domain.length;if(i<2&&2!=s&&this.nval!=s&&this.domain[s-1]<=this.domain[0])throw Error("Colormap colors/domain bad format");const r=(this.domain[s-1]-this.domain[0])/(i-1);this.xarr=[],this.rarr=[],this.garr=[],this.barr=[],this.aarr=[];for(let e=0;e<i;e++)2==s?this.xarr.push(this.domain[0]+e*r):this.xarr.push(this.domain[e]),this.rarr.push(t[e].r),this.garr.push(t[e].g),this.barr.push(t[e].b),this.aarr.push(t[e].a);this.rspline=new m(this.xarr,this.rarr),this.gspline=new m(this.xarr,this.garr),this.bspline=new m(this.xarr,this.barr),this.aspline=new m(this.xarr,this.aarr)}static clamp=(t,e,i)=>Math.min(Math.max(t,e),i);rangeDomain(){return[this.domain[0],this.domain[this.domain.length-1]]}bar(t){if(t<this.xarr[0])return this.lowColor;if(t>this.xarr[this.xarr.length-1])return this.highColor;const e=new p(this.rarr[0],this.garr[0],this.barr[0],this.aarr[0]);for(let i=0;i<this.xarr.length-1;i++)t>this.xarr[i]&&t<=this.xarr[i+1]&&(e.r=this.rarr[i],e.g=this.garr[i],e.b=this.barr[i],e.a=this.aarr[i]);return e}linear(t){if(t<this.xarr[0])return this.lowColor;if(t>this.xarr[this.xarr.length-1])return this.highColor;const e=new p(this.rarr[0],this.garr[0],this.barr[0],this.aarr[0]);for(let i=0;i<this.xarr.length-1;i++)t>this.xarr[i]&&t<=this.xarr[i+1]&&(e.r=(this.rarr[i+1]-this.rarr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.rarr[i],e.g=(this.garr[i+1]-this.garr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.garr[i],e.b=(this.barr[i+1]-this.barr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.barr[i],e.a=(this.aarr[i+1]-this.aarr[i])*(t-this.xarr[i])/(this.xarr[i+1]-this.xarr[i])+this.aarr[i]);return e}spline(t){return t<this.xarr[0]?this.lowColor:t>this.xarr[this.xarr.length-1]?this.highColor:new p(this.rspline.at(t),this.gspline.at(t),this.bspline.at(t),this.aspline.at(t))}at(t){let e=null;switch(this.type){case"linear":e=this.linear(t);break;case"spline":e=this.spline(t);break;case"bar":e=this.bar(t);break;default:throw Error("Interpolant type not exist")}return e}sample(t){let e=this.xarr[0],i=this.xarr[this.xarr.length-1],s=new Uint8Array(4*t),r=(i-e)/t;for(let i=0;i<t;i++){let t=this.at(e+i*r).toRGBA();s[4*i+0]=t[0],s[4*i+1]=t[1],s[4*i+2]=t[2],s[4*i+3]=t[3]}return{min:e,max:i,buffer:s}}},t.ColormapLegend=class{constructor(t,e,i){i=Object.assign({nticks:6,legendWidth:25,textColor:"#fff",class:"openlime-legend"},i),Object.assign(this,i),this.viewer=t,this.colorscale=e,this.container=document.querySelector(`.${this.class}`),this.container||(this.container=document.createElement("div"),this.container.classList.add(this.class)),this.scale=document.createElement("div"),this.scale.style=`display: flex; border-radius: 20px; height: 22px; color: ${this.textColor}; \n\t\tfont-weight: bold; overflow: hidden; margin: 0px 2px 4px 0px; background-color: #7c7c7c; \n\t\tfont-family: Arial,Helvetica,sans-serif; font-size:12px;\n\t\tborder: 1px solid #000;`,this.container.appendChild(this.scale),this.viewer.containerElement.appendChild(this.container);const s=e.rangeDomain(),r=document.createElement("div");r.style=`display: flex; align-items: center; justify-content: center; \n\t\tbackground: ${e.linear(s[0]).toHex()}; width: ${this.legendWidth}%; margin: 0`,r.textContent=e.description,this.scale.appendChild(r),"linear"==this.colorscale.type&&this.legendLinear(),"bar"==this.colorscale.type&&this.legendBar()}legendLinear(){const t=this.colorscale.rangeDomain(),e=(t[1]-t[0])/this.nticks,i=(100-this.legendWidth)/this.nticks;let s=t[0];for(let r=0;r<this.nticks;r++){let n=t[0]+e*r,a=r<this.nticks-1?t[0]+e*(r+.5):n;const o=this.colorscale.at(n),l=this.colorscale.at(s),h=this.colorscale.at(a),c=document.createElement("div"),d=`background: linear-gradient(to right, ${l.toHex()}, ${o.toHex()}, ${h.toHex()})`;c.style=`display: flex; align-items: center; justify-content: center; \n\t\t\t${d};\twidth: ${i}%; margin: 0`,c.textContent=n.toFixed(1),this.scale.appendChild(c),s=a}}legendBar(){const t=(100-this.legendWidth)/this.colorscale.domain.length;for(let e=0;e<this.colorscale.xarr.length;e++){const i=new p(this.colorscale.rarr[e],this.colorscale.garr[e],this.colorscale.barr[e],this.colorscale.aarr[e]),s=this.colorscale.xarr[e],r=document.createElement("div"),n=`background: ${i.toHex()}`;r.style=`display: flex; align-items: center; justify-content: center; \n\t\t\t${n};\twidth: ${t}%; margin: 0`,r.textContent=s.toFixed(1),this.scale.appendChild(r)}}},t.Controller=R,t.Controller2D=C,t.ControllerPanZoom=A,t.CoordinateSystem=o,t.Draggable=class{constructor(t,e,i){i=Object.assign({top:null,bottom:20,left:null,right:20,handleSize:10,handleGap:5,zindex:200,handleColor:"#f0f0f0b3"},i),Object.assign(this,i),this.element=t,this.parent=e,"string"==typeof this.parent&&(this.parent=document.querySelector(this.parent)),this.left&&(this.right=null),this.top&&(this.bottom=null),"setCtxMenu"in window||(window.addEventListener("contextmenu",(t=>t.preventDefault())),window.setCtxMenu=!0),this.container=document.createElement("div"),this.container.classList.add("openlime-draggable"),this.container.style=`display: flex; gap:${this.handleGap}px; position: absolute; z-index: ${this.zindex}; touch-action: none; visibility: visible;`,this.handle=document.createElement("div"),this.handle.style=`border-radius: 4px; background-color: ${this.handleColor}; padding: 0; width: ${this.handleSize}px; height: ${this.handleSize}px; z-index: 205;`,this.container.appendChild(this.handle),this.parent.appendChild(this.container),this.dragEvents(),this.element.style.position="unset",this.appendChild(this.element),addEventListener("resize",(t=>{this.updatePos()}))}appendChild(t){this.container.appendChild(t),this.updatePos()}updatePos(){const t=this.container.offsetWidth,e=this.container.offsetHeight;let i=0,s=0;this.top&&(i=this.top),this.bottom&&(i=this.parent.offsetHeight-this.bottom-e),this.left&&(s=this.left),this.right&&(s=this.parent.offsetWidth-this.right-t),this.container.style.top=`${i}px`,this.container.style.left=`${s}px`}dragEvents(){let t,e;const i=this;function s(s){s.preventDefault(),i.container.style.opacity=.6,i.container.style.left=s.clientX-t+"px",i.container.style.top=s.clientY-e+"px"}this.handle.addEventListener("pointerdown",(function(r){r.preventDefault(),i.container.style.opacity=.6,t=r.clientX-i.container.offsetLeft,e=r.clientY-i.container.offsetTop,document.addEventListener("pointermove",s)})),document.addEventListener("pointerup",(function(){i.container.style.opacity=1,document.removeEventListener("pointermove",s)}))}},t.HSH=G,t.Layer=c,t.LayerAnnotationImage=E,t.LayerCombiner=y,t.LayerImage=v,t.LayerMaskedImage=T,t.LayerNeuralRTI=Y,t.LayerRTI=V,t.Layout=l,t.LayoutTileImages=b,t.LayoutTiles=_,t.LightSphereController=class{constructor(t,e){e=Object.assign({width:128,height:128,top:60,right:0,thetaMin:0,colorSpot:"#ffffff",colorBkg:"#0000ff",colorMark:"#ff0000"},e),Object.assign(this,e),this.parent=t,this.layers=[],"string"==typeof this.parent&&(this.parent=document.querySelector(this.parent)),this.lightDir=[0,0],this.containerElement=document.createElement("div"),this.containerElement.style=`padding: 0; position: absolute; width: ${this.width}px; height: ${this.height}px; top:${this.top}px; right:${this.right}px; z-index: 200; touch-action: none; visibility: visible;`,this.containerElement.classList.add("openlime-lsc"),this.width,this.dlCanvas=document.createElement("canvas"),this.dlCanvas.width=this.width,this.dlCanvas.height=this.height,this.dlCanvasCtx=this.dlCanvas.getContext("2d"),this.dlGradient="",this.containerElement.appendChild(this.dlCanvas),this.parent.appendChild(this.containerElement),this.r=.5*this.width,this.thetaMinRad=this.thetaMin/180*Math.PI,this.rmax=this.r*Math.cos(this.thetaMinRad),this.interactLightDir(.5*this.width,.5*this.height),this.pointerDown=!1,this.dlCanvas.addEventListener("pointerdown",(t=>{this.pointerDown=!0;const e=this.dlCanvas.getBoundingClientRect();let i=this.dlCanvas.width*(t.clientX-e.left)/e.width,s=this.dlCanvas.height*(t.clientY-e.top)/e.height;this.interactLightDir(i,s),t.preventDefault()})),this.dlCanvas.addEventListener("pointermove",(t=>{if(this.pointerDown){const e=this.dlCanvas.getBoundingClientRect();let i=this.dlCanvas.width*(t.clientX-e.left)/e.width,s=this.dlCanvas.height*(t.clientY-e.top)/e.height;this.interactLightDir(i,s),t.preventDefault()}})),this.dlCanvas.addEventListener("pointerup",(t=>{this.pointerDown=!1})),this.dlCanvas.addEventListener("pointerout",(t=>{this.pointerDown=!1}))}addLayer(t){this.layers.push(t)}show(){return this.containerElement.style.visibility="visible"}hide(){return this.containerElement.style.visibility="hidden"}computeGradient(){const t=(this.lightDir[0]+1)*this.dlCanvas.width*.5,e=(1-this.lightDir[1])*this.dlCanvas.height*.5;this.dlGradient=this.dlCanvasCtx.createRadialGradient(t,e,this.dlCanvas.height/8,t,e,this.dlCanvas.width/1.2),this.dlGradient.addColorStop(0,this.colorSpot),this.dlGradient.addColorStop(1,this.colorBkg)}interactLightDir(t,e){let i=t-this.r,s=this.r-e;const r=Math.atan2(s,i);let n=Math.sqrt(i*i+s*s);n=n>this.rmax?this.rmax:n,i=n*Math.cos(this.thetaMinRad)*Math.cos(r),s=n*Math.cos(this.thetaMinRad)*Math.sin(r),t=i+this.r,e=this.r-s,this.lightDir[0]=2*(t/this.dlCanvas.width-.5),this.lightDir[1]=2*(1-e/this.dlCanvas.height-.5);for(const t of this.layers)t.controls.light&&t.setControl("light",this.lightDir,5);this.computeGradient(),this.drawLightSelector(t,e)}drawLightSelector(t,e){this.dlCanvasCtx.clearRect(0,0,this.dlCanvas.width,this.dlCanvas.height),this.dlCanvasCtx.beginPath(),this.dlCanvasCtx.arc(this.dlCanvas.width/2,this.dlCanvas.height/2,this.dlCanvas.width/2,0,2*Math.PI),this.dlCanvasCtx.fillStyle=this.dlGradient,this.dlCanvasCtx.fill(),this.dlCanvasCtx.beginPath(),this.dlCanvasCtx.arc(t,e,this.dlCanvas.width/30,0,2*Math.PI),this.dlCanvasCtx.strokeStyle=this.colorMark,this.dlCanvasCtx.lineWidth=2,this.dlCanvasCtx.stroke()}},t.PointerManager=z,t.Raster=f,t.Ruler=N,t.ScaleBar=k,t.Shader=g,t.ShaderCombiner=class extends g{constructor(t){super(t),this.mode="mean",this.samplers=[{id:0,name:"source1",type:"vec3"},{id:1,name:"source2",type:"vec3"}],this.modes=["first","second","mean","diff"],this.operations={first:"color = c1;",second:"color = c2;",mean:"color = (c1 + c2)/2.0;",diff:"color = vec4(c2.rgb - c1.rgb, c1.a);"}}fragShaderSrc(t){return`\n\n${!(t instanceof WebGLRenderingContext)?"in":"varying"} vec2 v_texcoord;\n\nuniform sampler2D source1;\nuniform sampler2D source2;\n\nvec4 data() {\n\tvec4 c1 = texture(source1, v_texcoord);\n\tvec4 c2 = texture(source2, v_texcoord);\n\tvec4 color;\n\t${this.operations[this.mode]};\n\treturn color;\n}\n`}vertShaderSrc(t){let e=!(t instanceof WebGLRenderingContext);return`${e?"#version 300 es":""}\n\n\n${e?"in":"attribute"} vec4 a_position;\n${e?"in":"attribute"} vec2 a_texcoord;\n\n${e?"out":"varying"} vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = a_position;\n\tv_texcoord = a_texcoord;\n}`}},t.ShaderFilter=L,t.ShaderFilterColormap=class extends L{constructor(t,e){if(super(e),e=Object.assign({inDomain:[],channelWeights:[1/3,1/3,1/3],maxSteps:256},e),Object.assign(this,e),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const i=this.colorscale.rangeDomain(),s=(this.inDomain[1]-this.inDomain[0])/(i[1]-i[0]),r=(this.inDomain[0]-i[0])/(i[1]-i[0]);this.samplers=[{name:`${this.samplerName("colormap")}`}],this.uniforms[this.uniformName("channel_weigths")]={type:"vec3",needsUpdate:!0,size:3,value:this.channelWeights},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:s},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:r}}async createTextures(t){const e=this.colorscale.sample(this.maxSteps);let i=t.LINEAR;"bar"==this.colorscale.type&&(i=t.NEAREST);const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,e.buffer),this.getSampler("colormap").tex=s}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                if(col.a == 0.0) return col;\n                float v = dot(col.rgb, ${this.uniformName("channel_weigths")});\n                float cv = v*${this.uniformName("scale")} + ${this.uniformName("bias")};\n\n                if(cv >= 1.0) return ${this.uniformName("high_color")};\n                if(cv <= 0.0) return ${this.uniformName("low_color")};\n\n                return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n            }`}},t.ShaderFilterOpacity=class extends L{constructor(t,e){super(e),this.uniforms[this.uniformName("opacity")]={type:"float",needsUpdate:!0,size:1,value:t}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                return vec4(col.rgb, col.a * ${this.uniformName("opacity")});\n            }`}},t.ShaderFilterTest=class extends L{constructor(t){super(t),this.uniforms[this.uniformName("nodata_col")]={type:"vec4",needsUpdate:!0,size:4,value:[1,1,0,1]}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                return col.a > 0.0 ? col : ${this.uniformName("nodata_col")};\n            }`}},t.ShaderFilterVector=class extends L{constructor(t,e){if(super(e),e=Object.assign({inDomain:[],maxSteps:256,arrowColor:[0,0,0,1]},e),Object.assign(this,e),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const i=this.colorscale.rangeDomain(),s=Math.sqrt((this.inDomain[1]*this.inDomain[1]+this.inDomain[0]*this.inDomain[0])/(i[1]*i[1]+i[0]*i[0]));this.modes={normalize:[{id:"off",enable:!0,src:`const bool ${this.modeName("arrowNormalize")} = false;`},{id:"on",enable:!1,src:`const bool ${this.modeName("arrowNormalize")} = true;`}],arrow:[{id:"mag",enable:!0,src:`const int ${this.modeName("arrowColor")} = 0;`},{id:"col",enable:!1,src:`const int ${this.modeName("arrowColor")} = 1;`}],field:[{id:"none",enable:!0,src:`const int ${this.modeName("fieldColor")} = 0;`},{id:"mag",enable:!1,src:`const int ${this.modeName("fieldColor")} = 1;`}]},this.samplers=[{name:`${this.samplerName("colormap")}`}],this.uniforms[this.uniformName("arrow_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.arrowColor},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:s},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:0}}async createTextures(t){const e=this.colorscale.sample(this.maxSteps);let i=t.LINEAR;"bar"==this.colorscale.type&&(i=t.NEAREST);const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,e.buffer),this.getSampler("colormap").tex=s}fragDataSrc(t){return`\n        // 2D vector field visualization by Matthias Reitinger, @mreitinger\n        // Based on "2D vector field visualization by Morgan McGuire, http://casual-effects.com", https://www.shadertoy.com/view/4s23DG\n        \n        const float ARROW_TILE_SIZE = 16.0;\n        const float ISQRT2 = 0.70710678118; // 1/sqrt(2)\n\n        // Computes the center pixel of the tile containing pixel pos\n        vec2 arrowTileCenterCoord(vec2 pos) {\n            return (floor(pos / ARROW_TILE_SIZE) + 0.5) * ARROW_TILE_SIZE;\n        }\n\n        // Computes the distance from a line segment\n        float line3(vec2 a, vec2 b, vec2 c) {\n            vec2 ab = a - b;\n            vec2 cb = c - b;\n            float d = dot(ab, cb);\n            float len2 = dot(cb, cb);\n            float t = 0.0;\n            if (len2 != 0.0) {\n              t = clamp(d / len2, 0.0, 1.0);\n            }\n            vec2 r = b + cb * t;\n            return distance(a, r);\n        }\n\n        // Computes the signed distance from a line segment\n        float line(vec2 p, vec2 p1, vec2 p2) {\n            vec2 center = (p1 + p2) * 0.5;\n            float len = length(p2 - p1);\n            vec2 dir = (p2 - p1) / len;\n            vec2 rel_p = p - center;\n            float dist1 = abs(dot(rel_p, vec2(dir.y, -dir.x)));\n            float dist2 = abs(dot(rel_p, dir)) - 0.5*len;\n            return max(dist1, dist2);\n        }\n        \n        // v = field sampled at arrowTileCenterCoord(p), scaled by the length\n        // desired in pixels for arrows\n        // Returns a signed distance from the arrow\n        float arrow(vec2 p, vec2 v) {\n            if (${this.modeName("arrowNormalize")}) v = normalize(v);\n            v *= ARROW_TILE_SIZE * 0.5; // Change from [-1,1] to pixels\n            // Make everything relative to the center, which may be fractional\n            p -= arrowTileCenterCoord(p);\n                \n            float mag_v = length(v), mag_p = length(p);\n            \n            if (mag_v > 0.0) {\n                // Non-zero velocity case\n                vec2 dir_v = normalize(v);\n                \n                // We can't draw arrows larger than the tile radius, so clamp magnitude.\n                // Enforce a minimum length to help see direction\n                mag_v = clamp(mag_v, 2.0, ARROW_TILE_SIZE * 0.4);\n        \n                // Arrow tip location\n                v = dir_v * mag_v;\n        \n                // Signed distance from shaft\n                float shaft = line3(p, v, -v);\n                // Signed distance from head\n                float head = min(line3(p, v, 0.4*v + 0.2*vec2(-v.y, v.x)),\n                                 line3(p, v, 0.4*v + 0.2*vec2(v.y, -v.x)));\n                return min(shaft, head);\n            } else {\n                // Signed distance from the center point\n                return mag_p;\n            }\n        }\n        \n        vec4 lookupColormap(float cv) {            \n            if(cv >= 1.0) \n                return ${this.uniformName("high_color")};\n            else if(cv <= 0.0) \n                return ${this.uniformName("low_color")};\n            return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n        }\n\n        vec4 ${this.functionName()}(vec4 col){\n            if(col.a == 0.0) return col;\n\n            vec2 p = v_texcoord*tileSize; // point in pixel\n            vec2 pc_coord = arrowTileCenterCoord(p)/tileSize; // center coordinate\n            vec4 pc_val = texture(kd, pc_coord); // [0..1] - lookup color in center\n            float s = 2.0;\n            float b = -1.0;\n            vec2 uvc = vec2(pc_val.x*s+b, pc_val.y*s+b); // [-1..1]\n            vec2 uvr =  vec2(col.r*s+b, col.g*s+b); // [-1..1]\n\n            // Colors\n            float vc = length(uvc)*ISQRT2;\n            float cvc = vc*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            float vr = length(uvr)*ISQRT2;\n            float cvr = vr*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            vec4 cmapc = lookupColormap(cvc);\n            vec4 cmapr = lookupColormap(cvr);\n                \n            // Arrow            \n            float arrow_dist = arrow(p, uvc);\n            \n            vec4 arrow_col = cmapc;\n            vec4 field_col = vec4(0.0, 0.0, 0.0, 0.0);\n\n            switch (${this.modeName("arrowColor")}) {\n                case 0:\n                    arrow_col = cmapc;\n                    break;\n                case 1:\n                    arrow_col = ${this.uniformName("arrow_color")};               \n                    break;\n            }\n\n            switch (${this.modeName("fieldColor")}) {\n                case 0:\n                    field_col = vec4(0.0, 0.0, 0.0, 0.0);\n                    break;\n                case 1:\n                    field_col = cmapr;              \n                    break;\n            }\n\n            float t = clamp(arrow_dist, 0.0, 1.0);\n            return  mix(arrow_col, field_col, t);\n        }`}},t.ShaderFilterVectorGlyph=class extends L{constructor(t,e,i){if(super(i),i=Object.assign({inDomain:[],maxSteps:256,glyphColor:[0,0,0,1],glyphsStride:80,glyphsSize:[304,64]},i),Object.assign(this,i),2!=this.inDomain.length&&this.inDomain[1]<=this.inDomain[0])throw Error("inDomain bad format");if(this.glyphsUrl=e,0==this.glyphsUrl.length)throw Error("glyphUrl is empty: no items to display");this.colorscale=t,0==this.inDomain.length&&(this.inDomain=this.colorscale.rangeDomain());const s=this.colorscale.rangeDomain(),r=Math.sqrt((this.inDomain[1]*this.inDomain[1]+this.inDomain[0]*this.inDomain[0])/(s[1]*s[1]+s[0]*s[0])),n=this.glyphsStride-this.glyphsSize[1],a=Math.round((this.glyphsSize[0]+n)/this.glyphsStride);this.modes={normalize:[{id:"off",enable:!0,src:`const bool ${this.modeName("glyphNormalize")} = false;`},{id:"on",enable:!1,src:`const bool ${this.modeName("glyphNormalize")} = true;`}],glyph:[{id:"mag",enable:!0,src:`const int ${this.modeName("glyphColor")} = 0;`},{id:"col",enable:!1,src:`const int ${this.modeName("glyphColor")} = 1;`}],field:[{id:"none",enable:!0,src:`const int ${this.modeName("fieldColor")} = 0;`},{id:"mag",enable:!1,src:`const int ${this.modeName("fieldColor")} = 1;`}]},this.samplers=[{name:`${this.samplerName("colormap")}`},{name:`${this.samplerName("glyphs")}`}],this.uniforms[this.uniformName("glyph_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.glyphColor},this.uniforms[this.uniformName("glyph_count")]={type:"float",needsUpdate:!0,size:1,value:a},this.uniforms[this.uniformName("glyph_wh")]={type:"float",needsUpdate:!0,size:1,value:this.glyphsSize[1]},this.uniforms[this.uniformName("glyph_stride")]={type:"float",needsUpdate:!0,size:1,value:this.glyphsStride},this.uniforms[this.uniformName("low_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.lowColor.value()},this.uniforms[this.uniformName("high_color")]={type:"vec4",needsUpdate:!0,size:4,value:this.colorscale.highColor.value()},this.uniforms[this.uniformName("scale")]={type:"float",needsUpdate:!0,size:1,value:r},this.uniforms[this.uniformName("bias")]={type:"float",needsUpdate:!0,size:1,value:0}}async createTextures(t){const i=await e.rasterizeSVG(this.glyphsUrl,this.glyphsSize),s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),this.getSampler("glyphs").tex=s;const r=this.colorscale.sample(this.maxSteps);let n=t.LINEAR;"bar"==this.colorscale.type&&(n=t.NEAREST);const a=t.createTexture();t.bindTexture(t.TEXTURE_2D,a),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.maxSteps,1,0,t.RGBA,t.UNSIGNED_BYTE,r.buffer),this.getSampler("colormap").tex=a}fragDataSrc(t){return`\n        // 2D vector glyph visualization\n        \n        const float GLYPH_TILE_SIZE = 16.0;\n        const float ISQRT2 = 0.70710678118; // 1/sqrt(2)\n\n        // Computes the center pixel of the tile containing pixel pos\n        vec2 glyphTileCenterCoord(vec2 pos) {\n            return (floor(pos / GLYPH_TILE_SIZE) + 0.5) * GLYPH_TILE_SIZE;\n        }\n\n        float glyph(vec2 p, vec2 v) {\n            if (${this.modeName("glyphNormalize")}) v = normalize(v);\n            \n            // Make everything relative to the center, which may be fractional\n            p -= glyphTileCenterCoord(p);\n                \n            float mag_v = length(v), mag_p = length(p);\n            \n            if (mag_v > 0.0) {\n                // Non-zero velocity case\n                vec2 dir_v = normalize(v);\n                \n                float level = floor((1.0-mag_v*ISQRT2) * ${this.uniformName("glyph_count")});\n                level = min(level, ${this.uniformName("glyph_count")} - 1.0);\n\n                mat2 rotm = mat2(\n                    dir_v[1], dir_v[0], // first column\n                    -dir_v[0], dir_v[1]  // second column\n                );\n            \n                float scaleToGlyph =  ${this.uniformName("glyph_wh")} / GLYPH_TILE_SIZE;\n                vec2 pp = rotm * p; // p on axys with origin in tile center and aligned with direction dir_v\n                pp += vec2(GLYPH_TILE_SIZE * 0.5, GLYPH_TILE_SIZE * 0.5); // pp in [0, GLYPH_TILE_SIZE]\n                pp *= scaleToGlyph; // pp in [0, glyph_wh]\n                pp.x += level * ${this.uniformName("glyph_stride")}; // apply stride\n                pp.y = ${this.uniformName("glyph_wh")} - pp.y - 1.0; // invert y-axis\n                //vec4 g = texelFetch(${this.samplerName("glyphs")}, ivec2(pp), 0);\n                float w = ${this.uniformName("glyph_stride")}*(${this.uniformName("glyph_count")} -1.0) + ${this.uniformName("glyph_wh")};\n                float h = ${this.uniformName("glyph_wh")};\n                vec2 ppnorm = pp/vec2(w,h);\n                vec4 g = texture(${this.samplerName("glyphs")}, ppnorm);\n                return 1.0-g.a;\n\n            } else {\n                // Signed distance from the center point\n                return mag_p;\n            }\n        }\n        \n        vec4 lookupColormap(float cv) {            \n            if(cv >= 1.0) \n                return ${this.uniformName("high_color")};\n            else if(cv <= 0.0) \n                return ${this.uniformName("low_color")};\n            return texture(${this.samplerName("colormap")}, vec2(cv, 0.5));\n        }\n\n        vec4 ${this.functionName()}(vec4 col){\n            if(col.a == 0.0) return col;\n\n            vec2 p = v_texcoord*tileSize; // point in pixel\n            vec2 pc_coord = glyphTileCenterCoord(p)/tileSize; // center coordinate\n            vec4 pc_val = texture(kd, pc_coord); // [0..1] - lookup color in center\n            float s = 2.0;\n            float b = -1.0;\n            vec2 uvc = vec2(pc_val.x*s+b, pc_val.y*s+b); // [-1..1]\n            vec2 uvr =  vec2(col.r*s+b, col.g*s+b); // [-1..1]\n\n            // Colors\n            float vc = length(uvc)*ISQRT2;\n            float cvc = vc*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            float vr = length(uvr)*ISQRT2;\n            float cvr = vr*${this.uniformName("scale")} + ${this.uniformName("bias")};\n            vec4 cmapc = lookupColormap(cvc);\n            vec4 cmapr = lookupColormap(cvr);\n                \n            // Glyph            \n            float glyph_dist = glyph(p, uvc);\n\n            vec4 glyph_col = cmapc;\n            vec4 field_col = vec4(0.0, 0.0, 0.0, 0.0);\n\n            switch (${this.modeName("glyphColor")}) {\n                case 0:\n                    glyph_col = cmapc;\n                    break;\n                case 1:\n                    glyph_col = ${this.uniformName("glyph_color")};               \n                    break;\n            }\n\n            switch (${this.modeName("fieldColor")}) {\n                case 0:\n                    field_col = vec4(0.0, 0.0, 0.0, 0.0);\n                    break;\n                case 1:\n                    field_col = cmapr;              \n                    break;\n            }\n\n            float t = clamp(glyph_dist, 0.0, 1.0);\n            return  mix(glyph_col, field_col, t);\n        }`}},t.ShaderGammaFilter=class extends L{constructor(t){super(t),this.uniforms[this.uniformName("gamma")]={type:"float",needsUpdate:!0,size:1,value:2.2}}fragDataSrc(t){return`\n            vec4 ${this.functionName()}(vec4 col){\n                float igamma = 1.0/${this.uniformName("gamma")};\n                return vec4(pow(col.r, igamma), pow(col.g, igamma), pow(col.b, igamma), col.a);\n            }`}},t.ShaderNeural=W,t.ShaderRTI=H,t.Skin=$,t.Tile=a,t.Transform=s,t.UIBasic=B,t.UIDialog=j,t.Units=P,t.Util=e,t.Viewer=I,Object.defineProperty(t,"__esModule",{value:!0})}));
