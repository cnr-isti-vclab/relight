#!/usr/bin/env bash

# Custom AppRun that keeps linuxdeploy's hook chain while ensuring
# bundled libraries in usr/lib* take precedence.

set -euo pipefail

APPDIR="$(readlink -f "$(dirname "$0")")"
export APPDIR

# Source linuxdeploy's Qt hook if present (restores QT_QPA_PLATFORMTHEME etc.).
HOOK_SCRIPT="$APPDIR/apprun-hooks/linuxdeploy-plugin-qt-hook.sh"
if [ -f "$HOOK_SCRIPT" ]; then
    # shellcheck source=/dev/null
    source "$HOOK_SCRIPT"
fi

prepend_ld_path() {
    local dir="$1"
    if [ -d "$dir" ]; then
        if [ -z "${LD_LIBRARY_PATH:-}" ]; then
            LD_LIBRARY_PATH="$dir"
        else
            LD_LIBRARY_PATH="$dir:$LD_LIBRARY_PATH"
        fi
    fi
}

prepend_ld_path "$APPDIR/usr/lib"
prepend_ld_path "$APPDIR/usr/lib64"
prepend_ld_path "$APPDIR/usr/lib/x86_64-linux-gnu"
export LD_LIBRARY_PATH

exec "$APPDIR/AppRun.wrapped" "$@"
